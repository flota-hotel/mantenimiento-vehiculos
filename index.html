<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Gesti√≥n Vehicular ‚Äî Hotel</title>

  <!-- PWA (opcional) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1e40af">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registrado', reg))
        .catch(err => console.error('Error registrando SW', err));
    }
  </script>

  <style>
    :root{ 
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --card: #ffffff;
      --ink: #1e293b;
      --muted: #64748b;
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #0f172a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --line: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:var(--ink);background:var(--bg)}
    
    /* Login Screen */
    .login-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);display:flex;align-items:center;justify-content:center;z-index:1000}
    .login-card{background:white;padding:40px;border-radius:20px;box-shadow:var(--shadow-lg);width:100%;max-width:400px;text-align:center}
    .login-title{font-size:24px;font-weight:700;margin-bottom:8px;color:var(--ink)}
    .login-subtitle{color:var(--muted);margin-bottom:32px}
    .login-form{display:flex;flex-direction:column;gap:20px}
    .role-card{border:2px solid var(--line);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s}
    .role-card:hover{border-color:var(--primary);transform:translateY(-2px)}
    .role-card.selected{border-color:var(--primary);background:rgba(30, 64, 175, 0.05)}
    .role-title{font-weight:600;margin-bottom:4px}
    .role-desc{font-size:14px;color:var(--muted)}
    .password-field{margin-top:20px}
    .password-field input{width:100%;padding:12px;border:1px solid var(--line);border-radius:8px;font-size:16px}
    .login-btn{background:var(--primary);color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.2s}
    .login-btn:hover{background:var(--primary-hover)}
    .login-btn:disabled{opacity:0.5;cursor:not-allowed}
    
    /* Main App */
    .app{display:none}
    .app.logged-in{display:block}
    
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:5;box-shadow:var(--shadow)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 24px}
    .brand{font-weight:700;font-size:18px;color:var(--primary);display:flex;align-items:center;gap:8px}
    .brand-icon{font-size:24px}
    .search{flex:1;display:flex;gap:8px;max-width:400px}
    .user-info{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:14px}
    .logout-btn{background:var(--danger);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px}
    .logout-btn:hover{background:#dc2626}
    
    input, select{width:100%;padding:12px 16px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px;transition:border-color 0.2s, box-shadow 0.2s}
    input:focus, select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30, 64, 175, 0.1)}
    
    button{border:0;border-radius:10px;padding:12px 20px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
    button:hover{background:var(--primary-hover);transform:translateY(-1px);box-shadow:var(--shadow)}
    button:active{transform:translateY(0)}
    button.secondary{background:#f8fafc;color:var(--ink);border:1px solid var(--line)}
    button.secondary:hover{background:#f1f5f9;border-color:var(--primary)}
    button.danger{background:var(--danger)}
    button.danger:hover{background:#dc2626}
    button.success{background:var(--success)}
    button.success:hover{background:#059669}
    
    .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:16px 24px;background:rgba(255,255,255,0.5);backdrop-filter:blur(10px)}
    .tab{padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer;font-weight:500;transition:all 0.2s;display:flex;align-items:center;gap:6px}
    .tab:hover{background:var(--primary);color:#fff;border-color:transparent;transform:translateY(-1px)}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent;box-shadow:var(--shadow)}
    
    .container{max-width:1400px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:20px}
    .kpis{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:24px;box-shadow:var(--shadow);transition:transform 0.2s, box-shadow 0.2s}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .card h3{margin:0 0 12px 0;font-size:14px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .big{font-size:32px;font-weight:800;color:var(--primary)}
    .kpi-icon{font-size:24px;margin-bottom:8px;opacity:0.7}
    
    table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden}
    th,td{padding:12px 16px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;background:#f8fafc;text-transform:uppercase;letter-spacing:0.5px;font-size:12px}
    tr:hover{background:#f8fafc}
    
    .row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600}
    .ok{background:#10b9811a;color:#065f46;border:1px solid #10b98140}
    .warnP{background:#f59e0b1a;color:#7c2d12;border:1px solid #f59e0b40}
    .dangerP{background:#ef44441a;color:#7f1d1d;border:1px solid #ef444440}
    
    .hidden{display:none !important}
    
    /* Asegurar que los modales est√©n ocultos por defecto */
    .modal.hidden{visibility:hidden;opacity:0}
    .modal{visibility:hidden;opacity:0;transition:opacity 0.3s ease, visibility 0.3s ease}
    .modal:not(.hidden){visibility:visible;opacity:1}
    .sticky-actions{position:fixed;right:24px;bottom:24px;display:flex;flex-direction:column;gap:12px;z-index:10}
    .footer{padding:24px;color:var(--muted);font-size:12px;text-align:center;background:var(--card);margin-top:40px;border-top:1px solid var(--line)}
    .tag{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:4px 12px;background:white}
    .test{font-size:12px;color:var(--ink)}
    .test .pass{color:#059669}
    .test .fail{color:#b91c1c}
    
    /* highlight bit√°cora */
    .flash{transition:background 0.4s}
    .flash td{background:inherit}
    .flash-ret{background:#fff7ed !important}
    .flash-ent{background:#eef2ff !important}
    .newtag{display:inline-block;margin-right:6px;font-size:12px}
    
    /* Action buttons */
    .action-btn{padding:6px 12px;font-size:12px;margin:0 2px}
    .edit-btn{background:var(--warn);color:white}
    .edit-btn:hover{background:#d97706}
    .delete-btn{background:var(--danger);color:white}
    .delete-btn:hover{background:#dc2626}
    .export-btn{background:var(--success);color:white}
    .export-btn:hover{background:#059669}
    
    /* Modal styles */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;cursor:pointer}
    .modal-content{background:white;padding:24px;border-radius:16px;max-width:800px;width:90%;max-height:90%;overflow-y:auto;cursor:default}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--line)}
    .modal-title{font-size:20px;font-weight:700;color:var(--ink)}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s}
    .close-btn:hover{background:var(--line);color:var(--ink);transform:scale(1.1)}
    
    /* Form improvements */
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--ink)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    
    /* Report preview */
    .report-preview{background:white;border:1px solid var(--line);border-radius:12px;padding:20px;margin-top:20px}
    .report-header{text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--primary)}
    .report-title{font-size:24px;font-weight:700;color:var(--primary);margin-bottom:8px}
    .report-date{color:var(--muted);font-size:14px}
    
    @media (max-width: 768px) {
      .row, .row-3, .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
      .topbar { flex-direction: column; gap: 16px; }
      .search { max-width: none; }
      .tabs { padding: 12px 16px; }
      .container { padding: 16px; }
    }
  </style>

  <!-- SheetJS para exportaciones a Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1 class="login-title">üöó Sistema de Gesti√≥n Vehicular</h1>
      <p class="login-subtitle">Seleccione su rol para acceder al sistema</p>
      
      <div class="login-form">
        <div class="role-card" data-role="admin" onclick="selectRole('admin')">
          <div class="role-title">üë®‚Äçüíº Administrador</div>
          <div class="role-desc">Acceso completo a todas las funciones</div>
        </div>
        
        <div class="role-card" data-role="operador" onclick="selectRole('operador')">
          <div class="role-title">üîß Operador</div>
          <div class="role-desc">Mantenimientos, cambios de aceite y combustible</div>
        </div>
        
        <div class="role-card" data-role="supervisor" onclick="selectRole('supervisor')">
          <div class="role-title">üëÅÔ∏è Supervisor</div>
          <div class="role-desc">Solo acceso a revisiones detalladas</div>
        </div>
        
        <div class="password-field">
          <input type="password" id="loginPassword" placeholder="Ingrese su contrase√±a" />
        </div>
        
        <button class="login-btn" onclick="attemptLogin()" disabled>Iniciar Sesi√≥n</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <span class="brand-icon">üöó</span>
        Sistema de Gesti√≥n Vehicular
      </div>
      <div class="search">
        <input id="qPlaca" type="text" placeholder="Buscar por placa (ej. ABC123)‚Ä¶"/>
        <button class="secondary" onclick="buscarPlaca()">üîç Buscar</button>
      </div>
      <div class="user-info">
        <span>üë§ <span id="currentUserRole"></span></span>
        <button class="secondary" onclick="cerrarTodosLosModales()" title="Cerrar ventanas abiertas">‚úñÔ∏è Cerrar Modales</button>
        <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>
    <div class="tabs" id="mainTabs">
      <button class="tab active" data-tab="dashboard" onclick="setTab('dashboard')" data-roles="admin">üìä Dashboard</button>
      <button class="tab" data-tab="vehiculos" onclick="setTab('vehiculos')" data-roles="admin">üöó Veh√≠culos</button>
      <button class="tab" data-tab="ficha-tecnica" onclick="setTab('ficha-tecnica')" data-roles="admin">üìã Ficha T√©cnica</button>
      <button class="tab" data-tab="polizas" onclick="setTab('polizas')" data-roles="admin">üõ°Ô∏è P√≥lizas & RTV</button>
      <button class="tab" data-tab="mantenimientos" onclick="setTab('mantenimientos')" data-roles="admin,operador">üîß Mantenimientos</button>
      <button class="tab" data-tab="combustible" onclick="setTab('combustible')" data-roles="admin,operador">‚õΩ Combustible</button>
      <button class="tab" data-tab="revision" onclick="setTab('revision')" data-roles="admin,supervisor">üîç Revisi√≥n</button>
      <button class="tab" data-tab="reportes" onclick="setTab('reportes')" data-roles="admin">üìà Reportes</button>
    </div>
  </header>

  <main class="container">
    <section id="tab-dashboard" class="tabpanel">
      <div class="grid kpis">
        <div class="card">
          <div class="kpi-icon">üöó</div>
          <h3>Veh√≠culos activos</h3>
          <div class="big" id="kpiVeh"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">üõ°Ô∏è</div>
          <h3>P√≥lizas ‚â§30d</h3>
          <div class="big" id="kpiPol30"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">‚ö†Ô∏è</div>
          <h3>P√≥lizas ‚â§7d</h3>
          <div class="big" id="kpiPol7"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">üìã</div>
          <h3>RTV ‚â§30d</h3>
          <div class="big" id="kpiRtv30"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">üîß</div>
          <h3>Mantenimientos mes</h3>
          <div class="big" id="kpiMantMes"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">‚õΩ</div>
          <h3>Gasto combustible mes</h3>
          <div class="big" id="kpiFuelMes"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">üìä</div>
          <h3>Promedio KM/L</h3>
          <div class="big" id="kpiKmL"></div>
        </div>
        <div class="card">
          <div class="kpi-icon">üí∞</div>
          <h3>Costo promedio mantto.</h3>
          <div class="big" id="kpiCostoMant"></div>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Alertas</strong><input id="fltAlertPlaca" type="text" placeholder="Filtrar por placa‚Ä¶" oninput="renderAlertas()"/></div>
        <table><thead><tr><th>Tipo</th><th>Placa</th><th>D√≠as/Km</th><th>Estado</th></tr></thead><tbody id="tblAlertas"></tbody></table>
      </div>
      <div class="card" style="margin-top:16px">
        <details>
          <summary>üß™ Pruebas r√°pidas (dev)</summary>
          <div class="test" id="testOut"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="secondary" onclick="runTests('get')">Probar GET Veh√≠culos</button>
            <button class="secondary" onclick="runTests('ui')">Probar UI (selects)</button>
            <button class="secondary" onclick="runTests('core')">Probar Core (setTab/XLSX)</button>
            <button class="secondary" onclick="runTests('auto')">Probar autoProximoKm</button>
            <button class="secondary" onclick="runTests('bit')">Probar reset & filtro Bit√°cora</button>
          </div>
        </details>
      </div>
    </section>

    <section id="tab-vehiculos" class="tabpanel hidden">
      <form class="card" onsubmit="guardarVehiculo(event)" style="margin-bottom:12px">
        <h3 style="margin:0 0 16px 0;color:var(--ink)">üöó Agregar Nuevo Veh√≠culo</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Placa</label>
            <input id="vPlaca" type="text" placeholder="ABC123" required/>
          </div>
          <div class="form-group">
            <label>Marca</label>
            <input id="vMarca" type="text" placeholder="Toyota" required/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Modelo</label>
            <input id="vModelo" type="text" placeholder="Corolla" required/>
          </div>
          <div class="form-group">
            <label>A√±o</label>
            <input id="vAnio" type="number" min="1990" max="2100" required/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Tipo</label>
            <select id="vTipo">
              <option value="sed√°n">Sed√°n</option>
              <option value="pickup">Pickup</option>
              <option value="SUV">SUV</option>
              <option value="buseta">Buseta</option>
              <option value="hatchback">Hatchback</option>
              <option value="minivan">Minivan</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="vEstado">
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
              <option value="mantenimiento">En Mantenimiento</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Due√±o</label>
            <input id="vDueno" type="text" placeholder="Ej: Hotel, Juan P√©rez, Empresa XYZ"/>
          </div>
          <div class="form-group">
            <label>N√∫mero de P√≥liza</label>
            <input id="vPoliza" type="text" placeholder="POL-123456"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Aseguradora</label>
            <input id="vAseguradora" type="text" placeholder="INS, Mapfre, etc."/>
          </div>
          <div class="form-group">
            <label>Color</label>
            <input id="vColor" type="text" placeholder="Blanco, Negro, etc."/>
          </div>
        </div>
        <div style="margin-top:20px">
          <button type="submit" class="success">üíæ Guardar Veh√≠culo</button>
          <button type="button" class="secondary" onclick="limpiarFormVehiculo()">üóëÔ∏è Limpiar</button>
        </div>
      </form>
      
      <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <select id="fltVehPlaca" onchange="renderVehiculos()">
            <option value="">üìã Todas las placas</option>
          </select>
          <select id="fltVehEstado" onchange="renderVehiculos()">
            <option value="">üöó Todos los estados</option>
            <option value="activo">‚úÖ Activo</option>
            <option value="inactivo">‚ùå Inactivo</option>
            <option value="mantenimiento">üîß En Mantenimiento</option>
          </select>
          <input id="fltVehDueno" type="text" placeholder="üîç Filtrar por due√±o..." onkeyup="renderVehiculos()"/>
        </div>
        <div>
          <button class="secondary export-btn" onclick="exportarVehiculo()">üìä Exportar Excel</button>
        </div>
      </div>
      
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Placa</th>
              <th>Marca/Modelo</th>
              <th>A√±o</th>
              <th>Tipo</th>
              <th>Due√±o</th>
              <th>Aseguradora</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tblVeh"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-ficha-tecnica" class="tabpanel hidden">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin:0 0 16px 0;color:var(--ink)">üìã Seleccionar Veh√≠culo para Ficha T√©cnica</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Veh√≠culo</label>
            <select id="fichaVehiculo" onchange="cargarFichaTecnica()">
              <option value="">Seleccione un veh√≠culo...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Per√≠odo de an√°lisis</label>
            <select id="fichaPeriodo" onchange="cargarFichaTecnica()">
              <option value="3">√öltimos 3 meses</option>
              <option value="6" selected>√öltimos 6 meses</option>
              <option value="12">√öltimo a√±o</option>
              <option value="all">Todo el historial</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="fichaTecnicaContent" class="hidden">
        <div class="row">
          <!-- Informaci√≥n b√°sica del veh√≠culo -->
          <div class="card">
            <h3>üöó Informaci√≥n del Veh√≠culo</h3>
            <div id="fichaInfoBasica"></div>
          </div>
          
          <!-- Estad√≠sticas de rendimiento -->
          <div class="card">
            <h3>üìä Estad√≠sticas de Rendimiento</h3>
            <div id="fichaEstadisticas"></div>
          </div>
        </div>
        
        <div class="row">
          <!-- Costos y mantenimiento -->
          <div class="card">
            <h3>üí∞ An√°lisis de Costos</h3>
            <div id="fichaCostos"></div>
          </div>
          
          <!-- Alertas y pr√≥ximos mantenimientos -->
          <div class="card">
            <h3>‚ö†Ô∏è Alertas y Pr√≥ximos Mantenimientos</h3>
            <div id="fichaAlertas"></div>
          </div>
        </div>
        
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">üìà Historial Detallado</h3>
            <div>
              <button class="export-btn" onclick="exportarFichaTecnicaCompleta()">üìä Exportar Ficha Completa</button>
              <button class="secondary" onclick="previsualizarFicha()">üëÅÔ∏è Vista Previa</button>
            </div>
          </div>
          <div id="fichaHistorial"></div>
        </div>
      </div>
    </section>

    <section id="tab-polizas" class="tabpanel hidden">
      <div class="card" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px 0;color:var(--ink)">+ P√≥liza / + RTV</h3>
        <div class="row">
          <div>
            <div class="row"><div><label>Veh√≠culo</label><select id="pVeh"></select></div><div><label>Aseguradora</label><input id="pAseg" type="text" placeholder="INS"/></div></div>
            <div class="row"><div><label>N¬∞ P√≥liza</label><input id="pNum" type="text"/></div><div><label>Vence (p√≥liza)</label><input id="pVence" type="date"/></div></div>
            <div><button class="secondary" onclick="guardarPoliza(event)">Guardar p√≥liza</button></div>
          </div>
          <div>
            <div class="row"><div><label>Veh√≠culo</label><select id="rVeh"></select></div><div><label>N¬∞ Cita</label><input id="rCita" type="text"/></div></div>
            <div class="row"><div><label>Vence (RTV)</label><input id="rVence" type="date"/></div><div></div></div>
            <div><button class="secondary" onclick="guardarRTV(event)">Guardar RTV</button></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>P√≥lizas</strong><select id="fltPolVencer" onchange="renderPolizas()"><option value="">Todas</option><option value="30">Solo ‚â§30 d√≠as</option><option value="7">Solo ‚â§7 d√≠as</option></select></div>
          <table><thead><tr><th>Placa</th><th>Aseguradora</th><th>N¬∞ P√≥liza</th><th>Vence</th><th>Sem√°foro</th></tr></thead><tbody id="tblPol"></tbody></table>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>RTV</strong><select id="fltRtvVencer" onchange="renderRtv()"><option value="">Todas</option><option value="30">Solo ‚â§30 d√≠as</option><option value="7">Solo ‚â§7 d√≠as</option></select></div>
          <table><thead><tr><th>Placa</th><th>N¬∞ Cita</th><th>Vence</th><th>Sem√°foro</th></tr></thead><tbody id="tblRtv"></tbody></table>
        </div>
      </div>
    </section>

    <section id="tab-mantenimientos" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarMantenimiento(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">+ Mantenimiento</h3>
          <div class="row"><div><label>Veh√≠culo</label><select id="mVeh"></select></div><div><label>Tipo</label><select id="mTipo"><option value="cambio_aceite">Cambio de aceite</option><option value="llantas">Llantas</option><option value="frenos">Frenos</option><option value="bateria">Bater√≠a</option><option value="alineacion">Alineaci√≥n</option><option value="otro">Otro</option></select></div></div>
          <div class="row"><div><label>Fecha</label><input id="mFecha" type="date" required/></div><div><label>Costo</label><input id="mCosto" type="number" min="0" step="0.01" required/></div></div>
          <div class="row"><div><label>Km actual</label><input id="mKm" type="number" min="0"/></div><div><label>Pr√≥ximo km</label><input id="mProx" type="number" min="0" placeholder="auto si cambio de aceite"/></div></div>
          <div class="row"><div><label>√öltimo cambio aceite (km)</label><input id="mKmPrevAceite" type="number" readonly/></div><div></div></div>
          <div><label>Observaciones</label><input id="mObs" type="text" placeholder="Detalles"/></div>
          <div style="margin-top:12px;display:flex;gap:8px"><button>Guardar</button><button type="button" class="secondary" onclick="autoProximoKm()">Sugerir pr√≥ximo (+5,000)</button></div>
        </form>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>üîß Hist√≥rico de Mantenimientos</strong>
            <div style="display:flex;gap:8px">
              <select id="fltMantPlaca" onchange="renderMant()">
                <option value="">üìã Todas las placas</option>
              </select>
              <select id="fltMantTipo" onchange="renderMant()">
                <option value="">üîß Todos los tipos</option>
                <option value="cambio_aceite">üõ¢Ô∏è Cambio de aceite</option>
                <option value="llantas">üõû Llantas</option>
                <option value="frenos">üõë Frenos</option>
                <option value="bateria">üîã Bater√≠a</option>
                <option value="alineacion">‚öñÔ∏è Alineaci√≥n</option>
                <option value="transmision">‚öôÔ∏è Transmisi√≥n</option>
                <option value="motor">üèéÔ∏è Motor</option>
                <option value="suspension">üî© Suspensi√≥n</option>
                <option value="aire_acondicionado">‚ùÑÔ∏è Aire Acondicionado</option>
                <option value="otro">üìù Otro</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Costo</th>
                <th>Km</th>
                <th>Pr√≥x.</th>
                <th>Obs</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblMant"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <span class="tag" id="sumMant"></span>
            <button class="export-btn" onclick="exportarMantenimientos()">üìä Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-combustible" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarCombustible(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">+ Carga de combustible</h3>
          <div class="row"><div><label>Veh√≠culo</label><select id="cVeh"></select></div><div><label>Fecha</label><input id="cFecha" type="date" required/></div></div>
          <div class="row"><div><label>Litros</label><input id="cLitros" type="number" step="0.01" min="0.01" required oninput="calcCosto();calcKmLEstimado()"/></div><div><label>‚Ç°/Litro</label><input id="cPPL" type="number" step="0.01" min="0" required oninput="calcCosto();calcKmLEstimado()"/></div></div>
          <div class="row"><div><label>Od√≥metro km</label><input id="cOdo" type="number" min="0" required oninput="calcCosto();calcKmLEstimado()"/></div><div><label>Proveedor</label><input id="cProv" type="text"/></div></div>
          <div class="row"><div><label>Od√≥metro anterior</label><input id="cOdoPrev" type="number" readonly/></div><div><label>Km/L estimado</label><input id="cKmLEst" type="number" step="0.01" readonly/></div></div>
          <div class="row"><div><label>Costo total</label><input id="cCosto" type="number" readonly/></div><div></div></div>
          <div style="margin-top:12px"><button>Guardar</button></div>
        </form>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>‚õΩ Registros de Combustible</strong>
            <div style="display:flex;gap:8px">
              <select id="fltFuelPlaca" onchange="renderFuel()">
                <option value="">üìã Todas las placas</option>
              </select>
              <select id="fltFuelMes" onchange="renderFuel()">
                <option value="">üìÖ Todos los meses</option>
                <option value="1">Este mes</option>
                <option value="3">√öltimos 3 meses</option>
                <option value="6">√öltimos 6 meses</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Fecha</th>
                <th>Litros</th>
                <th>‚Ç°/L</th>
                <th>Costo</th>
                <th>Od√≥metro</th>
                <th>Km/L</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblFuel"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <span class="tag" id="sumFuel"></span>
              <span class="tag" id="avgKmL"></span>
            </div>
            <button class="export-btn" onclick="exportarCombustible()">üìä Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-revision" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarRevision(event)">
          <h3 style="margin:0 0 16px 0;color:var(--ink)">üîç Nueva Revisi√≥n Detallada</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="rVeh" required></select>
            </div>
            <div class="form-group">
              <label>Tipo de Revisi√≥n</label>
              <select id="rTipo">
                <option value="rutinaria">Rutinaria</option>
                <option value="preventiva">Preventiva</option>
                <option value="post_mantenimiento">Post-Mantenimiento</option>
                <option value="pre_viaje">Pre-Viaje</option>
                <option value="incidente">Por Incidente</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Fecha y Hora</label>
              <input id="rFecha" type="datetime-local" required/>
            </div>
            <div class="form-group">
              <label>Inspector</label>
              <input id="rInspector" type="text" placeholder="Nombre del inspector" required/>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Kilometraje Actual</label>
              <input id="rKm" type="number" min="0" required/>
            </div>
            <div class="form-group">
              <label>Nivel de Combustible</label>
              <select id="rNivelComb">
                <option value="vacio">Vac√≠o (E)</option>
                <option value="1/4">1/4</option>
                <option value="1/2">1/2</option>
                <option value="3/4">3/4</option>
                <option value="lleno">Lleno (F)</option>
              </select>
            </div>
          </div>
          
          <!-- Revisiones de l√≠quidos -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">üõ¢Ô∏è Revisi√≥n de L√≠quidos</h4>
            <div class="form-row-3">
              <div class="form-group">
                <label>Aceite de Motor</label>
                <select id="rAceiteMotor">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>L√≠quido de Frenos</label>
                <select id="rLiquidoFrenos">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Coolant/Refrigerante</label>
                <select id="rCoolant">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>L√≠quido Limpiaparabrisas</label>
                <select id="rLimpiaparabrisas">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="vacio">Vac√≠o</option>
                </select>
              </div>
              <div class="form-group">
                <label>Aceite de Transmisi√≥n</label>
                <select id="rAceiteTransmision">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="verificar">Verificar</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>L√≠quido Direcci√≥n</label>
                <select id="rLiquidoDireccion">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Revisiones mec√°nicas -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">üîß Revisi√≥n Mec√°nica</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Estado de Llantas</label>
                <select id="rEstadoLlantas">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="desgastadas">Desgastadas</option>
                  <option value="cambiar">Necesitan Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Presi√≥n de Llantas</label>
                <select id="rPresionLlantas">
                  <option value="correcta">Correcta</option>
                  <option value="baja">Baja</option>
                  <option value="alta">Alta</option>
                  <option value="revisar">Revisar</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Sistema de Frenos</label>
                <select id="rSistemaFrenos">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="revisar">Revisar</option>
                  <option value="urgente">Atenci√≥n Urgente</option>
                </select>
              </div>
              <div class="form-group">
                <label>Bater√≠a</label>
                <select id="rBateria">
                  <option value="excelente">Excelente</option>
                  <option value="buena">Buena</option>
                  <option value="regular">Regular</option>
                  <option value="debil">D√©bil</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Revisiones el√©ctricas y exteriores -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">üí° Sistema El√©ctrico y Exterior</h4>
            <div class="form-row">
              <div style="display:flex;gap:20px;flex-wrap:wrap">
                <label><input type="checkbox" id="rLucesDelanteras"/> Luces Delanteras</label>
                <label><input type="checkbox" id="rLucesTraseras"/> Luces Traseras</label>
                <label><input type="checkbox" id="rLucesDireccionales"/> Direccionales</label>
                <label><input type="checkbox" id="rLucesFreno"/> Luces de Freno</label>
                <label><input type="checkbox" id="rLucesReversa"/> Luces de Reversa</label>
              </div>
            </div>
            <div class="form-row">
              <div style="display:flex;gap:20px;flex-wrap:wrap">
                <label><input type="checkbox" id="rEspejosLaterales"/> Espejos Laterales</label>
                <label><input type="checkbox" id="rEspejoRetrovisor"/> Espejo Retrovisor</label>
                <label><input type="checkbox" id="rLimpiaparabrisas"/> Limpiaparabrisas</label>
                <label><input type="checkbox" id="rCinturones"/> Cinturones de Seguridad</label>
                <label><input type="checkbox" id="rBocina"/> Bocina</label>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Estado General de Carrocer√≠a</label>
              <select id="rEstadoCarroceria">
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="rayones_menores">Rayones Menores</option>
                <option value="golpes_menores">Golpes Menores</option>
                <option value="da√±os_mayores">Da√±os Mayores</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado del Interior</label>
              <select id="rEstadoInterior">
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="desgastado">Desgastado</option>
                <option value="necesita_limpieza">Necesita Limpieza</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Observaciones Generales</label>
            <textarea id="rObservaciones" rows="3" placeholder="Describa cualquier anomal√≠a, recomendaci√≥n o comentario adicional..."></textarea>
          </div>
          
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Guardar Revisi√≥n</button>
            <button type="button" class="secondary" onclick="limpiarFormRevision()">üóëÔ∏è Limpiar</button>
          </div>
        </form>
        
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>üîç Hist√≥rico de Revisiones</strong>
            <div style="display:flex;gap:8px">
              <select id="fltRevPlaca" onchange="renderRevisiones()">
                <option value="">üìã Todas las placas</option>
              </select>
              <select id="fltRevTipo" onchange="renderRevisiones()">
                <option value="">üîç Todos los tipos</option>
                <option value="rutinaria">Rutinaria</option>
                <option value="preventiva">Preventiva</option>
                <option value="post_mantenimiento">Post-Mantenimiento</option>
                <option value="pre_viaje">Pre-Viaje</option>
                <option value="incidente">Por Incidente</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Inspector</th>
                <th>Fecha</th>
                <th>Km</th>
                <th>Estado General</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblRevisiones"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:end">
            <button class="export-btn" onclick="exportarRevisiones()">üìä Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-reportes" class="tabpanel hidden">
      <div class="card">
        <h3 style="margin:0 0 20px 0">üìä Generador de Reportes</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Reporte</label>
            <select id="repTipo" onchange="actualizarConfigReporte()">
              <option value="mantenimientos">üîß Mantenimientos</option>
              <option value="combustible">‚õΩ Combustible</option>
              <option value="revisiones">üîç Revisiones</option>
              <option value="polizas_rtv">üõ°Ô∏è P√≥lizas & RTV</option>
              <option value="ficha_vehiculo">üìã Ficha T√©cnica por Veh√≠culo</option>
              <option value="resumen_costos">üí∞ Resumen de Costos</option>
              <option value="alertas">‚ö†Ô∏è Alertas y Vencimientos</option>
            </select>
          </div>
          <div class="form-group">
            <label>Veh√≠culo (opcional)</label>
            <select id="repPlaca">
              <option value="">üìã Todos los veh√≠culos</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Inicio</label>
            <input id="repA" type="date"/>
          </div>
          <div class="form-group">
            <label>Fecha de Fin</label>
            <input id="repB" type="date"/>
          </div>
        </div>
        
        <div class="form-row" id="repConfigAdicional">
          <!-- Se llenar√° din√°micamente seg√∫n el tipo de reporte -->
        </div>
        
        <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
          <button class="success" onclick="previsualizarReporte()">üëÅÔ∏è Vista Previa</button>
          <button class="export-btn" onclick="exportReportXLSX()">üìä Exportar Excel</button>
          <button class="secondary" onclick="enviarReporteEmail()">üìß Enviar por Email</button>
        </div>
      </div>
      
      <!-- √Årea de vista previa -->
      <div id="reportePreview" class="hidden">
        <div class="card">
          <div class="modal-header">
            <h3 class="modal-title">üëÅÔ∏è Vista Previa del Reporte</h3>
            <button class="close-btn" onclick="cerrarPreviewReporte()">√ó</button>
          </div>
          
          <div class="report-preview" id="reporteContent">
            <!-- El contenido del reporte se generar√° aqu√≠ -->
          </div>
          
          <div style="margin-top:20px;text-align:center">
            <button class="export-btn" onclick="exportReportXLSX()">üìä Exportar a Excel</button>
            <button class="secondary" onclick="imprimirReporte()">üñ®Ô∏è Imprimir</button>
            <button class="secondary" onclick="cerrarPreviewReporte()">‚úñÔ∏è Cerrar</button>
          </div>
        </div>
      </div>
    </section>

    <div class="sticky-actions" id="stickyActions">
      <button onclick="setTab('mantenimientos')" data-roles="admin,operador">üîß + Mantenimiento</button>
      <button onclick="setTab('combustible')" class="secondary" data-roles="admin,operador">‚õΩ + Combustible</button>
      <button onclick="setTab('revision')" class="secondary" data-roles="admin,supervisor">üîç + Revisi√≥n</button>
    </div>
    
    <!-- Modales de Edici√≥n -->
    
    <!-- Modal Editar Veh√≠culo -->
    <div id="modalEditVehiculo" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Veh√≠culo</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditVehiculo')">√ó</button>
        </div>
        <form onsubmit="actualizarVehiculo(event)">
          <input type="hidden" id="editVehId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Placa</label>
              <input id="editVPlaca" type="text" required/>
            </div>
            <div class="form-group">
              <label>Marca</label>
              <input id="editVMarca" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Modelo</label>
              <input id="editVModelo" type="text" required/>
            </div>
            <div class="form-group">
              <label>A√±o</label>
              <input id="editVAnio" type="number" min="1990" max="2100" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tipo</label>
              <select id="editVTipo">
                <option value="sed√°n">Sed√°n</option>
                <option value="pickup">Pickup</option>
                <option value="SUV">SUV</option>
                <option value="buseta">Buseta</option>
                <option value="hatchback">Hatchback</option>
                <option value="minivan">Minivan</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editVEstado">
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
                <option value="mantenimiento">En Mantenimiento</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Due√±o</label>
              <input id="editVDueno" type="text" placeholder="Ej: Hotel, Juan P√©rez, Empresa XYZ"/>
            </div>
            <div class="form-group">
              <label>N√∫mero de P√≥liza</label>
              <input id="editVPoliza" type="text"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Aseguradora</label>
              <input id="editVAseguradora" type="text"/>
            </div>
            <div class="form-group">
              <label>Color</label>
              <input id="editVColor" type="text"/>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditVehiculo'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Mantenimiento -->
    <div id="modalEditMantenimiento" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Mantenimiento</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditMantenimiento')">√ó</button>
        </div>
        <form onsubmit="actualizarMantenimiento(event)">
          <input type="hidden" id="editMantId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editMVeh" required></select>
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <select id="editMTipo">
                <option value="cambio_aceite">üõ¢Ô∏è Cambio de aceite</option>
                <option value="llantas">üõû Llantas</option>
                <option value="frenos">üõë Frenos</option>
                <option value="bateria">üîã Bater√≠a</option>
                <option value="alineacion">‚öñÔ∏è Alineaci√≥n</option>
                <option value="transmision">‚öôÔ∏è Transmisi√≥n</option>
                <option value="motor">üèéÔ∏è Motor</option>
                <option value="suspension">üî© Suspensi√≥n</option>
                <option value="aire_acondicionado">‚ùÑÔ∏è Aire Acondicionado</option>
                <option value="otro">üìù Otro</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input id="editMFecha" type="date" required/>
            </div>
            <div class="form-group">
              <label>Costo</label>
              <input id="editMCosto" type="number" min="0" step="0.01" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Km actual</label>
              <input id="editMKm" type="number" min="0"/>
            </div>
            <div class="form-group">
              <label>Pr√≥ximo km</label>
              <input id="editMProx" type="number" min="0"/>
            </div>
          </div>
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editMObs" rows="3"></textarea>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditMantenimiento'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Combustible -->
    <div id="modalEditCombustible" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Registro de Combustible</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditCombustible')">√ó</button>
        </div>
        <form onsubmit="actualizarCombustible(event)">
          <input type="hidden" id="editFuelId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editCVeh" required></select>
            </div>
            <div class="form-group">
              <label>Fecha</label>
              <input id="editCFecha" type="date" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Litros</label>
              <input id="editCLitros" type="number" step="0.01" min="0.01" required/>
            </div>
            <div class="form-group">
              <label>‚Ç°/Litro</label>
              <input id="editCPPL" type="number" step="0.01" min="0" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Od√≥metro km</label>
              <input id="editCOdo" type="number" min="0" required/>
            </div>
            <div class="form-group">
              <label>Proveedor</label>
              <input id="editCProv" type="text"/>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditCombustible'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <div class="footer">
    Sistema de Gesti√≥n Vehicular - Hotel ¬© 2024 | Conectado a Google Sheets v√≠a Apps Script
  </div>
  </div> <!-- Cierre mainApp -->

  <script>
  // ====== API: Backend Python FastAPI ======
  const API = "https://8000-i2csqmmo4txbkyhmexll8-6532622b.e2b.dev";
  const API_KEY = ""; // si activas API key, col√≥cala aqu√≠

  // ====== ESTADO ======
  let Vehiculos=[], Polizas=[], RTV=[], Mantenimientos=[], Combustible=[], Bitacora=[], Alertas=[], Revisiones=[];
  let currentUser = null;
  
  // ====== SISTEMA DE ROLES Y LOGIN ======
  const ROLES = {
    admin: {
      name: 'Administrador',
      password: 'Admin',
      permissions: ['dashboard', 'vehiculos', 'ficha-tecnica', 'polizas', 'mantenimientos', 'combustible', 'revision', 'reportes']
    },
    operador: {
      name: 'Operador',
      password: 'operador123', 
      permissions: ['mantenimientos', 'combustible']
    },
    supervisor: {
      name: 'Supervisor',
      password: 'supervisor123',
      permissions: ['revision']
    }
  };
  
  let selectedRole = null;
  
  function selectRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-card').forEach(card => {
      card.classList.remove('selected');
    });
    document.querySelector(`[data-role="${role}"]`).classList.add('selected');
    document.getElementById('loginPassword').focus();
    document.querySelector('.login-btn').disabled = false;
  }
  
  function attemptLogin() {
    const password = document.getElementById('loginPassword').value;
    
    if (!selectedRole || !password) {
      alert('Por favor seleccione un rol e ingrese la contrase√±a');
      return;
    }
    
    if (ROLES[selectedRole] && ROLES[selectedRole].password === password) {
      currentUser = {
        role: selectedRole,
        name: ROLES[selectedRole].name,
        permissions: ROLES[selectedRole].permissions
      };
      
      // Cerrar todos los modales antes de mostrar la app
      cerrarTodosLosModales();
      
      // Ocultar login y mostrar app
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').classList.add('logged-in');
      
      // Ir a la primera pesta√±a disponible seg√∫n el rol
      const firstAvailableTab = currentUser.permissions[0] || 'dashboard';
      setTab(firstAvailableTab);
      
      // Actualizar UI seg√∫n rol
      updateUIForRole();
      
      // Cargar datos
      loadAll();
      
      alert(`¬°Bienvenido, ${currentUser.name}!`);
    } else {
      alert('Contrase√±a incorrecta. Intente nuevamente.');
      document.getElementById('loginPassword').value = '';
    }
  }
  
  function logout() {
    if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
      currentUser = null;
      selectedRole = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('logged-in');
      document.getElementById('loginPassword').value = '';
      document.querySelectorAll('.role-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector('.login-btn').disabled = true;
    }
  }
  
  function updateUIForRole() {
    if (!currentUser) return;
    
    // Actualizar nombre de usuario en header
    document.getElementById('currentUserRole').textContent = currentUser.name;
    
    // Mostrar/ocultar tabs seg√∫n permisos
    document.querySelectorAll('.tab[data-roles]').forEach(tab => {
      const roles = tab.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        tab.style.display = 'flex';
      } else {
        tab.style.display = 'none';
      }
    });
    
    // Mostrar/ocultar botones flotantes seg√∫n permisos
    document.querySelectorAll('#stickyActions button[data-roles]').forEach(btn => {
      const roles = btn.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        btn.style.display = 'flex';
      } else {
        btn.style.display = 'none';
      }
    });
    
    // Redirigir a dashboard si la tab actual no est√° permitida
    const currentTab = document.querySelector('.tab.active');
    if (currentTab && currentTab.dataset.roles && !currentTab.dataset.roles.split(',').includes(currentUser.role)) {
      setTab('dashboard');
    }
  }
  
  function hasPermission(permission) {
    return currentUser && currentUser.permissions.includes(permission);
  }

  // ====== HELPERS ======
  const byId = id=> document.getElementById(id);
  const fmt = n=> new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC',maximumFractionDigits:0}).format(Number(n)||0);
  const vehById = id=> Vehiculos.find(v=> Number(v.id)===Number(id));
  const today = ()=> new Date().toISOString().slice(0,10);
  const diasRestantes = (iso)=> Math.ceil((new Date(iso) - new Date())/86400000);
  const semaforo = (d)=> d<=7? '<span class="pill dangerP">‚â§7d</span>' : (d<=30? '<span class="pill warnP">‚â§30d</span>' : '<span class="pill ok">OK</span>');

  function setTab(name){
    // Verificar permisos
    if (!hasPermission(name)) {
      alert('No tiene permisos para acceder a esta secci√≥n');
      return;
    }
    
    try{ localStorage.setItem('tab', name); }catch{}
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    const btn = document.querySelector(`.tab[data-tab="${name}"]`);
    if(btn) btn.classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(s=>s.classList.add('hidden'));
    const sec = byId('tab-'+name);
    if(sec) sec.classList.remove('hidden');
    render();
  }

  // ====== API CLIENT PARA FASTAPI ======
  async function apiGet(table){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}`;
    const r = await fetch(url, { 
      cache: 'no-store',
      headers: { 'Content-Type': 'application/json' }
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'GET error');
    return j.data;
  }
  
  async function apiPost(table, data, action=null){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}`;
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      cache: 'no-store'
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'POST error');
    return j;
  }
  
  async function apiPut(table, id, data){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}/${id}`;
    const r = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      cache: 'no-store'
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'PUT error');
    return j;
  }
  
  async function apiDelete(table, id){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}/${id}`;
    const r = await fetch(url, {
      method: 'DELETE',
      cache: 'no-store'
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'DELETE error');
    return j;
  }

  // ====== CARGA INICIAL ======
  async function loadAll(){
    try{
      // Cargar datos del nuevo backend
      Vehiculos = await apiGet('vehiculos');
      Mantenimientos = await apiGet('mantenimientos');
      Combustible = await apiGet('combustible');
      Revisiones = await apiGet('revisiones');
      Polizas = await apiGet('polizas');
      
      // Inicializar arrays vac√≠os para compatibilidad con el frontend
      RTV = [];
      Bitacora = [];
      Alertas = [];
      
      fillVehSelects();
      fillPlacaFilters();
      render();
    }catch(e){
      alert('Error cargando datos: '+e.message);
      console.error(e);
    }
  }

  // ====== RENDER ======
  function render(){ 
    renderKpis(); 
    renderAlertas(); 
    renderVehiculos(); 
    renderPolizas(); 
    renderRtv(); 
    renderMant(); 
    renderFuel(); 
    renderRevisiones(); 
    refreshHints(); 
  }

  function renderKpis(){
    byId('kpiVeh').textContent = Vehiculos.filter(v=>v.estado==='activo').length;
    
    const p30 = Polizas.filter(p=> diasRestantes(p.vencimiento_poliza)<=30 && diasRestantes(p.vencimiento_poliza)>=0).length;
    const p7 = Polizas.filter(p=> diasRestantes(p.vencimiento_poliza)<=7 && diasRestantes(p.vencimiento_poliza)>=0).length;
    const r30 = RTV.filter(r=> diasRestantes(r.vencimiento_rtv)<=30 && diasRestantes(r.vencimiento_rtv)>=0).length;
    
    byId('kpiPol30').textContent=p30; 
    byId('kpiPol7').textContent=p7; 
    byId('kpiRtv30').textContent=r30;
    
    const month=new Date(); month.setDate(1);
    const gastoMes = Combustible.filter(f=> new Date(f.fecha)>=month)
      .reduce((a,f)=> a + Number(f.litros)*Number(f.precio_por_litro), 0);
    byId('kpiFuelMes').textContent = fmt(gastoMes);
    
    const mantMes = Mantenimientos.filter(m=> {
      const d=new Date(m.fecha); const n=new Date();
      return d.getMonth()===n.getMonth() && d.getFullYear()===n.getFullYear();
    }).length;
    byId('kpiMantMes').textContent = mantMes;
    
    // Nuevos KPIs
    // KM/L promedio
    const combustibleReciente = Combustible.filter(f=> new Date(f.fecha)>=month);
    let totalKmL = 0, countKmL = 0;
    combustibleReciente.forEach(f => {
      const prev = Combustible
        .filter(x=> Number(x.vehiculo_id)===Number(f.vehiculo_id) && new Date(x.fecha) < new Date(f.fecha))
        .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
      if (prev) {
        const dist = Number(f.odometro_km) - Number(prev.odometro_km);
        if (dist > 0) {
          const kmL = dist / Number(f.litros);
          totalKmL += kmL;
          countKmL++;
        }
      }
    });
    const avgKmL = countKmL > 0 ? (totalKmL / countKmL).toFixed(1) : '0';
    byId('kpiKmL').textContent = avgKmL;
    
    // Costo promedio mantenimiento
    const mantRecientes = Mantenimientos.filter(m=> new Date(m.fecha)>=month);
    const costoPromMant = mantRecientes.length > 0 ? 
      mantRecientes.reduce((a,m)=> a + Number(m.costo||0), 0) / mantRecientes.length : 0;
    byId('kpiCostoMant').textContent = fmt(costoPromMant);
  }
  function renderAlertas(){
    const q=byId('fltAlertPlaca').value?.trim().toUpperCase();
    const rows = (Alertas||[])
      .filter(a=> !q || (vehById(a.vehiculo_id)?.placa||'').includes(q))
      .map(a=>`<tr><td>${a.tipo}</td><td>${vehById(a.vehiculo_id)?.placa||''}</td><td>${a.dias_restantes||''} ${a.km_restantes? ((a.dias_restantes?' / ':'')+a.km_restantes+' km'):''}</td><td><span class="pill ${a.estado==='pendiente'?'warnP':'ok'}">${a.estado}</span></td></tr>`)
      .join('');
    byId('tblAlertas').innerHTML = rows || '<tr><td colspan="4">Sin alertas</td></tr>';
  }
  function renderVehiculos(){
    const q=byId('fltVehPlaca').value||''; 
    const est=byId('fltVehEstado').value;
    const dueno=byId('fltVehDueno')?.value?.toLowerCase()||'';
    
    const rows = Vehiculos
      .filter(v=> {
        const matchPlaca = !q || (v.placa||'').includes(q);
        const matchEstado = !est || v.estado===est;
        const matchDueno = !dueno || (v.dueno||'').toLowerCase().includes(dueno);
        return matchPlaca && matchEstado && matchDueno;
      })
      .map(v=>{
        const estadoColor = v.estado === 'activo' ? 'ok' : (v.estado === 'mantenimiento' ? 'warnP' : 'dangerP');
        
        // Manejar campos que pueden no existir en datos antiguos
        const duenoValue = v.dueno || 'Hotel';
        const aseguradoraValue = v.aseguradora || '-';
        
        return `<tr>
          <td><strong>${v.placa}</strong></td>
          <td>${v.marca} ${v.modelo}</td>
          <td>${v.anio}</td>
          <td>${v.tipo}</td>
          <td>üë§ ${duenoValue}</td>
          <td>${aseguradoraValue}</td>
          <td><span class="pill ${estadoColor}">${v.estado}</span></td>
          <td>
            <button class="action-btn edit-btn" onclick="editarVehiculo('${v.id}')" title="Editar">‚úèÔ∏è</button>
            <button class="action-btn export-btn" onclick="exportFichaExcel('${v.placa}')" title="Exportar">üìä</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarVehiculo('${v.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    byId('tblVeh').innerHTML = rows || '<tr><td colspan="8">Sin veh√≠culos</td></tr>';
  }
  function renderPolizas(){
    const mode=byId('fltPolVencer').value;
    const rows = Polizas.map(p=>{
      const d=diasRestantes(p.vencimiento_poliza);
      if(mode==='30' && d>30) return '';
      if(mode==='7' && d>7) return '';
      return `<tr><td>${vehById(p.vehiculo_id)?.placa||''}</td><td>${p.aseguradora}</td><td>${p.numero_poliza}</td><td>${p.vencimiento_poliza}</td><td>${semaforo(d)}</td></tr>`;
    }).join('');
    byId('tblPol').innerHTML = rows || '<tr><td colspan="5">Sin datos</td></tr>';
  }
  function renderRtv(){
    const mode=byId('fltRtvVencer').value;
    const rows = RTV.map(r=>{
      const d=diasRestantes(r.vencimiento_rtv);
      if(mode==='30' && d>30) return '';
      if(mode==='7' && d>7) return '';
      return `<tr><td>${vehById(r.vehiculo_id)?.placa||''}</td><td>${r.numero_cita||'-'}</td><td>${r.vencimiento_rtv}</td><td>${semaforo(d)}</td></tr>`;
    }).join('');
    byId('tblRtv').innerHTML = rows || '<tr><td colspan="4">Sin datos</td></tr>';
  }
  function renderMant(){
    const q=byId('fltMantPlaca').value||''; const t=byId('fltMantTipo').value;
    const filtered = Mantenimientos
      .filter(m=> (!t || m.tipo===t) && (!q || (vehById(m.vehiculo_id)?.placa||'')===q))
      .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      
    const rows = filtered
      .map(m=>{
        const tipoIcon = {
          'cambio_aceite': 'üõ¢Ô∏è',
          'llantas': 'üõû',
          'frenos': 'üõë',
          'bateria': 'üîã',
          'alineacion': '‚öñÔ∏è',
          'transmision': '‚öôÔ∏è',
          'motor': 'üèéÔ∏è',
          'suspension': 'üî©',
          'aire_acondicionado': '‚ùÑÔ∏è'
        }[m.tipo] || 'üìù';
        
        return `<tr>
          <td><strong>${vehById(m.vehiculo_id)?.placa||''}</strong></td>
          <td>${m.fecha}</td>
          <td>${tipoIcon} ${m.tipo.replace('_', ' ')}</td>
          <td><strong>${fmt(m.costo)}</strong></td>
          <td>${m.km_actual??''}</td>
          <td>${m.proximo_km??''}</td>
          <td>${m.observaciones||''}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editarMantenimiento('${m.id}')" title="Editar">‚úèÔ∏è</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarMantenimiento('${m.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    byId('tblMant').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
    
    const total = filtered.reduce((a,b)=>a+(Number(b.costo)||0),0);
    const count = filtered.length;
    byId('sumMant').textContent = `${count} registros - Total: ${fmt(total)}`;
  }
  function renderFuel(){
    const q=byId('fltFuelPlaca').value||'';
    const meses=byId('fltFuelMes')?.value;
    
    let rec = Combustible.filter(f=> (!q || (vehById(f.vehiculo_id)?.placa||'')===q));
    
    if (meses) {
      const fechaLimite = new Date();
      fechaLimite.setMonth(fechaLimite.getMonth() - parseInt(meses));
      rec = rec.filter(f=> new Date(f.fecha) >= fechaLimite);
    }
    
    rec = rec.sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
    
    const rows = rec.map(f=>{
      const prev = Combustible
        .filter(x=> Number(x.vehiculo_id)===Number(f.vehiculo_id) && new Date(x.fecha) < new Date(f.fecha))
        .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
      const dist = prev? (Number(f.odometro_km)-Number(prev.odometro_km)): null;
      const kmL = (dist && dist>0)? (dist/Number(f.litros)): null;
      const costo = Number(f.litros)*Number(f.precio_por_litro);
      
      return `<tr>
        <td><strong>${vehById(f.vehiculo_id)?.placa||''}</strong></td>
        <td>${f.fecha}</td>
        <td>${f.litros}L</td>
        <td>${fmt(f.precio_por_litro)}</td>
        <td><strong>${fmt(costo)}</strong></td>
        <td>${f.odometro_km} km</td>
        <td>${kmL ? '<span class="pill ' + (kmL > 10 ? 'ok' : kmL > 7 ? 'warnP' : 'dangerP') + '">' + kmL.toFixed(1) + '</span>' : '-'}</td>
        <td>
          <button class="action-btn edit-btn" onclick="editarCombustible('${f.id}')" title="Editar">‚úèÔ∏è</button>
          ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarCombustible('${f.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
        </td>
      </tr>`;
    }).join('');
    byId('tblFuel').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
    
    // Estad√≠sticas
    const totalCosto = rec.reduce((a,f)=> a + (Number(f.litros)*Number(f.precio_por_litro)), 0);
    const totalLitros = rec.reduce((a,f)=> a + Number(f.litros), 0);
    const kmLPromedio = rec.map(f=>{
      const prev = Combustible
        .filter(x=> Number(x.vehiculo_id)===Number(f.vehiculo_id) && new Date(x.fecha) < new Date(f.fecha))
        .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
      if (!prev) return null;
      const dist = Number(f.odometro_km) - Number(prev.odometro_km);
      return dist > 0 ? dist / Number(f.litros) : null;
    }).filter(x => x !== null);
    
    const avgKmL = kmLPromedio.length > 0 ? (kmLPromedio.reduce((a,b)=>a+b,0) / kmLPromedio.length).toFixed(1) : '0';
    
    if (byId('sumFuel')) byId('sumFuel').textContent = `${rec.length} cargas - ${totalLitros.toFixed(1)}L - ${fmt(totalCosto)}`;
    if (byId('avgKmL')) byId('avgKmL').textContent = `Promedio: ${avgKmL} km/L`;
  }
  function fmtDT(v){
    if(v===undefined || v===null) return '';
    const d = new Date(v);
    if(!isNaN(d)) return d.toISOString().slice(0,16).replace('T',' ');
    const s = String(v);
    return s.indexOf('T')>-1 ? s.replace('T',' ').slice(0,16) : s;
  }
  function renderBit(){
    const q=byId('fltBitPlaca').value||'';
    const rows = Bitacora
      .filter(b=> (!q || (vehById(b.vehiculo_id)?.placa||'')===q))
      .sort((a,b)=> new Date(b.fecha_hora) - new Date(a.fecha_hora))
      .map(b=>`<tr><td>${vehById(b.vehiculo_id)?.placa||''}</td><td>${b.accion}</td><td>${b.conductor||''}</td><td>${fmtDT(b.fecha_hora)}</td><td>${b.km}</td><td>${b.nivel_combustible}</td><td>${['F:',b.chequeo_frenos?'‚úî':'‚úñ',' D:',b.chequeo_direccion?'‚úî':'‚úñ',' L:',b.chequeo_luces?'‚úî':'‚úñ'].join('')}</td><td>${b.observaciones||''}</td></tr>`)
      .join('');
    byId('tblBit').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
  }
  
  function renderRevisiones(){
    const q=byId('fltRevPlaca')?.value||'';
    const t=byId('fltRevTipo')?.value||'';
    
    const rows = (Revisiones||[])
      .filter(r=> (!q || (vehById(r.vehiculo_id)?.placa||'')===q) && (!t || r.tipo===t))
      .sort((a,b)=> new Date(b.fecha_hora) - new Date(a.fecha_hora))
      .map(r=>{
        const tipoIcon = {
          'rutinaria': 'üîÑ',
          'preventiva': 'üõ°Ô∏è',
          'post_mantenimiento': 'üîß',
          'pre_viaje': '‚úàÔ∏è',
          'incidente': '‚ö†Ô∏è'
        }[r.tipo] || 'üîç';
        
        // Calcular estado general basado en las revisiones
        let estadoGeneral = 'excelente';
        const checks = [
          r.aceite_motor, r.liquido_frenos, r.coolant, r.estado_llantas,
          r.sistema_frenos, r.bateria, r.estado_carroceria, r.estado_interior
        ];
        if (checks.some(c => c === 'cambiar' || c === 'urgente' || c === 'da√±os_mayores')) {
          estadoGeneral = 'urgente';
        } else if (checks.some(c => c === 'bajo' || c === 'regular' || c === 'revisar')) {
          estadoGeneral = 'regular';
        } else if (checks.some(c => c === 'bueno')) {
          estadoGeneral = 'bueno';
        }
        
        const estadoColor = estadoGeneral === 'urgente' ? 'dangerP' : 
                           estadoGeneral === 'regular' ? 'warnP' : 'ok';
        
        return `<tr>
          <td><strong>${vehById(r.vehiculo_id)?.placa||''}</strong></td>
          <td>${tipoIcon} ${r.tipo.replace('_', ' ')}</td>
          <td>${r.inspector}</td>
          <td>${fmtDT(r.fecha_hora)}</td>
          <td>${r.km} km</td>
          <td><span class="pill ${estadoColor}">${estadoGeneral}</span></td>
          <td>
            <button class="action-btn" onclick="verDetalleRevision('${r.id}')" title="Ver detalle">üëÅÔ∏è</button>
            <button class="action-btn edit-btn" onclick="editarRevision('${r.id}')" title="Editar">‚úèÔ∏è</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarRevision('${r.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    
    if (byId('tblRevisiones')) {
      byId('tblRevisiones').innerHTML = rows || '<tr><td colspan="7">Sin registros</td></tr>';
    }
  }
  function fillVehSelects(){
    const opts = '<option value="">Seleccione un veh√≠culo...</option>' + 
                 Vehiculos.map(v=>`<option value="${v.id}">${v.placa} - ${v.marca} ${v.modelo}</option>`).join('');
    ['mVeh','cVeh','bVeh','pVeh','rVeh','fichaVehiculo','editMVeh','editCVeh'].forEach(id=> { 
      const el = byId(id); 
      if(el) {
        const currentValue = el.value;
        el.innerHTML = opts;
        if (currentValue) el.value = currentValue;
      }
    });
  }
  function fillPlacaFilters(){
    const placas = Array.from(new Set(Vehiculos.map(v=>v.placa))).sort();
    const ids=['fltVehPlaca','fltMantPlaca','fltFuelPlaca','fltBitPlaca','fltRevPlaca','repPlaca'];
    ids.forEach(id=>{ 
      const el=byId(id); 
      if(!el) return; 
      const cur = el.value; 
      const baseText = id.includes('rep') ? 'Todos los veh√≠culos' : 'Todas las placas';
      el.innerHTML = `<option value="">üìã ${baseText}</option>` + placas.map(p=>`<option value="${p}">${p}</option>`).join(''); 
      if(placas.includes(cur)) el.value=cur; 
    });
  }

  // ====== FORM HANDLERS ======
  async function guardarVehiculo(e){
    e.preventDefault();
    if(!hasPermission('vehiculos')) return alert('Sin permisos para crear veh√≠culos');
    
    try{
      const ano=Number(byId('vAnio').value); 
      const year=new Date().getFullYear();
      if(ano<1990||ano>year+1) return alert('A√±o fuera de rango');
      
      // Objeto para FastAPI backend
      const obj = { 
        placa: (byId('vPlaca').value||'').trim().toUpperCase(), 
        marca: byId('vMarca').value||'', 
        modelo: byId('vModelo').value||'', 
        ano: ano,
        color: byId('vColor').value||'',
        propietario: byId('vDueno').value||'hotel',
        poliza: byId('vPoliza').value||'',
        seguro: byId('vAseguradora').value||''
      };
      
      await apiPost('vehiculos', obj);
      Vehiculos = await apiGet('vehiculos');
      fillVehSelects(); 
      fillPlacaFilters(); 
      renderVehiculos(); 
      renderKpis();
      limpiarFormVehiculo();
      alert('‚úÖ Veh√≠culo creado exitosamente');
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  
  function limpiarFormVehiculo() {
    ['vPlaca', 'vMarca', 'vModelo', 'vAnio', 'vDueno', 'vPoliza', 'vAseguradora', 'vColor'].forEach(id => {
      const el = byId(id);
      if (el) el.value = '';
    });
    const tipoEl = byId('vTipo');
    const estadoEl = byId('vEstado');
    if (tipoEl) tipoEl.selectedIndex = 0;
    if (estadoEl) estadoEl.selectedIndex = 0;
  }
  async function guardarPoliza(e){
    if(e&&e.preventDefault) e.preventDefault();
    const rol=byId('rol').value; if(rol!=='admin') return alert('Solo admin puede crear p√≥lizas');
    try{
      const obj={ vehiculo_id:Number(byId('pVeh').value), aseguradora:byId('pAseg').value||'', numero_poliza:byId('pNum').value||'', vencimiento_poliza:byId('pVence').value||'' };
      if(!obj.vencimiento_poliza) return alert('Vencimiento requerido');
      await apiPost('Polizas', obj);
      Polizas = await apiGet('Polizas');
      renderPolizas(); renderKpis();
      alert('P√≥liza guardada');
    }catch(e2){ alert('Error: '+e2.message); }
  }
  async function guardarRTV(e){
    if(e&&e.preventDefault) e.preventDefault();
    const rol=byId('rol').value; if(rol!=='admin') return alert('Solo admin puede crear RTV');
    try{
      const obj={ vehiculo_id:Number(byId('rVeh').value), numero_cita:byId('rCita').value||'', vencimiento_rtv:byId('rVence').value||'' };
      if(!obj.vencimiento_rtv) return alert('Vencimiento RTV requerido');
      await apiPost('RTV', obj);
      RTV = await apiGet('RTV');
      renderRtv(); renderKpis();
      alert('RTV guardada');
    }catch(e2){ alert('Error: '+e2.message); }
  }
  async function guardarMantenimiento(e){
    e.preventDefault();
    if(!hasPermission('mantenimientos')) return alert('Sin permisos para crear mantenimientos');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('mVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    const obj = { 
      fecha: byId('mFecha').value, 
      placa: placa,
      tipo: byId('mTipo').value,
      descripcion: byId('mObs').value || byId('mTipo').value,
      costo: Number(byId('mCosto').value||0), 
      kilometraje: byId('mKm').value? Number(byId('mKm').value): null
    };
    
    try{ 
      await apiPost('mantenimientos', obj); 
      Mantenimientos = await apiGet('mantenimientos'); 
      renderMant(); 
      renderKpis(); 
      refreshHints(); 
      alert('‚úÖ Mantenimiento guardado exitosamente'); 
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  
  async function guardarCombustible(e){
    e.preventDefault();
    if(!hasPermission('combustible')) return alert('Sin permisos para registrar combustible');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('cVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    const obj = { 
      fecha: byId('cFecha').value, 
      placa: placa,
      litros: Number(byId('cLitros').value), 
      costo: Number(byId('cPPL').value) * Number(byId('cLitros').value), 
      kilometraje: Number(byId('cOdo').value), 
      estacion: byId('cProv').value||'' 
    };
    
    try{ 
      await apiPost('combustible', obj); 
      Combustible = await apiGet('combustible'); 
      renderFuel(); 
      renderKpis(); 
      refreshHints(); 
      alert('‚úÖ Carga de combustible guardada exitosamente'); 
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  function resetBitacoraForm(){
    byId('bVeh').selectedIndex = 0;
    byId('bAccion').value = 'retiro';
    byId('bCond').value = '';
    byId('bFecha').value = '';
    byId('bKm').value = '';
    byId('bNivel').value = 'lleno';
    byId('bFrenos').checked = false;
    byId('bDir').checked = false;
    byId('bLuces').checked = false;
    byId('bGolpes').value = 'false';
    byId('bObs').value = '';
  }
  
  async function guardarRevision(e){
    e.preventDefault();
    if(!hasPermission('revision')) return alert('Sin permisos para crear revisiones');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('rVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    // Evaluar estados generales
    const estadoMotor = evaluarEstadoGeneral(['rAceiteMotor', 'rCoolant', 'rBateria']);
    const estadoFrenas = evaluarEstadoGeneral(['rLiquidoFrenos', 'rSistemaFrenos']);
    const estadoLuces = evaluarEstadoLuces();
    const estadoLlantas = byId('rEstadoLlantas').value || 'bueno';
    const estadoCarroceria = byId('rEstadoCarroceria').value || 'bueno';
    
    // Determinar aprobaci√≥n general
    const aprobado = [estadoMotor, estadoFrenas, estadoLuces, estadoLlantas, estadoCarroceria].every(estado => estado !== 'malo');
    
    const obj = {
      fecha: byId('rFecha').value,
      placa: placa,
      inspector: byId('rInspector').value || 'Inspector',
      estado_motor: estadoMotor,
      estado_frenos: estadoFrenas,
      estado_luces: estadoLuces,
      estado_llantas: estadoLlantas,
      estado_carroceria: estadoCarroceria,
      observaciones: byId('rObservaciones').value || '',
      aprobado: aprobado
    };
    
    try {
      await apiPost('revisiones', obj);
      Revisiones = await apiGet('revisiones');
      renderRevisiones();
      limpiarFormRevision();
      alert('‚úÖ Revisi√≥n guardada exitosamente');
    } catch(e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  // Funci√≥n auxiliar para evaluar estado general
  function evaluarEstadoGeneral(fieldIds) {
    const estados = fieldIds.map(id => byId(id)?.value || 'bueno');
    if (estados.some(e => e === 'malo')) return 'malo';
    if (estados.some(e => e === 'regular')) return 'regular';
    return 'bueno';
  }
  
  // Funci√≥n auxiliar para evaluar estado de luces
  function evaluarEstadoLuces() {
    const luces = ['rLucesDelanteras', 'rLucesTraseras', 'rLucesDireccionales', 'rLucesFreno'];
    const funcionan = luces.map(id => byId(id)?.checked || false);
    const porcentajeFuncionando = funcionan.filter(Boolean).length / funcionan.length;
    
    if (porcentajeFuncionando >= 0.8) return 'bueno';
    if (porcentajeFuncionando >= 0.5) return 'regular';
    return 'malo';
  }
  
  function limpiarFormRevision() {
    // Resetear campos de texto
    ['rInspector', 'rFecha', 'rKm', 'rObservaciones'].forEach(id => {
      const el = byId(id);
      if (el) el.value = '';
    });
    
    // Resetear selects
    ['rVeh', 'rTipo', 'rNivelComb', 'rAceiteMotor', 'rLiquidoFrenos', 'rCoolant', 
     'rLimpiaparabrisas', 'rAceiteTransmision', 'rLiquidoDireccion', 'rEstadoLlantas',
     'rPresionLlantas', 'rSistemaFrenos', 'rBateria', 'rEstadoCarroceria', 'rEstadoInterior'].forEach(id => {
      const el = byId(id);
      if (el) el.selectedIndex = 0;
    });
    
    // Desmarcar checkboxes
    ['rLucesDelanteras', 'rLucesTraseras', 'rLucesDireccionales', 'rLucesFreno', 
     'rLucesReversa', 'rEspejosLaterales', 'rEspejoRetrovisor', 'rLimpiaparabrisas', 
     'rCinturones', 'rBocina'].forEach(id => {
      const el = byId(id);
      if (el) el.checked = false;
    });
  }
  async function guardarBitacora(e){
    e.preventDefault();
    const rol=byId('rol').value; if(!['admin','recepcion'].includes(rol)) return alert('Sin permiso');
    const obj = { vehiculo_id:Number(byId('bVeh').value), accion:byId('bAccion').value, conductor:byId('bCond').value||'', fecha_hora:byId('bFecha').value||new Date().toISOString().slice(0,16), km:Number(byId('bKm').value), nivel_combustible:byId('bNivel').value, golpes_carroceria:(byId('bGolpes').value==='true'), chequeo_frenos:byId('bFrenos').checked, chequeo_direccion:byId('bDir').checked, chequeo_luces:byId('bLuces').checked, observaciones:byId('bObs').value||'' };
    if(obj.accion==='retiro' && !obj.conductor) return alert('Conductor obligatorio en retiro');
    if(obj.accion==='entrega' && obj.golpes_carroceria && !obj.observaciones) return alert('Si hay golpes, agregue observaciones');
    try {
      await apiPost('Bitacora', obj);
      Bitacora = await apiGet('Bitacora');
      Alertas  = await apiGet('Alertas');
      const placaSel = vehById(obj.vehiculo_id)?.placa || '';
      const flt = byId('fltBitPlaca'); if (flt && placaSel) flt.value = placaSel;
      setTab('bitacora');
      renderBit();
      renderAlertas();
      const tbody = byId('tblBit');
      if (tbody && tbody.firstElementChild){
        const firstRow = tbody.firstElementChild;
        try { firstRow.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
        const flashClass = (obj.accion === 'retiro') ? 'flash-ret' : 'flash-ent';
        firstRow.classList.add('flash', flashClass);
        setTimeout(() => firstRow.classList.remove('flash', 'flash-ret', 'flash-ent'), 3000);
        const firstCell = firstRow.cells && firstRow.cells[0];
        if (firstCell){
          const badge = document.createElement('span');
          badge.textContent = 'üÜï';
          badge.className = 'newtag';
          badge.title = (obj.accion === 'retiro') ? 'Nuevo retiro' : 'Nueva entrega';
          firstCell.prepend(badge);
          setTimeout(() => { try{ badge.remove(); }catch{} }, 60000);
        }
        const dateCell = firstRow.cells && firstRow.cells[3];
        if (dateCell){
          const original = dateCell.textContent || (typeof fmtDT==='function' ? fmtDT(obj.fecha_hora) : String(obj.fecha_hora||''));
          dateCell.dataset.old = original;
          dateCell.textContent = 'justo ahora';
          setTimeout(() => { dateCell.textContent = dateCell.dataset.old || original; }, 60000);
        }
      }
      resetBitacoraForm();
      refreshHints();
      alert('Bit√°cora guardada');
    } catch (err) {
      console.error('Error guardando Bit√°cora', err);
      alert('Error guardando Bit√°cora: ' + (err?.message || err));
    }
  }

  // ====== UTILIDADES ======
  function getLastBitKm(vid){
    const rec = (Bitacora||[]).filter(b=> Number(b.vehiculo_id)===Number(vid)).sort((a,b)=> new Date(b.fecha_hora)-new Date(a.fecha_hora))[0];
    return rec? (Number(rec.km)||'') : '';
  }
  function getLastFuelOdo(vid){
    const rec = (Combustible||[]).filter(c=> Number(c.vehiculo_id)===Number(vid)).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
    return rec? (Number(rec.odometro_km)||'') : '';
  }
  function getLastOilKm(vid){
    const rec = (Mantenimientos||[]).filter(m=> Number(m.vehiculo_id)===Number(vid) && m.tipo==='cambio_aceite').sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
    return rec? (Number(rec.km_actual)||'') : '';
  }
  function refreshHints(){
    const bSel = byId('bVeh'); if(bSel && bSel.value){ const v = getLastBitKm(bSel.value); const el=byId('bKmPrev'); if(el) el.value = v; }
    const cSel = byId('cVeh'); if(cSel && cSel.value){ const v = getLastFuelOdo(cSel.value); const el=byId('cOdoPrev'); if(el) el.value = v; }
    const mSel = byId('mVeh'); if(mSel && mSel.value){ const v = getLastOilKm(mSel.value); const el=byId('mKmPrevAceite'); if(el) el.value = v; }
    calcKmLEstimado();
  }
  function calcCosto(){ const L=Number(byId('cLitros').value||0); const P=Number(byId('cPPL').value||0); byId('cCosto').value = (L*P)||0; }
  function calcKmLEstimado(){
    const prev = Number(byId('cOdoPrev')?.value||0);
    const odo = Number(byId('cOdo')?.value||0);
    const litros = Number(byId('cLitros')?.value||0);
    const dist = odo - prev;
    const val = (litros>0 && dist>0)? (dist/litros).toFixed(2): '';
    if(byId('cKmLEst')) byId('cKmLEst').value = val;
  }
  function buscarPlaca(){ const v=byId('qPlaca').value.trim().toUpperCase(); if(!v) return; const sel = byId('fltVehPlaca'); if(sel){ sel.value=v; } setTab('vehiculos'); renderVehiculos(); }
  function exportarVehiculo(){ const placa = byId('fltVehPlaca').value; if(!placa) return alert('Seleccione una placa en el filtro'); exportFichaExcel(placa); }
  function autoProximoKm(){ const tipo = byId('mTipo').value; if(tipo !== 'cambio_aceite') { alert('Aplica solo a "Cambio de aceite"'); return; } const km = parseInt(byId('mKm').value||'0',10); if(!km || Number.isNaN(km) || km<0){ alert('Ingrese km actual v√°lido'); return; } byId('mProx').value = km + 5000; }
  
  // ====== FUNCIONES DE EDICI√ìN ======
  
  function editarVehiculo(id) {
    console.log('Editando veh√≠culo ID:', id);
    
    if (!hasPermission('vehiculos')) {
      alert('Sin permisos para editar veh√≠culos');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == id);
    console.log('Veh√≠culo encontrado:', vehiculo);
    
    if (!vehiculo) {
      alert('Veh√≠culo no encontrado');
      return;
    }
    
    // Llenar el modal de edici√≥n
    byId('editVehId').value = vehiculo.id;
    byId('editVPlaca').value = vehiculo.placa || '';
    byId('editVMarca').value = vehiculo.marca || '';
    byId('editVModelo').value = vehiculo.modelo || '';
    byId('editVAnio').value = vehiculo.anio || '';
    byId('editVTipo').value = vehiculo.tipo || 'otro';
    byId('editVEstado').value = vehiculo.estado || 'activo';
    byId('editVDueno').value = vehiculo.dueno || '';
    byId('editVPoliza').value = vehiculo.numero_poliza || '';
    byId('editVAseguradora').value = vehiculo.aseguradora || '';
    byId('editVColor').value = vehiculo.color || '';
    
    // Mostrar modal
    const modal = byId('modalEditVehiculo');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarVehiculo(e) {
    e.preventDefault();
    
    const id = byId('editVehId').value;
    const obj = {
      id: parseInt(id),
      placa: byId('editVPlaca').value.trim().toUpperCase(),
      marca: byId('editVMarca').value,
      modelo: byId('editVModelo').value,
      anio: parseInt(byId('editVAnio').value),
      tipo: byId('editVTipo').value,
      estado: byId('editVEstado').value,
      dueno: byId('editVDueno').value,
      numero_poliza: byId('editVPoliza').value,
      aseguradora: byId('editVAseguradora').value,
      color: byId('editVColor').value
    };
    
    try {
      await apiPost('Vehiculos', obj, 'update');
      Vehiculos = await apiGet('Vehiculos');
      fillVehSelects();
      fillPlacaFilters();
      renderVehiculos();
      cerrarModal('modalEditVehiculo');
      alert('‚úÖ Veh√≠culo actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  function editarMantenimiento(id) {
    console.log('Editando mantenimiento ID:', id);
    
    if (!hasPermission('mantenimientos')) {
      alert('Sin permisos para editar mantenimientos');
      return;
    }
    
    const mant = Mantenimientos.find(m => m.id == id);
    console.log('Mantenimiento encontrado:', mant);
    
    if (!mant) {
      alert('Mantenimiento no encontrado');
      return;
    }
    
    fillVehSelects(); // Asegurar que los selects est√©n llenos
    
    byId('editMantId').value = mant.id;
    byId('editMVeh').value = mant.vehiculo_id;
    byId('editMTipo').value = mant.tipo;
    byId('editMFecha').value = mant.fecha;
    byId('editMCosto').value = mant.costo;
    byId('editMKm').value = mant.km_actual || '';
    byId('editMProx').value = mant.proximo_km || '';
    byId('editMObs').value = mant.observaciones || '';
    
    const modal = byId('modalEditMantenimiento');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarMantenimiento(e) {
    e.preventDefault();
    
    const id = byId('editMantId').value;
    const obj = {
      id: parseInt(id),
      vehiculo_id: parseInt(byId('editMVeh').value),
      tipo: byId('editMTipo').value,
      fecha: byId('editMFecha').value,
      costo: parseFloat(byId('editMCosto').value),
      km_actual: byId('editMKm').value ? parseInt(byId('editMKm').value) : null,
      proximo_km: byId('editMProx').value ? parseInt(byId('editMProx').value) : null,
      observaciones: byId('editMObs').value
    };
    
    try {
      await apiPost('Mantenimientos', obj, 'update');
      Mantenimientos = await apiGet('Mantenimientos');
      renderMant();
      renderKpis();
      cerrarModal('modalEditMantenimiento');
      alert('‚úÖ Mantenimiento actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  function editarCombustible(id) {
    console.log('Editando combustible ID:', id);
    
    if (!hasPermission('combustible')) {
      alert('Sin permisos para editar registros de combustible');
      return;
    }
    
    const fuel = Combustible.find(f => f.id == id);
    console.log('Combustible encontrado:', fuel);
    
    if (!fuel) {
      alert('Registro de combustible no encontrado');
      return;
    }
    
    fillVehSelects();
    
    byId('editFuelId').value = fuel.id;
    byId('editCVeh').value = fuel.vehiculo_id;
    byId('editCFecha').value = fuel.fecha;
    byId('editCLitros').value = fuel.litros;
    byId('editCPPL').value = fuel.precio_por_litro;
    byId('editCOdo').value = fuel.odometro_km;
    byId('editCProv').value = fuel.proveedor || '';
    
    const modal = byId('modalEditCombustible');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarCombustible(e) {
    e.preventDefault();
    
    const id = byId('editFuelId').value;
    const obj = {
      id: parseInt(id),
      vehiculo_id: parseInt(byId('editCVeh').value),
      fecha: byId('editCFecha').value,
      litros: parseFloat(byId('editCLitros').value),
      precio_por_litro: parseFloat(byId('editCPPL').value),
      odometro_km: parseInt(byId('editCOdo').value),
      proveedor: byId('editCProv').value
    };
    
    try {
      await apiPost('Combustible', obj, 'update');
      Combustible = await apiGet('Combustible');
      renderFuel();
      renderKpis();
      cerrarModal('modalEditCombustible');
      alert('‚úÖ Registro de combustible actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  function cerrarModal(modalId) {
    const modal = byId(modalId);
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  // Funci√≥n para cerrar todos los modales
  function cerrarTodosLosModales() {
    const modales = ['modalEditVehiculo', 'modalEditMantenimiento', 'modalEditCombustible', 'reportePreview'];
    modales.forEach(modalId => {
      const modal = byId(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }
    });
    
    // Tambi√©n cerrar cualquier elemento con clase 'modal'
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    });
  }
  
  // Funci√≥n para inicializar la aplicaci√≥n correctamente
  function inicializarApp() {
    // Asegurarse de que todos los modales est√©n cerrados
    cerrarTodosLosModales();
    
    // Resetear cualquier estado de la interfaz
    const loginScreen = byId('loginScreen');
    const mainApp = byId('mainApp');
    
    if (loginScreen) loginScreen.style.display = 'flex';
    if (mainApp) mainApp.classList.remove('logged-in');
    
    // Limpiar formularios si existen
    try {
      limpiarFormVehiculo();
    } catch(e) {}
    
    // Asegurar que el dashboard sea la pesta√±a por defecto
    setTimeout(() => {
      setTab('dashboard');
    }, 100);
  }
  
  // Funciones de eliminaci√≥n (solo para admin)
  async function eliminarVehiculo(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar veh√≠culos');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == id);
    if (!vehiculo) return;
    
    if (confirm(`¬øEst√° seguro de eliminar el veh√≠culo ${vehiculo.placa}?`)) {
      try {
        await apiPost('Vehiculos', {id: parseInt(id)}, 'delete');
        Vehiculos = await apiGet('Vehiculos');
        fillVehSelects();
        fillPlacaFilters();
        renderVehiculos();
        alert('‚úÖ Veh√≠culo eliminado exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }
  
  async function eliminarMantenimiento(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¬øEst√° seguro de eliminar este registro de mantenimiento?')) {
      try {
        await apiPost('Mantenimientos', {id: parseInt(id)}, 'delete');
        Mantenimientos = await apiGet('Mantenimientos');
        renderMant();
        renderKpis();
        alert('‚úÖ Registro eliminado exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }
  
  async function eliminarCombustible(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¬øEst√° seguro de eliminar este registro de combustible?')) {
      try {
        await apiPost('Combustible', {id: parseInt(id)}, 'delete');
        Combustible = await apiGet('Combustible');
        renderFuel();
        renderKpis();
        alert('‚úÖ Registro eliminado exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }

  // ====== FICHA T√âCNICA ======
  
  function cargarFichaTecnica() {
    const vehiculoId = byId('fichaVehiculo').value;
    const periodo = byId('fichaPeriodo').value;
    
    if (!vehiculoId) {
      byId('fichaTecnicaContent').classList.add('hidden');
      return;
    }
    
    const vehiculo = vehById(vehiculoId);
    if (!vehiculo) return;
    
    // Calcular fecha l√≠mite seg√∫n el per√≠odo
    let fechaLimite = new Date('2000-01-01');
    if (periodo !== 'all') {
      fechaLimite = new Date();
      fechaLimite.setMonth(fechaLimite.getMonth() - parseInt(periodo));
    }
    
    // Filtrar datos por veh√≠culo y per√≠odo
    const mantVehiculo = Mantenimientos.filter(m => 
      Number(m.vehiculo_id) === Number(vehiculoId) && 
      new Date(m.fecha) >= fechaLimite
    );
    
    const fuelVehiculo = Combustible.filter(f => 
      Number(f.vehiculo_id) === Number(vehiculoId) && 
      new Date(f.fecha) >= fechaLimite
    );
    
    const revVehiculo = (Revisiones || []).filter(r => 
      Number(r.vehiculo_id) === Number(vehiculoId) && 
      new Date(r.fecha_hora) >= fechaLimite
    );
    
    // Informaci√≥n b√°sica
    const poliza = Polizas.find(p => Number(p.vehiculo_id) === Number(vehiculoId));
    const rtv = RTV.find(r => Number(r.vehiculo_id) === Number(vehiculoId));
    
    let infoBasica = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Placa:</strong> ${vehiculo.placa}<br>
          <strong>Marca:</strong> ${vehiculo.marca}<br>
          <strong>Modelo:</strong> ${vehiculo.modelo}<br>
          <strong>A√±o:</strong> ${vehiculo.anio}<br>
          <strong>Tipo:</strong> ${vehiculo.tipo}<br>
          <strong>Color:</strong> ${vehiculo.color || 'No especificado'}
        </div>
        <div>
          <strong>Due√±o:</strong> ${vehiculo.dueno || 'Hotel'}<br>
          <strong>Estado:</strong> <span class="pill ${vehiculo.estado === 'activo' ? 'ok' : 'warnP'}">${vehiculo.estado}</span><br>
          <strong>Aseguradora:</strong> ${vehiculo.aseguradora || 'No especificada'}<br>
          <strong>P√≥liza:</strong> ${vehiculo.numero_poliza || 'No especificada'}<br>
          <strong>Vence P√≥liza:</strong> ${poliza ? poliza.vencimiento_poliza : 'No registrada'}<br>
          <strong>Vence RTV:</strong> ${rtv ? rtv.vencimiento_rtv : 'No registrada'}
        </div>
      </div>
    `;
    
    // Estad√≠sticas de rendimiento
    const totalKm = fuelVehiculo.length > 0 ? 
      Math.max(...fuelVehiculo.map(f => Number(f.odometro_km))) - 
      Math.min(...fuelVehiculo.map(f => Number(f.odometro_km))) : 0;
    
    const totalLitros = fuelVehiculo.reduce((a, f) => a + Number(f.litros), 0);
    const promedioKmL = totalLitros > 0 ? (totalKm / totalLitros).toFixed(1) : '0';
    
    const ultimaRevision = revVehiculo.length > 0 ? 
      revVehiculo.sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora))[0] : null;
    
    let estadisticas = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Km Recorridos (per√≠odo):</strong> ${totalKm.toLocaleString()} km<br>
          <strong>Litros Consumidos:</strong> ${totalLitros.toFixed(1)} L<br>
          <strong>Promedio Km/L:</strong> ${promedioKmL}<br>
          <strong>Mantenimientos:</strong> ${mantVehiculo.length}
        </div>
        <div>
          <strong>Revisiones:</strong> ${revVehiculo.length}<br>
          <strong>√öltima Revisi√≥n:</strong> ${ultimaRevision ? new Date(ultimaRevision.fecha_hora).toLocaleDateString() : 'No registrada'}<br>
          <strong>Od√≥metro Actual:</strong> ${fuelVehiculo.length > 0 ? Math.max(...fuelVehiculo.map(f => Number(f.odometro_km))).toLocaleString() : 'No disponible'} km
        </div>
      </div>
    `;
    
    // An√°lisis de costos
    const totalMant = mantVehiculo.reduce((a, m) => a + Number(m.costo || 0), 0);
    const totalComb = fuelVehiculo.reduce((a, f) => a + (Number(f.litros) * Number(f.precio_por_litro)), 0);
    const promedioMantMensual = mantVehiculo.length > 0 ? (totalMant / parseInt(periodo === 'all' ? 12 : periodo)) : 0;
    
    let costos = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Costo Total Mantenimiento:</strong> ${fmt(totalMant)}<br>
          <strong>Costo Total Combustible:</strong> ${fmt(totalComb)}<br>
          <strong>Costo Total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(totalMant + totalComb)}</span>
        </div>
        <div>
          <strong>Promedio Mant. Mensual:</strong> ${fmt(promedioMantMensual)}<br>
          <strong>Costo por Km:</strong> ${totalKm > 0 ? fmt((totalMant + totalComb) / totalKm) : fmt(0)}<br>
          <strong>Costo por Litro Prom.:</strong> ${totalLitros > 0 ? fmt(totalComb / totalLitros) : fmt(0)}
        </div>
      </div>
    `;
    
    // Alertas
    const alertasVehiculo = (Alertas || []).filter(a => Number(a.vehiculo_id) === Number(vehiculoId));
    let alertasHtml = alertasVehiculo.length > 0 ? 
      alertasVehiculo.map(a => `<div class="pill ${a.estado === 'pendiente' ? 'warnP' : 'ok'}">${a.tipo}: ${a.dias_restantes || a.km_restantes || 'Revisar'}</div>`).join('') :
      '<div class="pill ok">Sin alertas pendientes</div>';
    
    // Historial combinado
    let historial = [];
    
    mantVehiculo.forEach(m => {
      historial.push({
        fecha: m.fecha,
        tipo: 'Mantenimiento',
        detalle: `${m.tipo} - ${fmt(m.costo)}`,
        km: m.km_actual || '',
        observaciones: m.observaciones || ''
      });
    });
    
    fuelVehiculo.forEach(f => {
      historial.push({
        fecha: f.fecha,
        tipo: 'Combustible',
        detalle: `${f.litros}L - ${fmt(Number(f.litros) * Number(f.precio_por_litro))}`,
        km: f.odometro_km,
        observaciones: f.proveedor || ''
      });
    });
    
    revVehiculo.forEach(r => {
      historial.push({
        fecha: r.fecha_hora.split('T')[0],
        tipo: 'Revisi√≥n',
        detalle: `${r.tipo} por ${r.inspector}`,
        km: r.km,
        observaciones: r.observaciones || 'Revisi√≥n completa'
      });
    });
    
    historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    const historialHtml = historial.map(h => `
      <tr>
        <td>${h.fecha}</td>
        <td><span class="pill ${h.tipo === 'Mantenimiento' ? 'warnP' : h.tipo === 'Combustible' ? 'ok' : 'dangerP'}">${h.tipo}</span></td>
        <td>${h.detalle}</td>
        <td>${h.km}</td>
        <td>${h.observaciones}</td>
      </tr>
    `).join('');
    
    // Llenar el contenido
    byId('fichaInfoBasica').innerHTML = infoBasica;
    byId('fichaEstadisticas').innerHTML = estadisticas;
    byId('fichaCostos').innerHTML = costos;
    byId('fichaAlertas').innerHTML = alertasHtml;
    byId('fichaHistorial').innerHTML = `
      <table>
        <thead>
          <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Km</th><th>Observaciones</th></tr>
        </thead>
        <tbody>${historialHtml}</tbody>
      </table>
    `;
    
    byId('fichaTecnicaContent').classList.remove('hidden');
  }
  
  function exportarFichaTecnicaCompleta() {
    const vehiculoId = byId('fichaVehiculo').value;
    if (!vehiculoId) {
      alert('Seleccione un veh√≠culo primero');
      return;
    }
    
    const vehiculo = vehById(vehiculoId);
    exportFichaExcel(vehiculo.placa);
  }
  
  function previsualizarFicha() {
    alert('Vista previa de ficha t√©cnica - Esta funcionalidad se puede expandir para mostrar un reporte imprimible');
  }

  // ====== EXPORTS (XLSX) ======
  function exportFichaExcel(placa){
    const v = Vehiculos.find(x=>x.placa===placa); if(!v) return alert('Placa no existe');
    const mant = Mantenimientos.filter(x=> Number(x.vehiculo_id)===Number(v.id)).map(x=>({Fecha:x.fecha, Tipo:x.tipo, Costo:Number(x.costo)||0, Km_actual:x.km_actual||'', Proximo_km:x.proximo_km||'', Obs:x.observaciones||''}));
    const fuel = Combustible.filter(x=> Number(x.vehiculo_id)===Number(v.id)).map(x=>({Fecha:x.fecha, Litros:Number(x.litros)||0, Precio_por_litro:Number(x.precio_por_litro)||0, Costo:(Number(x.litros)*Number(x.precio_por_litro))||0, Odometro:Number(x.odometro_km)||0}));
    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.json_to_sheet(mant); ws1['!cols']=[{wch:12},{wch:18},{wch:12},{wch:12},{wch:12},{wch:30}];
    const ws2 = XLSX.utils.json_to_sheet(fuel); ws2['!cols']=[{wch:12},{wch:10},{wch:14},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws1, 'Mantenimientos');
    XLSX.utils.book_append_sheet(wb, ws2, 'Combustible');
    XLSX.writeFile(wb, `ficha_${placa}.xlsx`);
  }
  function exportMantXLSX(){
    const a='2025-01-01'; const b=today(); const p='';
    const data = Mantenimientos.filter(x=> x.fecha>=a && x.fecha<=b && (!p || (vehById(x.vehiculo_id)?.placa||'')===p)).map(x=>({Placa:vehById(x.vehiculo_id)?.placa||'', Fecha:x.fecha, Tipo:x.tipo, Costo:Number(x.costo)||0, Km_actual:x.km_actual||'', Proximo_km:x.proximo_km||'', Obs:x.observaciones||''}));
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(data); ws['!cols']=[{wch:10},{wch:12},{wch:18},{wch:12},{wch:12},{wch:12},{wch:30}];
    XLSX.utils.book_append_sheet(wb, ws, 'Mantenimientos'); XLSX.writeFile(wb, 'reporte_mantenimientos.xlsx');
  }
  function exportFuelXLSX(){
    const a='2025-01-01'; const b=today(); const p='';
    const data = Combustible.filter(x=> x.fecha>=a && x.fecha<=b && (!p || (vehById(x.vehiculo_id)?.placa||'')===p)).map(x=>({Placa:vehById(x.vehiculo_id)?.placa||'', Fecha:x.fecha, Litros:Number(x.litros)||0, Precio_por_litro:Number(x.precio_por_litro)||0, Costo:(Number(x.litros)*Number(x.precio_por_litro))||0, Odometro:Number(x.odometro_km)||0}));
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(data); ws['!cols']=[{wch:10},{wch:12},{wch:10},{wch:16},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws, 'Combustible'); XLSX.writeFile(wb, 'reporte_combustible.xlsx');
  }
  function exportAlertXLSX(){
    const data = (Alertas||[]).map(a=>({Tipo:a.tipo, Placa:vehById(a.vehiculo_id)?.placa||'', Dias:a.dias_restantes||'', Km:a.km_restantes||'', Estado:a.estado}));
    const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(data); ws['!cols']=[{wch:22},{wch:12},{wch:8},{wch:10},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws, 'Alertas'); XLSX.writeFile(wb, 'reporte_alertas.xlsx');
  }
  // ====== REPORTES MEJORADOS ======
  
  function actualizarConfigReporte() {
    const tipo = byId('repTipo').value;
    const configDiv = byId('repConfigAdicional');
    
    // Limpiar configuraci√≥n anterior
    configDiv.innerHTML = '';
    
    // Agregar configuraciones espec√≠ficas seg√∫n el tipo
    if (tipo === 'ficha_vehiculo') {
      configDiv.innerHTML = `
        <div class="form-group">
          <label>Per√≠odo de An√°lisis</label>
          <select id="repPeriodo">
            <option value="3">√öltimos 3 meses</option>
            <option value="6">√öltimos 6 meses</option>
            <option value="12">√öltimo a√±o</option>
            <option value="all">Todo el historial</option>
          </select>
        </div>
      `;
    } else if (tipo === 'resumen_costos') {
      configDiv.innerHTML = `
        <div class="form-group">
          <label>Agrupar por</label>
          <select id="repAgrupar">
            <option value="vehiculo">Veh√≠culo</option>
            <option value="mes">Mes</option>
            <option value="tipo">Tipo de Gasto</option>
          </select>
        </div>
      `;
    }
  }
  
  function previsualizarReporte() {
    const tipo = byId('repTipo').value;
    const placa = byId('repPlaca').value;
    const fechaA = byId('repA').value || '2000-01-01';
    const fechaB = byId('repB').value || today();
    
    let contenido = '';
    let titulo = '';
    
    // Generar contenido seg√∫n el tipo de reporte
    switch(tipo) {
      case 'mantenimientos':
        titulo = 'Reporte de Mantenimientos';
        contenido = generarReporteMantenimientos(placa, fechaA, fechaB);
        break;
      case 'combustible':
        titulo = 'Reporte de Combustible';
        contenido = generarReporteCombustible(placa, fechaA, fechaB);
        break;
      case 'revisiones':
        titulo = 'Reporte de Revisiones';
        contenido = generarReporteRevisiones(placa, fechaA, fechaB);
        break;
      case 'polizas_rtv':
        titulo = 'Reporte de P√≥lizas y RTV';
        contenido = generarReportePolizasRTV();
        break;
      case 'ficha_vehiculo':
        if (!placa) {
          alert('Seleccione un veh√≠culo para la ficha t√©cnica');
          return;
        }
        titulo = `Ficha T√©cnica - ${placa}`;
        contenido = generarFichaTecnicaCompleta(placa);
        break;
      case 'resumen_costos':
        titulo = 'Resumen de Costos';
        contenido = generarResumenCostos(placa, fechaA, fechaB);
        break;
      case 'alertas':
        titulo = 'Alertas y Vencimientos';
        contenido = generarReporteAlertas();
        break;
    }
    
    // Mostrar en el modal de vista previa
    const reporteContent = byId('reporteContent');
    reporteContent.innerHTML = `
      <div class="report-header">
        <div class="report-title">${titulo}</div>
        <div class="report-date">Generado el ${new Date().toLocaleDateString('es-CR')}</div>
        ${placa ? `<div style="margin-top:8px">Veh√≠culo: <strong>${placa}</strong></div>` : ''}
        ${fechaA !== '2000-01-01' ? `<div>Per√≠odo: ${fechaA} - ${fechaB}</div>` : ''}
      </div>
      ${contenido}
    `;
    
    byId('reportePreview').classList.remove('hidden');
  }
  
  function generarReporteMantenimientos(placa, fechaA, fechaB) {
    const data = Mantenimientos.filter(x=> 
      x.fecha >= fechaA && x.fecha <= fechaB && 
      (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
    );
    
    const total = data.reduce((a, m) => a + Number(m.costo || 0), 0);
    
    const tablaHtml = `
      <h4>üìä Resumen</h4>
      <p><strong>Total de registros:</strong> ${data.length}</p>
      <p><strong>Costo total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(total)}</span></p>
      
      <h4>üìã Detalle</h4>
      <table>
        <thead>
          <tr><th>Placa</th><th>Fecha</th><th>Tipo</th><th>Costo</th><th>Km</th><th>Observaciones</th></tr>
        </thead>
        <tbody>
          ${data.map(m => `
            <tr>
              <td>${vehById(m.vehiculo_id)?.placa||''}</td>
              <td>${m.fecha}</td>
              <td>${m.tipo}</td>
              <td><strong>${fmt(m.costo)}</strong></td>
              <td>${m.km_actual || ''}</td>
              <td>${m.observaciones || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    return data.length > 0 ? tablaHtml : '<p>No se encontraron registros para el per√≠odo seleccionado.</p>';
  }
  
  function generarReporteCombustible(placa, fechaA, fechaB) {
    const data = Combustible.filter(x=> 
      x.fecha >= fechaA && x.fecha <= fechaB && 
      (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
    );
    
    const totalCosto = data.reduce((a, f) => a + (Number(f.litros) * Number(f.precio_por_litro)), 0);
    const totalLitros = data.reduce((a, f) => a + Number(f.litros), 0);
    
    const tablaHtml = `
      <h4>üìä Resumen</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div>
          <p><strong>Total de cargas:</strong> ${data.length}</p>
          <p><strong>Total litros:</strong> ${totalLitros.toFixed(1)} L</p>
        </div>
        <div>
          <p><strong>Costo total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(totalCosto)}</span></p>
          <p><strong>Precio promedio/L:</strong> ${totalLitros > 0 ? fmt(totalCosto/totalLitros) : fmt(0)}</p>
        </div>
      </div>
      
      <h4>üìã Detalle</h4>
      <table>
        <thead>
          <tr><th>Placa</th><th>Fecha</th><th>Litros</th><th>‚Ç°/L</th><th>Costo</th><th>Od√≥metro</th><th>Proveedor</th></tr>
        </thead>
        <tbody>
          ${data.map(f => `
            <tr>
              <td>${vehById(f.vehiculo_id)?.placa||''}</td>
              <td>${f.fecha}</td>
              <td>${f.litros}</td>
              <td>${fmt(f.precio_por_litro)}</td>
              <td><strong>${fmt(Number(f.litros) * Number(f.precio_por_litro))}</strong></td>
              <td>${f.odometro_km} km</td>
              <td>${f.proveedor || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    return data.length > 0 ? tablaHtml : '<p>No se encontraron registros para el per√≠odo seleccionado.</p>';
  }
  
  function cerrarPreviewReporte() {
    byId('reportePreview').classList.add('hidden');
  }
  
  function imprimirReporte() {
    window.print();
  }
  
  function enviarReporteEmail() {
    alert('Funcionalidad de env√≠o por email - Se puede integrar con un servicio de email');
  }
  
  function exportReportXLSX(){
    const tipo = byId('repTipo').value;
    const placa = byId('repPlaca').value||'';
    const a = byId('repA').value||'2000-01-01';
    const b = byId('repB').value||today();
    const wb = XLSX.utils.book_new();

    if(tipo==='mantenimientos'){
      const data = Mantenimientos.filter(x=> x.fecha>=a && x.fecha<=b && (!placa || (vehById(x.vehiculo_id)?.placa||'')===placa)).map(x=>({Placa:vehById(x.vehiculo_id)?.placa||'', Fecha:x.fecha, Tipo:x.tipo, Costo:Number(x.costo)||0, Km_actual:x.km_actual||'', Proximo_km:x.proximo_km||'', Obs:x.observaciones||''}));
      const ws=XLSX.utils.json_to_sheet(data); ws['!cols']=[{wch:10},{wch:12},{wch:18},{wch:12},{wch:12},{wch:12},{wch:30}];
      XLSX.utils.book_append_sheet(wb, ws, 'Mantenimientos');
      XLSX.writeFile(wb, 'reporte_mantenimientos.xlsx');
      return;
    }
    if(tipo==='combustible'){
      const data = Combustible.filter(x=> x.fecha>=a && x.fecha<=b && (!placa || (vehById(x.vehiculo_id)?.placa||'')===placa)).map(x=>({Placa:vehById(x.vehiculo_id)?.placa||'', Fecha:x.fecha, Litros:Number(x.litros)||0, Precio_por_litro:Number(x.precio_por_litro)||0, Costo:(Number(x.litros)*Number(x.precio_por_litro))||0, Odometro:Number(x.odometro_km)||0}));
      const ws=XLSX.utils.json_to_sheet(data); ws['!cols']=[{wch:10},{wch:12},{wch:10},{wch:16},{wch:12},{wch:12}];
      XLSX.utils.book_append_sheet(wb, ws, 'Combustible');
      XLSX.writeFile(wb, 'reporte_combustible.xlsx');
      return;
    }
    if(tipo==='revisiones'){
      const data = (Revisiones||[]).filter(x=> (!placa || (vehById(x.vehiculo_id)?.placa||'')===placa) && (String(x.fecha_hora).slice(0,10)>=a) && (String(x.fecha_hora).slice(0,10)<=b)).map(x=>({Placa:vehById(x.vehiculo_id)?.placa||'', Tipo:x.tipo, Inspector:x.inspector||'', FechaHora:x.fecha_hora, Km:x.km||'', AceiteMotor:x.aceite_motor||'', LiquidoFreno:x.liquido_frenos||'', Coolant:x.coolant||'', Obs:x.observaciones||''}));
      const ws=XLSX.utils.json_to_sheet(data); ws['!cols']=[{wch:10},{wch:12},{wch:16},{wch:18},{wch:10},{wch:12},{wch:12},{wch:12},{wch:30}];
      XLSX.utils.book_append_sheet(wb, ws, 'Revisiones');
      XLSX.writeFile(wb, 'reporte_revisiones.xlsx');
      return;
    }
    if(tipo==='polizas_rtv'){
      const dataP = Polizas.map(p=>({Placa:vehById(p.vehiculo_id)?.placa||'', Aseguradora:p.aseguradora||'', Numero:p.numero_poliza||'', Vence:p.vencimiento_poliza||''}));
      const dataR = RTV.map(r=>({Placa:vehById(r.vehiculo_id)?.placa||'', Cita:r.numero_cita||'', Vence:r.vencimiento_rtv||''}));
      const wsP=XLSX.utils.json_to_sheet(dataP); wsP['!cols']=[{wch:10},{wch:16},{wch:16},{wch:12}];
      const wsR=XLSX.utils.json_to_sheet(dataR); wsR['!cols']=[{wch:10},{wch:12},{wch:12}];
      XLSX.utils.book_append_sheet(wb, wsP, 'Polizas');
      XLSX.utils.book_append_sheet(wb, wsR, 'RTV');
      XLSX.writeFile(wb, 'reporte_polizas_rtv.xlsx');
      return;
    }
    
    alert('‚úÖ Reporte exportado exitosamente');
  }

  // ====== TESTS ======
  function tlog(msg, ok=true){ const el=byId('testOut'); if(!el) return; const div=document.createElement('div'); div.className= ok? 'pass' : 'fail'; div.textContent = (ok?'‚úî ':'‚úñ ')+msg; el.appendChild(div); }
  function clearTests(){ const el=byId('testOut'); if(el) el.innerHTML=''; }
  async function runTests(kind){ clearTests(); try{
      if(kind==='get'){ const data = await apiGet('Vehiculos'); tlog('GET Vehiculos devolvi√≥ array', Array.isArray(data)); tlog('GET no lanz√≥ error', true); }
      if(kind==='ui'){ fillVehSelects(); const m = byId('mVeh'); tlog('Select mVeh existe', !!m); tlog('Select mVeh poblado (si hay veh√≠culos)', m && m.options.length>=0); }
      if(kind==='core'){
        tlog('Funci√≥n setTab definida', typeof setTab==='function');
        try{ setTab(localStorage.getItem('tab') || 'dashboard'); tlog('setTab ejecuta sin throw', true); }catch(e){ tlog('setTab lanz√≥ excepci√≥n: '+e.message, false); }
        tlog('Librer√≠a XLSX cargada', !!window.XLSX);
        tlog('exportReportXLSX existe', typeof exportReportXLSX==='function');
        tlog('refreshHints existe', typeof refreshHints==='function');
      }
      if(kind==='auto'){
        const old = window.alert; let lastMsg=''; window.alert = (m)=>{ lastMsg=String(m||''); };
        byId('mTipo').value='cambio_aceite'; byId('mKm').value='12000'; byId('mProx').value=''; autoProximoKm();
        tlog('autoProximoKm suma 5000 (12000‚Üí17000)', byId('mProx').value==='17000');
        byId('mTipo').value='llantas'; byId('mKm').value='100'; byId('mProx').value=''; lastMsg=''; autoProximoKm();
        tlog('autoProximoKm alerta cuando tipo ‚â† cambio_aceite', lastMsg.toLowerCase().includes('cambio de aceite'));
        byId('mTipo').value='cambio_aceite'; byId('mKm').value=''; lastMsg=''; autoProximoKm();
        tlog('autoProximoKm alerta si km vac√≠o', lastMsg.toLowerCase().includes('km'));
        window.alert = old;
      }
      if(kind==='bit'){
        byId('bVeh').selectedIndex=0; byId('fltBitPlaca').value=''; resetBitacoraForm();
        if(Vehiculos.length){ byId('bVeh').value = String(Vehiculos[0].id); const placa = Vehiculos[0].placa; const flt = byId('fltBitPlaca'); flt.value = placa; tlog('Filtro Bit√°cora se puede fijar por placa', flt.value===placa); resetBitacoraForm(); tlog('resetBitacoraForm limpia campos', !byId('bCond').value && !byId('bKm').value && byId('bNivel').value==='lleno'); } else { tlog('No hay veh√≠culos de ejemplo para probar filtro Bit√°cora', false); }
      }
    }catch(err){ tlog('Error en test: '+err.message, false); }
  }

  // ====== INIT ======
  window.addEventListener('DOMContentLoaded', ()=>{
    // Inicializar la aplicaci√≥n correctamente
    inicializarApp();
    
    // Event listeners para el login
    document.getElementById('loginPassword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && selectedRole) {
        attemptLogin();
      }
    });
    
    // Inicializar fechas por defecto en reportes
    const hoy = today();
    const tresMesesAtras = new Date();
    tresMesesAtras.setMonth(tresMesesAtras.getMonth() - 3);
    
    setTimeout(() => {
      const fechaA = byId('repA');
      const fechaB = byId('repB');
      if (fechaA) fechaA.value = tresMesesAtras.toISOString().slice(0,10);
      if (fechaB) fechaB.value = hoy;
      
      // Event listeners para hints y c√°lculos
      ['bVeh','cVeh','mVeh','rVeh'].forEach(id=>{ 
        const el=byId(id); 
        if(el){ el.addEventListener('change', refreshHints); }
      });
      
      ['cOdo','cLitros','cFecha'].forEach(id=>{ 
        const el=byId(id); 
        if(el){ 
          el.addEventListener('input', calcKmLEstimado); 
          el.addEventListener('change', calcKmLEstimado); 
        }
      });
      
      // UX: Enter en buscador = buscar
      const q = byId('qPlaca');
      if(q){ 
        q.addEventListener('keydown', (e)=>{ 
          if(e.key==='Enter'){ 
            e.preventDefault(); 
            buscarPlaca(); 
          } 
        }); 
      }
      
      // Cerrar modales al hacer click fuera o con ESC
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.classList.add('hidden');
        }
      });
      
      // Cerrar modales con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          cerrarTodosLosModales();
        }
      });
      
      // Asegurar que los botones de cerrar funcionen
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('close-btn') || e.target.textContent === '√ó') {
          const modal = e.target.closest('.modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        }
      });
      
    }, 100);
  });
  </script>
</body>
</html>
