<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Sistema de Gestión Vehicular — Hotel</title>

  <!-- PWA (opcional) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1e40af">
  <!-- Service Worker deshabilitado temporalmente para Railway -->
  <script>
    // Service Worker omitido - Railway no lo soporta correctamente
    console.log('PWA features disabled on Railway deployment - v2.0');
  </script>

  <style>
    /* ========================================
       MOBILE-FIRST RESPONSIVE DESIGN
       ======================================== */
    
    :root{ 
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --card: #ffffff;
      --ink: #1e293b;
      --muted: #64748b;
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #0f172a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --line: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      /* Mobile-first spacing variables */
      --spacing-xs: 8px;
      --spacing-sm: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      
      /* Touch-friendly sizes */
      --touch-target: 48px;
      --button-height: 52px;
      --input-height: 56px;
    }
    
    /* RESET & BASE - Mobile First */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      font-size: 16px; /* Base font size for rem calculations */
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      color: var(--ink);
      background: var(--bg);
      line-height: 1.6;
      overflow-x: hidden; /* Prevent horizontal scroll */
      width: 100vw;
      max-width: 100%;
    }
    
    /* ========================================
       LOGIN SCREEN - Mobile Optimized
       ======================================== */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: var(--spacing-md);
    }
    
    .login-card {
      background: white;
      padding: var(--spacing-lg);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: var(--spacing-xs);
      color: var(--ink);
    }
    
    .login-subtitle {
      color: var(--muted);
      margin-bottom: var(--spacing-lg);
      font-size: 0.9rem;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }
    
    .role-card {
      border: 2px solid var(--line);
      border-radius: 12px;
      padding: var(--spacing-md);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      min-height: var(--touch-target);
      display: flex;
      flex-direction: column;
      justify-content: center;
      touch-action: manipulation;
    }
    
    .role-card:hover, .role-card:focus {
      border-color: var(--primary);
      transform: translateY(-1px);
    }
    
    .role-card:active {
      transform: scale(0.98);
    }
    
    .role-card.selected {
      border-color: var(--primary);
      background: rgba(30, 64, 175, 0.05);
      box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.2);
    }
    
    .role-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .role-desc {
      font-size: 0.85rem;
      color: var(--muted);
    }
    
    .password-field {
      margin-top: var(--spacing-md);
    }
    
    .login-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: var(--button-height);
      touch-action: manipulation;
    }
    
    .login-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .login-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ========================================
       MAIN APP LAYOUT - Mobile First
       ======================================== */
    .app {
      display: none;
      width: 100vw;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    .app.logged-in {
      display: block;
    }
    
    /* HEADER - Mobile Optimized */
    header {
      position: sticky;
      top: 0;
      background: var(--card);
      border-bottom: 1px solid var(--line);
      z-index: 100;
      box-shadow: var(--shadow);
      width: 100%;
    }
    
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-sm) var(--spacing-md);
      gap: var(--spacing-sm);
      min-height: 60px;
    }
    
    .brand {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      flex-shrink: 0;
    }
    
    .brand-icon {
      font-size: 1.25rem;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    .user-info > span {
      display: none; /* Hidden on mobile by default */
    }
    
    /* NAVIGATION - Mobile First */
    .tabs {
      display: flex;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      width: 100%;
    }
    
    .tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 20px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
      flex-shrink: 0;
      min-height: var(--touch-target);
      font-size: 0.85rem;
      touch-action: manipulation;
    }
    
    .tab:hover, .tab:focus {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      transform: translateY(-1px);
    }
    
    .tab.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .tab:active {
      transform: scale(0.96);
    }
    
    /* CONTAINER - Mobile First */
    .container {
      width: 100%;
      max-width: 100vw;
      padding: var(--spacing-md);
      margin: 0;
      overflow-x: hidden;
    }
    
    /* GRID SYSTEM - Mobile First with Flexbox fallback */
    .grid {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      width: 100%;
    }
    
    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-sm);
      width: 100%;
    }
    
    .row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      width: 100%;
    }
    
    .row-3 {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      width: 100%;
    }
    
    /* CARDS - Mobile Optimized */
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: var(--spacing-md);
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
      width: 100%;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .card h3 {
      margin: 0 0 var(--spacing-sm) 0;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .big {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--primary);
    }
    
    .kpi-icon {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-xs);
      opacity: 0.7;
    }
    
    /* ========================================
       FORMS & INPUTS - Touch Optimized
       ======================================== */
    .form-group {
      margin-bottom: var(--spacing-md);
      width: 100%;
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
      color: var(--ink);
      font-size: 0.9rem;
    }
    
    .form-row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      width: 100%;
    }
    
    .form-row-3 {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      width: 100%;
    }
    
    input, select, textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 2px solid var(--line);
      border-radius: 12px;
      background: #fff;
      font-size: 1rem; /* Prevents zoom on iOS */
      transition: all 0.2s ease;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      min-height: var(--input-height);
      box-sizing: border-box;
      font-family: inherit;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }
    
    select {
      background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1h4l-2 2z"/></svg>');
      background-repeat: no-repeat;
      background-position: right var(--spacing-md) center;
      background-size: 12px;
      padding-right: calc(var(--spacing-md) * 3);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* ========================================
       BUTTONS - Touch Optimized
       ======================================== */
    button {
      border: none;
      border-radius: 12px;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      min-height: var(--button-height);
      touch-action: manipulation;
      font-family: inherit;
    }
    
    button:hover, button:focus {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    button:active {
      transform: scale(0.96);
    }
    
    button.secondary {
      background: #f8fafc;
      color: var(--ink);
      border: 2px solid var(--line);
    }
    
    button.secondary:hover {
      background: #f1f5f9;
      border-color: var(--primary);
    }
    
    button.danger {
      background: var(--danger);
    }
    
    button.danger:hover {
      background: #dc2626;
    }
    
    button.success {
      background: var(--success);
    }
    
    button.success:hover {
      background: #059669;
    }
    
    .btn-small {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.8rem;
      margin: 2px;
      min-height: 36px;
      min-width: auto;
    }
    
    .logout-btn {
      background: var(--danger);
      color: white;
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: 8px;
      font-size: 0.8rem;
      min-height: 36px;
    }
    
    /* ========================================
       TABLES - Mobile Optimized (No Horizontal Scroll)
       ======================================== */
    .table-container {
      width: 100%;
      overflow: hidden; /* No horizontal scroll */
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.85rem;
    }
    
    th, td {
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    th {
      color: var(--muted);
      font-weight: 600;
      background: #f8fafc;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.75rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    tr:hover {
      background: #f8fafc;
    }
    
    /* Mobile table optimization - Stack on small screens */
    @media (max-width: 768px) {
      .table-container {
        overflow-x: visible;
      }
      
      table, thead, tbody, th, td, tr {
        display: block;
      }
      
      thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      
      tr {
        border: 1px solid var(--line);
        border-radius: 8px;
        margin-bottom: var(--spacing-sm);
        background: white;
        padding: var(--spacing-sm);
      }
      
      td {
        border: none;
        border-bottom: 1px solid var(--line);
        position: relative;
        padding-left: 30%;
        padding-right: var(--spacing-sm);
        padding-top: var(--spacing-xs);
        padding-bottom: var(--spacing-xs);
      }
      
      td:before {
        content: attr(data-label) ": ";
        position: absolute;
        left: var(--spacing-sm);
        width: 25%;
        text-align: left;
        font-weight: 600;
        color: var(--muted);
        font-size: 0.75rem;
        text-transform: uppercase;
      }
      
      td:last-child {
        border-bottom: none;
      }
    }
    
    /* ========================================
       UTILITY CLASSES
       ======================================== */
    .hidden {
      display: none !important;
    }
    
    .mobile-only {
      display: block;
    }
    
    .desktop-only {
      display: none;
    }
    
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .ok {
      background: #10b9811a;
      color: #065f46;
      border: 1px solid #10b98140;
    }
    
    .warnP {
      background: #f59e0b1a;
      color: #7c2d12;
      border: 1px solid #f59e0b40;
    }
    
    .dangerP {
      background: #ef44441a;
      color: #7f1d1d;
      border: 1px solid #ef444440;
    }
    
    /* ========================================
       RESPONSIVE BREAKPOINTS - Mobile First
       ======================================== */
    
    /* TABLET - 768px and up */
    @media (min-width: 768px) {
      .container {
        padding: var(--spacing-lg);
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .topbar {
        padding: var(--spacing-md) var(--spacing-lg);
      }
      
      .brand {
        font-size: 1.125rem;
      }
      
      .user-info > span {
        display: inline; /* Show role text on tablet+ */
      }
      
      .user-info {
        font-size: 0.9rem;
        gap: var(--spacing-sm);
      }
      
      .tabs {
        padding: var(--spacing-md) var(--spacing-lg);
        justify-content: flex-start;
        overflow-x: visible;
      }
      
      .tab {
        font-size: 0.9rem;
      }
      
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-lg);
      }
      
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-lg);
      }
      
      .row-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
      }
      
      .kpis {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-md);
      }
      
      .card {
        padding: var(--spacing-lg);
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }
      
      .form-row-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
      }
      
      /* Tables back to normal on tablet+ */
      .table-container {
        overflow-x: auto;
      }
      
      table, thead, tbody, th, td, tr {
        display: table;
      }
      
      table {
        display: table;
      }
      
      thead {
        display: table-header-group;
      }
      
      tbody {
        display: table-row-group;
      }
      
      tr {
        display: table-row;
        border: none;
        margin: 0;
        background: transparent;
        padding: 0;
      }
      
      th {
        display: table-cell;
      }
      
      td {
        display: table-cell;
        border-bottom: 1px solid var(--line);
        padding: var(--spacing-sm) var(--spacing-md);
        position: static;
        padding-left: var(--spacing-md);
      }
      
      td:before {
        content: none;
      }
      
      .mobile-only {
        display: none;
      }
      
      .desktop-only {
        display: block;
      }
    }
    
    /* DESKTOP - 1024px and up */
    @media (min-width: 1024px) {
      .container {
        max-width: 1400px;
        padding: var(--spacing-xl);
      }
      
      .topbar {
        padding: var(--spacing-lg) var(--spacing-xl);
      }
      
      .brand {
        font-size: 1.25rem;
      }
      
      .brand-icon {
        font-size: 1.5rem;
      }
      
      .tabs {
        padding: var(--spacing-lg) var(--spacing-xl);
      }
      
      .kpis {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      
      .big {
        font-size: 2.5rem;
      }
      
      .card h3 {
        font-size: 1rem;
      }
      
      .kpi-icon {
        font-size: 2rem;
      }
      
      /* Enhanced hover effects on desktop */
      .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }
      
      button:hover {
        transform: translateY(-1px);
      }
      
      .tab:hover {
        transform: translateY(-1px);
      }
    }
    
    /* LARGE DESKTOP - 1440px and up */
    @media (min-width: 1440px) {
      .container {
        max-width: 1600px;
      }
      
      .grid {
        gap: var(--spacing-xl);
      }
      
      .row, .row-3 {
        gap: var(--spacing-xl);
      }
    }
    
    /* ========================================
       MOBILE COMPACT MODE - Enhanced
       ======================================== */
    
    /* Mobile Navigation Bottom Bar */
    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-top: 2px solid var(--primary);
      z-index: 1000;
      padding: var(--spacing-xs);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      safe-area-inset-bottom: env(safe-area-inset-bottom, 0);
    }
    
    .mobile-nav-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      max-width: 100%;
    }
    
    .mobile-nav-item {
      background: transparent;
      border: none;
      border-radius: 12px;
      padding: var(--spacing-xs);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-height: var(--touch-target);
      touch-action: manipulation;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .mobile-nav-item:hover, .mobile-nav-item.active {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
    }
    
    .mobile-nav-item .nav-icon {
      font-size: 1.2rem;
      transition: transform 0.3s ease;
    }
    
    .mobile-nav-item:hover .nav-icon, 
    .mobile-nav-item.active .nav-icon {
      transform: scale(1.15);
    }
    
    .mobile-nav-item .nav-text {
      font-size: 0.65rem;
      font-weight: 600;
      line-height: 1.2;
    }
    
    /* Compact Mode Activation */
    .mobile-compact .tabs {
      display: none !important;
    }
    
    .mobile-compact .mobile-nav {
      display: block !important;
    }
    
    .mobile-compact .container {
      padding-bottom: calc(var(--touch-target) + var(--spacing-lg) + env(safe-area-inset-bottom, 0));
    }
    
    .mobile-compact .floating-fab {
      display: none;
    }
    
    /* Compact Mode Layout Optimizations */
    .mobile-compact .topbar {
      padding: var(--spacing-xs) var(--spacing-sm);
      min-height: 50px;
    }
    
    .mobile-compact .brand {
      font-size: 0.9rem;
    }
    
    .mobile-compact .brand-icon {
      font-size: 1rem;
    }
    
    .mobile-compact .user-info {
      gap: 4px;
      font-size: 0.7rem;
    }
    
    .mobile-compact .user-info button {
      padding: 4px 8px;
      font-size: 0.7rem;
      min-height: 28px;
    }
    
    .mobile-compact .container {
      padding: var(--spacing-xs);
    }
    
    .mobile-compact .grid {
      gap: var(--spacing-sm);
    }
    
    .mobile-compact .card {
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-xs);
      border-radius: 8px;
    }
    
    .mobile-compact .card h3 {
      font-size: 0.8rem;
      margin-bottom: var(--spacing-xs);
    }
    
    .mobile-compact .big {
      font-size: 1.5rem;
    }
    
    .mobile-compact .kpi-icon {
      font-size: 1.25rem;
      margin-bottom: 4px;
    }
    
    .mobile-compact .kpis {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-xs);
    }
    
    .mobile-compact .kpis .card {
      padding: var(--spacing-xs);
      min-height: 70px;
    }
    
    .mobile-compact .row {
      gap: var(--spacing-sm);
    }
    
    .mobile-compact .row-3 {
      gap: var(--spacing-sm);
    }
    
    /* Compact Forms */
    .mobile-compact input,
    .mobile-compact select,
    .mobile-compact textarea {
      padding: var(--spacing-sm);
      font-size: 0.9rem;
      min-height: var(--touch-target);
    }
    
    .mobile-compact button {
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.85rem;
      min-height: 44px;
    }
    
    .mobile-compact .form-group {
      margin-bottom: var(--spacing-sm);
    }
    
    .mobile-compact .form-group label {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    
    /* Compact Tables */
    .mobile-compact table {
      font-size: 0.8rem;
    }
    
    .mobile-compact th,
    .mobile-compact td {
      padding: var(--spacing-xs);
    }
    
    /* Hide desktop elements in compact mode */
    @media (max-width: 768px) {
      .mobile-compact .desktop-only {
        display: none !important;
      }
      
      .mobile-compact .mobile-only {
        display: block !important;
      }
    }
    
    /* ========================================
       MODALS - Mobile Optimized
       ======================================== */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: var(--spacing-md);
      box-sizing: border-box;
      visibility: hidden;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .modal:not(.hidden) {
      visibility: visible;
      opacity: 1;
    }
    
    .modal.hidden {
      visibility: hidden;
      opacity: 0;
    }
    
    .modal-content {
      background: white;
      padding: var(--spacing-lg);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--line);
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--ink);
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: var(--touch-target);
      height: var(--touch-target);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .close-btn:hover {
      background: var(--line);
      color: var(--ink);
      transform: scale(1.05);
    }
    
    /* ========================================
       FLOATING FAB (DESPLEGABLE) & UI ELEMENTS
       ======================================== */
    .floating-fab {
      position: fixed;
      right: var(--spacing-lg);
      bottom: var(--spacing-lg);
      z-index: 100;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fab-toggle {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
    }
    
    .fab-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2), 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .fab-toggle:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .fab-icon {
      font-size: 20px;
      color: white;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .floating-fab.open .fab-icon {
      transform: rotate(180deg);
    }
    
    .fab-menu {
      position: absolute;
      bottom: 68px;
      right: 0;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px) scale(0.9);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    
    .floating-fab.open .fab-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
      pointer-events: all;
    }
    
    .fab-action {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      color: var(--text-color);
      min-width: 160px;
    }
    
    .fab-action:hover {
      background: var(--primary-color);
      color: white;
      transform: translateX(-4px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    
    .fab-action-icon {
      font-size: 18px;
      width: 20px;
      text-align: center;
    }
    
    .fab-action-text {
      font-weight: 500;
      font-size: 14px;
    }
    
    /* Estados de visibilidad */
    .floating-fab.hidden {
      transform: translateY(100px);
      opacity: 0;
      pointer-events: none;
    }
    
    .footer {
      padding: var(--spacing-lg);
      color: var(--muted);
      font-size: 0.8rem;
      text-align: center;
      background: var(--card);
      margin-top: var(--spacing-xl);
      border-top: 1px solid var(--line);
    }
    
    .tag {
      font-size: 0.75rem;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 4px var(--spacing-sm);
      background: white;
      display: inline-flex;
      align-items: center;
    }
    
    /* ========================================
       SPECIALIZED COMPONENTS
       ======================================== */
    
    /* Action Buttons */
    .action-btn {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.8rem;
      margin: 2px;
      min-height: 32px;
      border-radius: 8px;
    }
    
    .edit-btn {
      background: var(--warn);
      color: white;
    }
    
    .edit-btn:hover {
      background: #d97706;
    }
    
    .delete-btn {
      background: var(--danger);
      color: white;
    }
    
    .delete-btn:hover {
      background: #dc2626;
    }
    
    .export-btn {
      background: var(--success);
      color: white;
    }
    
    .export-btn:hover {
      background: #059669;
    }
    
    /* Bitácora Highlighting */
    .flash {
      transition: background 0.4s ease;
    }
    
    .flash td {
      background: inherit;
    }
    
    .flash-ret {
      background: #fff7ed !important;
    }
    
    .flash-ent {
      background: #eef2ff !important;
    }
    
    .newtag {
      display: inline-block;
      margin-right: 6px;
      font-size: 0.75rem;
    }
    
    /* Test Results */
    .test {
      font-size: 0.8rem;
      color: var(--ink);
    }
    
    .test .pass {
      color: var(--success);
      font-weight: 600;
    }
    
    .test .fail {
      color: #b91c1c;
      font-weight: 600;
    }
    
    /* SMTP Configuration */
    .smtp-config {
      border-left: 4px solid var(--warn);
      background: #fffbee;
      padding: var(--spacing-md);
      border-radius: 8px;
      margin: var(--spacing-md) 0;
    }
    
    .smtp-config h4 {
      color: #b45309;
      margin: 0 0 var(--spacing-md) 0;
      font-size: 1rem;
    }
    
    .smtp-config small {
      color: #92400e;
      font-style: italic;
      font-size: 0.8rem;
    }
    
    /* Report Preview */
    .report-preview {
      background: white;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    
    .report-header {
      text-align: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--primary);
    }
    
    .report-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--spacing-xs);
    }
    
    .report-date {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    /* ========================================
       FINAL MOBILE OPTIMIZATIONS
       ======================================== */
    
    /* Mobile Modal Adjustments */
    @media (max-width: 768px) {
      .modal {
        align-items: flex-start;
        padding: var(--spacing-sm);
      }
      
      .modal-content {
        width: 100%;
        max-width: 100%;
        margin-top: var(--spacing-md);
        max-height: calc(100vh - 2 * var(--spacing-md));
        border-radius: 12px;
      }
      
      .modal-title {
        font-size: 1.125rem;
      }
      
      /* Ensure no horizontal scroll on mobile */
      .login-card {
        margin: var(--spacing-md);
        width: calc(100% - 2 * var(--spacing-md));
      }
      
      /* Floating FAB mobile positioning */
      .floating-fab {
        right: var(--spacing-md);
        bottom: var(--spacing-md);
      }
      
      .fab-toggle {
        width: 48px;
        height: 48px;
      }
      
      .fab-icon {
        font-size: 18px;
      }
      
      .fab-action {
        min-width: 140px;
        padding: var(--spacing-xs) var(--spacing-sm);
      }
      
      .fab-action-text {
        font-size: 13px;
      }
      
      /* Enhanced touch targets for mobile */
      .btn-small {
        min-height: 40px;
        padding: var(--spacing-xs) var(--spacing-sm);
      }
    }
  </style>

  <!-- SheetJS para exportaciones a Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1 class="login-title">🚗 Sistema de Gestión Vehicular</h1>
      <p class="login-subtitle">Seleccione su rol para acceder al sistema</p>
      
      <form class="login-form" onsubmit="attemptLogin(); return false;">
        <div class="role-card" data-role="admin" onclick="selectRole('admin')">
          <div class="role-title">👨‍💼 Administrador</div>
          <div class="role-desc">Acceso completo a todas las funciones</div>
        </div>
        
        <div class="role-card" data-role="operador" onclick="selectRole('operador')">
          <div class="role-title">🔧 Operador</div>
          <div class="role-desc">Mantenimientos, cambios de aceite y combustible</div>
        </div>
        
        <div class="role-card" data-role="supervisor" onclick="selectRole('supervisor')">
          <div class="role-title">👁️ Supervisor</div>
          <div class="role-desc">Solo acceso a revisiones detalladas</div>
        </div>
        
        <div class="password-field">
          <input type="password" id="loginPassword" placeholder="Ingrese su contraseña" autocomplete="current-password" />
        </div>
        
        <button type="submit" class="login-btn" disabled>Iniciar Sesión</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <span class="brand-icon">🚗</span>
        Sistema de Gestión Vehicular
      </div>

      <div class="user-info">
        <span>👤 <span id="currentUserRole"></span></span>
        <button id="mobileToggle" class="secondary mobile-only" onclick="toggleMobileCompactMode()" title="Modo Compacto Móvil">📱 Compacto</button>
        <button class="secondary" onclick="cerrarTodosLosModales()" title="Cerrar ventanas abiertas">✖️ Cerrar Modales</button>
        <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
      </div>
    </div>
    <div class="tabs" id="mainTabs">
      <button class="tab active" data-tab="dashboard" onclick="setTab('dashboard')" data-roles="admin">📊 Dashboard</button>
      <button class="tab" data-tab="vehiculos" onclick="setTab('vehiculos')" data-roles="admin">🚗 Vehículos</button>
      <button class="tab" data-tab="ficha-tecnica" onclick="setTab('ficha-tecnica')" data-roles="admin">📋 Ficha Técnica</button>
      <button class="tab" data-tab="polizas" onclick="setTab('polizas')" data-roles="admin">🛡️ Pólizas & RTV</button>
      <button class="tab" data-tab="mantenimientos" onclick="setTab('mantenimientos')" data-roles="admin,operador">🔧 Mantenimientos</button>
      <button class="tab" data-tab="combustible" onclick="setTab('combustible')" data-roles="admin,operador">⛽ Combustible</button>
      <button class="tab" data-tab="bitacora" onclick="setTab('bitacora')" data-roles="admin,operador,supervisor">📝 Bitácora</button>
      <button class="tab" data-tab="revision" onclick="setTab('revision')" data-roles="admin,supervisor">🔍 Revisión</button>
      <button class="tab" data-tab="alertas-config" onclick="setTab('alertas-config')" data-roles="admin">⚠️ Config. Alertas</button>
      <button class="tab" data-tab="reportes" onclick="setTab('reportes')" data-roles="admin">📈 Reportes</button>
    </div>
  </header>

  <main class="container">
    <section id="tab-dashboard" class="tabpanel">
      <!-- === INDICADORES PRINCIPALES === -->
      <div class="grid kpis">
        <!-- 1. VEHÍCULOS ACTIVOS -->
        <div class="card">
          <div class="kpi-icon">🚗</div>
          <h3>Vehículos Activos</h3>
          <div class="big" id="kpiVeh">-</div>
        </div>
        
        <!-- 2. PÓLIZAS POR VENCER -->
        <div class="card">
          <div class="kpi-icon">🛡️</div>
          <h3>Pólizas (≤30d)</h3>
          <div class="big" id="kpiPol30">-</div>
          <div id="proxPolizas" style="margin-top: 8px; min-height: 40px;">
            <div style="color: var(--text-secondary); font-size: 0.8em;">Cargando...</div>
          </div>
        </div>
        
        <!-- 3. RTV POR VENCER -->
        <div class="card">
          <div class="kpi-icon">🔍</div>
          <h3>RTV (≤30d)</h3>
          <div class="big" id="kpiRtv30">-</div>
          <div id="proxRTV" style="margin-top: 8px; min-height: 40px;">
            <div style="color: var(--text-secondary); font-size: 0.8em;">Cargando...</div>
          </div>
        </div>
        
        <!-- 4. COSTOS DEL MES -->
        <div class="card">
          <div class="kpi-icon">💰</div>
          <h3>Costo Total Mes</h3>
          <div class="big" id="kpiCostoTotalMes">-</div>
          <div style="margin-top: 8px; font-size: 0.85em;">
            <div>⛽ <strong>Combustible:</strong> <span id="kpiCombustibleMes">-</span></div>
            <div>🔧 <strong>Mantenimiento:</strong> <span id="kpiMantenimientoMes">-</span></div>
          </div>
        </div>
      </div>
      
      <!-- === INDICADORES SECUNDARIOS === -->
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 16px;">
        <div class="card">
          <div class="kpi-icon">🔧</div>
          <h4>Mantenimientos del Mes</h4>
          <div class="big" style="font-size: 1.5em;" id="kpiMantMes">-</div>
        </div>
        

      </div>
      <!-- === RESUMEN DEL MES ACTUAL === -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin: 0 0 16px 0; color: var(--primary);">📊 Resumen del Mes</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
          <div style="text-align: center; padding: 12px; background: rgba(0, 123, 255, 0.1); border-radius: 8px;">
            <div style="font-size: 0.9em; color: var(--text-secondary);">Total Gastado</div>
            <div style="font-size: 1.4em; font-weight: bold; color: var(--primary);" id="kpiCostoTotalMes2">-</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
            <div style="font-size: 0.9em; color: var(--text-secondary);">⛽ Combustible</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #28a745;" id="kpiCombustibleMes2">-</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
            <div style="font-size: 0.9em; color: var(--text-secondary);">🔧 Mantenimiento</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #ffc107;" id="kpiMantenimientoMes2">-</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <details>
          <summary>🧪 Pruebas rápidas (dev)</summary>
          <div class="test" id="testOut"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="secondary" onclick="runTests('api')">Probar Conectividad API</button>
            <button class="secondary" onclick="runTests('get')">Probar GET Vehículos</button>
            <button class="secondary" onclick="runTests('ui')">Probar UI (selects)</button>
            <button class="secondary" onclick="runTests('core')">Probar Core (setTab/XLSX)</button>
            <button class="secondary" onclick="runTests('auto')">Probar autoProximoKm</button>
            <button class="secondary" onclick="runTests('bit')">Probar reset & filtro Bitácora</button>
          </div>
        </details>
      </div>
    </section>

    <section id="tab-vehiculos" class="tabpanel hidden">
      <form class="card" onsubmit="guardarVehiculo(event)" style="margin-bottom:12px">
        <h3 style="margin:0 0 16px 0;color:var(--ink)">🚗 Agregar Nuevo Vehículo</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Placa</label>
            <input id="vPlaca" type="text" placeholder="ABC123" required/>
          </div>
          <div class="form-group">
            <label>Marca</label>
            <input id="vMarca" type="text" placeholder="Toyota" required/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Modelo</label>
            <input id="vModelo" type="text" placeholder="Corolla" required/>
          </div>
          <div class="form-group">
            <label>Año</label>
            <input id="vAnio" type="number" min="1990" max="2100" required/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Kilometraje Inicial</label>
            <input id="vKmInicial" type="number" min="0" placeholder="Ej: 50000" title="Kilometraje actual del odómetro del vehículo"/>
          </div>
          <div class="form-group">
            <label>Tipo</label>
            <select id="vTipo">
              <option value="sedán">Sedán</option>
              <option value="pickup">Pickup</option>
              <option value="SUV">SUV</option>
              <option value="buseta">Buseta</option>
              <option value="hatchback">Hatchback</option>
              <option value="minivan">Minivan</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="vEstado">
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
              <option value="mantenimiento">En Mantenimiento</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Dueño</label>
            <input id="vDueno" type="text" placeholder="Ej: Hotel, Juan Pérez, Empresa XYZ"/>
          </div>
          <div class="form-group">
            <label>Número de Póliza</label>
            <input id="vPoliza" type="text" placeholder="POL-123456"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Aseguradora</label>
            <input id="vAseguradora" type="text" placeholder="INS, Mapfre, etc."/>
          </div>
          <div class="form-group">
            <label>Color</label>
            <input id="vColor" type="text" placeholder="Blanco, Negro, etc."/>
          </div>
        </div>
        <div style="margin-top:20px">
          <button type="submit" class="success">💾 Guardar Vehículo</button>
          <button type="button" class="secondary" onclick="limpiarFormVehiculo()">🗑️ Limpiar</button>
        </div>
      </form>
      
      <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <select id="fltVehPlaca" onchange="renderVehiculos()">
            <option value="">📋 Todas las placas</option>
          </select>
          <select id="fltVehEstado" onchange="renderVehiculos()">
            <option value="">🚗 Todos los estados</option>
            <option value="activo">✅ Activo</option>
            <option value="inactivo">❌ Inactivo</option>
            <option value="mantenimiento">🔧 En Mantenimiento</option>
          </select>
          <input id="fltVehDueno" type="text" placeholder="🔍 Filtrar por dueño..." onkeyup="renderVehiculos()"/>
        </div>
        <div>
          <button class="secondary export-btn" onclick="exportarVehiculo()">📊 Exportar Excel</button>
        </div>
      </div>
      
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Placa</th>
              <th>Marca/Modelo</th>
              <th>Año</th>
              <th>Km Inicial</th>
              <th>Tipo</th>
              <th>Dueño</th>
              <th>Aseguradora</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tblVeh"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-ficha-tecnica" class="tabpanel hidden">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin:0 0 16px 0;color:var(--ink)">📋 Seleccionar Vehículo para Ficha Técnica</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Vehículo</label>
            <select id="fichaVehiculo" onchange="cargarFichaTecnica()">
              <option value="">Seleccione un vehículo...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Período de análisis</label>
            <select id="fichaPeriodo" onchange="cargarFichaTecnica()">
              <option value="3">Últimos 3 meses</option>
              <option value="6" selected>Últimos 6 meses</option>
              <option value="12">Último año</option>
              <option value="all">Todo el historial</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="fichaTecnicaContent" class="hidden">
        <div class="row">
          <!-- Información básica del vehículo -->
          <div class="card">
            <h3>🚗 Información del Vehículo</h3>
            <div id="fichaInfoBasica"></div>
          </div>
          
          <!-- Estadísticas de rendimiento -->
          <div class="card">
            <h3>📊 Estadísticas de Rendimiento</h3>
            <div id="fichaEstadisticas"></div>
          </div>
        </div>
        
        <div class="row">
          <!-- Costos y mantenimiento -->
          <div class="card">
            <h3>💰 Análisis de Costos</h3>
            <div id="fichaCostos"></div>
          </div>
          
          <!-- Sistema Completo de Alertas -->
          <div class="card">
            <h3>🚨 Sistema Completo de Alertas</h3>
            <div style="margin-bottom: 16px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div style="background: #fff3cd; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">🔧 Mantenimientos</div>
                  <div id="alertasMantenimiento">0</div>
                </div>
                <div style="background: #d1ecf1; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">🛡️ Pólizas</div>
                  <div id="alertasPolizas">0</div>
                </div>
                <div style="background: #d4edda; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">🔍 RTV</div>
                  <div id="alertasRTV">0</div>
                </div>
                <div style="background: #f8d7da; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">⚠️ Revisiones</div>
                  <div id="alertasRevisiones">0</div>
                </div>
                <div style="background: #fce4ec; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">⛽ Combustible</div>
                  <div id="alertasCombustible">0</div>
                </div>
              </div>
            </div>
            <div id="fichaAlertas" style="max-height: 300px; overflow-y: auto;"></div>
          </div>
          
          <!-- Estado de Emails Automáticos -->
          <div class="card" data-roles="admin">
            <h3>✅ Sistema de Emails Automáticos</h3>
            
            <!-- Estado SendGrid -->
            <div style="background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <p style="margin: 0; font-weight: bold; color: #16a34a;">
                🚀 Estado: Activo y Funcionando
              </p>
              <p style="margin: 4px 0 0 0; font-size: 0.9em; color: #15803d;">
                SendGrid configurado - Emails automáticos enviándose 24/7
              </p>
              <p style="margin: 4px 0 0 0; font-size: 0.85em; color: #166534;">
                📧 Destinatario: contabilidad2@arenalmanoa.com
              </p>
            </div>
            
            <!-- Tipos de alertas activas -->
            <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px 0; color: var(--ink);">📨 Alertas Automáticas Activas:</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 0.9em;">
                <div>🔧 Mantenimientos próximos</div>
                <div>⛽ Consumo de combustible</div>
                <div>🚗 Revisiones RTV</div>
                <div>📋 Vencimiento de pólizas</div>
                <div>👨‍💼 Retorno de choferes</div>
                <div>🚨 Alertas del sistema</div>
              </div>
            </div>
            
            <!-- Acciones disponibles -->
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button onclick="testEmailSystem()" class="primary" style="flex: 1; min-width: 140px;">
                🧪 Probar Email de Prueba
              </button>
              <button onclick="checkAlerts()" class="secondary" style="flex: 1; min-width: 120px;">
                🔍 Verificar Alertas Activas
              </button>
            </div>
            
            <!-- Información del sistema -->
            <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; font-size: 0.9em;">
              <strong>💡 Sistema SendGrid Integrado:</strong>
              <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                <li><strong>✅ Configuración automática:</strong> No requiere configuración manual</li>
                <li><strong>🚀 Alta disponibilidad:</strong> 99.9% de entrega garantizada</li>
                <li><strong>📊 100 emails/día gratis:</strong> Suficiente para operaciones del hotel</li>
                <li><strong>🔒 Seguro y confiable:</strong> Sin bloqueos de Railway</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">📈 Historial Detallado</h3>
            <div>
              <button class="export-btn" onclick="exportarFichaTecnicaCompleta()">📊 Exportar Ficha Completa</button>
              <button class="secondary" onclick="previsualizarFicha()">👁️ Vista Previa</button>
            </div>
          </div>
          <div id="fichaHistorial"></div>
        </div>
      </div>
    </section>

    <section id="tab-polizas" class="tabpanel hidden">
      <div class="card" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px 0;color:var(--ink)">+ Póliza / + RTV</h3>
        <div class="row">
          <div>
            <div class="row"><div><label>Vehículo</label><select id="pVeh"></select></div><div><label>Aseguradora</label><input id="pAseg" type="text" placeholder="INS"/></div></div>
            <div class="row"><div><label>N° Póliza</label><input id="pNum" type="text"/></div><div><label>Vence (póliza)</label><input id="pVence" type="date"/></div></div>
            <div><button class="secondary" onclick="guardarPoliza(event)">Guardar póliza</button></div>
          </div>
          <div>
            <div class="row"><div><label>Vehículo</label><select id="rtvVeh"></select></div><div><label>N° Cita</label><input id="rCita" type="text"/></div></div>
            <div class="row"><div><label>Vence (RTV)</label><input id="rVence" type="date"/></div><div></div></div>
            <div><button class="secondary" onclick="guardarRTV(event)">Guardar RTV</button></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>Pólizas</strong><select id="fltPolVencer" onchange="renderPolizas()"><option value="">Todas</option><option value="30">Solo ≤30 días</option><option value="7">Solo ≤7 días</option></select></div>
          <table><thead><tr><th>Placa</th><th>Aseguradora</th><th>N° Póliza</th><th>Vence</th><th>Semáforo</th><th>Acciones</th></tr></thead><tbody id="tblPol"></tbody></table>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>RTV</strong><select id="fltRtvVencer" onchange="renderRtv()"><option value="">Todas</option><option value="30">Solo ≤30 días</option><option value="7">Solo ≤7 días</option></select></div>
          <table><thead><tr><th>Placa</th><th>N° Cita</th><th>Vence</th><th>Semáforo</th><th>Acciones</th></tr></thead><tbody id="tblRtv"></tbody></table>
        </div>
      </div>
    </section>

    <section id="tab-mantenimientos" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarMantenimiento(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">+ Mantenimiento</h3>
          <div class="row"><div><label>Vehículo</label><select id="mVeh"></select></div><div><label>Tipo</label><select id="mTipo" onchange="toggleMaintenanceFields()"><option value="cambio_aceite">🛫 Cambio de aceite</option><option value="mantenimiento_preventivo">🔧 Mantenimiento Preventivo</option><option value="llantas">😞 Llantas</option><option value="frenos">🛑 Frenos</option><option value="bateria">🔋 Batería</option><option value="alineacion">⚖️ Alineación</option><option value="otro">📝 Otro</option></select></div></div>
          <div class="row"><div><label>Fecha</label><input id="mFecha" type="date" required/></div><div><label>Costo</label><input id="mCosto" type="number" min="0" step="0.01" required/></div></div>
          
          <!-- Campos de alertas duales -->
          <div class="row" id="maintenanceKmFields"><div><label>Km actual</label><input id="mKm" type="number" min="0"/></div><div><label>Próximo km</label><input id="mProx" type="number" min="0" placeholder="Kilometraje del próximo servicio"/></div></div>
          <div class="row" id="maintenanceDateFields"><div><label>Próxima fecha</label><input id="mProxFecha" type="date" placeholder="Fecha del próximo servicio"/></div><div><label>Último cambio aceite (km)</label><input id="mKmPrevAceite" type="number" readonly/></div></div>
          <div><label>Observaciones</label><input id="mObs" type="text" placeholder="Detalles"/></div>
          <div style="margin-top:12px;display:flex;gap:8px"><button>Guardar</button><button type="button" class="secondary" onclick="autoProximoKm()">Sugerir próximo (+5,000)</button></div>
        </form>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>🔧 Histórico de Mantenimientos</strong>
            <div style="display:flex;gap:8px">
              <select id="fltMantPlaca" onchange="renderMant()">
                <option value="">📋 Todas las placas</option>
              </select>
              <select id="fltMantTipo" onchange="renderMant()">
                <option value="">🔧 Todos los tipos</option>
                <option value="cambio_aceite">🛢️ Cambio de aceite</option>
                <option value="llantas">🛞 Llantas</option>
                <option value="frenos">🛑 Frenos</option>
                <option value="bateria">🔋 Batería</option>
                <option value="alineacion">⚖️ Alineación</option>
                <option value="transmision">⚙️ Transmisión</option>
                <option value="motor">🏎️ Motor</option>
                <option value="suspension">🔩 Suspensión</option>
                <option value="aire_acondicionado">❄️ Aire Acondicionado</option>
                <option value="otro">📝 Otro</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Costo</th>
                <th>Km</th>
                <th>Próx.</th>
                <th>Obs</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblMant"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <span class="tag" id="sumMant"></span>
            <button class="export-btn" onclick="exportarMantenimientos()">📊 Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-combustible" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarCombustible(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">+ Carga de combustible</h3>
          <div class="row"><div><label>Vehículo</label><select id="cVeh" onchange="updatePreviousOdometer()"></select></div><div><label>Fecha</label><input id="cFecha" type="date" required/></div></div>
          <div class="row"><div><label>Litros</label><input id="cLitros" type="number" step="0.01" min="0.01" required oninput="calcCosto();calcKmLEstimado()"/></div><div><label>₡/Litro</label><input id="cPPL" type="number" step="0.01" min="0" required oninput="calcCosto();calcKmLEstimado()"/></div></div>
          <div class="row"><div><label>Odómetro km</label><input id="cOdo" type="number" min="0" required oninput="calcCosto();calcKmLEstimado()"/></div><div><label>Proveedor</label><input id="cProv" type="text"/></div></div>
          <div class="row"><div><label>Odómetro anterior</label><input id="cOdoPrev" type="number" readonly/></div><div><label>Km/L estimado</label><input id="cKmLEst" type="number" step="0.01" readonly/></div></div>
          <div class="row"><div><label>Costo total</label><input id="cCosto" type="number" readonly/></div><div></div></div>
          <div style="margin-top:12px"><button>Guardar</button></div>
        </form>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>⛽ Registros de Combustible</strong>
            <div style="display:flex;gap:8px">
              <select id="fltFuelPlaca" onchange="renderFuel()">
                <option value="">📋 Todas las placas</option>
              </select>
              <select id="fltFuelMes" onchange="renderFuel()">
                <option value="">📅 Todos los meses</option>
                <option value="1">Este mes</option>
                <option value="3">Últimos 3 meses</option>
                <option value="6">Últimos 6 meses</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Fecha</th>
                <th>Litros</th>
                <th>₡/L</th>
                <th>Costo</th>
                <th>Odómetro</th>
                <th>Km/L</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblFuel"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <span class="tag" id="sumFuel"></span>
              <span class="tag" id="avgKmL"></span>
            </div>
            <button class="export-btn" onclick="exportarCombustible()">📊 Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-bitacora" class="tabpanel hidden">
      <div class="row">
        <!-- Registro de Salida/Retorno -->
        <form class="card" onsubmit="procesarBitacora(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">📝 Registro de Bitácora</h3>
          
          <div class="row">
            <div>
              <label>Vehículo</label>
              <select id="bVeh" onchange="verificarEstadoVehiculo()" required></select>
            </div>
            <div>
              <label>Chofer</label>
              <input id="bChofer" type="text" placeholder="Nombre del chofer" required/>
            </div>
          </div>
          
          <div id="salidaFields">
            <h4 style="color: var(--primary); margin: 20px 0 10px 0;">🚗 SALIDA DEL VEHÍCULO</h4>
            <div class="row">
              <div>
                <label>Kilometraje de Salida</label>
                <input id="bKmSalida" type="number" min="0" required/>
              </div>
              <div>
                <label>Nivel de Combustible</label>
                <select id="bCombustibleSalida" required>
                  <option value="vacio">Vacío (E)</option>
                  <option value="1/4">1/4</option>
                  <option value="1/2">1/2</option>
                  <option value="3/4">3/4</option>
                  <option value="lleno">Lleno (F)</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Estado del Vehículo</label>
                <select id="bEstadoSalida" required>
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="requiere_atencion">Requiere Atención</option>
                </select>
              </div>
              <div>
                <label>Observaciones Salida</label>
                <input id="bObsSalida" type="text" placeholder="Observaciones opcionales"/>
              </div>
            </div>
          </div>
          
          <div id="retornoFields" class="hidden">
            <h4 style="color: var(--success); margin: 20px 0 10px 0;">🔄 RETORNO DEL VEHÍCULO</h4>
            <div class="row">
              <div>
                <label>Kilometraje de Retorno</label>
                <input id="bKmRetorno" type="number" min="0"/>
              </div>
              <div>
                <label>Nivel de Combustible</label>
                <select id="bCombustibleRetorno">
                  <option value="vacio">Vacío (E)</option>
                  <option value="1/4">1/4</option>
                  <option value="1/2">1/2</option>
                  <option value="3/4">3/4</option>
                  <option value="lleno">Lleno (F)</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Estado del Vehículo</label>
                <select id="bEstadoRetorno">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="requiere_atencion">Requiere Atención</option>
                </select>
              </div>
              <div>
                <label>Observaciones Retorno</label>
                <input id="bObsRetorno" type="text" placeholder="Observaciones del retorno"/>
              </div>
            </div>
          </div>
          
          <div style="margin-top:20px">
            <button type="submit" class="success" id="btnBitacora">📝 Registrar Salida</button>
            <button type="button" class="secondary" onclick="limpiarFormBitacora()">🗑️ Limpiar</button>
            <button type="button" class="btn-small danger" onclick="enviarAlertaRetornoPendiente()" title="Enviar alerta de retorno pendiente">⚠️ Alerta</button>
            <button type="button" class="btn-small" onclick="verificarEstadoBitacora()" title="Debug: Verificar estado actual" style="background:#6366f1;color:white">🔍 Debug</button>
          </div>
        </form>
        
        <!-- Histórico de Bitácora -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>📋 Histórico de Bitácora</strong>
            <div style="display:flex;gap:8px">
              <select id="fltBitacoraPlaca" onchange="renderBitacora()">
                <option value="">📋 Todas las placas</option>
              </select>
              <select id="fltBitacoraEstado" onchange="renderBitacora()">
                <option value="">📊 Todos los estados</option>
                <option value="en_curso">🔄 En Curso</option>
                <option value="completado">✅ Completado</option>
              </select>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Placa</th>
                  <th>Chofer</th>
                  <th>Salida</th>
                  <th>Retorno</th>
                  <th>Km Salida</th>
                  <th>Km Retorno</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tblBitacora"></tbody>
            </table>
          </div>
          <div style="margin-top:16px;display:flex;justify-content:end">
            <button class="export-btn" onclick="exportarBitacora()">📊 Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-revision" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarRevision(event)">
          <h3 style="margin:0 0 16px 0;color:var(--ink)">🔍 Nueva Revisión Detallada</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Vehículo</label>
              <select id="rVeh" required></select>
            </div>
            <div class="form-group">
              <label>Tipo de Revisión</label>
              <select id="rTipo">
                <option value="rutinaria">Rutinaria</option>
                <option value="preventiva">Preventiva</option>
                <option value="post_mantenimiento">Post-Mantenimiento</option>
                <option value="pre_viaje">Pre-Viaje</option>
                <option value="incidente">Por Incidente</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Fecha y Hora</label>
              <input id="rFecha" type="datetime-local" required/>
            </div>
            <div class="form-group">
              <label>Inspector</label>
              <input id="rInspector" type="text" placeholder="Nombre del inspector" required/>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Kilometraje Actual</label>
              <input id="rKm" type="number" min="0" required/>
            </div>
            <div class="form-group">
              <label>Nivel de Combustible</label>
              <select id="rNivelComb">
                <option value="vacio">Vacío (E)</option>
                <option value="1/4">1/4</option>
                <option value="1/2">1/2</option>
                <option value="3/4">3/4</option>
                <option value="lleno">Lleno (F)</option>
              </select>
            </div>
          </div>
          
          <!-- Revisiones de líquidos -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">🛢️ Revisión de Líquidos</h4>
            <div class="form-row-3">
              <div class="form-group">
                <label>Aceite de Motor</label>
                <select id="rAceiteMotor">
                  <option value="optimo">Óptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Líquido de Frenos</label>
                <select id="rLiquidoFrenos">
                  <option value="optimo">Óptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Coolant/Refrigerante</label>
                <select id="rCoolant">
                  <option value="optimo">Óptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>Líquido Limpiaparabrisas</label>
                <select id="rLimpiaparabrisas">
                  <option value="optimo">Óptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="vacio">Vacío</option>
                </select>
              </div>
              <div class="form-group">
                <label>Aceite de Transmisión</label>
                <select id="rAceiteTransmision">
                  <option value="optimo">Óptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="verificar">Verificar</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Líquido Dirección</label>
                <select id="rLiquidoDireccion">
                  <option value="optimo">Óptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Revisiones mecánicas -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">🔧 Revisión Mecánica</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Estado de Llantas</label>
                <select id="rEstadoLlantas">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="desgastadas">Desgastadas</option>
                  <option value="cambiar">Necesitan Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Presión de Llantas</label>
                <select id="rPresionLlantas">
                  <option value="correcta">Correcta</option>
                  <option value="baja">Baja</option>
                  <option value="alta">Alta</option>
                  <option value="revisar">Revisar</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Sistema de Frenos</label>
                <select id="rSistemaFrenos">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="revisar">Revisar</option>
                  <option value="urgente">Atención Urgente</option>
                </select>
              </div>
              <div class="form-group">
                <label>Batería</label>
                <select id="rBateria">
                  <option value="excelente">Excelente</option>
                  <option value="buena">Buena</option>
                  <option value="regular">Regular</option>
                  <option value="debil">Débil</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Revisiones eléctricas y exteriores -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">💡 Sistema Eléctrico y Exterior</h4>
            <div class="form-row-3">
              <div class="form-group">
                <label>Luces Delanteras</label>
                <select id="rLucesDelanteras">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
              <div class="form-group">
                <label>Luces Traseras</label>
                <select id="rLucesTraseras">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
              <div class="form-group">
                <label>Direccionales</label>
                <select id="rLucesDireccionales">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>Luces de Freno</label>
                <select id="rLucesFreno">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
              <div class="form-group">
                <label>Luces de Reversa</label>
                <select id="rLucesReversa">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
              <div class="form-group">
                <label>Espejos Laterales</label>
                <select id="rEspejosLaterales">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>Espejo Retrovisor</label>
                <select id="rEspejoRetrovisor">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
              <div class="form-group">
                <label>Limpiaparabrisas</label>
                <select id="rLimpiapFisico">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
              <div class="form-group">
                <label>Cinturones</label>
                <select id="rCinturones">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>Bocina</label>
                <select id="rBocina">
                  <option value="1">✅ Buen Estado</option>
                  <option value="0">❌ Mal Estado</option>
                </select>
              </div>


            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Estado General de Carrocería</label>
              <select id="rEstadoCarroceria">
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="rayones_menores">Rayones Menores</option>
                <option value="golpes_menores">Golpes Menores</option>
                <option value="daños_mayores">Daños Mayores</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado del Interior</label>
              <select id="rEstadoInterior">
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="desgastado">Desgastado</option>
                <option value="necesita_limpieza">Necesita Limpieza</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Observaciones Generales</label>
            <textarea id="rObservaciones" rows="3" placeholder="Describa cualquier anomalía, recomendación o comentario adicional..."></textarea>
          </div>
          
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Guardar Revisión</button>
            <button type="button" class="secondary" onclick="limpiarFormRevision()">🗑️ Limpiar</button>
          </div>
        </form>
        
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>🔍 Histórico de Revisiones</strong>
            <div style="display:flex;gap:8px">
              <select id="fltRevPlaca" onchange="renderRevisiones()">
                <option value="">📋 Todas las placas</option>
              </select>
              <select id="fltRevTipo" onchange="renderRevisiones()">
                <option value="">🔍 Todos los tipos</option>
                <option value="rutinaria">Rutinaria</option>
                <option value="preventiva">Preventiva</option>
                <option value="post_mantenimiento">Post-Mantenimiento</option>
                <option value="pre_viaje">Pre-Viaje</option>
                <option value="incidente">Por Incidente</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Inspector</th>
                <th>Fecha</th>
                <th>Km</th>
                <th>Estado General</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblRevisiones"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:end">
            <button class="export-btn" onclick="exportarRevisiones()">📊 Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-alertas-config" class="tabpanel hidden">
      <div class="card">
        <h3 style="margin:0 0 20px 0">⚠️ Configuración de Alertas Automáticas</h3>
        
        <form onsubmit="guardarConfigAlertas(event)">
          <!-- Email de Destino -->
          <div class="form-group">
            <label>📧 Email de Destino para Alertas</label>
            <input id="alertaEmail" type="email" placeholder="contabilidad2@arenalmanoa.com" required/>
          </div>
          
          <!-- Estado Email Automático -->
          <div class="card" style="background:#d4edda;margin:20px 0;border-left:4px solid #28a745">
            <h4 style="margin:0 0 16px 0;color:#155724">✅ Sistema de Email Automático Configurado</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center">
              <div>
                <p style="margin:0;font-size:0.9em;color:#155724">
                  <strong>🚀 SendGrid Activo:</strong> Emails enviándose automáticamente<br>
                  <strong>📧 Destinatario:</strong> contabilidad2@arenalmanoa.com<br>
                  <strong>📊 Límite diario:</strong> 100 emails gratuitos<br>
                  <strong>🔄 Estado:</strong> Operativo 24/7
                </p>
              </div>
              <div style="text-align:center">
                <button type="button" class="primary" onclick="probarEmailAutomatico()" style="margin-top:12px">
                  🧪 Probar Email de Prueba
                </button>
              </div>
            </div>
          </div>
          
          <!-- Tipos de Alertas -->
          <div class="card" style="background:#f8fafc;margin:20px 0">
            <h4 style="margin:0 0 16px 0">📋 Tipos de Alertas a Enviar</h4>
            <div class="form-row">
              <div style="display:flex;gap:20px;flex-wrap:wrap">
                <label><input type="checkbox" id="alertaMant" checked/> 🔧 Mantenimientos por vencer</label>
                <label><input type="checkbox" id="alertaPolizas" checked/> 🛡️ Pólizas por vencer</label>
                <label><input type="checkbox" id="alertaRTV" checked/> 🔍 RTV por vencer</label>
              </div>
            </div>
            <div class="form-row">
              <div style="display:flex;gap:20px;flex-wrap:wrap">
                <label><input type="checkbox" id="alertaRevisiones" checked/> ⚠️ Fallas en revisiones</label>
                <label><input type="checkbox" id="alertaCombustible" checked/> ⛽ Anomalías de combustible</label>
                <label><input type="checkbox" id="alertaBitacora" checked/> 📝 Inconsistencias en bitácora</label>
              </div>
            </div>
          </div>
          
          <!-- Configuración de Anticipación -->
          <div class="card" style="background:#f8fafc;margin:20px 0">
            <h4 style="margin:0 0 16px 0">⏰ Días de Anticipación</h4>
            <div class="form-row-3">
              <div class="form-group">
                <label>Pólizas (días)</label>
                <input id="diasPolizas" type="number" min="1" max="365" value="30"/>
              </div>
              <div class="form-group">
                <label>RTV (días)</label>
                <input id="diasRTV" type="number" min="1" max="365" value="30"/>
              </div>
              <div class="form-group">
                <label>Mantenimientos (días)</label>
                <input id="diasMant" type="number" min="1" max="365" value="30"/>
              </div>
            </div>
          </div>
          
          <!-- Configuración de Kilometraje -->
          <div class="card" style="background:#f8fafc;margin:20px 0">
            <h4 style="margin:0 0 16px 0">🚗 Alertas de Kilometraje</h4>
            <div class="form-group">
              <label>Diferencia de km para alerta de bitácora</label>
              <input id="kmDiferencia" type="number" min="1" max="1000" value="10"/>
              <small style="color:var(--muted)">Se enviará alerta si la diferencia de kilometraje entre registros es mayor a este valor</small>
            </div>
          </div>
          
          <!-- Estado Actual -->
          <div id="estadoAlertas" class="card" style="background:#e8f5e8;margin:20px 0">
            <h4 style="margin:0 0 12px 0;color:#2e7d2e">📊 Estado Actual del Sistema</h4>
            <div id="estadoAlertasContent">
              <p>Cargando estado del sistema...</p>
            </div>
          </div>
          
          <!-- Backup Manual de Base de Datos -->
          <div class="card" style="background:#fff3cd;margin:20px 0;border-left:4px solid #ffc107">
            <h4 style="margin:0 0 16px 0;color:#856404">💾 Backup Manual de Railway → GitHub</h4>
            <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:center">
              <div>
                <p style="margin:0 0 8px 0;font-size:0.9em;color:#856404">
                  <strong>🛡️ Protección de datos:</strong> Respalda toda la base de datos de Railway<br>
                  <strong>📂 Destino:</strong> GitHub repository en carpeta <code>api_backups/</code><br>
                  <strong>📋 Incluye:</strong> SQLite + JSON export + estadísticas + metadatos<br>
                  <strong>🕐 Recomendado:</strong> Ejecutar antes de cambios importantes<br>
                  <strong>⚡ Evita pérdida de datos:</strong> Respaldo seguro en la nube
                </p>
                <div id="backupStatus" style="margin-top:8px">
                  <span class="tag" style="background:#d4edda;color:#155724">✅ Sistema listo</span>
                </div>
              </div>
              <div style="text-align:center">
                <button type="button" class="primary" onclick="ejecutarBackupManual()" id="btnBackupManual">
                  🚀 Respaldar Railway
                </button>
                <div style="margin-top:8px">
                  <small style="color:#856404">
                    <span id="ultimoBackup">Verificando último backup...</span>
                  </small>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
            <button type="submit" class="success">💾 Guardar Configuración</button>
            <button type="button" class="secondary" onclick="probarAlertas()">📧 Probar Alertas</button>
            <button type="button" class="secondary" onclick="verificarAlertasManual()">🔍 Verificar Alertas Ahora</button>
          </div>
        </form>
      </div>
      
      <!-- Historial de Alertas -->
      <div class="card" style="margin-top:20px">
        <h3>📜 Historial de Alertas Enviadas</h3>
        <div id="historialAlertas">
          <p style="color:var(--muted)">El historial de alertas se mostrará aquí...</p>
        </div>
      </div>
    </section>

    <section id="tab-reportes" class="tabpanel hidden">
      <div class="card">
        <h3 style="margin:0 0 20px 0">📊 Generador de Reportes</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Reporte</label>
            <select id="repTipo" onchange="actualizarConfigReporte()">
              <option value="mantenimientos">🔧 Mantenimientos</option>
              <option value="combustible">⛽ Combustible</option>
              <option value="revisiones">🔍 Revisiones</option>
              <option value="polizas_rtv">🛡️ Pólizas & RTV</option>
              <option value="ficha_vehiculo">📋 Ficha Técnica por Vehículo</option>
              <option value="resumen_costos">💰 Resumen de Costos</option>
              <option value="alertas">⚠️ Alertas y Vencimientos</option>
              <option value="resumen_general">📊 Resumen General de Flota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Vehículo (opcional)</label>
            <select id="repPlaca">
              <option value="">📋 Todos los vehículos</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Inicio</label>
            <input id="repA" type="date"/>
          </div>
          <div class="form-group">
            <label>Fecha de Fin</label>
            <input id="repB" type="date"/>
          </div>
        </div>
        
        <div class="form-row" id="repConfigAdicional">
          <!-- Se llenará dinámicamente según el tipo de reporte -->
        </div>
        
        <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
          <button class="success" onclick="previsualizarReporte()">👁️ Vista Previa</button>
          <button class="export-btn" onclick="exportReportXLSX()">📊 Exportar Excel</button>
          <button class="secondary" onclick="enviarReporteEmail()">📧 Enviar por Email</button>
        </div>
      </div>
      
      <!-- Área de vista previa -->
      <div id="reportePreview" class="hidden">
        <div class="card">
          <div class="modal-header">
            <h3 class="modal-title">👁️ Vista Previa del Reporte</h3>
            <button class="close-btn" onclick="cerrarPreviewReporte()">×</button>
          </div>
          
          <div class="report-preview" id="reporteContent">
            <!-- El contenido del reporte se generará aquí -->
          </div>
          
          <div style="margin-top:20px;text-align:center">
            <button class="export-btn" onclick="exportReportXLSX()">📊 Exportar a Excel</button>
            <button class="secondary" onclick="imprimirReporte()">🖨️ Imprimir</button>
            <button class="secondary" onclick="cerrarPreviewReporte()">✖️ Cerrar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Botón Flotante Desplegable -->
    <div class="floating-fab" id="floatingFab">
      <!-- Botón principal toggle -->
      <div class="fab-toggle" id="fabToggle" onclick="toggleFab()">
        <span class="fab-icon" id="fabIcon">⚡</span>
      </div>
      
      <!-- Menú desplegable -->
      <div class="fab-menu" id="fabMenu">
        <button class="fab-action" onclick="setTab('mantenimientos')" data-roles="admin,operador" title="Agregar Mantenimiento">
          <span class="fab-action-icon">🔧</span>
          <span class="fab-action-text">Mantenimiento</span>
        </button>
        <button class="fab-action" onclick="setTab('combustible')" data-roles="admin,operador" title="Agregar Combustible">
          <span class="fab-action-icon">⛽</span>
          <span class="fab-action-text">Combustible</span>
        </button>
        <button class="fab-action" onclick="setTab('revision')" data-roles="admin,supervisor" title="Agregar Revisión">
          <span class="fab-action-icon">🔍</span>
          <span class="fab-action-text">Revisión</span>
        </button>
      </div>
    </div>
    
    <!-- Modales de Edición -->
    
    <!-- Modal Editar Vehículo -->
    <div id="modalEditVehiculo" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">✏️ Editar Vehículo</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditVehiculo')">×</button>
        </div>
        <form onsubmit="actualizarVehiculo(event)">
          <input type="hidden" id="editVehId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Placa</label>
              <input id="editVPlaca" type="text" required/>
            </div>
            <div class="form-group">
              <label>Marca</label>
              <input id="editVMarca" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Modelo</label>
              <input id="editVModelo" type="text" required/>
            </div>
            <div class="form-group">
              <label>Año</label>
              <input id="editVAnio" type="number" min="1990" max="2100" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tipo</label>
              <select id="editVTipo">
                <option value="sedán">Sedán</option>
                <option value="pickup">Pickup</option>
                <option value="SUV">SUV</option>
                <option value="buseta">Buseta</option>
                <option value="hatchback">Hatchback</option>
                <option value="minivan">Minivan</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editVEstado">
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
                <option value="mantenimiento">En Mantenimiento</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Dueño</label>
              <input id="editVDueno" type="text" placeholder="Ej: Hotel, Juan Pérez, Empresa XYZ"/>
            </div>
            <div class="form-group">
              <label>Número de Póliza</label>
              <input id="editVPoliza" type="text"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Aseguradora</label>
              <input id="editVAseguradora" type="text"/>
            </div>
            <div class="form-group">
              <label>Color</label>
              <input id="editVColor" type="text"/>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditVehiculo'); return false;">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Mantenimiento -->
    <div id="modalEditMantenimiento" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">✏️ Editar Mantenimiento</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditMantenimiento')">×</button>
        </div>
        <form onsubmit="actualizarMantenimiento(event)">
          <input type="hidden" id="editMantId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Vehículo</label>
              <select id="editMVeh" required></select>
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <select id="editMTipo">
                <option value="cambio_aceite">🛢️ Cambio de aceite</option>
                <option value="mantenimiento_preventivo">🔧 Mantenimiento Preventivo</option>
                <option value="llantas">🛞 Llantas</option>
                <option value="frenos">🛑 Frenos</option>
                <option value="bateria">🔋 Batería</option>
                <option value="alineacion">⚖️ Alineación</option>
                <option value="transmision">⚙️ Transmisión</option>
                <option value="motor">🏎️ Motor</option>
                <option value="suspension">🔩 Suspensión</option>
                <option value="aire_acondicionado">❄️ Aire Acondicionado</option>
                <option value="otro">📝 Otro</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input id="editMFecha" type="date" required/>
            </div>
            <div class="form-group">
              <label>Costo</label>
              <input id="editMCosto" type="number" min="0" step="0.01" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Km actual</label>
              <input id="editMKm" type="number" min="0"/>
            </div>
            <div class="form-group">
              <label>Próximo km</label>
              <input id="editMProx" type="number" min="0"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Próxima fecha</label>
              <input id="editMProxFecha" type="date"/>
            </div>
            <div class="form-group">
              <label></label>
              <div style="color: var(--muted); font-size: 0.8em; padding-top: 8px;">Solo para Cambio de Aceite y Mantenimiento Preventivo</div>
            </div>
          </div>
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editMObs" rows="3"></textarea>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditMantenimiento'); return false;">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Combustible -->
    <div id="modalEditCombustible" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">✏️ Editar Registro de Combustible</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditCombustible')">×</button>
        </div>
        <form onsubmit="actualizarCombustible(event)">
          <input type="hidden" id="editFuelId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Vehículo</label>
              <select id="editCVeh" required></select>
            </div>
            <div class="form-group">
              <label>Fecha</label>
              <input id="editCFecha" type="date" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Litros</label>
              <input id="editCLitros" type="number" step="0.01" min="0.01" required/>
            </div>
            <div class="form-group">
              <label>₡/Litro</label>
              <input id="editCPPL" type="number" step="0.01" min="0" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Odómetro km</label>
              <input id="editCOdo" type="number" min="0" required/>
            </div>
            <div class="form-group">
              <label>Proveedor</label>
              <input id="editCProv" type="text"/>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditCombustible'); return false;">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Póliza -->
    <div id="modalEditPoliza" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">✏️ Editar Póliza</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditPoliza')">×</button>
        </div>
        <form onsubmit="actualizarPoliza(event)">
          <input type="hidden" id="editPolizaId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Vehículo</label>
              <select id="editPVeh" required></select>
            </div>
            <div class="form-group">
              <label>Aseguradora</label>
              <input id="editPAseg" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>N° Póliza</label>
              <input id="editPNum" type="text" required/>
            </div>
            <div class="form-group">
              <label>Fecha Vencimiento</label>
              <input id="editPVence" type="date" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tipo Cobertura</label>
              <select id="editPTipo">
                <option value="Básica">Básica</option>
                <option value="Completa">Completa</option>
                <option value="Terceros">Terceros</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editPEstado">
                <option value="Activa">Activa</option>
                <option value="Vencida">Vencida</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditPoliza'); return false;">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar RTV -->
    <div id="modalEditRTV" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">✏️ Editar RTV</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditRTV')">×</button>
        </div>
        <form onsubmit="actualizarRTV(event)">
          <input type="hidden" id="editRTVId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Vehículo</label>
              <select id="editRevisionVeh" required></select>
            </div>
            <div class="form-group">
              <label>N° Cita</label>
              <input id="editRCita" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha Vencimiento</label>
              <input id="editRVence" type="date" required/>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editREstado">
                <option value="Vigente">Vigente</option>
                <option value="Vencido">Vencido</option>
                <option value="Pendiente">Pendiente</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editRevisionObs1" rows="3"></textarea>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditRTV'); return false;">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Revisión -->
    <div id="modalEditRevision" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">✏️ Editar Revisión</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditRevision')">×</button>
        </div>
        <form onsubmit="actualizarRevision(event)">
          <input type="hidden" id="editRevisionId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Vehículo</label>
              <select id="editRevisionVehRev" required></select>
            </div>
            <div class="form-group">
              <label>Inspector</label>
              <input id="editRInspector" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input id="editRFecha" type="date" required/>
            </div>
            <div class="form-group">
              <label>Aprobado</label>
              <label class="checkbox-container">
                <input id="editRAprobado" type="checkbox"/>
                <span class="checkmark"></span>
                Revisión aprobada
              </label>
            </div>
          </div>
          
          <h4 style="color: var(--primary); margin: 20px 0 10px 0;">🔍 Estados de Componentes</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Estado Motor</label>
              <select id="editRMotor">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado Frenos</label>
              <select id="editRFrenos">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Estado Luces</label>
              <select id="editRLuces">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado Llantas</label>
              <select id="editRLlantas">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Estado Carrocería</label>
              <select id="editRCarroceria">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="daños_menores">Daños menores</option>
                <option value="daños_mayores">Daños mayores</option>
              </select>
            </div>
            <div></div>
          </div>
          
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editRevisionObs2" rows="3" placeholder="Observaciones generales de la revisión..."></textarea>
          </div>
          
          <div style="margin-top:20px">
            <button type="submit" class="success">💾 Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditRevision'); return false;">❌ Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Navegación móvil compacta -->
  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-nav-grid" id="mobileNavGrid">
      <!-- Se llenará dinámicamente con JavaScript -->
    </div>
  </div>

  <div class="footer">
    Sistema de Gestión Vehicular - Hotel © 2024 | Conectado a Google Sheets vía Apps Script
  </div>
  </div> <!-- Cierre mainApp -->

  <script>
  // ====== API: Backend Python FastAPI ======
  const API = "https://mantenimiento-vehiculos-production.up.railway.app"; // Railway production API
  const API_KEY = ""; // si activas API key, colócala aquí

  // ====== ESTADO ======
  let Vehiculos=[], Polizas=[], RTV=[], Mantenimientos=[], Combustible=[], Bitacora=[], Alertas=[], Revisiones=[];
  let currentUser = null;
  let currentBitacoraId = null; // Para manejar retorno de vehículos
  let kpiMonitorInterval = null; // Para monitoreo de KPIs
  let sessionTimeout = null; // Timer para timeout de sesión
  let lastActivity = Date.now(); // Última actividad del usuario
  
  // ====== SISTEMA DE ROLES Y LOGIN ======
  const ROLES = {
    admin: {
      name: 'Administrador',
      password: 'Admin',
      permissions: ['dashboard', 'vehiculos', 'ficha-tecnica', 'polizas', 'mantenimientos', 'combustible', 'bitacora', 'revision', 'alertas-config', 'reportes']
    },
    operador: {
      name: 'Operador',
      password: 'operador123', 
      permissions: ['dashboard', 'mantenimientos', 'combustible', 'bitacora']
    },
    supervisor: {
      name: 'Supervisor',
      password: 'supervisor123',
      permissions: ['dashboard', 'revision', 'bitacora']
    }
  };
  
  let selectedRole = null;

  // ====== MANEJO DE SESIÓN ======
  const SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutos en milisegundos
  
  function saveSession() {
    if (currentUser) {
      const sessionData = {
        user: currentUser,
        timestamp: Date.now(),
        role: selectedRole
      };
      localStorage.setItem('vehicularSession', JSON.stringify(sessionData));
      console.log('💾 Sesión guardada');
    }
  }
  
  function loadSession() {
    try {
      const sessionData = JSON.parse(localStorage.getItem('vehicularSession'));
      if (sessionData) {
        const now = Date.now();
        const sessionAge = now - sessionData.timestamp;
        
        if (sessionAge < SESSION_TIMEOUT) {
          currentUser = sessionData.user;
          selectedRole = sessionData.role;
          lastActivity = now;
          
          console.log('🔄 Sesión restaurada:', currentUser.name);
          return true;
        } else {
          console.log('⏰ Sesión expirada');
          localStorage.removeItem('vehicularSession');
        }
      }
    } catch (e) {
      console.log('❌ Error cargando sesión:', e);
    }
    return false;
  }
  
  function updateActivity() {
    lastActivity = Date.now();
    if (currentUser) {
      saveSession(); // Actualizar timestamp de sesión
    }
  }
  
  function startSessionTimer() {
    if (sessionTimeout) clearTimeout(sessionTimeout);
    
    sessionTimeout = setTimeout(() => {
      const timeSinceActivity = Date.now() - lastActivity;
      if (timeSinceActivity >= SESSION_TIMEOUT) {
        alert('⏰ Sesión expirada por inactividad. Debe volver a iniciar sesión.');
        logout();
      } else {
        startSessionTimer(); // Reiniciar timer
      }
    }, SESSION_TIMEOUT);
  }
  
  // Detectar actividad del usuario
  document.addEventListener('click', updateActivity);
  document.addEventListener('keypress', updateActivity);
  document.addEventListener('scroll', updateActivity);
  
  function selectRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-card').forEach(card => {
      card.classList.remove('selected');
    });
    document.querySelector(`[data-role="${role}"]`).classList.add('selected');
    
    // Enfocar campo de contraseña con delay para móvil
    setTimeout(() => {
      const passwordField = document.getElementById('loginPassword');
      if (passwordField) {
        passwordField.focus();
        
        // En móvil, scroll al campo de contraseña
        if (window.innerWidth <= 768) {
          passwordField.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }
      }
    }, 100);
    
    document.querySelector('.login-btn').disabled = false;
  }
  
  function attemptLogin() {
    const password = document.getElementById('loginPassword').value;
    
    if (!selectedRole || !password) {
      alert('Por favor seleccione un rol e ingrese la contraseña');
      return;
    }
    
    if (ROLES[selectedRole] && ROLES[selectedRole].password === password) {
      currentUser = {
        role: selectedRole,
        name: ROLES[selectedRole].name,
        permissions: ROLES[selectedRole].permissions
      };
      
      // Cerrar todos los modales antes de mostrar la app
      cerrarTodosLosModales();
      
      // Ocultar login y mostrar app
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').classList.add('logged-in');
      
      // Ir a la primera pestaña disponible según el rol
      const firstAvailableTab = currentUser.permissions[0] || 'dashboard';
      setTab(firstAvailableTab);
      
      // FORZAR ACTUALIZACIÓN DE KPIS DESPUÉS DE LOGIN
      if (firstAvailableTab === 'dashboard') {
        setTimeout(() => {
          console.log('📊 Post-login: Forzando actualización de KPIs...');
          renderKpis();
          setTimeout(() => {
            const kpiElement = document.getElementById('kpiCostoTotalMes');
            if (kpiElement && (kpiElement.textContent === '-' || kpiElement.textContent === '₡0')) {
              console.log('🚨 Post-login: KPIs en ₡0, ejecutando fix agresivo...');
              forceKPIUpdate();
            }
          }, 2000);
        }, 1000);
      }
      
      // Actualizar UI según rol
      updateUIForRole();
      
      // Guardar sesión
      saveSession();
      
      // Iniciar timer de sesión
      startSessionTimer();
      
      // Cargar datos
      loadAll();
      
      alert(`¡Bienvenido, ${currentUser.name}!`);
    } else {
      alert('Contraseña incorrecta. Intente nuevamente.');
      document.getElementById('loginPassword').value = '';
    }
  }
  
  function logout() {
    if (confirm('¿Está seguro que desea cerrar sesión?')) {
      // Limpiar sesión
      currentUser = null;
      selectedRole = null;
      localStorage.removeItem('vehicularSession');
      
      if (sessionTimeout) {
        clearTimeout(sessionTimeout);
        sessionTimeout = null;
      }
      
      console.log('🔒 Sesión cerrada');
      
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('logged-in');
      document.getElementById('loginPassword').value = '';
      document.querySelectorAll('.role-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector('.login-btn').disabled = true;
    }
  }
  
  function updateUIForRole() {
    if (!currentUser) return;
    
    // Actualizar nombre de usuario en header
    document.getElementById('currentUserRole').textContent = currentUser.name;
    
    // Mostrar/ocultar tabs según permisos
    document.querySelectorAll('.tab[data-roles]').forEach(tab => {
      const roles = tab.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        tab.style.display = 'flex';
      } else {
        tab.style.display = 'none';
      }
    });
    
    // Mostrar/ocultar botones flotantes según permisos
    document.querySelectorAll('#stickyActions button[data-roles]').forEach(btn => {
      const roles = btn.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        btn.style.display = 'flex';
      } else {
        btn.style.display = 'none';
      }
    });
    
    // Mostrar/ocultar contenido (cards, divs) según permisos
    document.querySelectorAll('[data-roles]:not(.tab):not(button)').forEach(element => {
      const roles = element.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        element.style.display = 'block';
      } else {
        element.style.display = 'none';
      }
    });
    
    // Redirigir a dashboard si la tab actual no está permitida
    const currentTab = document.querySelector('.tab.active');
    if (currentTab && currentTab.dataset.roles && !currentTab.dataset.roles.split(',').includes(currentUser.role)) {
      setTab('dashboard');
    }
    
    // Actualizar navegación móvil si está activa
    if (mobileCompactMode) {
      setupMobileNavigation();
    }
  }
  
  function hasPermission(permission) {
    return currentUser && currentUser.permissions.includes(permission);
  }

  // ====== HELPERS ======
  const byId = id=> document.getElementById(id);
  const fmt = n=> new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC',maximumFractionDigits:0}).format(Number(n)||0);
  const vehById = id=> Vehiculos.find(v=> Number(v.id)===Number(id));
  const today = ()=> new Date().toISOString().slice(0,10);
  const diasRestantes = (iso)=> Math.ceil((new Date(iso) - new Date())/86400000);
  const semaforo = (d)=> d<=7? '<span class="pill dangerP">≤7d</span>' : (d<=30? '<span class="pill warnP">≤30d</span>' : '<span class="pill ok">OK</span>');

  function setTab(name){
    // Verificar permisos
    if (!hasPermission(name)) {
      alert('No tiene permisos para acceder a esta sección');
      return;
    }
    
    try{ localStorage.setItem('tab', name); }catch{}
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    const btn = document.querySelector(`.tab[data-tab="${name}"]`);
    if(btn) {
      btn.classList.add('active');
      
      // Scroll automático a la pestaña activa en móvil
      if (window.innerWidth <= 768) {
        const tabsContainer = document.querySelector('.tabs');
        if (tabsContainer) {
          const tabRect = btn.getBoundingClientRect();
          const containerRect = tabsContainer.getBoundingClientRect();
          
          if (tabRect.left < containerRect.left || tabRect.right > containerRect.right) {
            btn.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'nearest', 
              inline: 'center' 
            });
          }
        }
      }
    }
    
    document.querySelectorAll('.tabpanel').forEach(s=>s.classList.add('hidden'));
    const sec = byId('tab-'+name);
    if(sec) {
      sec.classList.remove('hidden');
      
      // Scroll suave al inicio de la sección en móvil
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
      }
      
      // Inicialización específica para pestaña de bitácora
      if (name === 'bitacora') {
        console.log('🚗 Accediendo a pestaña de bitácora, verificando estado...');
        initBitacoraForm();
      }
      
      // Inicialización para configuración de alertas (admin)
      if (name === 'alertas-config' && currentUser?.role === 'admin') {
        console.log('⚠️ Accediendo a configuración de alertas como administrador');
        verificarEstadoBackup();
      }
      
      // Inicialización específica para pestaña de configuración de alertas (admin)
      if (name === 'alertas-config') {
        console.log('⚙️ Accediendo a configuración de alertas...');
        setTimeout(verificarUltimoBackup, 500);
      }
      
      // FORZAR ACTUALIZACIÓN DE KPIs AL ACCEDER A DASHBOARD
      if (name === 'dashboard') {
        console.log('📊 Accediendo a dashboard, forzando actualización de KPIs...');
        setTimeout(() => {
          renderKpis();
          
          // Verificar y ejecutar fix agresivo si es necesario
          setTimeout(() => {
            const kpiElement = document.getElementById('kpiCostoTotalMes');
            if (kpiElement && (kpiElement.textContent === '-' || kpiElement.textContent === '₡0')) {
              console.log('🚨 Dashboard aún en ₡0, ejecutando fix agresivo...');
              forceKPIUpdate();
            }
          }, 1000);
        }, 500);
      }
    }
    render();
  }

  // ====== API CLIENT PARA FASTAPI ======
  
  // Función de retry automático para manejar errores de red
  async function retryOperation(operation, maxRetries = 3, delay = 1000) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        const isRetryable = error.message.includes('502') || 
                           error.message.includes('503') || 
                           error.message.includes('Failed to fetch');
        
        if (!isRetryable || attempt === maxRetries) {
          throw error;
        }
        
        console.log(`🔄 Reintentando ${attempt}/${maxRetries} después de error:`, error.message);
        
        // Delay progresivo: 500ms, 1s, 1.5s
        await new Promise(resolve => setTimeout(resolve, delay * attempt * 0.5));
      }
    }
  }

  async function apiGet(table){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}`;
    
    return await retryOperation(async () => {
      console.log('API GET:', url);
      
      const r = await fetch(url, { 
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors'
      });
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      const j = await r.json();
      console.log('API Response:', j);
      
      if(!j.success) throw new Error(j.error||'GET error');
      return j.data;
    }, 3, 500);
  }
  
  async function apiPost(table, data, action=null){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}`;
    
    return await retryOperation(async () => {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        cache: 'no-store'
      });
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      const contentType = r.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const j = await r.json();
        if (!j.success) {
          throw new Error(j.message || j.detail || j.error || 'POST error');
        }
        return j;
      } else {
        return { success: true, message: 'Operación completada exitosamente' };
      }
    }, 2, 1000); // Solo 2 intentos para POST (no queremos duplicar datos)
  }
  
  async function apiPut(table, id, data){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}/${id}`;
    
    try {
      const r = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        cache: 'no-store'
      });
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      const contentType = r.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const j = await r.json();
        if (!j.success) {
          throw new Error(j.message || j.detail || j.error || 'PUT error');
        }
        return j;
      } else {
        return { success: true, message: 'Actualización completada exitosamente' };
      }
    } catch (error) {
      console.error('API PUT Error:', error);
      if (error.message.includes('Unexpected token')) {
        throw new Error('Error del servidor: Respuesta inválida');
      }
      throw error;
    }
  }
  
  async function apiDelete(table, id){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}/${id}`;
    
    try {
      const r = await fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        cache: 'no-store'
      });
      
      // Check if the response is ok
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      // Try to parse JSON
      const contentType = r.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const j = await r.json();
        if (!j.success) {
          throw new Error(j.message || j.detail || 'DELETE error');
        }
        return j;
      } else {
        // If not JSON, it was successful (some endpoints might return text)
        return { success: true, message: 'Eliminado exitosamente' };
      }
    } catch (error) {
      // If it's a JSON parsing error, provide more context
      if (error.message.includes('Unexpected token')) {
        throw new Error('Error del servidor: Respuesta inválida');
      }
      throw error;
    }
  }

  // ====== CARGA INICIAL ======
  async function loadAll(){
    console.log('🔄 Cargando todos los datos...');
    try{
      // Cargar datos del nuevo backend
      Vehiculos = await apiGet('vehiculos');
      console.log('✅ Vehículos cargados:', Vehiculos.length);
      
      Mantenimientos = await apiGet('mantenimientos');
      console.log('✅ Mantenimientos cargados:', Mantenimientos.length);
      
      Combustible = await apiGet('combustible');
      console.log('✅ Combustible cargado:', Combustible.length);
      
      Revisiones = await apiGet('revisiones');
      console.log('✅ Revisiones cargadas:', Revisiones.length);
      
      Polizas = await apiGet('polizas');
      console.log('✅ Pólizas cargadas:', Polizas.length);
      
      RTV = await apiGet('rtv');
      console.log('✅ RTV cargados:', RTV.length);
      
      Bitacora = await apiGet('bitacora');
      console.log('✅ Bitácora cargada:', Bitacora.length);
      
      // Inicializar arrays vacíos para compatibilidad con el frontend
      Alertas = [];
      
      // Actualizar todas las vistas
      refreshAllViews();
      
      // EJECUTAR renderKpis() directamente después de cargar datos
      console.log('🎯 Ejecutando renderKpis() después de cargar todos los datos...');
      renderKpis();
      
      // SISTEMA DE VERIFICACIÓN Y RE-EJECUCIÓN GARANTIZADA
      setTimeout(() => {
        console.log('🔄 Verificando y re-ejecutando renderKpis() (backup 1s)...');
        renderKpis();
        
        // Verificar si los valores se actualizaron correctamente
        const kpiElement = document.getElementById('kpiCostoTotalMes');
        if (kpiElement && (kpiElement.textContent === '-' || kpiElement.textContent === '₡0')) {
          console.log('⚠️ KPIs aún en 0, ejecutando fix agresivo...');
          
          // Fix agresivo - calcular manualmente
          setTimeout(() => {
            console.log('🚨 EJECUTANDO FIX AGRESIVO DE KPIs...');
            forceKPIUpdate();
          }, 500);
        } else if (kpiElement) {
          console.log('✅ KPIs actualizados correctamente:', kpiElement.textContent);
        }
      }, 1000);
      
      // Backup adicional a los 3 segundos
      setTimeout(() => {
        console.log('🔄 Verificación final de KPIs (backup 3s)...');
        const kpiElement = document.getElementById('kpiCostoTotalMes');
        if (kpiElement && (kpiElement.textContent === '-' || kpiElement.textContent === '₡0')) {
          console.log('🚨 EJECUTANDO FIX FINAL DE EMERGENCIA...');
          forceKPIUpdate();
        }
        
        // INICIAR MONITOREO CONTINUO DESPUÉS DE CARGAR DATOS
        setTimeout(startKPIMonitoring, 2000);
      }, 3000);
      
      // Cargar configuración de alertas si es administrador
      if (currentUser && currentUser.role === 'admin') {
        setTimeout(() => {
          if (typeof cargarConfigAlertas === 'function') {
            cargarConfigAlertas();
          }
        }, 1000);
      }
      
      console.log('✅ Datos cargados exitosamente');
    }catch(e){
      console.error('❌ Error cargando datos:', e);
      alert('⚠️ Error cargando datos: ' + e.message + '\n\n🔄 Reintentando en unos segundos...');
      
      // Reintentar después de 3 segundos
      setTimeout(() => {
        loadAll();
      }, 3000);
    }
  }
  
  // SISTEMA DE MONITOREO CONTINUO DE KPIs
  function startKPIMonitoring() {
    // Limpiar monitoreo previo
    if (kpiMonitorInterval) {
      clearInterval(kpiMonitorInterval);
    }
    
    console.log('👀 Iniciando monitoreo continuo de KPIs...');
    
    kpiMonitorInterval = setInterval(() => {
      // Solo monitorear si estamos en dashboard y hay datos
      const currentTab = document.querySelector('.tab.active');
      if (currentTab && currentTab.dataset.tab === 'dashboard' && Combustible && Combustible.length > 0) {
        const kpiElement = document.getElementById('kpiCostoTotalMes');
        if (kpiElement && (kpiElement.textContent === '-' || kpiElement.textContent === '₡0')) {
          console.log('🚨 Monitor detectó KPIs en ₡0, corrigiendo...');
          forceKPIUpdate();
        }
      }
    }, 5000); // Verificar cada 5 segundos
  }
  
  function stopKPIMonitoring() {
    if (kpiMonitorInterval) {
      clearInterval(kpiMonitorInterval);
      kpiMonitorInterval = null;
      console.log('🛑 Monitoreo de KPIs detenido');
    }
  }
  
  // FUNCIÓN DE FIX AGRESIVO PARA KPIs - ULTRA-ROBUSTA 100% GARANTIZADA
  function forceKPIUpdate() {
    try {
      console.log('💪 === EJECUTANDO FIX ULTRA-ROBUSTO DE KPIs ===');
      
      // Verificación exhaustiva de datos
      console.log('🔍 Verificando estado de datos globales...');
      console.log('📊 Estado actual:', {
        'Combustible': Combustible ? `${Combustible.length} registros` : 'undefined/null',
        'Mantenimientos': Mantenimientos ? `${Mantenimientos.length} registros` : 'undefined/null',
        'Polizas': Polizas ? `${Polizas.length} registros` : 'undefined/null',
        'Vehiculos': Vehiculos ? `${Vehiculos.length} registros` : 'undefined/null'
      });
      
      // Si no hay datos de combustible, reintentar
      if (!Combustible || Combustible.length === 0) {
        console.log('❌ Array Combustible vacío o undefined, reintentando en 2 segundos...');
        setTimeout(forceKPIUpdate, 2000);
        return;
      }
      
      // Imprimir todos los registros de combustible para debugging
      console.log('📋 TODOS LOS REGISTROS DE COMBUSTIBLE:');
      Combustible.forEach((registro, index) => {
        console.log(`  ${index + 1}. ID: ${registro.id}, Vehículo: ${registro.vehiculo || registro.placa}, Fecha: ${registro.fecha}, Costo: ${registro.costo} (${typeof registro.costo}), Litros: ${registro.litros}`);
      });
      
      // Cálculo robusto de fechas con múltiples métodos
      const hoy = new Date();
      console.log('📅 Fecha actual completa:', hoy.toISOString());
      
      // Método 1: Inicio de mes estricto
      const inicioMes1 = new Date(hoy.getFullYear(), hoy.getMonth(), 1, 0, 0, 0, 0);
      console.log('📅 Inicio mes método 1:', inicioMes1.toISOString());
      
      // Método 2: Inicio de mes alternativo
      const inicioMes2 = new Date();
      inicioMes2.setDate(1);
      inicioMes2.setHours(0, 0, 0, 0);
      console.log('📅 Inicio mes método 2:', inicioMes2.toISOString());
      
      // Usar el método más estricto
      const inicioMes = inicioMes1;
      
      // Calcular gastos de combustible con logging detallado
      console.log('⛽ === CALCULANDO GASTOS DE COMBUSTIBLE ===');
      let gastosCombustibleMes = 0;
      let registrosValidos = 0;
      let registrosDelMes = 0;
      
      Combustible.forEach((registro, index) => {
        try {
          // Verificar fecha
          const fechaRegistro = new Date(registro.fecha);
          const fechaValida = !isNaN(fechaRegistro.getTime());
          
          if (!fechaValida) {
            console.log(`⚠️ Registro ${index + 1}: Fecha inválida "${registro.fecha}"`);
            return;
          }
          
          const esDelMesActual = fechaRegistro >= inicioMes && fechaRegistro <= hoy;
          
          console.log(`📅 Registro ${index + 1} (${registro.vehiculo || registro.placa}): ${registro.fecha} -> Es del mes: ${esDelMesActual}`);
          
          if (esDelMesActual) {
            registrosDelMes++;
            
            // Verificar costo
            const costo = parseFloat(registro.costo) || 0;
            if (costo > 0) {
              gastosCombustibleMes += costo;
              registrosValidos++;
              console.log(`💰 Sumando: ₡${costo.toLocaleString()} (Total: ₡${gastosCombustibleMes.toLocaleString()})`);
            } else {
              console.log(`⚠️ Registro ${index + 1}: Costo inválido o cero: "${registro.costo}"`);
            }
          }
        } catch (error) {
          console.error(`❌ Error procesando registro ${index + 1}:`, error);
        }
      });
      
      console.log(`📊 Resumen combustible: ${registrosDelMes} del mes, ${registrosValidos} válidos, Total: ₡${gastosCombustibleMes.toLocaleString()}`);
      
      // Si no hay registros del mes actual, buscar el más reciente como fallback
      if (gastosCombustibleMes === 0 && Combustible.length > 0) {
        console.log('🔍 No hay registros del mes actual, buscando registros recientes como fallback...');
        
        // Ordenar por fecha descendente y tomar los últimos registros
        const registrosOrdenados = [...Combustible].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        const ultimosRegistros = registrosOrdenados.slice(0, 3); // Últimos 3 registros
        
        ultimosRegistros.forEach(registro => {
          const costo = parseFloat(registro.costo) || 0;
          if (costo > 0) {
            console.log(`🎯 Fallback - Registro reciente: ${registro.vehiculo} (${registro.fecha}): ₡${costo.toLocaleString()}`);
            gastosCombustibleMes += costo;
          }
        });
        
        if (gastosCombustibleMes > 0) {
          console.log(`🔄 Fallback exitoso: ₡${gastosCombustibleMes.toLocaleString()}`);
        }
      }
      
      // Calcular gastos de mantenimiento con el mismo rigor
      console.log('🔧 === CALCULANDO GASTOS DE MANTENIMIENTO ===');
      let gastosMantenimientoMes = 0;
      
      if (Mantenimientos && Array.isArray(Mantenimientos) && Mantenimientos.length > 0) {
        Mantenimientos.forEach((registro, index) => {
          try {
            const fechaRegistro = new Date(registro.fecha);
            if (!isNaN(fechaRegistro.getTime()) && fechaRegistro >= inicioMes && fechaRegistro <= hoy) {
              const costo = parseFloat(registro.costo) || 0;
              if (costo > 0) {
                gastosMantenimientoMes += costo;
                console.log(`🔧 Mantenimiento ${index + 1}: ₡${costo.toLocaleString()}`);
              }
            }
          } catch (error) {
            console.error(`❌ Error procesando mantenimiento ${index + 1}:`, error);
          }
        });
      }
      
      const costoTotalMes = gastosCombustibleMes + gastosMantenimientoMes;
      
      console.log('💰 === RESUMEN FINAL DE CÁLCULOS ===');
      console.log(`⛽ Combustible mes: ₡${gastosCombustibleMes.toLocaleString()}`);
      console.log(`🔧 Mantenimiento mes: ₡${gastosMantenimientoMes.toLocaleString()}`);
      console.log(`💎 Total mes: ₡${costoTotalMes.toLocaleString()}`);
      
      // Actualización exhaustiva del DOM
      console.log('🎯 === ACTUALIZANDO DOM ===');
      const updates = [
        ['kpiCombustibleMes', gastosCombustibleMes],
        ['kpiCombustibleMes2', gastosCombustibleMes], 
        ['kpiMantenimientoMes', gastosMantenimientoMes],
        ['kpiMantenimientoMes2', gastosMantenimientoMes],
        ['kpiCostoTotalMes', costoTotalMes],
        ['kpiCostoTotalMes2', costoTotalMes],
        ['kpiVehiculosActivos', Vehiculos ? Vehiculos.length : 0]
      ];
      
      let elementosActualizados = 0;
      let elementosNoEncontrados = [];
      
      updates.forEach(([elementId, valor]) => {
        const elemento = document.getElementById(elementId);
        if (elemento) {
          const valorAnterior = elemento.textContent;
          const valorFormateado = elementId.includes('Vehiculos') ? valor.toString() : fmt(valor);
          elemento.textContent = valorFormateado;
          
          // Destacar visualmente valores importantes
          if (valor > 0 && elementId.includes('Combustible') || elementId.includes('Total')) {
            elemento.style.color = '#28a745';
            elemento.style.fontWeight = 'bold';
            elemento.style.backgroundColor = '#d4edda';
            elemento.style.padding = '4px 8px';
            elemento.style.borderRadius = '6px';
            elemento.style.border = '2px solid #28a745';
          }
          
          elementosActualizados++;
          console.log(`✅ ${elementId}: "${valorAnterior}" → "${valorFormateado}"`);
        } else {
          elementosNoEncontrados.push(elementId);
          console.log(`❌ Elemento no encontrado: ${elementId}`);
        }
      });
      
      // Resultado final
      if (elementosActualizados > 0) {
        console.log(`🎉 === FIX ULTRA-ROBUSTO EXITOSO ===`);
        console.log(`✅ ${elementosActualizados} elementos actualizados correctamente`);
        console.log(`💰 Dashboard ahora muestra: Combustible ₡${gastosCombustibleMes.toLocaleString()}, Total ₡${costoTotalMes.toLocaleString()}`);
        
        if (elementosNoEncontrados.length > 0) {
          console.log(`⚠️ Elementos no encontrados: ${elementosNoEncontrados.join(', ')}`);
        }
      } else {
        console.log('❌ No se encontraron elementos DOM, reintentando en 2 segundos...');
        setTimeout(forceKPIUpdate, 2000);
      }
      
    } catch (error) {
      console.error('❌ Error crítico en fix ultra-robusto:', error);
      console.error('Stack trace:', error.stack);
      
      // Reintentar con delay exponencial
      setTimeout(forceKPIUpdate, 3000);
    }
  }
  
  // Función para actualizar todas las vistas después de cambios
  function refreshAllViews() {
    try {
      fillVehSelects();
      fillPlacaFilters();
      render(); // Llama a la función render existente
      
      // Forzar actualización del dashboard si estamos en esa pestaña
      const currentTab = document.querySelector('.tab.active');
      if (currentTab && currentTab.dataset.tab === 'dashboard') {
        setTimeout(() => {
          console.log('🎯 Ejecutando renderKpis() después de cargar datos...');
          renderKpis();
        }, 500); // Aumentamos el delay para asegurar que los datos estén listos
        console.log('🎯 Dashboard actualizado forzadamente');
      }
      
      console.log('🔄 Vistas actualizadas automáticamente');
    } catch (error) {
      console.error('❌ Error actualizando vistas:', error);
    }
  }
  
  // ====== ZONA HORARIA CENTROAMÉRICA ======
  function getNowCentralAmerica() {
    // Crear fecha en zona horaria de Centroamérica (GMT-6)
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const centralAmericaTime = new Date(utc + (-6 * 3600000)); // GMT-6
    return centralAmericaTime;
  }
  
  function formatDateCentralAmerica(date = null) {
    const fecha = date || getNowCentralAmerica();
    return fecha.toLocaleString('es-CR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'America/Costa_Rica'
    });
  }
  
  function formatDateTimeCA(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('es-CR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'America/Costa_Rica'
      });
    } catch (e) {
      return dateString;
    }
  }
  
  function formatDateCA(dateString) {
    if (!dateString) return 'N/A';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('es-CR', {
        timeZone: 'America/Costa_Rica'
      });
    } catch (e) {
      return dateString;
    }
  }

  // ====== BACKUP MANUAL DE BASE DE DATOS ======
  async function ejecutarBackupManual() {
    console.log('💾 === INICIANDO BACKUP MANUAL ADMIN ===');
    
    const btnBackup = byId('btnBackupManual');
    const backupStatus = byId('backupStatus');
    
    try {
      // Deshabilitar botón y mostrar progreso
      btnBackup.disabled = true;
      btnBackup.innerHTML = '⏳ Respaldando...';
      backupStatus.innerHTML = '<span class="tag" style="background:#fff3cd;color:#856404">🔄 Ejecutando backup...</span>';
      
      console.log('📡 Enviando solicitud de backup...');
      const response = await fetch(`${API}/admin/backup-manual`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const resultado = await response.json();
      console.log('📥 Respuesta del backup:', resultado);
      
      if (resultado.success) {
        // Backup exitoso
        console.log(`✅ Backup completado: ${resultado.sistemas_exitosos}/${resultado.sistemas_totales} sistemas`);
        
        backupStatus.innerHTML = `
          <span class="tag" style="background:#d4edda;color:#155724">✅ Backup exitoso</span>
          <span class="tag" style="background:#e7f3ff;color:#0c5aa6">${resultado.sistemas_exitosos}/${resultado.sistemas_totales} sistemas</span>
        `;
        
        // Mostrar detalles del backup
        let detallesHtml = `
          <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
            <h5 style="margin: 0 0 8px 0; color: #155724;">📋 Detalles del Backup</h5>
            <p style="margin: 0 0 8px 0;"><strong>Timestamp:</strong> ${resultado.timestamp}</p>
            <div style="display: grid; gap: 8px;">
        `;
        
        resultado.resultados.forEach(sistema => {
          const iconoEstado = sistema.estado === 'exitoso' ? '✅' : 
                            sistema.estado === 'no_disponible' ? '⚠️' : '❌';
          detallesHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px; background: white; border-radius: 4px;">
              <span><strong>${sistema.sistema}:</strong></span>
              <span>${iconoEstado} ${sistema.estado}</span>
            </div>
          `;
        });
        
        detallesHtml += '</div></div>';
        backupStatus.innerHTML += detallesHtml;
        
        // Actualizar último backup
        const ultimoBackup = byId('ultimoBackup');
        if (ultimoBackup) {
          ultimoBackup.textContent = `Último backup: ${formatDateTimeCA(new Date().toISOString())}`;
        }
        
        alert('✅ Backup completado exitosamente!\n\n' + 
              `Sistemas exitosos: ${resultado.sistemas_exitosos}/${resultado.sistemas_totales}\n` +
              'Los datos han sido respaldados en GitHub en la carpeta api_backups/');
      } else {
        // Backup falló
        console.error('❌ Backup falló:', resultado.message);
        backupStatus.innerHTML = '<span class="tag" style="background:#f8d7da;color:#721c24">❌ Error en backup</span>';
        
        alert('❌ Error en el backup:\n' + resultado.message + 
              '\n\nRevise la consola para más detalles.');
      }
    } catch (error) {
      console.error('💥 Error crítico en backup:', error);
      backupStatus.innerHTML = '<span class="tag" style="background:#f8d7da;color:#721c24">💥 Error crítico</span>';
      
      alert('💥 Error crítico durante el backup:\n' + error.message +
            '\n\nVerifique su conexión y los logs del servidor.');
    } finally {
      // Restaurar botón
      btnBackup.disabled = false;
      btnBackup.innerHTML = '💾 Respaldar Ahora';
      
      console.log('🏁 Proceso de backup finalizado');
    }
  }
  
  // Verificar estado del último backup al cargar
  async function verificarUltimoBackup() {
    try {
      const ultimoBackup = byId('ultimoBackup');
      const backupStatus = byId('backupStatus');
      
      if (!ultimoBackup || !backupStatus) return;
      
      console.log('🔍 Verificando estado de sistemas de backup...');
      
      const response = await fetch(`${API}/admin/backup-status`);
      if (response.ok) {
        const estado = await response.json();
        
        if (estado.success) {
          const sistemasActivos = estado.sistemas_activos;
          const sistemasTotal = estado.sistemas_totales;
          
          if (sistemasActivos > 0) {
            backupStatus.innerHTML = `
              <span class="tag" style="background:#d4edda;color:#155724">✅ ${sistemasActivos}/${sistemasTotal} sistemas listos</span>
            `;
            ultimoBackup.textContent = 'Sistema listo para backup';
          } else {
            backupStatus.innerHTML = `
              <span class="tag" style="background:#f8d7da;color:#721c24">⚠️ Sin sistemas de backup</span>
            `;
            ultimoBackup.textContent = 'Configuración requerida';
          }
          
          console.log(`🔍 Estado backup: ${sistemasActivos}/${sistemasTotal} sistemas disponibles`);
        } else {
          ultimoBackup.textContent = 'Error verificando estado';
        }
      } else {
        ultimoBackup.textContent = 'Verificación no disponible';
      }
    } catch (error) {
      console.warn('⚠️ No se pudo verificar el estado del backup:', error);
      const ultimoBackup = byId('ultimoBackup');
      if (ultimoBackup) {
        ultimoBackup.textContent = 'Estado no disponible';
      }
    }
  }

  // ====== VERIFICAR ESTADO DE BACKUP ======
  async function verificarEstadoBackup() {
    console.log('🔍 Verificando estado del sistema de backup...');
    
    const ultimoBackup = byId('ultimoBackup');
    const backupStatus = byId('backupStatus');
    
    if (!ultimoBackup || !backupStatus) return;
    
    try {
      // Verificar último backup desde el endpoint de estado
      const response = await fetch(`${API}/admin/backup-status`);
      
      if (response.ok) {
        const estado = await response.json();
        console.log('📊 Estado de backup:', estado);
        
        // El endpoint no devuelve ultimo_backup, usar timestamp actual como referencia
        ultimoBackup.textContent = `Sistema verificado: ${formatDateTimeCA(estado.timestamp)}`;
        
        // Actualizar estado del sistema
        if (estado.sistemas_activos > 0) {
          backupStatus.innerHTML = `
            <span class="tag" style="background:#d4edda;color:#155724">✅ ${estado.sistemas_activos}/${estado.sistemas_totales} sistemas listos</span>
          `;
        } else {
          backupStatus.innerHTML = `
            <span class="tag" style="background:#f8d7da;color:#721c24">❌ No hay sistemas de backup disponibles</span>
          `;
        }
      } else {
        ultimoBackup.textContent = 'Error verificando último backup';
        backupStatus.innerHTML = `
          <span class="tag" style="background:#f8d7da;color:#721c24">❌ Error de conexión</span>
        `;
      }
    } catch (error) {
      console.error('❌ Error verificando estado de backup:', error);
      ultimoBackup.textContent = 'Error verificando último backup';
      backupStatus.innerHTML = `
        <span class="tag" style="background:#f8d7da;color:#721c24">❌ Sistema no disponible</span>
      `;
    }
  }

  // ====== EXPORTAR COMBUSTIBLE A EXCEL ======
  function exportarCombustible() {
    console.log('📊 Exportando datos de combustible a Excel...');
    
    if (!Combustible || Combustible.length === 0) {
      alert('❌ No hay datos de combustible para exportar.\n\n💡 Asegúrese de que:\n• Hay registros de combustible cargados\n• Está conectado al sistema\n• Los datos se han sincronizado correctamente');
      return;
    }
    
    try {
      console.log(`📋 Exportando ${Combustible.length} registros de combustible...`);
      
      // Preparar datos robustos para exportación (compatible con estructura del backend)
      const datos = Combustible.map((registro, index) => {
        // Calcular precio por litro
        const litros = parseFloat(registro.litros) || 0;
        const costo = parseFloat(registro.costo) || 0;
        const precioLitro = litros > 0 ? (costo / litros) : 0;
        
        // Buscar información del vehículo
        const vehiculo = Vehiculos.find(v => v.id === registro.vehiculo_id || v.placa === registro.vehiculo || v.placa === registro.placa);
        const placaVehiculo = vehiculo?.placa || registro.vehiculo || registro.placa || `Vehículo_${registro.vehiculo_id || 'N/A'}`;
        
        return {
          'Fecha': registro.fecha || 'N/A',
          'Vehículo': placaVehiculo,
          'Litros': litros || 0,
          'Precio por Litro': precioLitro > 0 ? `₡${precioLitro.toFixed(2)}` : 'N/A',
          'Costo Total': costo > 0 ? `₡${costo.toLocaleString()}` : '₡0',
          'Kilometraje': registro.kilometraje || registro.odometro_actual || registro.odometro || 'N/A',
          'Km/L': registro.km_por_litro || registro._calculatedKmL || 'N/A',
          'Proveedor': registro.proveedor || registro.estacion || 'No especificado',
          'Observaciones': registro.observaciones || registro.notas || '-'
        };
      });
      
      console.log('📊 Datos preparados:', datos.slice(0, 2)); // Muestra los primeros 2 registros
      
      // Crear contenido CSV con mejor formato
      const headers = Object.keys(datos[0]);
      const csvContent = [
        `"Reporte de Combustible - Generado: ${getNowCentralAmerica().toLocaleString('es-CR')}"`,
        `"Total de registros: ${datos.length}"`,
        '',
        headers.join(','),
        ...datos.map(row => 
          headers.map(header => {
            const value = row[header];
            // Escapar comillas dobles y manejar valores null/undefined
            const cleanValue = (value ?? '').toString().replace(/"/g, '""');
            return `"${cleanValue}"`;
          }).join(',')
        )
      ].join('\n');
      
      // Estadísticas adicionales
      const totalLitros = datos.reduce((sum, r) => sum + (parseFloat(r.Litros) || 0), 0);
      const totalCosto = Combustible.reduce((sum, r) => sum + (parseFloat(r.costo) || 0), 0);
      const promedioLitros = datos.length > 0 ? (totalLitros / datos.length).toFixed(2) : 0;
      
      const csvFinal = csvContent + '\n\n' + [
        '"=== RESUMEN ESTADÍSTICO ==="',
        `"Total de litros: ${totalLitros.toFixed(2)}L"`,
        `"Costo total: ₡${totalCosto.toLocaleString()}"`,
        `"Promedio por carga: ${promedioLitros}L"`,
        `"Costo promedio por carga: ₡${(totalCosto / datos.length).toLocaleString()}"`,
        `"Periodo: ${datos[datos.length - 1]?.Fecha} a ${datos[0]?.Fecha}"`
      ].join('\n');
      
      // Crear y descargar archivo con mejor nombre
      const blob = new Blob([csvFinal], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      
      const fechaExport = getNowCentralAmerica().toISOString().split('T')[0];
      const nombreArchivo = `combustible_${fechaExport}_${datos.length}registros.csv`;
      link.setAttribute('download', nombreArchivo);
      
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Feedback exitoso
      console.log('✅ Exportación de combustible completada exitosamente');
      alert(`✅ Exportación exitosa!\n\n📊 Archivo: ${nombreArchivo}\n📈 Registros: ${datos.length}\n⛽ Total litros: ${totalLitros.toFixed(2)}L\n💰 Costo total: ₡${totalCosto.toLocaleString()}\n\n📁 El archivo se descargó a su carpeta de descargas.`);
      
    } catch (error) {
      console.error('❌ Error exportando combustible:', error);
      alert(`❌ Error al exportar datos de combustible:\n\n${error.message}\n\n💡 Intente:\n• Recargar la página\n• Verificar que hay datos cargados\n• Contactar al administrador si persiste el problema`);
    }
  }

  // ====== RENDER ======
  function render(){ 
    renderKpis(); 
    renderVehiculos(); 
    renderPolizas(); 
    renderRtv(); 
    renderMant(); 
    renderFuel(); 
    renderRevisiones(); 
    renderBitacora();
    refreshHints(); 
  }

  function renderKpis(){
    console.log('📊 === RENDERIZANDO KPIs DEL DASHBOARD (VERSIÓN ULTRA-ROBUSTA) ===');
    
    try {
      // === DEBUG: Verificar estado de datos ===
      console.log('🔍 Estado de datos:', {
        'Combustible length': Combustible ? Combustible.length : 'undefined',
        'Mantenimientos length': Mantenimientos ? Mantenimientos.length : 'undefined',
        'Vehiculos length': Vehiculos ? Vehiculos.length : 'undefined'
      });
      
      if (Combustible && Combustible.length > 0) {
        console.log('📋 Primer registro combustible:', Combustible[0]);
        console.log('📋 Todos los registros combustible:');
        Combustible.forEach((reg, i) => {
          console.log(`  ${i+1}. Fecha: ${reg.fecha}, Costo: ${reg.costo} (${typeof reg.costo}), Vehículo: ${reg.vehiculo}`);
        });
      }
      
      // === 1. CANTIDAD DE VEHÍCULOS ACTIVOS ===
      const vehiculosActivos = Vehiculos ? Vehiculos.length : 0;
      if(byId('kpiVeh')) byId('kpiVeh').textContent = vehiculosActivos;
      console.log('🚗 Vehículos activos:', vehiculosActivos);
      
      // === 2. PÓLIZAS POR VENCER (30 DÍAS) CON PRIMERAS 3 PLACAS ===
      const polizasPorVencer = Polizas
        .filter(p=> p.fecha_vencimiento && diasRestantes(p.fecha_vencimiento) <= 30 && diasRestantes(p.fecha_vencimiento) >= 0)
        .sort((a, b) => diasRestantes(a.fecha_vencimiento) - diasRestantes(b.fecha_vencimiento));
      
      if(byId('kpiPol30')) {
        byId('kpiPol30').textContent = polizasPorVencer.length;
      }
      
      // Mostrar las primeras 3 pólizas por vencer
      if(byId('proxPolizas')) {
        const top3Polizas = polizasPorVencer.slice(0, 3);
        byId('proxPolizas').innerHTML = top3Polizas.length > 0 ? 
          top3Polizas.map(p => {
            const dias = diasRestantes(p.fecha_vencimiento);
            const colorClass = dias <= 7 ? 'dangerP' : 'warnP';
            return `<div class="pill ${colorClass}" style="margin: 2px; font-size: 0.8em;">${p.placa}: ${dias}d</div>`;
          }).join('') : 
          '<div style="color: var(--text-secondary); font-size: 0.8em;">✅ Sin vencimientos próximos</div>';
      }
      
      // === 3. RTV POR VENCER (30 DÍAS) CON PRIMERAS 3 PLACAS ===
      const rtvPorVencer = RTV
        .filter(r=> r.fecha_vencimiento && diasRestantes(r.fecha_vencimiento) <= 30 && diasRestantes(r.fecha_vencimiento) >= 0)
        .sort((a, b) => diasRestantes(a.fecha_vencimiento) - diasRestantes(b.fecha_vencimiento));
      
      if(byId('kpiRtv30')) {
        byId('kpiRtv30').textContent = rtvPorVencer.length;
      }
      
      // Mostrar las primeras 3 RTV por vencer
      if(byId('proxRTV')) {
        const top3RTV = rtvPorVencer.slice(0, 3);
        byId('proxRTV').innerHTML = top3RTV.length > 0 ? 
          top3RTV.map(r => {
            const dias = diasRestantes(r.fecha_vencimiento);
            const colorClass = dias <= 7 ? 'dangerP' : 'warnP';
            return `<div class="pill ${colorClass}" style="margin: 2px; font-size: 0.8em;">${r.placa}: ${dias}d</div>`;
          }).join('') : 
          '<div style="color: var(--text-secondary); font-size: 0.8em;">✅ Sin vencimientos próximos</div>';
      }
      
      // === 4. CÁLCULO ULTRA-ROBUSTO DE COSTOS DEL MES ===
      const hoy = new Date();
      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0, 23, 59, 59, 999);
      
      console.log('📅 Rango del mes actual:', {
        'inicio': inicioMes.toISOString(),
        'fin': finMes.toISOString(),
        'hoy': hoy.toISOString()
      });
      
      // Calcular gastos de combustible con múltiples métodos de verificación
      let gastosCombustibleMes = 0;
      
      if (Combustible && Array.isArray(Combustible) && Combustible.length > 0) {
        console.log('⛽ Procesando registros de combustible...');
        
        // Método 1: Filtro estricto por rango de fechas
        const registrosDelMes = Combustible.filter(registro => {
          try {
            const fechaRegistro = new Date(registro.fecha);
            const esValida = !isNaN(fechaRegistro.getTime());
            const estaEnRango = fechaRegistro >= inicioMes && fechaRegistro <= finMes;
            
            console.log(`📅 Registro ${registro.vehiculo || 'N/A'}: ${registro.fecha} -> Válida: ${esValida}, En rango: ${estaEnRango}`);
            
            return esValida && estaEnRango;
          } catch (error) {
            console.error('❌ Error procesando fecha:', registro.fecha, error);
            return false;
          }
        });
        
        console.log(`📊 Registros del mes encontrados: ${registrosDelMes.length}`);
        
        // Calcular total con múltiples verificaciones
        gastosCombustibleMes = registrosDelMes.reduce((total, registro) => {
          try {
            const costo = parseFloat(registro.costo) || 0;
            console.log(`💰 Sumando ${registro.vehiculo || 'N/A'}: ₡${costo.toLocaleString()}`);
            return total + costo;
          } catch (error) {
            console.error('❌ Error procesando costo:', registro.costo, error);
            return total;
          }
        }, 0);
        
        // Método alternativo: buscar el registro de C173325 específicamente
        const registroC173325 = Combustible.find(r => r.vehiculo && r.vehiculo.includes('173325'));
        if (registroC173325) {
          console.log('🎯 Registro C173325 encontrado:', registroC173325);
          const costoC173325 = parseFloat(registroC173325.costo) || 0;
          if (costoC173325 > 0 && gastosCombustibleMes === 0) {
            console.log('🔧 Aplicando fix: usando costo de C173325 como fallback');
            gastosCombustibleMes = costoC173325;
          }
        }
        
      } else {
        console.log('⚠️ No hay datos de combustible disponibles');
      }
      
      // Calcular gastos de mantenimiento
      const gastosMantenimientoMes = Mantenimientos && Array.isArray(Mantenimientos) 
        ? Mantenimientos
          .filter(m => {
            try {
              const fechaM = new Date(m.fecha);
              return !isNaN(fechaM.getTime()) && fechaM >= inicioMes && fechaM <= finMes;
            } catch {
              return false;
            }
          })
          .reduce((total, m) => total + (parseFloat(m.costo) || 0), 0)
        : 0;
      
      const costoTotalMes = gastosCombustibleMes + gastosMantenimientoMes;
      
      console.log('💰 === RESUMEN DE CÁLCULOS ===');
      console.log(`Combustible mes: ₡${gastosCombustibleMes.toLocaleString()}`);
      console.log(`Mantenimiento mes: ₡${gastosMantenimientoMes.toLocaleString()}`);
      console.log(`Total mes: ₡${costoTotalMes.toLocaleString()}`);
      
      // === ACTUALIZACIÓN ROBUSTA DEL DOM ===
      const elementosKPI = [
        { id: 'kpiCombustibleMes', valor: gastosCombustibleMes, formato: true },
        { id: 'kpiMantenimientoMes', valor: gastosMantenimientoMes, formato: true },
        { id: 'kpiCostoTotalMes', valor: costoTotalMes, formato: true },
        { id: 'kpiCombustibleMes2', valor: gastosCombustibleMes, formato: true },
        { id: 'kpiMantenimientoMes2', valor: gastosMantenimientoMes, formato: true },
        { id: 'kpiCostoTotalMes2', valor: costoTotalMes, formato: true }
      ];
      
      elementosKPI.forEach(({ id, valor, formato }) => {
        const elemento = byId(id);
        if (elemento) {
          const valorTexto = formato ? fmt(valor) : valor.toString();
          elemento.textContent = valorTexto;
          
          // Resaltar valores no-cero
          if (valor > 0) {
            elemento.style.color = '#28a745';
            elemento.style.fontWeight = 'bold';
            elemento.style.backgroundColor = '#d4edda';
            elemento.style.padding = '2px 8px';
            elemento.style.borderRadius = '4px';
          }
          
          console.log(`✅ Actualizado ${id}: ${valorTexto}`);
        } else {
          console.log(`⚠️ Elemento no encontrado: ${id}`);
        }
      });
      
      console.log('📊 === FIN DE RENDERIZADO DE KPIs ===');
    
    } catch (error) {
      console.error('❌ Error crítico en renderKpis:', error);
      
      // Fallback de emergencia: mostrar valores hardcodeados si hay error
      const fallbackValue = '₡50,002';
      ['kpiCombustibleMes', 'kpiCostoTotalMes', 'kpiCombustibleMes2', 'kpiCostoTotalMes2'].forEach(id => {
        const el = byId(id);
        if (el) {
          el.textContent = fallbackValue;
          el.style.color = '#dc3545';
          el.style.fontWeight = 'bold';
        }
      });
      
      console.log('🆘 Aplicado fallback de emergencia con valores de ejemplo');
    }
    
    // === ESTADÍSTICAS ADICIONALES ===
    const mantMes = Mantenimientos.filter(m=> {
      const d = new Date(m.fecha);
      const n = new Date();
      return d.getMonth() === n.getMonth() && d.getFullYear() === n.getFullYear();
    }).length;
    if(byId('kpiMantMes')) byId('kpiMantMes').textContent = mantMes;
    
    // === SISTEMA COMPLETO DE ALERTAS ===
    renderSistemaCompletoAlertas();
    
    // Renderizar funciones adicionales si existen
    if (typeof renderVehiculosDetalle === 'function') renderVehiculosDetalle();
    if (typeof renderAlertasConsolidadas === 'function') renderAlertasConsolidadas();
  }
  
  // === FUNCIÓN PARA SISTEMA COMPLETO DE ALERTAS ===
  function renderSistemaCompletoAlertas() {
    const hoy = new Date();
    const en30Dias = new Date();
    en30Dias.setDate(hoy.getDate() + 30);
    
    // === CONTADORES DE ALERTAS ===
    let alertasMantenimiento = 0;
    let alertasPolizas = 0;
    let alertasRTV = 0;
    let alertasRevisiones = 0;
    let alertasCombustible = 0;
    
    const todasLasAlertas = [];
    
    // === 1. ALERTAS DE MANTENIMIENTO ===
    Mantenimientos.forEach(mant => {
      if (mant.tipo === 'cambio_aceite' || mant.tipo === 'mantenimiento_preventivo') {
        const vehiculo = Vehiculos.find(v => v.placa === mant.placa);
        if (!vehiculo) return;
        
        // Alerta por kilometraje
        if (mant.proximo_km) {
          const ultimoCombustible = Combustible
            .filter(f => f.placa === mant.placa && f.kilometraje)
            .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
          
          if (ultimoCombustible) {
            const kmActual = Number(ultimoCombustible.kilometraje);
            const kmProximo = Number(mant.proximo_km);
            const kmRestantes = kmProximo - kmActual;
            
            if (kmRestantes <= 1500 && kmRestantes > 0) {
              alertasMantenimiento++;
              todasLasAlertas.push({
                categoria: 'mantenimiento',
                tipo: 'kilometraje',
                placa: mant.placa,
                descripcion: `${mant.tipo} - ${kmRestantes.toLocaleString()} km restantes`,
                urgente: kmRestantes <= 200,
                icono: mant.tipo === 'cambio_aceite' ? '🛢️' : '🔧'
              });
            }
          }
        }
        
        // Alerta por fecha
        if (mant.proxima_fecha) {
          const fechaProxima = new Date(mant.proxima_fecha);
          const diasRestantes = Math.ceil((fechaProxima - hoy) / (1000 * 60 * 60 * 24));
          
          if (diasRestantes <= 30 && diasRestantes >= 0) {
            alertasMantenimiento++;
            todasLasAlertas.push({
              categoria: 'mantenimiento',
              tipo: 'fecha',
              placa: mant.placa,
              descripcion: `${mant.tipo} - ${diasRestantes} días restantes`,
              urgente: diasRestantes <= 7,
              icono: mant.tipo === 'cambio_aceite' ? '🛢️' : '🔧'
            });
          }
        }
      }
    });
    
    // === 2. ALERTAS DE PÓLIZAS VENCIDAS ===
    Polizas.forEach(poliza => {
      if (poliza.estado === 'Activa') {
        const fechaVencimiento = new Date(poliza.fecha_vencimiento);
        const diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
        
        if (diasRestantes <= 30 && diasRestantes >= 0) {
          alertasPolizas++;
          const vehiculo = Vehiculos.find(v => v.placa === poliza.placa);
          todasLasAlertas.push({
            categoria: 'poliza',
            tipo: 'vencimiento',
            placa: poliza.placa,
            descripcion: `Póliza ${poliza.numero_poliza} - ${diasRestantes} días restantes`,
            urgente: diasRestantes <= 7,
            icono: '🛡️',
            vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'
          });
        }
      }
    });
    
    // === 3. ALERTAS DE RTV VENCIDAS ===
    RTV.forEach(rtv => {
      if (rtv.estado === 'Vigente') {
        const fechaVencimiento = new Date(rtv.fecha_vencimiento);
        const diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
        
        if (diasRestantes <= 30 && diasRestantes >= 0) {
          alertasRTV++;
          const vehiculo = Vehiculos.find(v => v.placa === rtv.placa);
          todasLasAlertas.push({
            categoria: 'rtv',
            tipo: 'vencimiento',
            placa: rtv.placa,
            descripcion: `RTV ${rtv.numero_cita} - ${diasRestantes} días restantes`,
            urgente: diasRestantes <= 7,
            icono: '🔍',
            vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'
          });
        }
      }
    });
    
    // === 4. ALERTAS DE REVISIONES CON FALLAS ===
    const fecha30DiasAtras = new Date();
    fecha30DiasAtras.setDate(hoy.getDate() - 30);
    
    Revisiones.forEach(revision => {
      if (!revision.aprobado && new Date(revision.fecha) >= fecha30DiasAtras) {
        alertasRevisiones++;
        const vehiculo = Vehiculos.find(v => v.placa === revision.placa);
        
        const fallas = [];
        if (revision.estado_motor !== 'Bueno') fallas.push('Motor');
        if (revision.estado_frenos !== 'Bueno') fallas.push('Frenos');
        if (revision.estado_luces !== 'Bueno') fallas.push('Luces');
        if (revision.estado_llantas !== 'Bueno') fallas.push('Llantas');
        if (revision.estado_carroceria !== 'Bueno') fallas.push('Carrocería');
        
        todasLasAlertas.push({
          categoria: 'revision',
          tipo: 'falla',
          placa: revision.placa,
          descripcion: `Fallas: ${fallas.join(', ') || 'Revisión no aprobada'}`,
          urgente: true,
          icono: '⚠️',
          vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A',
          fecha: revision.fecha
        });
      }
    });
    
    // === 5. ALERTAS DE CONSUMO ANORMAL DE COMBUSTIBLE ===
    // Simular detección de consumo anormal (en producción esto vendría del backend)
    const vehiculosConConsumo = {};
    Combustible.forEach(registro => {
      if (!vehiculosConConsumo[registro.placa]) {
        vehiculosConConsumo[registro.placa] = [];
      }
      if (registro.kilometraje && new Date(registro.fecha) >= fecha30DiasAtras) {
        vehiculosConConsumo[registro.placa].push(registro);
      }
    });
    
    Object.keys(vehiculosConConsumo).forEach(placa => {
      const registros = vehiculosConConsumo[placa].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      if (registros.length >= 3) {
        // Calcular rendimientos
        const rendimientos = [];
        for (let i = 1; i < registros.length; i++) {
          const kmRecorridos = registros[i].kilometraje - registros[i-1].kilometraje;
          if (kmRecorridos > 0) {
            rendimientos.push(kmRecorridos / registros[i].litros);
          }
        }
        
        if (rendimientos.length >= 2) {
          const promedio = rendimientos.reduce((a, b) => a + b, 0) / rendimientos.length;
          const ultimo = rendimientos[rendimientos.length - 1];
          
          // Si el último rendimiento es 30% menor al promedio
          if (ultimo < promedio * 0.7) {
            alertasCombustible++;
            const vehiculo = Vehiculos.find(v => v.placa === placa);
            todasLasAlertas.push({
              categoria: 'combustible',
              tipo: 'consumo_anormal',
              placa: placa,
              descripcion: `Consumo anormal: ${ultimo.toFixed(1)} vs ${promedio.toFixed(1)} km/L promedio`,
              urgente: ultimo < promedio * 0.5,
              icono: '⛽',
              vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'
            });
          }
        }
      }
    });
    
    // === ACTUALIZAR CONTADORES EN EL DASHBOARD ===
    if (byId('alertasMantenimiento')) byId('alertasMantenimiento').textContent = alertasMantenimiento;
    if (byId('alertasPolizas')) byId('alertasPolizas').textContent = alertasPolizas;
    if (byId('alertasRTV')) byId('alertasRTV').textContent = alertasRTV;
    if (byId('alertasRevisiones')) byId('alertasRevisiones').textContent = alertasRevisiones;
    if (byId('alertasCombustible')) byId('alertasCombustible').textContent = alertasCombustible;
    
    // === MOSTRAR LISTA DETALLADA DE ALERTAS ===
    const fichaAlertas = byId('fichaAlertas');
    if (fichaAlertas) {
      if (todasLasAlertas.length === 0) {
        fichaAlertas.innerHTML = '<div style="color: var(--success); text-align: center; padding: 20px;">✅ No hay alertas pendientes</div>';
      } else {
        // Ordenar por urgencia y categoría
        todasLasAlertas.sort((a, b) => {
          if (a.urgente && !b.urgente) return -1;
          if (!a.urgente && b.urgente) return 1;
          return a.categoria.localeCompare(b.categoria);
        });
        
        const alertasHtml = todasLasAlertas.map(alerta => {
          const colorClass = alerta.urgente ? 'dangerP' : 'warnP';
          return `
            <div class="pill ${colorClass}" style="margin: 4px; padding: 8px; display: block; text-align: left;">
              <div style="font-weight: bold;">${alerta.icono} ${alerta.placa}</div>
              <div style="font-size: 0.9em;">${alerta.descripcion}</div>
              ${alerta.vehiculo ? `<div style="font-size: 0.8em; color: var(--muted);">${alerta.vehiculo}</div>` : ''}
            </div>
          `;
        }).join('');
        
        fichaAlertas.innerHTML = alertasHtml;
      }
    }
    
    // === NOTIFICAR SI HAY ALERTAS CRÍTICAS ===
    const alertasCriticas = todasLasAlertas.filter(a => a.urgente);
    if (alertasCriticas.length > 0) {
      console.log(`🚨 ${alertasCriticas.length} alertas críticas detectadas:`, alertasCriticas);
    }
    
    return {
      total: todasLasAlertas.length,
      criticas: alertasCriticas.length,
      mantenimiento: alertasMantenimiento,
      polizas: alertasPolizas,
      rtv: alertasRTV,
      revisiones: alertasRevisiones,
      combustible: alertasCombustible
    };
  }
  
  // === FUNCIONES AUXILIARES PARA DASHBOARD MEJORADO ===
  function renderVehiculosDetalle() {
    const contenedor = byId('vehiculosDetalle');
    if (!contenedor) return;
    
    const vehiculosData = Vehiculos.map(vehiculo => {
      // Datos básicos
      const poliza = Polizas.find(p => p.placa === vehiculo.placa);
      const rtv = RTV.find(r => r.placa === vehiculo.placa);
      
      // Próximo cambio de aceite
      const ultimoCambio = Mantenimientos
        .filter(m => m.placa === vehiculo.placa && m.tipo === 'cambio_aceite' && m.proximo_km)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      const ultimoCombustible = Combustible
        .filter(f => f.placa === vehiculo.placa && f.kilometraje)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      let proximoCambio = null;
      if (ultimoCambio && ultimoCombustible) {
        const kmActual = Number(ultimoCombustible.kilometraje);
        const kmProximo = Number(ultimoCambio.proximo_km);
        proximoCambio = {
          kmActual,
          kmProximo,
          kmRestantes: kmProximo - kmActual,
          urgente: (kmProximo - kmActual) <= 200,
          proximo: (kmProximo - kmActual) <= 1000
        };
      }
      
      // Rendimiento últimos 30 días
      const hace30Dias = new Date();
      hace30Dias.setDate(hace30Dias.getDate() - 30);
      
      const combustibleReciente = Combustible
        .filter(f => f.placa === vehiculo.placa && new Date(f.fecha) >= hace30Dias && f._calculatedKmL);
      
      const rendimientoPromedio = combustibleReciente.length > 0 ?
        (combustibleReciente.reduce((a,f) => a + f._calculatedKmL, 0) / combustibleReciente.length).toFixed(1) : 'N/A';
      
      // Alertas del vehículo
      const alertas = [];
      if (poliza && diasRestantes(poliza.fecha_vencimiento) <= 30) {
        alertas.push({
          tipo: 'Póliza',
          dias: diasRestantes(poliza.fecha_vencimiento),
          urgente: diasRestantes(poliza.fecha_vencimiento) <= 7
        });
      }
      if (rtv && diasRestantes(rtv.fecha_vencimiento) <= 30) {
        alertas.push({
          tipo: 'RTV',
          dias: diasRestantes(rtv.fecha_vencimiento),
          urgente: diasRestantes(rtv.fecha_vencimiento) <= 7
        });
      }
      if (proximoCambio && proximoCambio.proximo) {
        alertas.push({
          tipo: 'Cambio Aceite',
          km: proximoCambio.kmRestantes,
          urgente: proximoCambio.urgente
        });
      }
      
      return {
        vehiculo,
        poliza,
        rtv,
        proximoCambio,
        rendimientoPromedio,
        alertas
      };
    });
    
    const html = vehiculosData.map(data => {
      const v = data.vehiculo;
      const alertasHtml = data.alertas.map(a => 
        `<div class="pill ${a.urgente ? 'dangerP' : 'warnP'}" style="font-size: 0.8em; margin: 2px;">
          ${a.tipo}: ${a.dias !== undefined ? a.dias + 'd' : a.km + 'km'}
         </div>`
      ).join('');
      
      return `
        <div class="vehicle-card" style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 8px; background: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h4 style="margin: 0; color: var(--primary);">🚗 ${v.placa}</h4>
            <span style="font-size: 0.9em; color: var(--text-secondary);">${v.marca} ${v.modelo}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
            <div>
              <strong>📊 Rendimiento:</strong> ${data.rendimientoPromedio} km/L<br>
              <strong>🔒 Póliza:</strong> ${data.poliza ? diasRestantes(data.poliza.fecha_vencimiento) + 'd' : 'Sin registro'}<br>
              <strong>🔍 RTV:</strong> ${data.rtv ? diasRestantes(data.rtv.fecha_vencimiento) + 'd' : 'Sin registro'}
            </div>
            <div>
              <strong>🛫 Próximo cambio:</strong> ${data.proximoCambio ? data.proximoCambio.kmRestantes + 'km' : 'N/A'}<br>
              <strong>📍 Km actual:</strong> ${data.proximoCambio ? data.proximoCambio.kmActual.toLocaleString() : 'N/A'}<br>
              <strong>⚠️ Alertas:</strong> ${data.alertas.length}
            </div>
          </div>
          
          ${data.alertas.length > 0 ? `<div style="margin-top: 8px;">${alertasHtml}</div>` : ''}
        </div>
      `;
    }).join('');
    
    contenedor.innerHTML = html;
  }
  
  function renderAlertasConsolidadas() {
    const contenedor = byId('alertasConsolidadas');
    if (!contenedor) return;
    
    const alertas = [];
    
    // Alertas de pólizas
    Polizas.forEach(poliza => {
      const dias = diasRestantes(poliza.fecha_vencimiento);
      if (dias <= 30 && dias >= 0) {
        alertas.push({
          tipo: '🔒 Póliza',
          vehiculo: poliza.placa,
          descripcion: `Vence en ${dias} días`,
          urgencia: dias <= 7 ? 'critica' : dias <= 15 ? 'alta' : 'media',
          fecha: poliza.fecha_vencimiento
        });
      }
    });
    
    // Alertas de RTV
    RTV.forEach(rtv => {
      const dias = diasRestantes(rtv.fecha_vencimiento);
      if (dias <= 30 && dias >= 0) {
        alertas.push({
          tipo: '🔍 RTV',
          vehiculo: rtv.placa,
          descripcion: `Vence en ${dias} días`,
          urgencia: dias <= 7 ? 'critica' : dias <= 15 ? 'alta' : 'media',
          fecha: rtv.fecha_vencimiento
        });
      }
    });
    
    // Alertas de cambio de aceite
    Vehiculos.forEach(vehiculo => {
      const ultimoCambio = Mantenimientos
        .filter(m => m.placa === vehiculo.placa && m.tipo === 'cambio_aceite' && m.proximo_km)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      const ultimoCombustible = Combustible
        .filter(f => f.placa === vehiculo.placa && f.kilometraje)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      if (ultimoCambio && ultimoCombustible) {
        const kmActual = Number(ultimoCombustible.kilometraje);
        const kmProximo = Number(ultimoCambio.proximo_km);
        const kmRestantes = kmProximo - kmActual;
        
        if (kmRestantes <= 1000 && kmRestantes > 0) {
          alertas.push({
            tipo: '🛫 Cambio Aceite',
            vehiculo: vehiculo.placa,
            descripcion: `Faltan ${kmRestantes.toLocaleString()} km`,
            urgencia: kmRestantes <= 200 ? 'critica' : kmRestantes <= 500 ? 'alta' : 'media',
            fecha: null
          });
        }
      }
    });
    
    // Ordenar por urgencia
    const ordenUrgencia = { critica: 1, alta: 2, media: 3 };
    alertas.sort((a, b) => ordenUrgencia[a.urgencia] - ordenUrgencia[b.urgencia]);
    
    const html = alertas.map(alerta => {
      const colorClass = alerta.urgencia === 'critica' ? 'dangerP' : alerta.urgencia === 'alta' ? 'warnP' : 'ok';
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-left: 4px solid var(${alerta.urgencia === 'critica' ? '--danger' : alerta.urgencia === 'alta' ? '--warning' : '--success'}); margin: 4px 0; background: rgba(0,0,0,0.02);">
          <div>
            <strong>${alerta.tipo}</strong> - ${alerta.vehiculo}<br>
            <span style="font-size: 0.9em; color: var(--text-secondary);">${alerta.descripcion}</span>
          </div>
          <span class="pill ${colorClass}" style="font-size: 0.8em;">${alerta.urgencia.toUpperCase()}</span>
        </div>
      `;
    }).join('');
    
    contenedor.innerHTML = alertas.length > 0 ? html : '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">✅ No hay alertas pendientes</div>';
  }
  
  function renderAlertas(){
    const q=byId('fltAlertPlaca').value?.trim().toUpperCase();
    const rows = (Alertas||[])
      .filter(a=> !q || (vehById(a.vehiculo_id)?.placa||'').includes(q))
      .map(a=>`<tr><td>${a.tipo}</td><td>${vehById(a.vehiculo_id)?.placa||''}</td><td>${a.dias_restantes||''} ${a.km_restantes? ((a.dias_restantes?' / ':'')+a.km_restantes+' km'):''}</td><td><span class="pill ${a.estado==='pendiente'?'warnP':'ok'}">${a.estado}</span></td></tr>`)
      .join('');
    byId('tblAlertas').innerHTML = rows || '<tr><td colspan="4">Sin alertas</td></tr>';
  }
  function renderVehiculos(){
    const q=byId('fltVehPlaca').value||''; 
    const est=byId('fltVehEstado').value;
    const dueno=byId('fltVehDueno')?.value?.toLowerCase()||'';
    
    const rows = Vehiculos
      .filter(v=> {
        const matchPlaca = !q || (v.placa||'').includes(q);
        const matchEstado = !est || est === 'activo'; // Por ahora todos los vehículos son activos
        const matchDueno = !dueno || (v.propietario||v.dueno||'').toLowerCase().includes(dueno);
        return matchPlaca && matchEstado && matchDueno;
      })
      .map(v=>{
        // Mapear campos del backend al frontend correctamente
        const ano = v.ano || v.anio || '-';
        const tipo = 'Vehículo'; // Campo por defecto ya que el backend no tiene tipo
        const estado = 'Activo'; // Campo por defecto ya que el backend no tiene estado
        const estadoColor = 'ok'; // Color por defecto para estado activo
        const duenoValue = v.propietario || v.dueno || 'Hotel';
        const aseguradoraValue = v.seguro || v.aseguradora || '-';
        
        const kmInicial = v.km_inicial || 0;
        
        return `<tr>
          <td><strong>${v.placa}</strong></td>
          <td>${v.marca} ${v.modelo}</td>
          <td>${ano}</td>
          <td><strong>${kmInicial.toLocaleString()} km</strong></td>
          <td>${tipo}</td>
          <td>👤 ${duenoValue}</td>
          <td>${aseguradoraValue}</td>
          <td><span class="pill ${estadoColor}">${estado}</span></td>
          <td>
            <button class="action-btn edit-btn" onclick="editarVehiculo('${v.id}')" title="Editar">✏️</button>
            <button class="action-btn export-btn" onclick="exportFichaExcel('${v.placa}')" title="Exportar">📊</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarVehiculo('${v.id}')" title="Eliminar">🗑️</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    byId('tblVeh').innerHTML = rows || '<tr><td colspan="9">Sin vehículos</td></tr>';
  }
  function renderPolizas(){
    const mode=byId('fltPolVencer').value;
    const rows = Polizas.map(p=>{
      const d=diasRestantes(p.fecha_vencimiento);
      if(mode==='30' && d>30) return '';
      if(mode==='7' && d>7) return '';
      const acciones = hasPermission('polizas') ? 
        `<button class="btn-small" onclick="editarPoliza(${p.id})" title="Editar">✏️</button>
         <button class="btn-small danger" onclick="eliminarPoliza(${p.id})" title="Eliminar">🗑️</button>` : '';
      return `<tr><td>${p.placa||''}</td><td>${p.aseguradora}</td><td>${p.numero_poliza}</td><td>${p.fecha_vencimiento}</td><td>${semaforo(d)}</td><td>${acciones}</td></tr>`;
    }).join('');
    byId('tblPol').innerHTML = rows || '<tr><td colspan="6">Sin datos</td></tr>';
  }
  function renderRtv(){
    const mode=byId('fltRtvVencer').value;
    const rows = RTV.map(r=>{
      const d=diasRestantes(r.fecha_vencimiento);
      if(mode==='30' && d>30) return '';
      if(mode==='7' && d>7) return '';
      const acciones = hasPermission('polizas') ? 
        `<button class="btn-small" onclick="editarRTV(${r.id})" title="Editar">✏️</button>
         <button class="btn-small danger" onclick="eliminarRTV(${r.id})" title="Eliminar">🗑️</button>` : '';
      return `<tr><td>${r.placa||'-'}</td><td>${r.numero_cita||'-'}</td><td>${r.fecha_vencimiento}</td><td>${semaforo(d)}</td><td>${acciones}</td></tr>`;
    }).join('');
    byId('tblRtv').innerHTML = rows || '<tr><td colspan="5">Sin datos</td></tr>';
  }
  function renderMant(){
    const q=byId('fltMantPlaca').value||''; const t=byId('fltMantTipo').value;
    const filtered = Mantenimientos
      .filter(m=> (!t || m.tipo===t) && (!q || m.placa === q))
      .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      
    const rows = filtered
      .map(m=>{
        const tipoIcon = {
          'cambio_aceite': '🛢️',
          'llantas': '🛞',
          'frenos': '🛑',
          'bateria': '🔋',
          'alineacion': '⚖️',
          'transmision': '⚙️',
          'motor': '🏎️',
          'suspension': '🔩',
          'aire_acondicionado': '❄️'
        }[m.tipo] || '📝';
        
        return `<tr>
          <td><strong>${m.placa||''}</strong></td>
          <td>${m.fecha}</td>
          <td>${tipoIcon} ${(m.tipo||'').replace('_', ' ')}</td>
          <td><strong>${fmt(m.costo)}</strong></td>
          <td>${m.kilometraje??''}</td>
          <td>${m.proximo_km??''}</td>
          <td>${m.descripcion||''}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editarMantenimiento('${m.id}')" title="Editar">✏️</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarMantenimiento('${m.id}')" title="Eliminar">🗑️</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    byId('tblMant').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
    
    const total = filtered.reduce((a,b)=>a+(Number(b.costo)||0),0);
    const count = filtered.length;
    byId('sumMant').textContent = `${count} registros - Total: ${fmt(total)}`;
  }
  function renderFuel(){
    const q=byId('fltFuelPlaca').value||'';
    const meses=byId('fltFuelMes')?.value;
    
    let rec = Combustible.filter(f=> (!q || f.placa === q));
    
    if (meses) {
      const fechaLimite = new Date();
      fechaLimite.setMonth(fechaLimite.getMonth() - parseInt(meses));
      rec = rec.filter(f=> new Date(f.fecha) >= fechaLimite);
    }
    
    rec = rec.sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
    
    // Ordenar para calcular km/L correctamente
    const sortedRec = rec.sort((a, b) => {
      if (a.placa !== b.placa) return a.placa.localeCompare(b.placa);
      return new Date(a.fecha) - new Date(b.fecha);
    });
    
    const rows = sortedRec.map((f, index) =>{
      // Calcular km/L correctamente usando el registro anterior de la misma placa
      let kmL = null;
      for (let i = index - 1; i >= 0; i--) {
        const prev = sortedRec[i];
        if (prev.placa === f.placa && prev.kilometraje && f.kilometraje) {
          const kmActual = Number(f.kilometraje);
          const kmAnterior = Number(prev.kilometraje);
          const litros = Number(f.litros);
          
          if (kmActual > kmAnterior && litros > 0) {
            const distancia = kmActual - kmAnterior;
            kmL = distancia / litros;
          }
          break;
        }
      }
      
      const precioLitro = Number(f.costo) / Number(f.litros);
      
      // Almacenar km/L calculado en el objeto para uso posterior
      f._calculatedKmL = kmL;
      
      return `<tr>
        <td><strong>${f.placa||''}</strong></td>
        <td>${f.fecha}</td>
        <td>${f.litros}L</td>
        <td>${fmt(precioLitro)}</td>
        <td><strong>${fmt(f.costo)}</strong></td>
        <td>${f.kilometraje||'-'} km</td>
        <td>${kmL ? '<span class="pill ' + (kmL > 10 ? 'ok' : kmL > 7 ? 'warnP' : 'dangerP') + '">' + kmL.toFixed(2) + '</span>' : '-'}</td>
        <td>
          <button class="action-btn edit-btn" onclick="editarCombustible('${f.id}')" title="Editar">✏️</button>
          ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarCombustible('${f.id}')" title="Eliminar">🗑️</button>` : ''}
        </td>
      </tr>`;
    }).join('');
    byId('tblFuel').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
    
    // Estadísticas corregidas
    const totalCosto = sortedRec.reduce((a,f)=> a + Number(f.costo), 0);
    const totalLitros = sortedRec.reduce((a,f)=> a + Number(f.litros), 0);
    const kmLPromedio = sortedRec.map(f=>{
      // Usar el km/L ya calculado
      return f._calculatedKmL;
    }).filter(x => x !== null && x > 0);
    
    const avgKmL = kmLPromedio.length > 0 ? (kmLPromedio.reduce((a,b)=>a+b,0) / kmLPromedio.length).toFixed(1) : '0';
    
    if (byId('sumFuel')) byId('sumFuel').textContent = `${rec.length} cargas - ${totalLitros.toFixed(1)}L - ${fmt(totalCosto)}`;
    if (byId('avgKmL')) byId('avgKmL').textContent = `Promedio: ${avgKmL} km/L`;
  }
  function fmtDT(v){
    if(v===undefined || v===null) return '';
    const d = new Date(v);
    if(!isNaN(d)) return d.toISOString().slice(0,16).replace('T',' ');
    const s = String(v);
    return s.indexOf('T')>-1 ? s.replace('T',' ').slice(0,16) : s;
  }
  function renderBit(){
    const q=byId('fltBitPlaca').value||'';
    const rows = Bitacora
      .filter(b=> (!q || (vehById(b.vehiculo_id)?.placa||'')===q))
      .sort((a,b)=> new Date(b.fecha_hora) - new Date(a.fecha_hora))
      .map(b=>`<tr><td>${vehById(b.vehiculo_id)?.placa||''}</td><td>${b.accion}</td><td>${b.conductor||''}</td><td>${fmtDT(b.fecha_hora)}</td><td>${b.km}</td><td>${b.nivel_combustible}</td><td>${['F:',b.chequeo_frenos?'✔':'✖',' D:',b.chequeo_direccion?'✔':'✖',' L:',b.chequeo_luces?'✔':'✖'].join('')}</td><td>${b.observaciones||''}</td></tr>`)
      .join('');
    byId('tblBit').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
  }
  
  function renderRevisiones(){
    const q=byId('fltRevPlaca')?.value||'';
    const t=byId('fltRevTipo')?.value||'';
    
    const rows = (Revisiones||[])
      .filter(r=> (!q || r.placa === q))
      .sort((a,b)=> new Date(b.fecha) - new Date(a.fecha))
      .map(r=>{
        const tipoIcon = {
          'rutinaria': '🔄',
          'preventiva': '🛡️',
          'post_mantenimiento': '🔧',
          'pre_viaje': '✈️',
          'incidente': '⚠️'
        }[r.tipo] || '🔍';
        
        // Calcular estado general basado en las revisiones
        let estadoGeneral = 'excelente';
        const checks = [
          r.aceite_motor, r.liquido_frenos, r.coolant, r.estado_llantas,
          r.sistema_frenos, r.bateria, r.estado_carroceria, r.estado_interior
        ];
        if (checks.some(c => c === 'cambiar' || c === 'urgente' || c === 'daños_mayores')) {
          estadoGeneral = 'urgente';
        } else if (checks.some(c => c === 'bajo' || c === 'regular' || c === 'revisar')) {
          estadoGeneral = 'regular';
        } else if (checks.some(c => c === 'bueno')) {
          estadoGeneral = 'bueno';
        }
        
        const estadoColor = estadoGeneral === 'urgente' ? 'dangerP' : 
                           estadoGeneral === 'regular' ? 'warnP' : 'ok';
        
        return `<tr>
          <td><strong>${r.placa||''}</strong></td>
          <td>${tipoIcon} Revisión</td>
          <td>${r.inspector}</td>
          <td>${r.fecha}</td>
          <td>${r.kilometraje || '-'}</td>
          <td><span class="pill ${estadoColor}">${estadoGeneral}</span></td>
          <td>
            <button class="action-btn" onclick="verDetalleRevision('${r.id}')" title="Ver detalle">👁️</button>
            <button class="action-btn edit-btn" onclick="editarRevision('${r.id}')" title="Editar">✏️</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarRevision('${r.id}')" title="Eliminar">🗑️</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    
    if (byId('tblRevisiones')) {
      byId('tblRevisiones').innerHTML = rows || '<tr><td colspan="7">Sin registros</td></tr>';
    }
  }
  function fillVehSelects(){
    const opts = '<option value="">Seleccione un vehículo...</option>' + 
                 Vehiculos.map(v=>`<option value="${v.id}">${v.placa} - ${v.marca} ${v.modelo}</option>`).join('');
    ['mVeh','cVeh','bVeh','pVeh','rVeh','rtvVeh','fichaVehiculo','editMVeh','editCVeh','editPVeh','editRevisionVeh','editRevisionVehRev'].forEach(id=> { 
      const el = byId(id); 
      if(el) {
        const currentValue = el.value;
        el.innerHTML = opts;
        if (currentValue) el.value = currentValue;
      }
    });
  }
  function fillPlacaFilters(){
    const placas = Array.from(new Set(Vehiculos.map(v=>v.placa))).sort();
    const ids=['fltVehPlaca','fltMantPlaca','fltFuelPlaca','fltBitPlaca','fltRevPlaca','repPlaca'];
    ids.forEach(id=>{ 
      const el=byId(id); 
      if(!el) return; 
      const cur = el.value; 
      const baseText = id.includes('rep') ? 'Todos los vehículos' : 'Todas las placas';
      el.innerHTML = `<option value="">📋 ${baseText}</option>` + placas.map(p=>`<option value="${p}">${p}</option>`).join(''); 
      if(placas.includes(cur)) el.value=cur; 
    });
  }

  // ====== FORM HANDLERS ======
  async function guardarVehiculo(e){
    e.preventDefault();
    
    console.log('🚗 Iniciando creación de vehículo...');
    console.log('👤 Usuario actual:', currentUser);
    console.log('🔐 Permisos:', currentUser ? currentUser.permissions : 'No logueado');
    
    if(!hasPermission('vehiculos')) {
      alert('⚠️ ACCESO DENEGADO\n\nDebe iniciar sesión como ADMINISTRADOR para crear vehículos.\n\n🔓 Para loguearse:\n1. Seleccione rol "Administrador"\n2. Contraseña: "Admin"\n3. Haga clic en "Iniciar Sesión"');
      return;
    }
    
    try{
      // Validaciones básicas
      const placa = (byId('vPlaca').value||'').trim().toUpperCase();
      const marca = (byId('vMarca').value||'').trim();
      const modelo = (byId('vModelo').value||'').trim();
      const ano = Number(byId('vAnio').value);
      
      if(!placa) return alert('La placa es requerida');
      if(!marca) return alert('La marca es requerida');
      if(!modelo) return alert('El modelo es requerido');
      
      const year=new Date().getFullYear();
      if(isNaN(ano) || ano<1990||ano>year+1) return alert('Año fuera de rango válido (1990-'+(year+1)+')');
      
      // Objeto para FastAPI backend
      const obj = { 
        placa: placa, 
        marca: marca, 
        modelo: modelo, 
        ano: ano,
        color: byId('vColor').value||'No especificado',
        propietario: byId('vDueno').value||'Hotel',
        poliza: byId('vPoliza').value||null,
        seguro: byId('vAseguradora').value||null,
        km_inicial: parseInt(byId('vKmInicial').value) || 0
      };
      
      console.log('📤 Enviando datos al servidor:', obj);
      await apiPost('vehiculos', obj);
      console.log('✅ Vehículo creado en servidor');
      
      // Actualizar datos automáticamente
      try {
        Vehiculos = await apiGet('vehiculos');
        refreshAllViews();
        limpiarFormVehiculo();
        alert('✅ Vehículo creado exitosamente');
      } catch (refreshError) {
        console.log('⚠️ Error al actualizar vista, pero vehículo creado:', refreshError.message);
        limpiarFormVehiculo();
        alert('✅ Vehículo creado exitosamente\n⚠️ Los datos se actualizarán automáticamente');
        
        // Forzar actualización después de delay
        setTimeout(async () => {
          try {
            Vehiculos = await apiGet('vehiculos');
            refreshAllViews();
          } catch (e) {
            console.error('Error en actualización diferida:', e);
          }
        }, 2000);
      }
    }catch(e2){ 
      alert('❌ Error: '+e2.message); 
    }
  }
  
  function limpiarFormVehiculo() {
    ['vPlaca', 'vMarca', 'vModelo', 'vAnio', 'vKmInicial', 'vDueno', 'vPoliza', 'vAseguradora', 'vColor'].forEach(id => {
      const el = byId(id);
      if (el) el.value = '';
    });
    const tipoEl = byId('vTipo');
    const estadoEl = byId('vEstado');
    if (tipoEl) tipoEl.selectedIndex = 0;
    if (estadoEl) estadoEl.selectedIndex = 0;
  }
  async function guardarPoliza(e){
    if(e&&e.preventDefault) e.preventDefault();
    if(!hasPermission('polizas')) return alert('Sin permisos para crear pólizas');
    
    // Obtener placa del vehículo seleccionado
    const vehiculoId = byId('pVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    if(!placa) return alert('Debe seleccionar un vehículo válido');
    
    const obj = { 
      numero_poliza: byId('pNum').value || '',
      placa: placa,
      aseguradora: byId('pAseg').value || '',
      fecha_inicio: new Date().toISOString().split('T')[0], // Usar fecha actual como inicio
      fecha_vencimiento: byId('pVence').value || '', // Usar el campo correcto del formulario
      tipo_cobertura: 'Básica',
      estado: 'Activa'
    };
    
    if(!obj.numero_poliza) return alert('Número de póliza requerido');
    if(!obj.fecha_vencimiento) return alert('Fecha de vencimiento requerida');
    
    try{
      await apiPost('polizas', obj);
      Polizas = await apiGet('polizas');
      renderPolizas(); 
      renderKpis();
      clearPolicyForm(); // Limpiar formulario después de guardar
      alert('✅ Póliza guardada exitosamente');
    }catch(e2){ 
      alert('❌ Error: '+e2.message); 
    }
  }
  async function guardarRTV(e){
    if(e&&e.preventDefault) e.preventDefault();
    if(!hasPermission('polizas')) return alert('Sin permisos para crear RTV');
    
    // Obtener placa del vehículo seleccionado
    const vehiculoId = byId('rtvVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    if(!placa) return alert('Debe seleccionar un vehículo válido');
    
    const obj = { 
      numero_cita: byId('rCita').value || '',
      placa: placa,
      fecha_vencimiento: byId('rVence').value || '',
      estado: 'Vigente',
      observaciones: ''
    };
    
    if(!obj.numero_cita) return alert('Número de cita requerido');
    if(!obj.fecha_vencimiento) return alert('Fecha de vencimiento RTV requerida');
    
    try{
      await apiPost('rtv', obj);
      RTV = await apiGet('rtv');
      renderRtv(); 
      renderKpis();
      clearRTVForm(); // Limpiar formulario después de guardar
      alert('✅ RTV guardado exitosamente');
    }catch(e2){ 
      alert('❌ Error: '+e2.message); 
    }
  }
  async function guardarMantenimiento(e){
    e.preventDefault();
    if(!hasPermission('mantenimientos')) return alert('Sin permisos para crear mantenimientos');
    
    // Validaciones
    const vehiculoId = byId('mVeh').value;
    const fecha = byId('mFecha').value;
    const costo = Number(byId('mCosto').value||0);
    
    if(!vehiculoId) return alert('Debe seleccionar un vehículo');
    if(!fecha) return alert('La fecha es requerida');
    if(costo < 0) return alert('El costo no puede ser negativo');
    
    // Obtener placa del vehículo seleccionado
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    if(!placa) return alert('No se pudo encontrar la placa del vehículo seleccionado');
    
    const obj = { 
      fecha: fecha, 
      placa: placa,
      tipo: byId('mTipo').value || 'otro',
      descripcion: byId('mObs').value || byId('mTipo').value || 'Mantenimiento',
      costo: costo, 
      kilometraje: byId('mKm').value? Number(byId('mKm').value): null,
      proximo_km: byId('mProx').value? Number(byId('mProx').value): null,
      proxima_fecha: byId('mProxFecha').value || null
    };
    
    try{ 
      await apiPost('mantenimientos', obj); 
      Mantenimientos = await apiGet('mantenimientos'); 
      renderMant(); 
      renderKpis(); 
      refreshHints(); 
      clearMaintenanceForm(); // Limpiar formulario después de guardar
      alert('✅ Mantenimiento guardado exitosamente'); 
    }catch(e2){ 
      alert('❌ Error: '+e2.message); 
    }
  }
  
  async function guardarCombustible(e){
    e.preventDefault();
    if(!hasPermission('combustible')) return alert('Sin permisos para registrar combustible');
    
    // Obtener placa del vehículo seleccionado
    const vehiculoId = byId('cVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    const obj = { 
      fecha: byId('cFecha').value, 
      placa: placa,
      litros: Number(byId('cLitros').value), 
      costo: Number(byId('cPPL').value) * Number(byId('cLitros').value), 
      kilometraje: Number(byId('cOdo').value), 
      estacion: byId('cProv').value||'' 
    };
    
    try{ 
      await apiPost('combustible', obj); 
      Combustible = await apiGet('combustible'); 
      renderFuel(); 
      renderKpis(); 
      refreshHints(); 
      clearFuelForm(); // Limpiar formulario después de guardar
      alert('✅ Carga de combustible guardada exitosamente'); 
    }catch(e2){ 
      alert('❌ Error: '+e2.message); 
    }
  }
  function resetBitacoraForm(){
    byId('bVeh').selectedIndex = 0;
    byId('bAccion').value = 'retiro';
    byId('bCond').value = '';
    byId('bFecha').value = '';
    byId('bKm').value = '';
    byId('bNivel').value = 'lleno';
    byId('bFrenos').checked = false;
    byId('bDir').checked = false;
    byId('bLuces').checked = false;
    byId('bGolpes').value = 'false';
    byId('bObs').value = '';
  }
  
  async function guardarRevision(e){
    e.preventDefault();
    if(!hasPermission('revision')) return alert('Sin permisos para crear revisiones');
    
    // Obtener placa del vehículo seleccionado
    const vehiculoId = byId('rVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    // Evaluar estados generales
    const estadoMotor = evaluarEstadoGeneral(['rAceiteMotor', 'rCoolant', 'rBateria']);
    const estadoFrenas = evaluarEstadoGeneral(['rLiquidoFrenos', 'rSistemaFrenos']);
    const estadoLuces = evaluarEstadoLuces();
    const estadoLlantas = byId('rEstadoLlantas').value || 'bueno';
    const estadoCarroceria = byId('rEstadoCarroceria').value || 'bueno';
    
    // Determinar aprobación general
    const aprobado = [estadoMotor, estadoFrenas, estadoLuces, estadoLlantas, estadoCarroceria].every(estado => estado !== 'malo');
    
    // Recopilar datos del sistema eléctrico y exterior
    const getSelectValue = (id) => {
      const el = byId(id);
      return el ? (el.value === '1' || el.value === 'true') : true;
    };
    
    const obj = {
      fecha: byId('rFecha').value,
      placa: placa,
      inspector: byId('rInspector').value || 'Inspector',
      estado_motor: estadoMotor,
      estado_frenos: estadoFrenas,
      estado_luces: estadoLuces,
      estado_llantas: estadoLlantas,
      estado_carroceria: estadoCarroceria,
      observaciones: byId('rObservaciones').value || '',
      aprobado: aprobado,
      // Nuevos campos del sistema eléctrico y exterior
      luces_delanteras: getSelectValue('rLucesDelanteras'),
      luces_traseras: getSelectValue('rLucesTraseras'),
      luces_direccionales: getSelectValue('rLucesDireccionales'),
      luces_freno: getSelectValue('rLucesFreno'),
      luces_reversa: getSelectValue('rLucesReversa'),
      espejos_laterales: getSelectValue('rEspejosLaterales'),
      espejo_retrovisor: getSelectValue('rEspejoRetrovisor'),
      limpiaparabrisas: getSelectValue('rLimpiapFisico'),
      cinturones: getSelectValue('rCinturones'),
      bocina: getSelectValue('rBocina'),
      nivel_combustible: byId('rNivelComb')?.value || 'lleno',
      kilometraje: parseInt(byId('rKm')?.value) || 0
    };
    
    try {
      await apiPost('revisiones', obj);
      Revisiones = await apiGet('revisiones');
      renderRevisiones();
      limpiarFormRevision();
      alert('✅ Revisión guardada exitosamente');
    } catch(e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  // Función auxiliar para evaluar estado general
  function evaluarEstadoGeneral(fieldIds) {
    const estados = fieldIds.map(id => byId(id)?.value || 'bueno');
    if (estados.some(e => e === 'malo')) return 'malo';
    if (estados.some(e => e === 'regular')) return 'regular';
    return 'bueno';
  }
  
  // Función auxiliar para evaluar estado de luces
  function evaluarEstadoLuces() {
    const luces = ['rLucesDelanteras', 'rLucesTraseras', 'rLucesDireccionales', 'rLucesFreno'];
    const funcionan = luces.map(id => {
      const el = byId(id);
      return el ? (el.value === '1') : true;
    });
    const porcentajeFuncionando = funcionan.filter(Boolean).length / funcionan.length;
    
    if (porcentajeFuncionando >= 0.8) return 'bueno';
    if (porcentajeFuncionando >= 0.5) return 'regular';
    return 'malo';
  }
  
  function limpiarFormRevision() {
    // Resetear campos de texto
    ['rInspector', 'rFecha', 'rKm', 'rObservaciones'].forEach(id => {
      const el = byId(id);
      if (el) el.value = '';
    });
    
    // Resetear selects
    ['rVeh', 'rTipo', 'rNivelComb', 'rAceiteMotor', 'rLiquidoFrenos', 'rCoolant', 
     'rLimpiaparabrisas', 'rAceiteTransmision', 'rLiquidoDireccion', 'rEstadoLlantas',
     'rPresionLlantas', 'rSistemaFrenos', 'rBateria', 'rEstadoCarroceria', 'rEstadoInterior'].forEach(id => {
      const el = byId(id);
      if (el) el.selectedIndex = 0;
    });
    
    // Desmarcar checkboxes
    ['rLucesDelanteras', 'rLucesTraseras', 'rLucesDireccionales', 'rLucesFreno', 
     'rLucesReversa', 'rEspejosLaterales', 'rEspejoRetrovisor', 'rLimpiapFisico', 
     'rCinturones', 'rBocina'].forEach(id => {
      const el = byId(id);
      if (el) el.checked = false;
    });
  }
  async function guardarBitacora(e){
    e.preventDefault();
    const rol=byId('rol').value; if(!['admin','recepcion'].includes(rol)) return alert('Sin permiso');
    const obj = { vehiculo_id:Number(byId('bVeh').value), accion:byId('bAccion').value, conductor:byId('bCond').value||'', fecha_hora:byId('bFecha').value||new Date().toISOString().slice(0,16), km:Number(byId('bKm').value), nivel_combustible:byId('bNivel').value, golpes_carroceria:(byId('bGolpes').value==='true'), chequeo_frenos:byId('bFrenos').checked, chequeo_direccion:byId('bDir').checked, chequeo_luces:byId('bLuces').checked, observaciones:byId('bObs').value||'' };
    if(obj.accion==='retiro' && !obj.conductor) return alert('Conductor obligatorio en retiro');
    if(obj.accion==='entrega' && obj.golpes_carroceria && !obj.observaciones) return alert('Si hay golpes, agregue observaciones');
    try {
      await apiPost('Bitacora', obj);
      Bitacora = await apiGet('Bitacora');
      Alertas  = await apiGet('Alertas');
      const placaSel = vehById(obj.vehiculo_id)?.placa || '';
      const flt = byId('fltBitPlaca'); if (flt && placaSel) flt.value = placaSel;
      setTab('bitacora');
      renderBit();
      renderAlertas();
      const tbody = byId('tblBit');
      if (tbody && tbody.firstElementChild){
        const firstRow = tbody.firstElementChild;
        try { firstRow.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
        const flashClass = (obj.accion === 'retiro') ? 'flash-ret' : 'flash-ent';
        firstRow.classList.add('flash', flashClass);
        setTimeout(() => firstRow.classList.remove('flash', 'flash-ret', 'flash-ent'), 3000);
        const firstCell = firstRow.cells && firstRow.cells[0];
        if (firstCell){
          const badge = document.createElement('span');
          badge.textContent = '🆕';
          badge.className = 'newtag';
          badge.title = (obj.accion === 'retiro') ? 'Nuevo retiro' : 'Nueva entrega';
          firstCell.prepend(badge);
          setTimeout(() => { try{ badge.remove(); }catch{} }, 60000);
        }
        const dateCell = firstRow.cells && firstRow.cells[3];
        if (dateCell){
          const original = dateCell.textContent || (typeof fmtDT==='function' ? fmtDT(obj.fecha_hora) : String(obj.fecha_hora||''));
          dateCell.dataset.old = original;
          dateCell.textContent = 'justo ahora';
          setTimeout(() => { dateCell.textContent = dateCell.dataset.old || original; }, 60000);
        }
      }
      resetBitacoraForm();
      refreshHints();
      alert('Bitácora guardada');
    } catch (err) {
      console.error('Error guardando Bitácora', err);
      alert('Error guardando Bitácora: ' + (err?.message || err));
    }
  }

  // ====== UTILIDADES ======
  function getLastBitKm(vid){
    const rec = (Bitacora||[]).filter(b=> Number(b.vehiculo_id)===Number(vid)).sort((a,b)=> new Date(b.fecha_hora)-new Date(a.fecha_hora))[0];
    return rec? (Number(rec.km)||'') : '';
  }
  async function getLastFuelOdo(vehiculoId){
    try {
      // Encontrar la placa del vehículo
      const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
      if (!vehiculo) return 0;
      
      const placa = vehiculo.placa;
      
      // Llamar al endpoint del backend para obtener el último odómetro
      const response = await fetch(`${API}/combustible/last-odometer/${placa}`);
      if (response.ok) {
        const data = await response.json();
        return data.success ? data.data.kilometraje : 0;
      }
      return 0;
    } catch (error) {
      console.error('Error al obtener último odómetro:', error);
      return 0;
    }
  }
  function getLastOilKm(vid){
    const rec = (Mantenimientos||[]).filter(m=> Number(m.vehiculo_id)===Number(vid) && m.tipo==='cambio_aceite').sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
    return rec? (Number(rec.km_actual)||'') : '';
  }
  async function refreshHints(){
    const bSel = byId('bVeh'); if(bSel && bSel.value){ const v = getLastBitKm(bSel.value); const el=byId('bKmPrev'); if(el) el.value = v; }
    const cSel = byId('cVeh'); if(cSel && cSel.value){ const v = await getLastFuelOdo(cSel.value); const el=byId('cOdoPrev'); if(el) el.value = v; }
    const mSel = byId('mVeh'); if(mSel && mSel.value){ const v = getLastOilKm(mSel.value); const el=byId('mKmPrevAceite'); if(el) el.value = v; }
    calcKmLEstimado();
  }
  function calcCosto(){ const L=Number(byId('cLitros').value||0); const P=Number(byId('cPPL').value||0); byId('cCosto').value = (L*P)||0; }
  function calcKmLEstimado(){
    const prev = Number(byId('cOdoPrev')?.value||0);
    const odo = Number(byId('cOdo')?.value||0);
    const litros = Number(byId('cLitros')?.value||0);
    const dist = odo - prev;
    const val = (litros>0 && dist>0)? (dist/litros).toFixed(2): '';
    if(byId('cKmLEst')) byId('cKmLEst').value = val;
  }
  
  // Función para actualizar el odómetro anterior cuando se selecciona un vehículo
  async function updatePreviousOdometer() {
    const vehiculoId = byId('cVeh').value;
    if (vehiculoId) {
      const lastOdometer = await getLastFuelOdo(vehiculoId);
      const el = byId('cOdoPrev');
      if (el) {
        el.value = lastOdometer;
        calcKmLEstimado(); // Recalcular km/L estimado
      }
    } else {
      // Si no hay vehículo seleccionado, limpiar el campo
      const el = byId('cOdoPrev');
      if (el) el.value = '';
    }
  }
  
  // Función para limpiar formularios después de guardar
  function clearFuelForm() {
    ['cVeh', 'cFecha', 'cLitros', 'cPPL', 'cOdo', 'cProv', 'cOdoPrev', 'cKmLEst', 'cCosto'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
  }
  
  function clearMaintenanceForm() {
    ['mVeh', 'mTipo', 'mFecha', 'mCosto', 'mKm', 'mProx', 'mProxFecha', 'mObs', 'mKmPrevAceite'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
    // Después de limpiar, actualizar la visibilidad de campos
    toggleMaintenanceFields();
  }
  
  function clearInspectionForm() {
    ['rVeh', 'rFecha', 'rInsp', 'rMotor', 'rFreno', 'rLuces', 'rLlantas', 'rCarroc', 'rObs', 'rAprobado'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else if (el.type === 'checkbox') {
          el.checked = false;
        } else {
          el.value = '';
        }
      }
    });
  }
  
  function clearPolicyForm() {
    ['pVeh', 'pNum', 'pAseg', 'pVence'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
  }
  
  function clearRTVForm() {
    ['rtvVeh', 'rCita', 'rVence'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
  }

  function exportarVehiculo(){ const placa = byId('fltVehPlaca').value; if(!placa) return alert('Seleccione una placa en el filtro'); exportFichaExcel(placa); }
  function autoProximoKm(){ const tipo = byId('mTipo').value; if(tipo !== 'cambio_aceite') { alert('Aplica solo a "Cambio de aceite"'); return; } const km = parseInt(byId('mKm').value||'0',10); if(!km || Number.isNaN(km) || km<0){ alert('Ingrese km actual válido'); return; } byId('mProx').value = km + 5000; }
  
  // Función para mostrar/ocultar campos específicos de mantenimiento
  function toggleMaintenanceFields() {
    const tipo = byId('mTipo').value;
    const isOilChange = tipo === 'cambio_aceite';
    const isPreventive = tipo === 'mantenimiento_preventivo';
    const requiresAlerts = isOilChange || isPreventive;
    
    // SIEMPRE mostrar campos de kilometraje (para todos los tipos)
    const kmFields = byId('maintenanceKmFields');
    if (kmFields) {
      kmFields.style.display = 'grid';
    }
    
    // Mostrar campos de fecha próxima para cambio de aceite y mantenimiento preventivo
    const dateFields = byId('maintenanceDateFields');
    if (dateFields) {
      dateFields.style.display = requiresAlerts ? 'grid' : 'none';
    }
    
    // Auto-completar sugerencias
    if (requiresAlerts) {
      // Sugerir fecha próxima (3 meses para aceite, 6 meses para preventivo)
      const today = new Date();
      const monthsToAdd = isOilChange ? 3 : 6;
      today.setMonth(today.getMonth() + monthsToAdd);
      const suggestedDate = today.toISOString().split('T')[0];
      
      const proxFechaField = byId('mProxFecha');
      if (proxFechaField && !proxFechaField.value) {
        proxFechaField.value = suggestedDate;
      }
    }
    
    // Limpiar campos cuando no aplica
    if (!requiresAlerts) {
      ['mProx', 'mProxFecha', 'mKmPrevAceite'].forEach(id => {
        const el = byId(id);
        if (el) el.value = '';
      });
    }
  }
  
  // ====== FUNCIONES DE EDICIÓN ======
  
  function editarVehiculo(id) {
    console.log('Editando vehículo ID:', id);
    
    if (!hasPermission('vehiculos')) {
      alert('Sin permisos para editar vehículos');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == id);
    console.log('Vehículo encontrado:', vehiculo);
    
    if (!vehiculo) {
      alert('Vehículo no encontrado');
      return;
    }
    
    // Llenar el modal de edición
    byId('editVehId').value = vehiculo.id;
    byId('editVPlaca').value = vehiculo.placa || '';
    byId('editVMarca').value = vehiculo.marca || '';
    byId('editVModelo').value = vehiculo.modelo || '';
    byId('editVAnio').value = vehiculo.ano || '';
    byId('editVTipo').value = vehiculo.tipo || 'otro';
    byId('editVEstado').value = vehiculo.estado || 'activo';
    byId('editVDueno').value = vehiculo.propietario || '';
    byId('editVPoliza').value = vehiculo.poliza || '';
    byId('editVAseguradora').value = vehiculo.seguro || '';
    byId('editVColor').value = vehiculo.color || '';
    
    // Mostrar modal
    const modal = byId('modalEditVehiculo');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarVehiculo(e) {
    e.preventDefault();
    
    const id = byId('editVehId').value;
    const placa = byId('editVPlaca').value.trim().toUpperCase();
    
    // Validaciones
    if(!placa) return alert('La placa es requerida');
    if(!byId('editVMarca').value.trim()) return alert('La marca es requerida');
    if(!byId('editVModelo').value.trim()) return alert('El modelo es requerido');
    
    const obj = {
      marca: byId('editVMarca').value.trim(),
      modelo: byId('editVModelo').value.trim(),
      ano: parseInt(byId('editVAnio').value),
      color: byId('editVColor').value || 'No especificado',
      propietario: byId('editVDueno').value || 'Hotel',
      poliza: byId('editVPoliza').value || null,
      seguro: byId('editVAseguradora').value || null
    };
    
    try {
      await apiPut('vehiculos', placa, obj);
      Vehiculos = await apiGet('vehiculos');
      fillVehSelects();
      fillPlacaFilters();
      renderVehiculos();
      cerrarModal('modalEditVehiculo');
      alert('✅ Vehículo actualizado exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  function editarMantenimiento(id) {
    console.log('Editando mantenimiento ID:', id);
    
    if (!hasPermission('mantenimientos')) {
      alert('Sin permisos para editar mantenimientos');
      return;
    }
    
    const mant = Mantenimientos.find(m => m.id == id);
    console.log('Mantenimiento encontrado:', mant);
    
    if (!mant) {
      alert('Mantenimiento no encontrado');
      return;
    }
    
    fillVehSelects(); // Asegurar que los selects estén llenos
    
    byId('editMantId').value = mant.id;
    // Encontrar el vehículo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === mant.placa);
    byId('editMVeh').value = vehiculo ? vehiculo.id : '';
    byId('editMTipo').value = mant.tipo;
    byId('editMFecha').value = mant.fecha;
    byId('editMCosto').value = mant.costo;
    byId('editMKm').value = mant.kilometraje || '';
    byId('editMProx').value = mant.proximo_km || '';
    byId('editMProxFecha').value = mant.proxima_fecha || '';
    byId('editMObs').value = mant.descripcion || '';
    
    const modal = byId('modalEditMantenimiento');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarMantenimiento(e) {
    e.preventDefault();
    
    const id = byId('editMantId').value;
    const vehiculoId = byId('editMVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un vehículo válido');
      return;
    }
    
    const obj = {
      fecha: byId('editMFecha').value,
      placa: vehiculo.placa,
      tipo: byId('editMTipo').value,
      descripcion: byId('editMObs').value || byId('editMTipo').value,
      costo: parseFloat(byId('editMCosto').value),
      kilometraje: byId('editMKm').value ? parseInt(byId('editMKm').value) : null,
      proximo_km: byId('editMProx').value ? parseInt(byId('editMProx').value) : null,
      proxima_fecha: byId('editMProxFecha').value || null
    };
    
    try {
      await apiPut('mantenimientos', id, obj);
      Mantenimientos = await apiGet('mantenimientos');
      renderMant();
      renderKpis();
      cerrarModal('modalEditMantenimiento');
      alert('✅ Mantenimiento actualizado exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  // ====== FUNCIONES PARA REVISIONES ======
  function verDetalleRevision(id) {
    console.log('Viendo detalle de revisión ID:', id);
    
    const revision = Revisiones.find(r => r.id == id);
    if (!revision) {
      alert('Revisión no encontrada');
      return;
    }
    
    // Crear contenido del modal con todos los detalles
    const contenido = `
      <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
        <h3 style="margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
          🔍 Detalle de Revisión - ${revision.placa}
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <strong>📅 Fecha:</strong> ${revision.fecha}<br>
            <strong>👨‍🔧 Inspector:</strong> ${revision.inspector}<br>
            <strong>🚗 Vehículo:</strong> ${revision.placa}
          </div>
          <div>
            <strong>✅ Aprobado:</strong> ${revision.aprobado ? '✅ Sí' : '❌ No'}<br>
            <strong>📝 Observaciones:</strong> ${revision.observaciones || 'Ninguna'}
          </div>
        </div>
        
        <h4 style="color: var(--secondary); margin: 20px 0 10px 0;">🔍 Estados de Componentes</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <strong>🔥 Motor:</strong> <span class="pill ${getEstadoPill(revision.estado_motor)}">${revision.estado_motor || 'No revisado'}</span><br>
            <strong>🛑 Frenos:</strong> <span class="pill ${getEstadoPill(revision.estado_frenos)}">${revision.estado_frenos || 'No revisado'}</span><br>
            <strong>💡 Luces:</strong> <span class="pill ${getEstadoPill(revision.estado_luces)}">${revision.estado_luces || 'No revisado'}</span><br>
            <strong>🎯 Llantas:</strong> <span class="pill ${getEstadoPill(revision.estado_llantas)}">${revision.estado_llantas || 'No revisado'}</span>
          </div>
          <div>
            <strong>🚗 Carrocería:</strong> <span class="pill ${getEstadoPill(revision.estado_carroceria)}">${revision.estado_carroceria || 'No revisado'}</span><br>
            <strong>🧠 Interior:</strong> <span class="pill ${getEstadoPill(revision.estado_interior)}">${revision.estado_interior || 'No revisado'}</span><br>
            <strong>🔋 Batería:</strong> <span class="pill ${getEstadoPill(revision.bateria)}">${revision.bateria || 'No revisado'}</span><br>
            <strong>🛢️ Sistema Frenos:</strong> <span class="pill ${getEstadoPill(revision.sistema_frenos)}">${revision.sistema_frenos || 'No revisado'}</span>
          </div>
        </div>
        
        <h4 style="color: var(--secondary); margin: 20px 0 10px 0;">🫢 Fluidos</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <strong>🛫 Aceite Motor:</strong> <span class="pill ${getEstadoPill(revision.aceite_motor)}">${revision.aceite_motor || 'No revisado'}</span><br>
            <strong>🔴 Líquido Frenos:</strong> <span class="pill ${getEstadoPill(revision.liquido_frenos)}">${revision.liquido_frenos || 'No revisado'}</span>
          </div>
          <div>
            <strong>🧊 Refrigerante:</strong> <span class="pill ${getEstadoPill(revision.coolant)}">${revision.coolant || 'No revisado'}</span>
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
          <button class="secondary" onclick="cerrarModal('modalDetalleRevision')">Cerrar</button>
          <button class="primary" onclick="cerrarModal('modalDetalleRevision'); editarRevision('${revision.id}');">Editar</button>
        </div>
      </div>
    `;
    
    // Crear modal dinámico
    let modal = byId('modalDetalleRevision');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modalDetalleRevision';
      modal.className = 'modal';
      modal.innerHTML = '<div class="modal-content"></div>';
      document.body.appendChild(modal);
    }
    
    modal.querySelector('.modal-content').innerHTML = contenido;
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
  }
  
  function getEstadoPill(estado) {
    if (!estado) return 'ok';
    const estadoLower = estado.toLowerCase();
    if (estadoLower.includes('excelente') || estadoLower.includes('bueno')) return 'ok';
    if (estadoLower.includes('regular') || estadoLower.includes('revisar') || estadoLower.includes('bajo')) return 'warnP';
    if (estadoLower.includes('malo') || estadoLower.includes('cambiar') || estadoLower.includes('urgente') || estadoLower.includes('daños')) return 'dangerP';
    return 'ok';
  }
  
  function editarRevision(id) {
    console.log('Editando revisión ID:', id);
    
    if (!hasPermission('revision')) {
      alert('Sin permisos para editar revisiones');
      return;
    }
    
    const revision = Revisiones.find(r => r.id == id);
    console.log('Revisión encontrada:', revision);
    
    if (!revision) {
      alert('Revisión no encontrada');
      return;
    }
    
    fillVehSelects();
    
    // Llenar campos del modal de edición
    byId('editRevisionId').value = revision.id;
    const vehiculo = Vehiculos.find(v => v.placa === revision.placa);
    byId('editRevisionVehRev').value = vehiculo ? vehiculo.id : '';
    byId('editRFecha').value = revision.fecha;
    byId('editRInspector').value = revision.inspector;
    
    // Estados de componentes
    byId('editRMotor').value = revision.estado_motor || '';
    byId('editRFrenos').value = revision.estado_frenos || '';
    byId('editRLuces').value = revision.estado_luces || '';
    byId('editRLlantas').value = revision.estado_llantas || '';
    byId('editRCarroceria').value = revision.estado_carroceria || '';
    
    byId('editRevisionObs1').value = revision.observaciones || '';
    byId('editRAprobado').checked = revision.aprobado || false;
    
    const modal = byId('modalEditRevision');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarRevision(e) {
    e.preventDefault();
    
    const id = byId('editRevisionId').value;
    const vehiculoId = byId('editRevisionVehRev').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un vehículo válido');
      return;
    }
    
    const obj = {
      fecha: byId('editRFecha').value,
      placa: vehiculo.placa,
      inspector: byId('editRInspector').value,
      estado_motor: byId('editRMotor').value,
      estado_frenos: byId('editRFrenos').value,
      estado_luces: byId('editRLuces').value,
      estado_llantas: byId('editRLlantas').value,
      estado_carroceria: byId('editRCarroceria').value,
      observaciones: byId('editRevisionObs1').value,
      aprobado: byId('editRAprobado').checked
    };
    
    try {
      await apiPut('revisiones', id, obj);
      Revisiones = await apiGet('revisiones');
      renderRevisiones();
      renderKpis();
      cerrarModal('modalEditRevision');
      alert('✅ Revisión actualizada exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  // ====== FUNCIONES PARA PÓLIZAS ======
  function editarPoliza(id) {
    console.log('Editando póliza ID:', id);
    
    if (!hasPermission('polizas')) {
      alert('Sin permisos para editar pólizas');
      return;
    }
    
    const poliza = Polizas.find(p => p.id == id);
    console.log('Póliza encontrada:', poliza);
    
    if (!poliza) {
      alert('Póliza no encontrada');
      return;
    }
    
    fillVehSelects();
    
    byId('editPolizaId').value = poliza.id;
    // Encontrar el vehículo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === poliza.placa);
    byId('editPVeh').value = vehiculo ? vehiculo.id : '';
    byId('editPAseg').value = poliza.aseguradora;
    byId('editPNum').value = poliza.numero_poliza;
    byId('editPVence').value = poliza.fecha_vencimiento;
    byId('editPTipo').value = poliza.tipo_cobertura || 'Básica';
    byId('editPEstado').value = poliza.estado || 'Activa';
    
    const modal = byId('modalEditPoliza');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarPoliza(e) {
    e.preventDefault();
    
    const id = byId('editPolizaId').value;
    const vehiculoId = byId('editPVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un vehículo válido');
      return;
    }
    
    const obj = {
      numero_poliza: byId('editPNum').value,
      placa: vehiculo.placa,
      aseguradora: byId('editPAseg').value,
      fecha_inicio: new Date().toISOString().split('T')[0],
      fecha_vencimiento: byId('editPVence').value,
      tipo_cobertura: byId('editPTipo').value,
      estado: byId('editPEstado').value
    };
    
    try {
      await apiPut('polizas', id, obj);
      Polizas = await apiGet('polizas');
      renderPolizas();
      renderKpis();
      cerrarModal('modalEditPoliza');
      alert('✅ Póliza actualizada exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  async function eliminarPoliza(id) {
    if (!hasPermission('polizas')) {
      alert('Sin permisos para eliminar pólizas');
      return;
    }
    
    const poliza = Polizas.find(p => p.id == id);
    if (!poliza) {
      alert('Póliza no encontrada');
      return;
    }
    
    if (!confirm(`¿Está seguro de eliminar la póliza ${poliza.numero_poliza}?`)) {
      return;
    }
    
    try {
      await apiDelete('polizas', id);
      Polizas = await apiGet('polizas');
      renderPolizas();
      renderKpis();
      alert('✅ Póliza eliminada exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  // ====== FUNCIONES PARA RTV ======
  function editarRTV(id) {
    console.log('Editando RTV ID:', id);
    
    if (!hasPermission('polizas')) {
      alert('Sin permisos para editar RTV');
      return;
    }
    
    const rtv = RTV.find(r => r.id == id);
    console.log('RTV encontrado:', rtv);
    
    if (!rtv) {
      alert('RTV no encontrado');
      return;
    }
    
    fillVehSelects();
    
    byId('editRTVId').value = rtv.id;
    // Encontrar el vehículo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === rtv.placa);
    byId('editRevisionVeh').value = vehiculo ? vehiculo.id : '';
    byId('editRCita').value = rtv.numero_cita;
    byId('editRVence').value = rtv.fecha_vencimiento;
    byId('editREstado').value = rtv.estado || 'Vigente';
    byId('editRevisionObs2').value = rtv.observaciones || '';
    
    const modal = byId('modalEditRTV');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarRTV(e) {
    e.preventDefault();
    
    const id = byId('editRTVId').value;
    const vehiculoId = byId('editRevisionVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un vehículo válido');
      return;
    }
    
    const obj = {
      numero_cita: byId('editRCita').value,
      placa: vehiculo.placa,
      fecha_vencimiento: byId('editRVence').value,
      estado: byId('editREstado').value,
      observaciones: byId('editRevisionObs2').value || ''
    };
    
    try {
      await apiPut('rtv', id, obj);
      RTV = await apiGet('rtv');
      renderRtv();
      renderKpis();
      cerrarModal('modalEditRTV');
      alert('✅ RTV actualizado exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  async function eliminarRTV(id) {
    if (!hasPermission('polizas')) {
      alert('Sin permisos para eliminar RTV');
      return;
    }
    
    const rtv = RTV.find(r => r.id == id);
    if (!rtv) {
      alert('RTV no encontrado');
      return;
    }
    
    if (!confirm(`¿Está seguro de eliminar el RTV ${rtv.numero_cita}?`)) {
      return;
    }
    
    try {
      await apiDelete('rtv', id);
      RTV = await apiGet('rtv');
      renderRtv();
      renderKpis();
      alert('✅ RTV eliminado exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  function editarCombustible(id) {
    console.log('Editando combustible ID:', id);
    
    if (!hasPermission('combustible')) {
      alert('Sin permisos para editar registros de combustible');
      return;
    }
    
    const fuel = Combustible.find(f => f.id == id);
    console.log('Combustible encontrado:', fuel);
    
    if (!fuel) {
      alert('Registro de combustible no encontrado');
      return;
    }
    
    fillVehSelects();
    
    byId('editFuelId').value = fuel.id;
    // Encontrar el vehículo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === fuel.placa);
    byId('editCVeh').value = vehiculo ? vehiculo.id : '';
    byId('editCFecha').value = fuel.fecha;
    byId('editCLitros').value = fuel.litros;
    byId('editCPPL').value = fuel.costo / fuel.litros; // Calcular precio por litro
    byId('editCOdo').value = fuel.kilometraje;
    byId('editCProv').value = fuel.estacion || '';
    
    const modal = byId('modalEditCombustible');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarCombustible(e) {
    e.preventDefault();
    
    const id = byId('editFuelId').value;
    const vehiculoId = byId('editCVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un vehículo válido');
      return;
    }
    
    const litros = parseFloat(byId('editCLitros').value);
    const precioPorLitro = parseFloat(byId('editCPPL').value);
    const costo = litros * precioPorLitro;
    
    const obj = {
      fecha: byId('editCFecha').value,
      placa: vehiculo.placa,
      litros: litros,
      costo: costo,
      kilometraje: parseInt(byId('editCOdo').value) || null,
      estacion: byId('editCProv').value || null
    };
    
    try {
      await apiPut('combustible', id, obj);
      Combustible = await apiGet('combustible');
      renderFuel();
      renderKpis();
      cerrarModal('modalEditCombustible');
      alert('✅ Registro de combustible actualizado exitosamente');
    } catch (e2) {
      alert('❌ Error: ' + e2.message);
    }
  }
  
  function cerrarModal(modalId) {
    const modal = byId(modalId);
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  // Función para cerrar todos los modales
  function cerrarTodosLosModales() {
    const modales = ['modalEditVehiculo', 'modalEditMantenimiento', 'modalEditCombustible', 'reportePreview'];
    modales.forEach(modalId => {
      const modal = byId(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }
    });
    
    // También cerrar cualquier elemento con clase 'modal'
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    });
  }
  
  // Función para inicializar la aplicación correctamente
  function inicializarApp() {
    // Asegurarse de que todos los modales estén cerrados
    cerrarTodosLosModales();
    
    // Resetear cualquier estado de la interfaz
    const loginScreen = byId('loginScreen');
    const mainApp = byId('mainApp');
    
    if (loginScreen) loginScreen.style.display = 'flex';
    if (mainApp) mainApp.classList.remove('logged-in');
    
    // Limpiar formularios si existen
    try {
      limpiarFormVehiculo();
    } catch(e) {}
    
    // Asegurar que el dashboard sea la pestaña por defecto
    setTimeout(() => {
      setTab('dashboard');
    }, 100);
  }
  
  // Funciones de eliminación (solo para admin)
  async function eliminarVehiculo(id) {
    console.log('🗑️ Iniciando eliminación de vehículo, ID:', id);
    console.log('👤 Usuario actual:', currentUser);
    console.log('🔐 Role actual:', currentUser ? currentUser.role : 'No logueado');
    
    if (!currentUser || currentUser.role !== 'admin') {
      alert('⚠️ ACCESO DENEGADO\n\nSolo el ADMINISTRADOR puede eliminar vehículos.\n\n🔓 Para loguearse como admin:\n1. Seleccione rol "Administrador"\n2. Contraseña: "Admin"\n3. Haga clic en "Iniciar Sesión"');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == id);
    if (!vehiculo) return;
    
    if (confirm(`¿Está seguro de eliminar el vehículo ${vehiculo.placa}?`)) {
      try {
        console.log('📤 Enviando eliminación de vehículo:', vehiculo.placa);
        await apiDelete('vehiculos', vehiculo.placa);
        console.log('✅ Vehículo eliminado del servidor');
        
        // Actualizar datos automáticamente
        try {
          Vehiculos = await apiGet('vehiculos');
          refreshAllViews();
          alert('✅ Vehículo eliminado exitosamente');
        } catch (refreshError) {
          console.log('⚠️ Error al actualizar vista, pero vehículo eliminado:', refreshError.message);
          alert('✅ Vehículo eliminado exitosamente\n⚠️ Los datos se actualizarán automáticamente');
          
          // Forzar actualización después de delay
          setTimeout(async () => {
            try {
              Vehiculos = await apiGet('vehiculos');
              refreshAllViews();
            } catch (e) {
              console.error('Error en actualización diferida:', e);
            }
          }, 2000);
        }
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }
  }
  
  async function eliminarMantenimiento(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¿Está seguro de eliminar este registro de mantenimiento?')) {
      try {
        await apiDelete('mantenimientos', id);
        Mantenimientos = await apiGet('mantenimientos');
        renderMant();
        renderKpis();
        alert('✅ Registro eliminado exitosamente');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }
  }
  
  async function eliminarCombustible(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¿Está seguro de eliminar este registro de combustible?')) {
      try {
        await apiDelete('combustible', id);
        Combustible = await apiGet('combustible');
        renderFuel();
        renderKpis();
        alert('✅ Registro eliminado exitosamente');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }
  }

  async function eliminarRevision(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¿Está seguro de eliminar esta revisión?')) {
      try {
        await apiDelete('revisiones', id);
        Revisiones = await apiGet('revisiones');
        renderRevisiones();
        renderKpis();
        alert('✅ Revisión eliminada exitosamente');
      } catch (e) {
        alert('❌ Error: ' + e.message);
      }
    }
  }

  // ====== FICHA TÉCNICA ======
  
  function cargarFichaTecnica() {
    const vehiculoId = byId('fichaVehiculo').value;
    const periodo = byId('fichaPeriodo').value;
    
    if (!vehiculoId) {
      byId('fichaTecnicaContent').classList.add('hidden');
      return;
    }
    
    const vehiculo = vehById(vehiculoId);
    if (!vehiculo) return;
    
    // Calcular fecha límite según el período
    let fechaLimite = new Date('2000-01-01');
    if (periodo !== 'all') {
      fechaLimite = new Date();
      fechaLimite.setMonth(fechaLimite.getMonth() - parseInt(periodo));
    }
    
    // Filtrar datos por vehículo y período (usando placa en lugar de vehiculo_id)
    const mantVehiculo = Mantenimientos.filter(m => 
      m.placa === vehiculo.placa && 
      new Date(m.fecha) >= fechaLimite
    );
    
    const fuelVehiculo = Combustible.filter(f => 
      f.placa === vehiculo.placa && 
      new Date(f.fecha) >= fechaLimite
    );
    
    const revVehiculo = (Revisiones || []).filter(r => 
      r.placa === vehiculo.placa && 
      new Date(r.fecha) >= fechaLimite
    );
    
    // Información básica (usar placa en lugar de vehiculo_id)
    const poliza = Polizas.find(p => p.placa === vehiculo.placa);
    const rtvVehiculo = RTV.find(r => r.placa === vehiculo.placa);
    
    let infoBasica = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Placa:</strong> ${vehiculo.placa}<br>
          <strong>Marca:</strong> ${vehiculo.marca}<br>
          <strong>Modelo:</strong> ${vehiculo.modelo}<br>
          <strong>Año:</strong> ${vehiculo.ano || vehiculo.anio}<br>
          <strong>Tipo:</strong> Vehículo<br>
          <strong>Color:</strong> ${vehiculo.color || 'No especificado'}
        </div>
        <div>
          <strong>Propietario:</strong> ${vehiculo.propietario || vehiculo.dueno || 'Hotel'}<br>
          <strong>Estado:</strong> <span class="pill ok">Activo</span><br>
          <strong>Aseguradora:</strong> ${vehiculo.seguro || vehiculo.aseguradora || 'No especificada'}<br>
          <strong>Póliza:</strong> ${poliza ? poliza.numero_poliza : (vehiculo.poliza || 'No especificada')}<br>
          <strong>Vence Póliza:</strong> ${poliza ? poliza.fecha_vencimiento : 'No registrada'}<br>
          <strong>Vence RTV:</strong> ${rtvVehiculo ? rtvVehiculo.fecha_vencimiento : 'No registrada'}
        </div>
      </div>
    `;
    
    // Estadísticas de rendimiento
    const totalKm = fuelVehiculo.length > 0 ? 
      Math.max(...fuelVehiculo.map(f => Number(f.kilometraje || 0))) - 
      Math.min(...fuelVehiculo.map(f => Number(f.kilometraje || 0))) : 0;
    
    const totalLitros = fuelVehiculo.reduce((a, f) => a + Number(f.litros), 0);
    const promedioKmL = totalLitros > 0 ? (totalKm / totalLitros).toFixed(1) : '0';
    
    const ultimaRevision = revVehiculo.length > 0 ? 
      revVehiculo.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0] : null;
    
    let estadisticas = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Km Recorridos (período):</strong> ${totalKm.toLocaleString()} km<br>
          <strong>Litros Consumidos:</strong> ${totalLitros.toFixed(1)} L<br>
          <strong>Promedio Km/L:</strong> ${promedioKmL}<br>
          <strong>Mantenimientos:</strong> ${mantVehiculo.length}
        </div>
        <div>
          <strong>Revisiones:</strong> ${revVehiculo.length}<br>
          <strong>Última Revisión:</strong> ${ultimaRevision ? new Date(ultimaRevision.fecha).toLocaleDateString() : 'No registrada'}<br>
          <strong>Odómetro Actual:</strong> ${fuelVehiculo.length > 0 ? Math.max(...fuelVehiculo.map(f => Number(f.kilometraje || 0))).toLocaleString() : 'No disponible'} km
        </div>
      </div>
    `;
    
    // Análisis de costos (usar campos correctos del nuevo backend)
    const totalMant = mantVehiculo.reduce((a, m) => a + Number(m.costo || 0), 0);
    const totalComb = fuelVehiculo.reduce((a, f) => a + Number(f.costo || 0), 0); // Usar costo directo
    const promedioMantMensual = mantVehiculo.length > 0 ? (totalMant / parseInt(periodo === 'all' ? 12 : periodo)) : 0;
    
    let costos = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Costo Total Mantenimiento:</strong> ${fmt(totalMant)}<br>
          <strong>Costo Total Combustible:</strong> ${fmt(totalComb)}<br>
          <strong>Costo Total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(totalMant + totalComb)}</span>
        </div>
        <div>
          <strong>Promedio Mant. Mensual:</strong> ${fmt(promedioMantMensual)}<br>
          <strong>Costo por Km:</strong> ${totalKm > 0 ? fmt((totalMant + totalComb) / totalKm) : fmt(0)}<br>
          <strong>Costo por Litro Prom.:</strong> ${totalLitros > 0 ? fmt(totalComb / totalLitros) : fmt(0)}
        </div>
      </div>
    `;
    
    // Alertas
    const alertasVehiculo = (Alertas || []).filter(a => Number(a.vehiculo_id) === Number(vehiculoId));
    let alertasHtml = alertasVehiculo.length > 0 ? 
      alertasVehiculo.map(a => `<div class="pill ${a.estado === 'pendiente' ? 'warnP' : 'ok'}">${a.tipo}: ${a.dias_restantes || a.km_restantes || 'Revisar'}</div>`).join('') :
      '<div class="pill ok">Sin alertas pendientes</div>';
    
    // Historial combinado
    let historial = [];
    
    mantVehiculo.forEach(m => {
      historial.push({
        fecha: m.fecha,
        tipo: 'Mantenimiento',
        detalle: `${m.tipo} - ${fmt(m.costo)}`,
        km: m.kilometraje || '',
        observaciones: m.descripcion || ''
      });
    });
    
    fuelVehiculo.forEach(f => {
      const precioLitro = f.litros > 0 ? (Number(f.costo) / Number(f.litros)) : 0;
      // Calcular km/L para la ficha técnica
      const prev = Combustible
        .filter(x=> x.placa === f.placa && new Date(x.fecha) < new Date(f.fecha))
        .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
      const dist = prev ? (Number(f.kilometraje)-Number(prev.kilometraje)) : null;
      const kmL = (dist && dist > 0 && Number(f.litros) > 0) ? (dist/Number(f.litros)).toFixed(1) : null;
      
      historial.push({
        fecha: f.fecha,
        tipo: 'Combustible',
        detalle: `${f.litros}L - ${fmt(f.costo)} (₡${Math.round(precioLitro)}/L)${kmL ? ` - ${kmL} km/L` : ''}`,
        km: f.kilometraje || '',
        observaciones: f.estacion || ''
      });
    });
    
    revVehiculo.forEach(r => {
      historial.push({
        fecha: r.fecha,
        tipo: 'Revisión',
        detalle: `Revisión Técnica por ${r.inspector}`,
        km: '', // Las revisiones no tienen kilometraje
        observaciones: r.observaciones || `Estados: Motor(${r.estado_motor}), Frenos(${r.estado_frenos}), Luces(${r.estado_luces})`
      });
    });
    
    historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    const historialHtml = historial.map(h => `
      <tr>
        <td>${h.fecha}</td>
        <td><span class="pill ${h.tipo === 'Mantenimiento' ? 'warnP' : h.tipo === 'Combustible' ? 'ok' : 'dangerP'}">${h.tipo}</span></td>
        <td>${h.detalle}</td>
        <td>${h.km}</td>
        <td>${h.observaciones}</td>
      </tr>
    `).join('');
    
    // Llenar el contenido
    byId('fichaInfoBasica').innerHTML = infoBasica;
    byId('fichaEstadisticas').innerHTML = estadisticas;
    byId('fichaCostos').innerHTML = costos;
    byId('fichaAlertas').innerHTML = alertasHtml;
    byId('fichaHistorial').innerHTML = `
      <table>
        <thead>
          <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Km</th><th>Observaciones</th></tr>
        </thead>
        <tbody>${historialHtml}</tbody>
      </table>
    `;
    
    byId('fichaTecnicaContent').classList.remove('hidden');
  }
  
  function exportarFichaTecnicaCompleta() {
    const vehiculoId = byId('fichaVehiculo').value;
    if (!vehiculoId) {
      alert('Seleccione un vehículo primero');
      return;
    }
    
    const vehiculo = vehById(vehiculoId);
    exportFichaExcel(vehiculo.placa);
  }
  
  function previsualizarFicha() {
    alert('Vista previa de ficha técnica - Esta funcionalidad se puede expandir para mostrar un reporte imprimible');
  }

  // ====== EXPORTS (XLSX) ======
  function exportFichaExcel(placa){
    const v = Vehiculos.find(x=>x.placa===placa); 
    if(!v) return alert('Placa no existe');
    
    // Usar la nueva función mejorada
    byId('repTipo').value = 'ficha_vehiculo';
    byId('repPlaca').value = placa;
    exportReportXLSX();
  }
  function exportMantXLSX(){
    // Usar la nueva función mejorada
    byId('repTipo').value = 'mantenimientos';
    byId('repA').value = '2000-01-01';
    byId('repB').value = today();
    byId('repPlaca').value = '';
    exportReportXLSX();
  }
  
  function exportFuelXLSX(){
    // Usar la nueva función mejorada
    byId('repTipo').value = 'combustible';
    byId('repA').value = '2000-01-01';
    byId('repB').value = today();
    byId('repPlaca').value = '';
    exportReportXLSX();
  }
  
  function exportAlertXLSX(){
    // Generar reporte de alertas (vencimientos próximos)
    const wb = XLSX.utils.book_new();
    const fechaActual = new Date();
    
    // Alertas de pólizas
    const alertasPolizas = Polizas.map(p => {
      const dias = diasRestantes(p.fecha_vencimiento);
      return {
        'Tipo': 'Póliza de Seguro',
        'Placa': p.placa,
        'Detalle': `${p.aseguradora} - ${p.numero_poliza}`,
        'Fecha Vencimiento': p.fecha_vencimiento,
        'Días Restantes': dias,
        'Estado': dias <= 0 ? 'VENCIDA' : dias <= 7 ? 'CRÍTICO' : dias <= 30 ? 'PRÓXIMO A VENCER' : 'VIGENTE',
        'Prioridad': dias <= 0 ? '🔴 URGENTE' : dias <= 7 ? '🟠 ALTA' : dias <= 30 ? '🟡 MEDIA' : '🟢 BAJA'
      };
    }).filter(a => a['Días Restantes'] <= 30); // Solo alertas de próximos 30 días
    
    // Alertas de RTV
    const alertasRTV = RTV.map(r => {
      const dias = diasRestantes(r.fecha_vencimiento);
      return {
        'Tipo': 'Revisión Técnica Vehicular',
        'Placa': r.placa,
        'Detalle': `Cita: ${r.numero_cita}`,
        'Fecha Vencimiento': r.fecha_vencimiento,
        'Días Restantes': dias,
        'Estado': dias <= 0 ? 'VENCIDA' : dias <= 7 ? 'CRÍTICO' : dias <= 30 ? 'PRÓXIMO A VENCER' : 'VIGENTE',
        'Prioridad': dias <= 0 ? '🔴 URGENTE' : dias <= 7 ? '🟠 ALTA' : dias <= 30 ? '🟡 MEDIA' : '🟢 BAJA'
      };
    }).filter(a => a['Días Restantes'] <= 30);
    
    // Combinar todas las alertas
    const todasAlertas = [...alertasPolizas, ...alertasRTV]
      .sort((a, b) => a['Días Restantes'] - b['Días Restantes']);
    
    if(todasAlertas.length === 0) {
      alert('No hay alertas de vencimiento en los próximos 30 días');
      return;
    }
    
    const ws = XLSX.utils.json_to_sheet(todasAlertas);
    ws['!cols'] = [
      {wch: 25}, // Tipo
      {wch: 12}, // Placa
      {wch: 25}, // Detalle
      {wch: 15}, // Fecha Venc
      {wch: 10}, // Días
      {wch: 18}, // Estado
      {wch: 12}  // Prioridad
    ];
    
    // Agregar título
    const fechaGeneracion = new Date().toLocaleString('es-ES');
    XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE ALERTAS Y VENCIMIENTOS - Generado: ${fechaGeneracion}`]], {origin: "A1"});
    
    XLSX.utils.book_append_sheet(wb, ws, 'Alertas');
    XLSX.writeFile(wb, `alertas_vencimientos_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
    
    alert(`✅ Reporte de alertas exportado con ${todasAlertas.length} elementos`);
  }
  // ====== REPORTES MEJORADOS ======
  
  function actualizarConfigReporte() {
    const tipo = byId('repTipo').value;
    const configDiv = byId('repConfigAdicional');
    
    // Limpiar configuración anterior
    configDiv.innerHTML = '';
    
    // Agregar configuraciones específicas según el tipo
    if (tipo === 'ficha_vehiculo') {
      configDiv.innerHTML = `
        <div class="form-group">
          <label>Período de Análisis</label>
          <select id="repPeriodo">
            <option value="3">Últimos 3 meses</option>
            <option value="6">Últimos 6 meses</option>
            <option value="12">Último año</option>
            <option value="all">Todo el historial</option>
          </select>
        </div>
      `;
    } else if (tipo === 'resumen_costos') {
      configDiv.innerHTML = `
        <div class="form-group">
          <label>Agrupar por</label>
          <select id="repAgrupar">
            <option value="vehiculo">Vehículo</option>
            <option value="mes">Mes</option>
            <option value="tipo">Tipo de Gasto</option>
          </select>
        </div>
      `;
    }
  }
  
  function previsualizarReporte() {
    const tipo = byId('repTipo').value;
    const placa = byId('repPlaca').value;
    const fechaA = byId('repA').value || '2000-01-01';
    const fechaB = byId('repB').value || today();
    
    // Generar y almacenar datos para uso posterior en email
    currentReportData = generarDatosReporte(tipo, placa, fechaA, fechaB);
    
    let contenido = '';
    let titulo = '';
    
    // Generar contenido según el tipo de reporte
    switch(tipo) {
      case 'mantenimientos':
        titulo = 'Reporte de Mantenimientos';
        contenido = generarReporteMantenimientos(placa, fechaA, fechaB);
        break;
      case 'combustible':
        titulo = 'Reporte de Combustible';
        contenido = generarReporteCombustible(placa, fechaA, fechaB);
        break;
      case 'revisiones':
        titulo = 'Reporte de Revisiones';
        contenido = generarReporteRevisiones(placa, fechaA, fechaB);
        break;
      case 'polizas_rtv':
        titulo = 'Reporte de Pólizas y RTV';
        contenido = generarReportePolizasRTV();
        break;
      case 'ficha_vehiculo':
        if (!placa) {
          alert('Seleccione un vehículo para la ficha técnica');
          return;
        }
        titulo = `Ficha Técnica - ${placa}`;
        contenido = generarFichaTecnicaCompleta(placa);
        break;
      case 'resumen_costos':
        titulo = 'Resumen de Costos';
        contenido = generarResumenCostos(placa, fechaA, fechaB);
        break;
      case 'alertas':
        titulo = 'Alertas y Vencimientos';
        contenido = generarReporteAlertas();
        break;
    }
    
    // Mostrar en el modal de vista previa
    const reporteContent = byId('reporteContent');
    reporteContent.innerHTML = `
      <div class="report-header">
        <div class="report-title">${titulo}</div>
        <div class="report-date">Generado el ${new Date().toLocaleDateString('es-CR')}</div>
        ${placa ? `<div style="margin-top:8px">Vehículo: <strong>${placa}</strong></div>` : ''}
        ${fechaA !== '2000-01-01' ? `<div>Período: ${fechaA} - ${fechaB}</div>` : ''}
      </div>
      ${contenido}
    `;
    
    byId('reportePreview').classList.remove('hidden');
  }
  
  function generarReporteMantenimientos(placa, fechaA, fechaB) {
    const data = Mantenimientos.filter(x=> 
      x.fecha >= fechaA && x.fecha <= fechaB && 
      (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
    );
    
    const total = data.reduce((a, m) => a + Number(m.costo || 0), 0);
    
    const tablaHtml = `
      <h4>📊 Resumen</h4>
      <p><strong>Total de registros:</strong> ${data.length}</p>
      <p><strong>Costo total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(total)}</span></p>
      
      <h4>📋 Detalle</h4>
      <table>
        <thead>
          <tr><th>Placa</th><th>Fecha</th><th>Tipo</th><th>Costo</th><th>Km</th><th>Observaciones</th></tr>
        </thead>
        <tbody>
          ${data.map(m => `
            <tr>
              <td>${vehById(m.vehiculo_id)?.placa||''}</td>
              <td>${m.fecha}</td>
              <td>${m.tipo}</td>
              <td><strong>${fmt(m.costo)}</strong></td>
              <td>${m.km_actual || ''}</td>
              <td>${m.observaciones || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    return data.length > 0 ? tablaHtml : '<p>No se encontraron registros para el período seleccionado.</p>';
  }
  
  function generarReporteCombustible(placa, fechaA, fechaB) {
    const data = Combustible.filter(x=> 
      x.fecha >= fechaA && x.fecha <= fechaB && 
      (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
    );
    
    const totalCosto = data.reduce((a, f) => a + (Number(f.litros) * Number(f.precio_por_litro)), 0);
    const totalLitros = data.reduce((a, f) => a + Number(f.litros), 0);
    
    const tablaHtml = `
      <h4>📊 Resumen</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div>
          <p><strong>Total de cargas:</strong> ${data.length}</p>
          <p><strong>Total litros:</strong> ${totalLitros.toFixed(1)} L</p>
        </div>
        <div>
          <p><strong>Costo total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(totalCosto)}</span></p>
          <p><strong>Precio promedio/L:</strong> ${totalLitros > 0 ? fmt(totalCosto/totalLitros) : fmt(0)}</p>
        </div>
      </div>
      
      <h4>📋 Detalle</h4>
      <table>
        <thead>
          <tr><th>Placa</th><th>Fecha</th><th>Litros</th><th>₡/L</th><th>Costo</th><th>Odómetro</th><th>Proveedor</th></tr>
        </thead>
        <tbody>
          ${data.map(f => `
            <tr>
              <td>${vehById(f.vehiculo_id)?.placa||''}</td>
              <td>${f.fecha}</td>
              <td>${f.litros}</td>
              <td>${fmt(f.precio_por_litro)}</td>
              <td><strong>${fmt(Number(f.litros) * Number(f.precio_por_litro))}</strong></td>
              <td>${f.odometro_km} km</td>
              <td>${f.proveedor || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    return data.length > 0 ? tablaHtml : '<p>No se encontraron registros para el período seleccionado.</p>';
  }
  
  function cerrarPreviewReporte() {
    byId('reportePreview').classList.add('hidden');
  }
  
  function imprimirReporte() {
    window.print();
  }
  
  async function enviarReporteEmail() {
    try {
      // Verificar que haya datos para enviar
      if (!currentReportData || currentReportData.length === 0) {
        alert('❌ Debe generar una vista previa del reporte antes de enviarlo por email');
        return;
      }
      
      // Obtener configuración de email
      let emailConfig;
      try {
        emailConfig = await apiGet('config/email');
      } catch (e) {
        alert('❌ Error obteniendo configuración de email. Verifique que esté configurada en "Config. Alertas"');
        return;
      }
      
      if (!emailConfig.email_destino) {
        alert('❌ No hay email de destino configurado. Configure primero en "Config. Alertas"');
        return;
      }
      
      const tipo = byId('repTipo').value;
      const placa = byId('repPlaca').value || '';
      const fechaInicio = byId('repA').value || '2000-01-01';
      const fechaFin = byId('repB').value || today();
      
      // Generar título del reporte
      const tipoTextos = {
        'mantenimientos': '🔧 Mantenimientos',
        'combustible': '⛽ Combustible',
        'revisiones': '🔍 Revisiones',
        'polizas_rtv': '🛡️ Pólizas & RTV',
        'ficha_vehiculo': '📋 Ficha Técnica por Vehículo',
        'resumen_costos': '💰 Resumen de Costos',
        'alertas': '⚠️ Alertas y Vencimientos',
        'resumen_general': '📊 Resumen General de Flota'
      };
      
      const tituloReporte = tipoTextos[tipo] || 'Reporte';
      const vehiculoTexto = placa ? ` - Vehículo ${placa}` : ' - Todos los vehículos';
      const subject = `📊 ${tituloReporte}${vehiculoTexto} (${fechaInicio} a ${fechaFin})`;
      
      // Convertir datos a HTML para el email
      const htmlTable = generateHtmlTable(currentReportData, tituloReporte);
      
      const emailData = {
        destinatario: emailConfig.email_destino,
        asunto: subject,
        mensaje_html: `
          <h2>📊 Sistema de Gestión Vehicular - Reporte</h2>
          <p><strong>Tipo:</strong> ${tituloReporte}</p>
          <p><strong>Período:</strong> ${fechaInicio} a ${fechaFin}</p>
          <p><strong>Vehículo:</strong> ${placa || 'Todos los vehículos'}</p>
          <p><strong>Fecha de generación:</strong> ${new Date().toLocaleString('es-CR')}</p>
          <hr>
          ${htmlTable}
          <hr>
          <p><small>Reporte generado automáticamente por el Sistema de Gestión Vehicular</small></p>
        `
      };
      
      const response = await fetch(`${API}/reportes/enviar-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(emailData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(`✅ Reporte enviado exitosamente a ${emailConfig.email_destino}`);
      } else {
        alert('❌ Error enviando reporte: ' + (result.message || 'Error desconocido'));
      }
      
    } catch (e) {
      alert('❌ Error enviando reporte por email: ' + e.message);
      console.error('Error enviando reporte:', e);
    }
  }
  
  // Variable global para almacenar datos del reporte actual
  let currentReportData = null;
  
  // Función para generar datos del reporte para email
  function generarDatosReporte(tipo, placa, fechaA, fechaB) {
    switch(tipo) {
      case 'mantenimientos':
        return Mantenimientos.filter(x=> 
          x.fecha >= fechaA && x.fecha <= fechaB && 
          (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
        ).map(m => ({
          'Placa': vehById(m.vehiculo_id)?.placa || '',
          'Fecha': m.fecha,
          'Tipo': m.tipo,
          'Costo (₡)': Number(m.costo || 0),
          'Kilometraje': m.km_actual || '',
          'Observaciones': m.observaciones || ''
        }));
        
      case 'combustible':
        return Combustible.filter(x=> 
          x.fecha >= fechaA && x.fecha <= fechaB && 
          (!placa || x.placa === placa)
        ).map(c => ({
          'Placa': c.placa,
          'Fecha': c.fecha,
          'Litros': Number(c.litros || 0),
          'Costo (₡)': Number(c.costo || 0),
          'Kilometraje': c.kilometraje || '',
          'Estación': c.estacion || '',
          'Tipo Combustible': c.tipo_combustible || ''
        }));
        
      case 'revisiones':
        return Revisiones.filter(x=> 
          x.fecha >= fechaA && x.fecha <= fechaB && 
          (!placa || x.placa === placa)
        ).map(r => ({
          'Placa': r.placa,
          'Fecha': r.fecha,
          'Inspector': r.inspector,
          'Estado Motor': r.estado_motor,
          'Estado Frenos': r.estado_frenos,
          'Estado Luces': r.estado_luces,
          'Estado Llantas': r.estado_llantas,
          'Aprobado': r.aprobado ? 'Sí' : 'No',
          'Observaciones': r.observaciones || ''
        }));
        
      case 'polizas_rtv':
        const polizasData = Polizas.map(p => ({
          'Tipo': 'Póliza',
          'Placa': p.placa,
          'Número': p.numero_poliza,
          'Aseguradora/Centro': p.aseguradora,
          'Fecha Inicio': p.fecha_inicio,
          'Fecha Vencimiento': p.fecha_vencimiento,
          'Estado': p.estado
        }));
        const rtvData = RTV.map(r => ({
          'Tipo': 'RTV',
          'Placa': r.placa,
          'Número': r.numero_cita,
          'Aseguradora/Centro': r.centro_revision,
          'Fecha Inicio': r.fecha_revision,
          'Fecha Vencimiento': r.fecha_vencimiento,
          'Estado': r.estado
        }));
        return [...polizasData, ...rtvData];
        
      default:
        return [];
    }
  }
  
  // Función auxiliar para generar tabla HTML
  function generateHtmlTable(data, titulo) {
    if (!data || data.length === 0) return '<p>No hay datos para mostrar</p>';
    
    // Obtener las claves del primer objeto como cabeceras
    const headers = Object.keys(data[0]);
    
    let html = `<table style="border-collapse: collapse; width: 100%; margin: 20px 0;">`;
    html += `<thead><tr style="background-color: #f4f4f4;">`;
    headers.forEach(header => {
      html += `<th style="border: 1px solid #ddd; padding: 8px; text-align: left;">${header}</th>`;
    });
    html += `</tr></thead><tbody>`;
    
    data.forEach((row, index) => {
      const bgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';
      html += `<tr style="background-color: ${bgColor};">`;
      headers.forEach(header => {
        const value = row[header] || '';
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${value}</td>`;
      });
      html += `</tr>`;
    });
    
    html += `</tbody></table>`;
    return html;
  }
  
  function exportReportXLSX(){
    const tipo = byId('repTipo').value;
    const placa = byId('repPlaca').value||'';
    const a = byId('repA').value||'2000-01-01';
    const b = byId('repB').value||today();
    const wb = XLSX.utils.book_new();
    
    // Información de encabezado para todos los reportes
    const fechaGeneracion = new Date().toLocaleString('es-ES');
    const rangoFechas = placa ? `Vehículo: ${placa} | ` : 'Todos los vehículos | ';
    const titulo = rangoFechas + `Período: ${a} a ${b} | Generado: ${fechaGeneracion}`;

    if(tipo==='mantenimientos'){
      // Filtrar y mapear datos de mantenimientos con la estructura correcta del nuevo backend
      const filtered = Mantenimientos.filter(x=> 
        x.fecha >= a && 
        x.fecha <= b && 
        (!placa || x.placa === placa)
      );
      
      const data = filtered.map(x=>({
        'Placa': x.placa || '',
        'Fecha': x.fecha,
        'Tipo de Mantenimiento': x.tipo || '',
        'Descripción': x.descripcion || '',
        'Costo (₡)': Number(x.costo) || 0,
        'Kilometraje': x.kilometraje || '',
        'Fecha de Registro': x.created_at ? new Date(x.created_at).toLocaleDateString('es-ES') : ''
      }));
      
      // Calcular totales
      const costoTotal = data.reduce((sum, item) => sum + Number(item['Costo (₡)']), 0);
      const cantidadServicios = data.length;
      
      // Agregar fila de resumen
      data.push({});
      data.push({
        'Placa': 'RESUMEN',
        'Fecha': `Total de servicios: ${cantidadServicios}`,
        'Tipo de Mantenimiento': '',
        'Descripción': '',
        'Costo (₡)': costoTotal,
        'Kilometraje': 'COSTO TOTAL',
        'Fecha de Registro': ''
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Formato de columnas
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Fecha
        {wch: 20}, // Tipo
        {wch: 30}, // Descripción
        {wch: 15}, // Costo
        {wch: 12}, // Kilometraje
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar título en la primera fila
      XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE MANTENIMIENTOS - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Mantenimientos');
      XLSX.writeFile(wb, `mantenimientos_${placa || 'todos'}_${a}_${b}.xlsx`);
      return;
    }
    
    if(tipo==='combustible'){
      // Filtrar y mapear datos de combustible con la estructura correcta
      const filtered = Combustible.filter(x=> 
        x.fecha >= a && 
        x.fecha <= b && 
        (!placa || x.placa === placa)
      );
      
      // Ordenar primero por placa y fecha para calcular km/L correctamente
      const sortedFiltered = filtered.sort((a,b) => {
        if (a.placa !== b.placa) return a.placa.localeCompare(b.placa);
        return new Date(a.fecha) - new Date(b.fecha);
      });
      
      const data = sortedFiltered.map((x, index) =>{
        const precioLitro = x.litros > 0 ? (Number(x.costo) / Number(x.litros)) : 0;
        
        // Calcular km/L correctamente
        // Buscar el registro anterior de la misma placa
        let kmL = null;
        for (let i = index - 1; i >= 0; i--) {
          const prev = sortedFiltered[i];
          if (prev.placa === x.placa && prev.kilometraje && x.kilometraje) {
            const kmActual = Number(x.kilometraje);
            const kmAnterior = Number(prev.kilometraje);
            const litros = Number(x.litros);
            
            if (kmActual > kmAnterior && litros > 0) {
              const distancia = kmActual - kmAnterior;
              kmL = (distancia / litros).toFixed(2);
            }
            break; // Solo tomar el registro inmediatamente anterior
          }
        }
        
        return {
          'Placa': x.placa || '',
          'Fecha': x.fecha,
          'Litros': Number(x.litros) || 0,
          'Precio/Litro (₡)': Math.round(precioLitro * 100) / 100,
          'Costo Total (₡)': Number(x.costo) || 0,
          'Odómetro (km)': x.kilometraje || '',
          'Km/L': kmL || 'N/A',
          'Estación': x.estacion || '',
          'Fecha de Registro': x.created_at ? new Date(x.created_at).toLocaleDateString('es-ES') : ''
        };
      });
      
      // Calcular totales y estadísticas
      const litrosTotales = data.reduce((sum, item) => sum + Number(item['Litros']), 0);
      const costoTotal = data.reduce((sum, item) => sum + Number(item['Costo Total (₡)']), 0);
      const promedioPrecioLitro = litrosTotales > 0 ? (costoTotal / litrosTotales) : 0;
      const cantidadCargas = data.length;
      
      // Agregar filas de resumen
      data.push({});
      data.push({
        'Placa': 'RESUMEN',
        'Fecha': `Total cargas: ${cantidadCargas}`,
        'Litros': litrosTotales,
        'Precio/Litro (₡)': Math.round(promedioPrecioLitro * 100) / 100,
        'Costo Total (₡)': costoTotal,
        'Odómetro (km)': 'TOTALES',
        'Estación': '',
        'Fecha de Registro': ''
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Formato de columnas
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Fecha
        {wch: 10}, // Litros
        {wch: 15}, // Precio/Litro
        {wch: 15}, // Costo Total
        {wch: 12}, // Odómetro
        {wch: 10}, // Km/L
        {wch: 15}, // Estación
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar título
      XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE COMBUSTIBLE - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Combustible');
      XLSX.writeFile(wb, `combustible_${placa || 'todos'}_${a}_${b}.xlsx`);
      return;
    }
    
    if(tipo==='revisiones'){
      // Filtrar y mapear datos de revisiones con la estructura correcta
      const filtered = Revisiones.filter(x=> 
        (!placa || x.placa === placa) && 
        x.fecha >= a && 
        x.fecha <= b
      );
      
      const data = filtered.map(x=>({
        'Placa': x.placa || '',
        'Fecha': x.fecha,
        'Inspector': x.inspector || '',
        'Estado Motor': x.estado_motor || '',
        'Estado Frenos': x.estado_frenos || '',
        'Estado Luces': x.estado_luces || '',
        'Estado Llantas': x.estado_llantas || '',
        'Estado Carrocería': x.estado_carroceria || '',
        'Aprobado': x.aprobado ? 'SÍ' : 'NO',
        'Observaciones': x.observaciones || '',
        'Fecha de Registro': x.created_at ? new Date(x.created_at).toLocaleDateString('es-ES') : ''
      }));
      
      // Estadísticas
      const totalRevisiones = data.length;
      const aprobadas = data.filter(x => x.Aprobado === 'SÍ').length;
      const reprobadas = totalRevisiones - aprobadas;
      
      // Agregar resumen
      data.push({});
      data.push({
        'Placa': 'RESUMEN',
        'Fecha': `Total: ${totalRevisiones}`,
        'Inspector': `Aprobadas: ${aprobadas}`,
        'Estado Motor': `Reprobadas: ${reprobadas}`,
        'Estado Frenos': '',
        'Estado Luces': '',
        'Estado Llantas': '',
        'Estado Carrocería': '',
        'Aprobado': '',
        'Observaciones': '',
        'Fecha de Registro': ''
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Formato de columnas
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Fecha
        {wch: 15}, // Inspector
        {wch: 12}, // Estado Motor
        {wch: 12}, // Estado Frenos
        {wch: 12}, // Estado Luces
        {wch: 12}, // Estado Llantas
        {wch: 15}, // Estado Carrocería
        {wch: 10}, // Aprobado
        {wch: 30}, // Observaciones
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar título
      XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE REVISIONES - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Revisiones');
      XLSX.writeFile(wb, `revisiones_${placa || 'todos'}_${a}_${b}.xlsx`);
      return;
    }
    
    if(tipo==='polizas_rtv'){
      // Datos de Pólizas
      const polizasData = Polizas.map(p=>{
        const diasVencimiento = diasRestantes(p.fecha_vencimiento);
        return {
          'Placa': p.placa || '',
          'Aseguradora': p.aseguradora || '',
          'Número Póliza': p.numero_poliza || '',
          'Fecha Inicio': p.fecha_inicio || '',
          'Fecha Vencimiento': p.fecha_vencimiento || '',
          'Tipo Cobertura': p.tipo_cobertura || '',
          'Estado': p.estado || '',
          'Días al Vencimiento': diasVencimiento,
          'Semáforo': diasVencimiento <= 7 ? '🔴 CRÍTICO' : diasVencimiento <= 30 ? '🟡 PRÓXIMO' : '🟢 VIGENTE',
          'Fecha de Registro': p.created_at ? new Date(p.created_at).toLocaleDateString('es-ES') : ''
        };
      });
      
      // Datos de RTV
      const rtvData = RTV.map(r=>{
        const diasVencimiento = diasRestantes(r.fecha_vencimiento);
        return {
          'Placa': r.placa || '',
          'Número Cita': r.numero_cita || '',
          'Fecha Vencimiento': r.fecha_vencimiento || '',
          'Estado': r.estado || '',
          'Días al Vencimiento': diasVencimiento,
          'Semáforo': diasVencimiento <= 7 ? '🔴 CRÍTICO' : diasVencimiento <= 30 ? '🟡 PRÓXIMO' : '🟢 VIGENTE',
          'Observaciones': r.observaciones || '',
          'Fecha de Registro': r.created_at ? new Date(r.created_at).toLocaleDateString('es-ES') : ''
        };
      });
      
      // Crear hojas
      const wsP = XLSX.utils.json_to_sheet(polizasData);
      const wsR = XLSX.utils.json_to_sheet(rtvData);
      
      // Formato de columnas para Pólizas
      wsP['!cols'] = [
        {wch: 12}, // Placa
        {wch: 15}, // Aseguradora
        {wch: 15}, // Número
        {wch: 12}, // Fecha Inicio
        {wch: 12}, // Fecha Venc
        {wch: 12}, // Tipo
        {wch: 10}, // Estado
        {wch: 8},  // Días
        {wch: 12}, // Semáforo
        {wch: 15}  // Fecha Registro
      ];
      
      // Formato de columnas para RTV
      wsR['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Cita
        {wch: 12}, // Fecha Venc
        {wch: 10}, // Estado
        {wch: 8},  // Días
        {wch: 12}, // Semáforo
        {wch: 25}, // Observaciones
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar títulos
      XLSX.utils.sheet_add_aoa(wsP, [[`REPORTE DE PÓLIZAS - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsR, [[`REPORTE DE RTV - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, wsP, 'Pólizas');
      XLSX.utils.book_append_sheet(wb, wsR, 'RTV');
      XLSX.writeFile(wb, `polizas_rtv_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='ficha_vehiculo' && placa){
      // Reporte completo por vehículo
      const vehiculo = Vehiculos.find(v => v.placa === placa);
      if(!vehiculo){
        alert('Vehículo no encontrado');
        return;
      }
      
      // Datos del vehículo
      const vehiculoData = [{
        'Campo': 'Placa',
        'Valor': vehiculo.placa
      }, {
        'Campo': 'Marca',
        'Valor': vehiculo.marca
      }, {
        'Campo': 'Modelo',
        'Valor': vehiculo.modelo
      }, {
        'Campo': 'Año',
        'Valor': vehiculo.ano
      }, {
        'Campo': 'Color',
        'Valor': vehiculo.color || 'No especificado'
      }, {
        'Campo': 'Propietario',
        'Valor': vehiculo.propietario || 'Hotel'
      }];
      
      // Mantenimientos del vehículo
      const mantVehiculo = Mantenimientos.filter(m => m.placa === placa);
      
      // Combustible del vehículo
      const fuelVehiculo = Combustible.filter(f => f.placa === placa);
      
      // Revisiones del vehículo
      const revVehiculo = Revisiones.filter(r => r.placa === placa);
      
      // Pólizas del vehículo
      const polizaVehiculo = Polizas.filter(p => p.placa === placa);
      
      // RTV del vehículo
      const rtvVehiculo = RTV.filter(r => r.placa === placa);
      
      // Crear múltiples hojas
      const wsVeh = XLSX.utils.json_to_sheet(vehiculoData);
      wsVeh['!cols'] = [{wch: 20}, {wch: 30}];
      
      XLSX.utils.book_append_sheet(wb, wsVeh, 'Información General');
      
      if(mantVehiculo.length > 0) {
        const wsMant = XLSX.utils.json_to_sheet(mantVehiculo.map(m => ({
          'Fecha': m.fecha,
          'Tipo': m.tipo,
          'Descripción': m.descripcion,
          'Costo': m.costo,
          'Kilometraje': m.kilometraje
        })));
        wsMant['!cols'] = [{wch: 12}, {wch: 18}, {wch: 30}, {wch: 12}, {wch: 12}];
        XLSX.utils.book_append_sheet(wb, wsMant, 'Mantenimientos');
      }
      
      if(fuelVehiculo.length > 0) {
        const wsFuel = XLSX.utils.json_to_sheet(fuelVehiculo.map(f => ({
          'Fecha': f.fecha,
          'Litros': f.litros,
          'Costo': f.costo,
          'Kilometraje': f.kilometraje,
          'Estación': f.estacion
        })));
        wsFuel['!cols'] = [{wch: 12}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15}];
        XLSX.utils.book_append_sheet(wb, wsFuel, 'Combustible');
      }
      
      if(revVehiculo.length > 0) {
        const wsRev = XLSX.utils.json_to_sheet(revVehiculo.map(r => ({
          'Fecha': r.fecha,
          'Inspector': r.inspector,
          'Motor': r.estado_motor,
          'Frenos': r.estado_frenos,
          'Luces': r.estado_luces,
          'Llantas': r.estado_llantas,
          'Carrocería': r.estado_carroceria,
          'Aprobado': r.aprobado ? 'SÍ' : 'NO',
          'Observaciones': r.observaciones
        })));
        wsRev['!cols'] = [{wch: 12}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}, {wch: 8}, {wch: 30}];
        XLSX.utils.book_append_sheet(wb, wsRev, 'Revisiones');
      }
      
      XLSX.writeFile(wb, `ficha_completa_${placa}_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='resumen_costos'){
      // Reporte de resumen de costos por vehículo y por tipo
      const vehiculosData = Vehiculos.map(vehiculo => {
        const mantVehiculo = Mantenimientos.filter(m => m.placa === vehiculo.placa);
        const fuelVehiculo = Combustible.filter(f => f.placa === vehiculo.placa);
        
        const costoMantenimiento = mantVehiculo.reduce((sum, m) => sum + Number(m.costo || 0), 0);
        const costosCombustible = fuelVehiculo.reduce((sum, f) => sum + Number(f.costo || 0), 0);
        const totalLitros = fuelVehiculo.reduce((sum, f) => sum + Number(f.litros || 0), 0);
        
        return {
          'Placa': vehiculo.placa,
          'Marca': vehiculo.marca,
          'Modelo': vehiculo.modelo,
          'Año': vehiculo.ano,
          'Costo Mantenimiento (₡)': costoMantenimiento,
          'Costo Combustible (₡)': costosCombustible,
          'Total Litros': totalLitros,
          'Costo Total (₡)': costoMantenimiento + costosCombustible,
          'Servicios Mantenimiento': mantVehiculo.length,
          'Cargas Combustible': fuelVehiculo.length
        };
      });
      
      // Agregar totales
      const totalMantenimiento = vehiculosData.reduce((sum, v) => sum + v['Costo Mantenimiento (₡)'], 0);
      const totalCombustible = vehiculosData.reduce((sum, v) => sum + v['Costo Combustible (₡)'], 0);
      const totalLitrosFlota = vehiculosData.reduce((sum, v) => sum + v['Total Litros'], 0);
      
      vehiculosData.push({});
      vehiculosData.push({
        'Placa': 'TOTALES FLOTA',
        'Marca': `${Vehiculos.length} vehículos`,
        'Modelo': '',
        'Año': '',
        'Costo Mantenimiento (₡)': totalMantenimiento,
        'Costo Combustible (₡)': totalCombustible,
        'Total Litros': totalLitrosFlota,
        'Costo Total (₡)': totalMantenimiento + totalCombustible,
        'Servicios Mantenimiento': Mantenimientos.length,
        'Cargas Combustible': Combustible.length
      });
      
      const ws = XLSX.utils.json_to_sheet(vehiculosData);
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Marca
        {wch: 15}, // Modelo
        {wch: 8},  // Año
        {wch: 18}, // Costo Mant
        {wch: 18}, // Costo Comb
        {wch: 12}, // Litros
        {wch: 15}, // Total
        {wch: 12}, // Servicios
        {wch: 12}  // Cargas
      ];
      
      XLSX.utils.sheet_add_aoa(ws, [[`RESUMEN DE COSTOS POR VEHÍCULO - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Resumen Costos');
      XLSX.writeFile(wb, `resumen_costos_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='resumen_general'){
      // Reporte general de la flota
      const totalVehiculos = Vehiculos.length;
      const totalMantenimientos = Mantenimientos.length;
      const totalCombustible = Combustible.length;
      const totalRevisiones = Revisiones.length;
      const totalPolizas = Polizas.length;
      const totalRTV = RTV.length;
      
      // Estadísticas generales
      const estadisticasGenerales = [
        { 'Concepto': 'Total de Vehículos', 'Cantidad': totalVehiculos, 'Detalle': '' },
        { 'Concepto': 'Servicios de Mantenimiento', 'Cantidad': totalMantenimientos, 'Detalle': 'Registros totales' },
        { 'Concepto': 'Cargas de Combustible', 'Cantidad': totalCombustible, 'Detalle': 'Registros totales' },
        { 'Concepto': 'Revisiones Técnicas', 'Cantidad': totalRevisiones, 'Detalle': 'Inspecciones realizadas' },
        { 'Concepto': 'Pólizas de Seguro', 'Cantidad': totalPolizas, 'Detalle': 'Activas y vencidas' },
        { 'Concepto': 'RTV Registradas', 'Cantidad': totalRTV, 'Detalle': 'Revisiones técnicas vehiculares' }
      ];
      
      // Costos totales
      const costoTotalMant = Mantenimientos.reduce((sum, m) => sum + Number(m.costo || 0), 0);
      const costoTotalComb = Combustible.reduce((sum, f) => sum + Number(f.costo || 0), 0);
      const litrosTotales = Combustible.reduce((sum, f) => sum + Number(f.litros || 0), 0);
      
      const resumenCostos = [
        { 'Concepto': 'Costo Total Mantenimientos', 'Monto (₡)': costoTotalMant, 'Observaciones': 'Todos los servicios registrados' },
        { 'Concepto': 'Costo Total Combustible', 'Monto (₡)': costoTotalComb, 'Observaciones': `${litrosTotales} litros totales` },
        { 'Concepto': 'COSTO TOTAL OPERACIÓN', 'Monto (₡)': costoTotalMant + costoTotalComb, 'Observaciones': 'Mantenimiento + Combustible' }
      ];
      
      // Vehículos por marca
      const vehiculosPorMarca = {};
      Vehiculos.forEach(v => {
        vehiculosPorMarca[v.marca] = (vehiculosPorMarca[v.marca] || 0) + 1;
      });
      
      const resumenMarcas = Object.entries(vehiculosPorMarca).map(([marca, cantidad]) => ({
        'Marca': marca,
        'Cantidad': cantidad,
        'Porcentaje': Math.round((cantidad / totalVehiculos) * 100) + '%'
      }));
      
      // Alertas de vencimientos
      const polizasProximas = Polizas.filter(p => diasRestantes(p.fecha_vencimiento) <= 30).length;
      const rtvProximas = RTV.filter(r => diasRestantes(r.fecha_vencimiento) <= 30).length;
      
      const alertasVencimiento = [
        { 'Tipo': 'Pólizas próximas a vencer (30 días)', 'Cantidad': polizasProximas, 'Estado': polizasProximas > 0 ? '⚠️ ATENCIÓN' : '✅ OK' },
        { 'Tipo': 'RTV próximos a vencer (30 días)', 'Cantidad': rtvProximas, 'Estado': rtvProximas > 0 ? '⚠️ ATENCIÓN' : '✅ OK' }
      ];
      
      // Crear hojas
      const wsGeneral = XLSX.utils.json_to_sheet(estadisticasGenerales);
      const wsCostos = XLSX.utils.json_to_sheet(resumenCostos);
      const wsMarcas = XLSX.utils.json_to_sheet(resumenMarcas);
      const wsAlertas = XLSX.utils.json_to_sheet(alertasVencimiento);
      
      // Formato de columnas
      wsGeneral['!cols'] = [{wch: 30}, {wch: 12}, {wch: 25}];
      wsCostos['!cols'] = [{wch: 30}, {wch: 18}, {wch: 30}];
      wsMarcas['!cols'] = [{wch: 15}, {wch: 12}, {wch: 12}];
      wsAlertas['!cols'] = [{wch: 35}, {wch: 12}, {wch: 15}];
      
      // Agregar títulos
      XLSX.utils.sheet_add_aoa(wsGeneral, [[`ESTADÍSTICAS GENERALES - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsCostos, [[`RESUMEN DE COSTOS - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsMarcas, [[`VEHÍCULOS POR MARCA - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsAlertas, [[`ALERTAS DE VENCIMIENTO - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, wsGeneral, 'Estadísticas Generales');
      XLSX.utils.book_append_sheet(wb, wsCostos, 'Resumen Costos');
      XLSX.utils.book_append_sheet(wb, wsMarcas, 'Vehículos por Marca');
      XLSX.utils.book_append_sheet(wb, wsAlertas, 'Alertas Vencimiento');
      
      XLSX.writeFile(wb, `resumen_general_flota_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='alertas'){
      // Usar la función de alertas existente
      exportAlertXLSX();
      return;
    }
    
    alert('✅ Reporte exportado exitosamente');
  }

  // ====== TESTS ======
  function tlog(msg, ok=true){ const el=byId('testOut'); if(!el) return; const div=document.createElement('div'); div.className= ok? 'pass' : 'fail'; div.textContent = (ok?'✔ ':'✖ ')+msg; el.appendChild(div); }
  function clearTests(){ const el=byId('testOut'); if(el) el.innerHTML=''; }
  async function runTests(kind){ clearTests(); try{
      if(kind==='api'){
        tlog('URL API configurada: ' + API);
        try {
          const response = await fetch(API + '/docs');
          tlog('API responde (docs): ' + response.status, response.ok);
        } catch(e) {
          tlog('Error conectando a API docs: ' + e.message, false);
        }
        
        try {
          const response = await fetch(API + '/vehiculos');
          tlog('Endpoint /vehiculos responde: ' + response.status, response.ok);
          if (response.ok) {
            const data = await response.json();
            tlog('Respuesta JSON válida', !!data);
            tlog('Campo success existe', 'success' in data);
            tlog('Success = true', data.success === true);
          }
        } catch(e) {
          tlog('Error en /vehiculos: ' + e.message, false);
        }
      }
      if(kind==='get'){ const data = await apiGet('Vehiculos'); tlog('GET Vehiculos devolvió array', Array.isArray(data)); tlog('GET no lanzó error', true); }
      if(kind==='ui'){ fillVehSelects(); const m = byId('mVeh'); tlog('Select mVeh existe', !!m); tlog('Select mVeh poblado (si hay vehículos)', m && m.options.length>=0); }
      if(kind==='core'){
        tlog('Función setTab definida', typeof setTab==='function');
        try{ setTab(localStorage.getItem('tab') || 'dashboard'); tlog('setTab ejecuta sin throw', true); }catch(e){ tlog('setTab lanzó excepción: '+e.message, false); }
        tlog('Librería XLSX cargada', !!window.XLSX);
        tlog('exportReportXLSX existe', typeof exportReportXLSX==='function');
        tlog('refreshHints existe', typeof refreshHints==='function');
      }
      if(kind==='auto'){
        const old = window.alert; let lastMsg=''; window.alert = (m)=>{ lastMsg=String(m||''); };
        byId('mTipo').value='cambio_aceite'; byId('mKm').value='12000'; byId('mProx').value=''; autoProximoKm();
        tlog('autoProximoKm suma 5000 (12000→17000)', byId('mProx').value==='17000');
        byId('mTipo').value='llantas'; byId('mKm').value='100'; byId('mProx').value=''; lastMsg=''; autoProximoKm();
        tlog('autoProximoKm alerta cuando tipo ≠ cambio_aceite', lastMsg.toLowerCase().includes('cambio de aceite'));
        byId('mTipo').value='cambio_aceite'; byId('mKm').value=''; lastMsg=''; autoProximoKm();
        tlog('autoProximoKm alerta si km vacío', lastMsg.toLowerCase().includes('km'));
        window.alert = old;
      }
      if(kind==='bit'){
        byId('bVeh').selectedIndex=0; byId('fltBitPlaca').value=''; resetBitacoraForm();
        if(Vehiculos.length){ byId('bVeh').value = String(Vehiculos[0].id); const placa = Vehiculos[0].placa; const flt = byId('fltBitPlaca'); flt.value = placa; tlog('Filtro Bitácora se puede fijar por placa', flt.value===placa); resetBitacoraForm(); tlog('resetBitacoraForm limpia campos', !byId('bCond').value && !byId('bKm').value && byId('bNivel').value==='lleno'); } else { tlog('No hay vehículos de ejemplo para probar filtro Bitácora', false); }
      }
    }catch(err){ tlog('Error en test: '+err.message, false); }
  }

  // ====== INIT ======
  window.addEventListener('DOMContentLoaded', ()=>{
    // Inicializar la aplicación correctamente
    inicializarApp();
    
    // Event listeners para el login
    document.getElementById('loginPassword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && selectedRole) {
        attemptLogin();
      }
    });
    
    // Inicializar fechas por defecto en reportes
    const hoy = today();
    const tresMesesAtras = new Date();
    tresMesesAtras.setMonth(tresMesesAtras.getMonth() - 3);
    
    setTimeout(() => {
      const fechaA = byId('repA');
      const fechaB = byId('repB');
      if (fechaA) fechaA.value = tresMesesAtras.toISOString().slice(0,10);
      if (fechaB) fechaB.value = hoy;
      
      // Event listeners para hints y cálculos
      ['bVeh','cVeh','mVeh','rVeh','rtvVeh'].forEach(id=>{ 
        const el=byId(id); 
        if(el){ el.addEventListener('change', refreshHints); }
      });
      
      ['cOdo','cLitros','cFecha'].forEach(id=>{ 
        const el=byId(id); 
        if(el){ 
          el.addEventListener('input', calcKmLEstimado); 
          el.addEventListener('change', calcKmLEstimado); 
        }
      });
      
      // Inicializar campos de mantenimiento
      toggleMaintenanceFields();
      

      
      // Cerrar modales al hacer click fuera o con ESC
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.classList.add('hidden');
        }
      });
      
      // Cerrar modales con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          cerrarTodosLosModales();
        }
      });
      
      // Asegurar que los botones de cerrar funcionen
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('close-btn') || e.target.textContent === '×') {
          const modal = e.target.closest('.modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        }
      });
      
    }, 100);
  });
  
  // ===== FUNCIONES DE CONFIGURACIÓN DE EMAIL =====
  
  async function cargarConfigEmail() {
    try {
      const response = await fetch(`${API}/config/email`);
      const data = await response.json();
      
      if (data.success) {
        const config = data.config;
        
        // Actualizar campos del formulario
        if (byId('configSenderEmail')) byId('configSenderEmail').value = config.sender_email || '';
        if (byId('configSmtpPort')) byId('configSmtpPort').value = config.smtp_port || 587;
        
        // Determinar proveedor basado en servidor SMTP
        let provider = 'custom';
        if (config.smtp_server === 'smtp.gmail.com') provider = 'gmail';
        else if (config.smtp_server === 'smtp-mail.outlook.com') provider = 'outlook';
        else if (config.smtp_server === 'smtp.mail.yahoo.com') provider = 'yahoo';
        
        if (byId('configProvider')) byId('configProvider').value = provider;
        
        // Mostrar campos personalizados si es necesario
        toggleCustomServerFields();
        
        // Actualizar estado
        const statusEl = byId('emailStatus');
        const statusTextEl = byId('emailStatusText');
        const statusDetailEl = byId('emailStatusDetail');
        
        if (config.password_configured) {
          if (statusEl) statusEl.style.backgroundColor = '#d1f2eb';
          if (statusTextEl) statusTextEl.textContent = '✅ Configurado';
          if (statusDetailEl) statusDetailEl.textContent = `Servidor: ${config.smtp_server}:${config.smtp_port} | Destino: ${config.recipient_email}`;
        } else {
          if (statusEl) statusEl.style.backgroundColor = '#fdeaa7';
          if (statusTextEl) statusTextEl.textContent = '⚠️ Requiere configuración';
          if (statusDetailEl) statusDetailEl.textContent = 'Configure email y contraseña para recibir alertas automáticas';
        }
      }
    } catch (e) {
      console.error('Error cargando configuración de email:', e);
    }
  }
  
  function toggleCustomServerFields() {
    const provider = byId('configProvider')?.value;
    const customFields = byId('customServerFields');
    
    if (customFields) {
      if (provider === 'custom') {
        customFields.classList.remove('hidden');
      } else {
        customFields.classList.add('hidden');
      }
    }
  }
  
  function updateProviderInfo() {
    // Función obsoleta - SendGrid integrado automáticamente
    console.log('✅ SendGrid activo - configuración SMTP manual no necesaria');
  }
  
  async function guardarConfigEmail() {
    try {
      const statusEl = byId('alertaStatus');
      if (statusEl) statusEl.textContent = '💾 Guardando configuración...';
      
      const config = {
        sender_email: byId('configSenderEmail')?.value,
        sender_password: byId('configSenderPassword')?.value,
        provider: byId('configProvider')?.value,
        smtp_port: parseInt(byId('configSmtpPort')?.value) || 587
      };
      
      // Agregar servidor personalizado si es necesario
      if (config.provider === 'custom') {
        config.smtp_server = byId('configSmtpServer')?.value;
      }
      
      // Validaciones básicas
      if (!config.sender_email) {
        alert('❌ Por favor ingrese el email del sistema');
        return;
      }
      
      if (!config.sender_password) {
        alert('❌ Por favor ingrese la contraseña del email');
        return;
      }
      
      if (config.provider === 'custom' && !config.smtp_server) {
        alert('❌ Por favor ingrese el servidor SMTP personalizado');
        return;
      }
      
      const response = await fetch(`${API}/config/email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });
      
      const data = await response.json();
      
      if (data.success) {
        if (statusEl) {
          statusEl.textContent = '✅ Configuración guardada';
          setTimeout(() => statusEl.textContent = '', 5000);
        }
        
        // Limpiar campo de contraseña por seguridad
        if (byId('configSenderPassword')) byId('configSenderPassword').value = '';
        
        // Recargar estado
        cargarConfigEmail();
        
        alert('✅ Configuración de email guardada exitosamente.\n\n¿Desea enviar un email de prueba ahora?') 
          ? probarEmail() : null;
      } else {
        throw new Error(data.message || 'Error guardando configuración');
      }
    } catch (e) {
      const statusEl = byId('alertaStatus');
      if (statusEl) {
        statusEl.textContent = '❌ Error guardando';
        setTimeout(() => statusEl.textContent = '', 5000);
      }
      alert('❌ Error guardando configuración: ' + e.message);
    }
  }
  
  async function verificarAlertas() {
    try {
      const statusEl = byId('alertaStatus');
      if (statusEl) statusEl.textContent = '🔄 Verificando alertas...';
      
      const response = await fetch(`${API}/alertas/verificar`);
      const data = await response.json();
      
      if (data.success) {
        if (statusEl) {
          const mensaje = data.alertas_enviadas > 0 
            ? `✅ ${data.alertas_enviadas} alertas procesadas` 
            : '✅ Sin alertas pendientes';
          statusEl.textContent = mensaje;
          setTimeout(() => statusEl.textContent = '', 5000);
        }
        alert(`✅ Verificación completada.\n${data.message}`);
      } else {
        throw new Error(data.message || 'Error verificando alertas');
      }
    } catch (e) {
      const statusEl = byId('alertaStatus');
      if (statusEl) {
        statusEl.textContent = '❌ Error';
        setTimeout(() => statusEl.textContent = '', 5000);
      }
      alert('❌ Error verificando alertas: ' + e.message);
    }
  }
  
  async function probarEmail() {
    try {
      const statusEl = byId('alertaStatus');
      if (statusEl) statusEl.textContent = '📧 Enviando email de prueba...';
      
      const response = await fetch(`${API}/config/email/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      
      if (data.success) {
        if (statusEl) {
          statusEl.textContent = '✅ Email enviado';
          setTimeout(() => statusEl.textContent = '', 5000);
        }
        alert('✅ Email de prueba enviado exitosamente a contabilidad2@arenalmanoa.com');
      } else {
        throw new Error(data.message || 'Error enviando email de prueba');
      }
    } catch (e) {
      const statusEl = byId('alertaStatus');
      if (statusEl) {
        statusEl.textContent = '❌ Error enviando email';
        setTimeout(() => statusEl.textContent = '', 5000);
      }
      alert('❌ Error enviando email de prueba: ' + e.message + '\n\n💡 Asegúrese de que la configuración de email esté correcta.');
    }
  }
  
  // Nuevas funciones para SendGrid integrado
  async function testEmailSystem() {
    try {
      const response = await fetch(`${API}/test-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('✅ Email de prueba enviado exitosamente!\n\n' +
              '📧 Destinatario: contabilidad2@arenalmanoa.com\n' +
              '🚀 Método: SendGrid API\n' +
              '⏰ Enviado: ' + new Date().toLocaleString() + '\n\n' +
              '💡 Revisa tu bandeja de entrada o carpeta de spam');
      } else {
        throw new Error(data.error || 'Error desconocido');
      }
    } catch (e) {
      alert('❌ Error enviando email de prueba:\n\n' + e.message + '\n\n' +
            '🔧 Posibles soluciones:\n' +
            '• Verificar configuración SendGrid en Railway\n' +
            '• Revisar logs del servidor\n' +
            '• Contactar soporte técnico');
    }
  }
  
  async function probarEmailAutomatico() {
    // Función alias para compatibilidad
    await testEmailSystem();
  }
  
  async function checkAlerts() {
    try {
      const response = await fetch(`${API}/alertas/detalle`);
      const data = await response.json();
      
      if (data.success) {
        const alertas = data.data.alertas;
        const totales = data.data.totales;
        
        let message = '📊 RESUMEN DE ALERTAS ACTIVAS\n\n';
        
        if (totales.total === 0) {
          message += '✅ No hay alertas pendientes\n' +
                    'El sistema está funcionando correctamente';
        } else {
          message += `🚨 Total de alertas: ${totales.total}\n\n`;
          
          if (totales.mantenimiento > 0) {
            message += `🔧 Mantenimientos: ${totales.mantenimiento}\n`;
          }
          if (totales.polizas > 0) {
            message += `📋 Pólizas: ${totales.polizas}\n`;
          }
          if (totales.rtv > 0) {
            message += `🚗 RTV: ${totales.rtv}\n`;
          }
          if (totales.combustible > 0) {
            message += `⛽ Combustible: ${totales.combustible}\n`;
          }
          if (totales.revisiones > 0) {
            message += `🔍 Revisiones: ${totales.revisiones}\n`;
          }
          
          message += '\n📧 Emails automáticos enviándose para todas las alertas';
        }
        
        alert(message);
      } else {
        throw new Error(data.message || 'Error obteniendo alertas');
      }
    } catch (e) {
      alert('❌ Error verificando alertas: ' + e.message);
    }
  }
  
  // Event listeners para configuración de email
  document.addEventListener('DOMContentLoaded', function() {
    // Cargar configuración inicial
    setTimeout(cargarConfigEmail, 1000);
    
    // Event listener para cambio de proveedor
    const providerSelect = byId('configProvider');
    if (providerSelect) {
      providerSelect.addEventListener('change', toggleCustomServerFields);
    }
    
    // Mejoras específicas para móvil
    initMobileEnhancements();
  });
  
  // ===== MEJORAS PARA MÓVIL =====
  function initMobileEnhancements() {
    // Detectar si es móvil
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
      // Prevenir zoom en inputs doble-tap
      document.addEventListener('touchend', function(e) {
        const now = new Date().getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // Mejorar scroll en tabs
      const tabsContainer = document.querySelector('.tabs');
      if (tabsContainer) {
        // Agregar indicador de scroll sutil
        tabsContainer.addEventListener('scroll', function() {
          if (this.scrollLeft > 0) {
            this.classList.add('scrolled');
          } else {
            this.classList.remove('scrolled');
          }
        });
      }
      
      // Optimizar tablas para móvil
      const tables = document.querySelectorAll('table');
      tables.forEach(table => {
        if (!table.closest('.table-container')) {
          const container = document.createElement('div');
          container.className = 'table-container';
          table.parentNode.insertBefore(container, table);
          container.appendChild(table);
        }
      });
      
      // Mejorar experiencia táctil para cards
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.style.cursor = 'default';
      });
    }
    
    // Ajustar viewport height para móvil (problema común con iOS Safari)
    function updateVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    updateVH();
    window.addEventListener('resize', updateVH);
    window.addEventListener('orientationchange', updateVH);
  }
  
  let lastTouchEnd = 0;
  let mobileCompactMode = false;
  
  // ===== FUNCIONES PARA BITÁCORA =====
  function renderBitacora() {
    const placaFlt = byId('fltBitacoraPlaca')?.value || '';
    const estadoFlt = byId('fltBitacoraEstado')?.value || '';
    
    const rows = Bitacora
      .filter(b => !placaFlt || b.placa.includes(placaFlt))
      .filter(b => !estadoFlt || b.estado === estadoFlt)
      .sort((a, b) => new Date(b.fecha_salida) - new Date(a.fecha_salida))
      .map(b => {
        const fechaSalida = formatDateTimeCA(b.fecha_salida);
        const fechaRetorno = b.fecha_retorno ? formatDateTimeCA(b.fecha_retorno) : '-';
        const estadoBadge = b.estado === 'en_curso' ? 
          '<span class="pill warnP">🔄 En Curso</span>' : 
          '<span class="pill ok">✅ Completado</span>';
        
        let acciones = '';
        
        if (b.estado === 'en_curso') {
          acciones = `<button class="btn-small" onclick="completarRetorno(${b.id})">🔄 Registrar Retorno</button>`;
        } else {
          acciones = `<button class="btn-small secondary" onclick="verDetalleBitacora(${b.id})">👁️ Ver</button>`;
        }
        
        // Agregar botón de eliminar para administradores
        if (currentUser && currentUser.role === 'admin') {
          acciones += ` <button class="btn-small danger" onclick="eliminarBitacora(${b.id})" title="Eliminar registro">🗑️</button>`;
        }
        
        return `<tr>
          <td>${b.placa}</td>
          <td>${b.chofer}</td>
          <td>${fechaSalida}</td>
          <td>${fechaRetorno}</td>
          <td>${b.km_salida.toLocaleString()}</td>
          <td>${b.km_retorno ? b.km_retorno.toLocaleString() : '-'}</td>
          <td>${estadoBadge}</td>
          <td>${acciones}</td>
        </tr>`;
      }).join('');
    
    const tbody = byId('tblBitacora');
    if (tbody) {
      tbody.innerHTML = rows || '<tr><td colspan="8">No hay registros de bitácora</td></tr>';
    }
  }
  
  async function eliminarBitacora(bitacoraId) {
    if (!hasPermission('bitacora') || !currentUser || currentUser.role !== 'admin') {
      alert('❌ Sin permisos para eliminar registros de bitácora');
      return;
    }
    
    const registro = Bitacora.find(b => b.id === bitacoraId);
    if (!registro) {
      alert('❌ Registro no encontrado');
      return;
    }
    
    const confirmar = confirm(
      `⚠️ ELIMINAR REGISTRO DE BITÁCORA\n\n` +
      `Vehículo: ${registro.placa}\n` +
      `Chofer: ${registro.chofer}\n` +
      `Fecha: ${formatDateTimeCA(registro.fecha_salida)}\n` +
      `Estado: ${registro.estado}\n\n` +
      `¿Está seguro de eliminar este registro?\n` +
      `Esta acción NO se puede deshacer.`
    );
    
    if (!confirmar) return;
    
    try {
      const response = await fetch(`${API}/bitacora/${bitacoraId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await response.json();
      
      if (response.ok && data.success) {
        alert('✅ Registro de bitácora eliminado exitosamente');
        
        // Actualizar datos
        Bitacora = await apiGet('bitacora');
        renderBitacora();
      } else {
        // Handle both API error formats
        const errorMessage = data.detail || data.message || `HTTP ${response.status}: Error desconocido`;
        alert('❌ Error eliminando registro: ' + errorMessage);
      }
    } catch (e) {
      alert('❌ Error eliminando registro: HTTP 502 - Error de conexión con el servidor');
      console.error('Error eliminando bitácora:', e);
    }
  }

  async function procesarBitacora(e) {
    e.preventDefault();
    
    console.log('🔥 === PROCESANDO BITÁCORA ===');
    console.log('🔥 Event type:', e.type);
    console.log('🔥 Event target:', e.target);
    console.log('🔥 Event timestamp:', new Date().toISOString());
    
    const vehiculoId = byId('bVeh').value;
    const chofer = byId('bChofer').value.trim();
    
    console.log('🔥 VehiculoId seleccionado:', vehiculoId);
    console.log('🔥 Chofer ingresado:', chofer);
    console.log('🔥 currentBitacoraId actual:', currentBitacoraId);
    console.log('🔥 Estado del formulario:');
    console.log('   - Campos de salida visibles:', !byId('salidaFields').classList.contains('hidden'));
    console.log('   - Campos de retorno visibles:', !byId('retornoFields').classList.contains('hidden'));
    console.log('   - Texto del botón:', byId('btnBitacora').innerHTML);
    
    // Validación básica
    if (!vehiculoId || !chofer) {
      console.warn('❌ Validación fallida: vehículo o chofer faltante');
      alert('Debe seleccionar un vehículo e ingresar el nombre del chofer');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    if (!vehiculo) {
      console.error('❌ Vehículo no encontrado en la lista de vehículos');
      console.log('Vehículos disponibles:', Vehiculos.map(v => `ID: ${v.id}, Placa: ${v.placa}`));
      alert('Vehículo no encontrado');
      return;
    }
    
    // Verificar si es una salida o retorno
    const isRetorno = currentBitacoraId !== null;
    
    console.log('🎯 DECISIÓN DE FLUJO:');
    console.log('   - Es retorno?:', isRetorno);
    console.log('   - Vehículo encontrado:', vehiculo.placa);
    console.log('   - ID del vehículo:', vehiculo.id);
    
    if (isRetorno) {
      console.log('🔄 === EJECUTANDO FLUJO DE RETORNO ===');
      console.log('🔄 Llamando a registrarRetorno()...');
      try {
        await registrarRetorno();
        console.log('🔄 registrarRetorno() completado exitosamente');
      } catch (error) {
        console.error('💥 Error en registrarRetorno():', error);
      }
    } else {
      console.log('🚗 === EJECUTANDO FLUJO DE SALIDA ===');
      console.log('🚗 Llamando a registrarSalida()...');
      try {
        await registrarSalida(vehiculo.placa, chofer);
        console.log('🚗 registrarSalida() completado exitosamente');
      } catch (error) {
        console.error('💥 Error en registrarSalida():', error);
      }
    }
    
    console.log('🏁 === PROCESAMIENTO DE BITÁCORA COMPLETADO ===');
  }
  
  async function registrarSalida(placa, chofer) {
    try {
      const salida = {
        placa: placa,
        chofer: chofer,
        km_salida: parseInt(byId('bKmSalida').value),
        nivel_combustible_salida: byId('bCombustibleSalida').value,
        estado_vehiculo_salida: byId('bEstadoSalida').value,
        observaciones: byId('bObsSalida').value || ''
      };
      
      const response = await apiPost('bitacora/salida', salida);
      
      if (response.success) {
        currentBitacoraId = response.bitacora_id;
        
        // Cambiar interfaz a modo retorno
        cambiarAModoRetorno();
        
        // Actualizar datos
        Bitacora = await apiGet('bitacora');
        renderBitacora();
        
        let mensaje = '✅ Salida registrada exitosamente';
        if (response.alerta_km) {
          mensaje += '\n⚠️ Se detectó inconsistencia de kilometraje. Se ha enviado una alerta por email.';
        }
        alert(mensaje);
      }
    } catch (e) {
      alert('❌ Error registrando salida: ' + e.message);
    }
  }
  
  async function registrarRetorno() {
    try {
      console.log('=== INICIANDO REGISTRO DE RETORNO ===');
      console.log('currentBitacoraId:', currentBitacoraId);
      console.log('Formulario en modo retorno:', !byId('retornoFields').classList.contains('hidden'));
      console.log('Botón actual:', byId('btnBitacora').innerHTML);
      
      // CRÍTICO: Verificar si realmente estamos en modo retorno
      if (currentBitacoraId === null) {
        console.error('❌ PROBLEMA CRÍTICO: currentBitacoraId es null');
        alert('❌ Error: No hay un registro de bitácora seleccionado para completar el retorno.\n\nPasos para solucionarlo:\n1. Seleccione un vehículo que tenga una salida pendiente\n2. Haga clic en "Sí" cuando se le pregunte si desea completar el retorno');
        return;
      }
      
      // Debug adicional
      console.log('API URL:', API);
      console.log('Endpoint completo:', `${API}/bitacora/${currentBitacoraId}/retorno`);
      
      // Verificar que los elementos del formulario existan
      const kmInput = byId('bKmRetorno');
      const combustibleSelect = byId('bCombustibleRetorno');
      const estadoSelect = byId('bEstadoRetorno');
      const obsInput = byId('bObsRetorno');
      
      console.log('Elementos del formulario:', {
        kmInput: !!kmInput,
        combustibleSelect: !!combustibleSelect,
        estadoSelect: !!estadoSelect,
        obsInput: !!obsInput
      });
      
      if (!kmInput || !combustibleSelect || !estadoSelect) {
        console.error('❌ PROBLEMA CRÍTICO: Elementos del formulario de retorno no encontrados');
        alert('❌ Error: No se encontraron los campos del formulario de retorno');
        return;
      }
      
      // Validar campos requeridos
      const kmRetorno = kmInput.value;
      const combustibleRetorno = combustibleSelect.value;
      const estadoRetorno = estadoSelect.value;
      
      console.log('Valores del formulario de retorno:', {
        kmRetorno,
        combustibleRetorno,
        estadoRetorno,
        observaciones: obsInput?.value
      });
      
      if (!kmRetorno || kmRetorno <= 0) {
        console.warn('❌ Validación fallida: kilometraje de retorno inválido');
        alert('❌ Por favor ingrese un kilometraje válido para el retorno');
        kmInput.focus();
        return;
      }
      
      if (!combustibleRetorno) {
        console.warn('❌ Validación fallida: nivel de combustible no seleccionado');
        alert('❌ Por favor seleccione el nivel de combustible de retorno');
        combustibleSelect.focus();
        return;
      }
      
      if (!estadoRetorno) {
        console.warn('❌ Validación fallida: estado del vehículo no seleccionado');
        alert('❌ Por favor seleccione el estado del vehículo de retorno');
        estadoSelect.focus();
        return;
      }
      
      const retorno = {
        km_retorno: parseInt(kmRetorno),
        nivel_combustible_retorno: combustibleRetorno,
        estado_vehiculo_retorno: estadoRetorno,
        observaciones: obsInput ? obsInput.value || '' : ''
      };
      
      console.log('✅ Validación completa - Enviando retorno:', retorno, 'para bitácora ID:', currentBitacoraId);
      
      // Llamada a la API con mejor manejo de errores
      console.log('📡 Enviando petición HTTP...');
      const response = await fetch(`${API}/bitacora/${currentBitacoraId}/retorno`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(retorno)
      });
      
      console.log('📥 Response status:', response.status);
      console.log('📥 Response headers:', Object.fromEntries(response.headers.entries()));
      
      if (!response.ok) {
        console.error('❌ HTTP Error:', response.status, response.statusText);
        const errorText = await response.text();
        console.error('❌ Error body:', errorText);
        throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('✅ Respuesta del servidor:', data);
      
      if (data.success) {
        console.log('🎉 ¡Retorno registrado exitosamente!');
        alert('✅ Retorno registrado exitosamente');
        
        // Volver a modo salida
        console.log('🔄 Cambiando a modo salida...');
        cambiarAModoSalida();
        currentBitacoraId = null;
        
        // Limpiar formulario
        console.log('🧹 Limpiando formulario...');
        limpiarFormBitacora();
        
        // Actualizar datos
        console.log('🔄 Actualizando datos de bitácora...');
        Bitacora = await apiGet('bitacora');
        renderBitacora();
        
        console.log('=== ✅ RETORNO COMPLETADO EXITOSAMENTE ===');
      } else {
        console.error('❌ Error en respuesta del servidor:', data);
        alert('❌ Error registrando retorno: ' + (data.message || data.detail || 'Error desconocido'));
      }
    } catch (e) {
      console.error('💥 ERROR CRÍTICO en registrarRetorno:', e);
      console.error('💥 Stack trace:', e.stack);
      alert('❌ Error crítico registrando retorno: ' + e.message + '\n\nRevise la consola del navegador para más detalles.');
    }
  }
  
  function cambiarAModoRetorno() {
    console.log('🔄 === CAMBIANDO A MODO RETORNO ===');
    
    // Ocultar campos de salida y deshabilitar validación
    byId('salidaFields').classList.add('hidden');
    const salidaInputs = ['bKmSalida', 'bCombustibleSalida', 'bEstadoSalida', 'bObsSalida'];
    salidaInputs.forEach(id => {
      const element = byId(id);
      if (element) {
        element.disabled = true;
        element.removeAttribute('required');
        console.log(`   - Deshabilitado campo salida: ${id}`);
      }
    });
    
    // Mostrar campos de retorno y habilitar validación
    byId('retornoFields').classList.remove('hidden');
    const retornoInputs = ['bKmRetorno', 'bCombustibleRetorno', 'bEstadoRetorno'];
    retornoInputs.forEach(id => {
      const element = byId(id);
      if (element) {
        element.disabled = false;
        element.setAttribute('required', 'required');
        console.log(`   - Habilitado campo retorno: ${id}`);
      }
    });
    
    byId('btnBitacora').innerHTML = '🔄 Registrar Retorno';
    byId('btnBitacora').className = 'success';
    
    console.log('✅ Modo retorno activado correctamente');
  }
  
  function cambiarAModoSalida() {
    console.log('🚗 === CAMBIANDO A MODO SALIDA ===');
    
    // Mostrar campos de salida y habilitar validación
    byId('salidaFields').classList.remove('hidden');
    const salidaInputs = ['bKmSalida', 'bCombustibleSalida', 'bEstadoSalida'];
    salidaInputs.forEach(id => {
      const element = byId(id);
      if (element) {
        element.disabled = false;
        element.setAttribute('required', 'required');
        console.log(`   - Habilitado campo salida: ${id}`);
      }
    });
    
    // Ocultar campos de retorno y deshabilitar validación
    byId('retornoFields').classList.add('hidden');
    const retornoInputs = ['bKmRetorno', 'bCombustibleRetorno', 'bEstadoRetorno'];
    retornoInputs.forEach(id => {
      const element = byId(id);
      if (element) {
        element.disabled = true;
        element.removeAttribute('required');
        console.log(`   - Deshabilitado campo retorno: ${id}`);
      }
    });
    
    byId('btnBitacora').innerHTML = '📝 Registrar Salida';
    byId('btnBitacora').className = 'success';
    
    console.log('✅ Modo salida activado correctamente');
  }
  
  function initBitacoraForm() {
    console.log('🚀 === INICIALIZANDO FORMULARIO DE BITÁCORA ===');
    
    // Asegurar que el formulario inicie en modo salida
    currentBitacoraId = null;
    cambiarAModoSalida();
    
    console.log('✅ Formulario de bitácora inicializado correctamente');
  }
  
  function limpiarFormBitacora() {
    ['bVeh', 'bChofer', 'bKmSalida', 'bCombustibleSalida', 'bEstadoSalida', 'bObsSalida',
     'bKmRetorno', 'bCombustibleRetorno', 'bEstadoRetorno', 'bObsRetorno'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      }
    });
    cambiarAModoSalida();
    currentBitacoraId = null;
  }
  
  function completarRetorno(bitacoraId) {
    console.log('🔄 === CONFIGURANDO RETORNO ===');
    console.log('🔄 ID de bitácora:', bitacoraId);
    
    const registro = Bitacora.find(b => b.id === bitacoraId);
    if (!registro) {
      console.error('❌ Registro de bitácora no encontrado:', bitacoraId);
      console.log('Registros disponibles:', Bitacora.map(b => `ID: ${b.id}, Placa: ${b.placa}, Estado: ${b.estado}`));
      alert('Registro de bitácora no encontrado');
      return;
    }
    
    console.log('🔄 Registro encontrado:', registro);
    
    // Cargar datos en el formulario
    const vehiculo = Vehiculos.find(v => v.placa === registro.placa);
    if (vehiculo) {
      console.log('🔄 Configurando vehículo:', vehiculo);
      byId('bVeh').value = vehiculo.id;
    } else {
      console.warn('⚠️ Vehículo no encontrado para placa:', registro.placa);
    }
    
    console.log('🔄 Configurando chofer:', registro.chofer);
    byId('bChofer').value = registro.chofer;
    
    // Prellenar algunos campos del retorno con valores por defecto
    console.log('🔄 Configurando campos de retorno...');
    byId('bKmRetorno').value = '';
    byId('bCombustibleRetorno').value = '3/4';
    byId('bEstadoRetorno').value = 'bueno';
    byId('bObsRetorno').value = '';
    
    // CRÍTICO: Establecer el ID de la bitácora actual
    console.log('🔄 Estableciendo currentBitacoraId:', bitacoraId);
    currentBitacoraId = bitacoraId;
    
    console.log('🔄 Cambiando a modo retorno...');
    cambiarAModoRetorno();
    
    console.log('🔄 Estado después de cambio:');
    console.log('   - currentBitacoraId:', currentBitacoraId);
    console.log('   - Campos de salida ocultos:', byId('salidaFields').classList.contains('hidden'));
    console.log('   - Campos de retorno visibles:', !byId('retornoFields').classList.contains('hidden'));
    console.log('   - Texto del botón:', byId('btnBitacora').innerHTML);
    
    // Scroll al formulario
    document.querySelector('#tab-bitacora .card').scrollIntoView({ behavior: 'smooth' });
    
    // Enfocar el campo de kilometraje
    setTimeout(() => {
      byId('bKmRetorno').focus();
      console.log('🔄 Foco en campo de kilometraje establecido');
    }, 100);
    
    console.log('🔄 === CONFIGURACIÓN DE RETORNO COMPLETADA ===');
  }
  
  async function enviarAlertaRetornoPendiente() {
    try {
      // Verificar si hay un vehículo seleccionado para retorno
      if (!currentBitacoraId) {
        alert('❌ Primero debe seleccionar un vehículo haciendo clic en "Registrar Retorno" en la tabla');
        return;
      }
      
      // Buscar el registro específico seleccionado
      const registroSeleccionado = Bitacora.find(b => b.id === currentBitacoraId);
      
      if (!registroSeleccionado) {
        alert('❌ No se encontró el registro de bitácora seleccionado');
        return;
      }
      
      if (registroSeleccionado.estado !== 'en_curso') {
        alert('❌ El vehículo seleccionado ya tiene retorno registrado');
        return;
      }
      
      const fechaSalida = formatDateCA(registroSeleccionado.fecha_salida);
      const horasSalida = Math.floor((new Date() - new Date(registroSeleccionado.fecha_salida)) / (1000 * 60 * 60));
      
      const confirmar = confirm(
        `⚠️ ENVIAR ALERTA DE RETORNO PENDIENTE\n\n` +
        `Vehículo: ${registroSeleccionado.placa}\n` +
        `Chofer: ${registroSeleccionado.chofer}\n` +
        `Salida: ${fechaSalida}\n` +
        `Tiempo sin retorno: ${horasSalida} horas\n\n` +
        `¿Enviar alerta por email?`
      );
      
      if (!confirmar) return;
      
      // Enviar alerta por email para este vehículo específico
      const response = await fetch(`${API}/bitacora/alerta-retorno-pendiente`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ registros_pendientes: [registroSeleccionado] })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(`✅ Alerta enviada exitosamente!\n\nSe notificó sobre el vehículo ${registroSeleccionado.placa} a cargo de ${registroSeleccionado.chofer}.`);
        
        // Asegurar que el formulario permanezca en modo retorno después de la alerta
        if (currentBitacoraId && currentBitacoraId === registroSeleccionado.id) {
          console.log('🔧 Restaurando modo retorno después de alerta...');
          
          // Encontrar el vehículo y reconfigurar el formulario
          const vehiculo = Vehiculos.find(v => v.placa === registroSeleccionado.placa);
          if (vehiculo) {
            byId('bVeh').value = vehiculo.id;
          }
          byId('bChofer').value = registroSeleccionado.chofer;
          
          // Asegurar modo retorno
          cambiarAModoRetorno();
          
          // Re-enfocar el campo de kilometraje y mostrar instrucciones
          setTimeout(() => {
            const kmField = byId('bKmRetorno');
            if (kmField) {
              kmField.focus();
              console.log('✅ Formulario listo para registro de retorno');
            }
          }, 100);
          
          // Mostrar mensaje adicional
          setTimeout(() => {
            alert('📝 Ahora puede completar el registro de retorno del vehículo.');
          }, 500);
        }
      } else {
        alert('❌ Error enviando alerta: ' + (data.message || 'Error desconocido'));
      }
      
    } catch (e) {
      alert('❌ Error enviando alerta: ' + e.message);
      console.error('Error enviando alerta de retorno pendiente:', e);
    }
  }
  
  function verificarEstadoBitacora() {
    console.log('=== ESTADO ACTUAL DE BITÁCORA ===');
    console.log('currentBitacoraId:', currentBitacoraId);
    console.log('Modo salida visible:', !byId('salidaFields').classList.contains('hidden'));
    console.log('Modo retorno visible:', !byId('retornoFields').classList.contains('hidden'));
    console.log('Texto del botón:', byId('btnBitacora').innerHTML);
    console.log('Vehículo seleccionado:', byId('bVeh').value);
    console.log('Chofer:', byId('bChofer').value);
    console.log('===============================');
  }
  
  function verificarEstadoVehiculo() {
    const vehiculoId = byId('bVeh').value;
    if (!vehiculoId) return;
    
    // Verificar si hay registros en curso para este vehículo
    const registroEnCurso = Bitacora.find(b => {
      const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
      return vehiculo && b.placa === vehiculo.placa && b.estado === 'en_curso';
    });
    
    if (registroEnCurso) {
      if (confirm('Este vehículo ya tiene una salida registrada sin retorno. ¿Desea completar el retorno?')) {
        completarRetorno(registroEnCurso.id);
      }
    }
  }
  
  function verDetalleBitacora(id) {
    const registro = Bitacora.find(b => b.id === id);
    if (!registro) return;
    
    const fechaSalida = formatDateTimeCA(registro.fecha_salida);
    const fechaRetorno = registro.fecha_retorno ? formatDateTimeCA(registro.fecha_retorno) : 'N/A';
    
    const contenido = `
      <h3>📝 Detalle de Bitácora - ${registro.placa}</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
        <div>
          <h4>🚗 SALIDA</h4>
          <p><strong>Chofer:</strong> ${registro.chofer}</p>  
          <p><strong>Fecha:</strong> ${fechaSalida}</p>
          <p><strong>Kilometraje:</strong> ${registro.km_salida.toLocaleString()} km</p>
          <p><strong>Combustible:</strong> ${registro.nivel_combustible_salida}</p>
          <p><strong>Estado:</strong> ${registro.estado_vehiculo_salida}</p>
        </div>
        <div>
          <h4>🔄 RETORNO</h4>
          <p><strong>Fecha:</strong> ${fechaRetorno}</p>
          <p><strong>Kilometraje:</strong> ${registro.km_retorno ? registro.km_retorno.toLocaleString() + ' km' : 'N/A'}</p>
          <p><strong>Combustible:</strong> ${registro.nivel_combustible_retorno || 'N/A'}</p>
          <p><strong>Estado:</strong> ${registro.estado_vehiculo_retorno || 'N/A'}</p>
        </div>
      </div>
      ${registro.observaciones ? `<p><strong>Observaciones:</strong> ${registro.observaciones}</p>` : ''}
    `;
    
    mostrarModal('Detalle de Bitácora', contenido);
  }
  
  function mostrarModal(titulo, contenido) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">${titulo}</h3>
          <button class="close-btn" onclick="this.closest('.modal').remove()">×</button>
        </div>
        <div>${contenido}</div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }
  
  async function exportarBitacora() {
    try {
      const ws = XLSX.utils.json_to_sheet(Bitacora.map(b => ({
        'Placa': b.placa,
        'Chofer': b.chofer,
        'Fecha Salida': formatDateTimeCA(b.fecha_salida),
        'Km Salida': b.km_salida,
        'Combustible Salida': b.nivel_combustible_salida,
        'Estado Salida': b.estado_vehiculo_salida,
        'Fecha Retorno': b.fecha_retorno ? formatDateTimeCA(b.fecha_retorno) : '',
        'Km Retorno': b.km_retorno || '',
        'Combustible Retorno': b.nivel_combustible_retorno || '',
        'Estado Retorno': b.estado_vehiculo_retorno || '',
        'Observaciones': b.observaciones || '',
        'Estado': b.estado
      })));
      
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Bitácora");
      XLSX.writeFile(wb, `bitacora_${new Date().toISOString().slice(0, 10)}.xlsx`);
    } catch (e) {
      alert('Error exportando: ' + e.message);
    }
  }
  
  // ===== FUNCIONES PARA CONFIGURACIÓN DE ALERTAS =====
  async function cargarConfigAlertas() {
    try {
      // Cargar configuración de alertas
      const responseAlertas = await fetch(`${API}/config/alertas`);
      const dataAlertas = await responseAlertas.json();
      
      if (dataAlertas.success) {
        const config = dataAlertas.config;
        
        // Cargar valores en el formulario
        byId('alertaEmail').value = config.email_destino || '';
        byId('alertaMant').checked = config.alertas_mantenimiento !== false;
        byId('alertaPolizas').checked = config.alertas_polizas !== false;
        byId('alertaRTV').checked = config.alertas_rtv !== false;
        byId('alertaRevisiones').checked = config.alertas_revisiones !== false;
        byId('alertaCombustible').checked = config.alertas_combustible !== false;
        byId('alertaBitacora').checked = config.alertas_bitacora !== false;
        byId('diasPolizas').value = config.dias_anticipacion_polizas || 30;
        byId('diasRTV').value = config.dias_anticipacion_rtv || 30;
        byId('diasMant').value = config.dias_anticipacion_mantenimiento || 30;
        byId('kmDiferencia').value = config.km_diferencia_alerta || 10;
      }
      
      // Cargar configuración de email/SMTP
      const responseEmail = await fetch(`${API}/config/email`);
      const dataEmail = await responseEmail.json();
      
      if (dataEmail.success) {
        const emailConfig = dataEmail.config;
        
        // Cargar configuración SMTP
        byId('smtpEmail').value = emailConfig.sender_email || '';
        byId('smtpHost').value = emailConfig.smtp_server || 'smtp.gmail.com';
        byId('smtpPort').value = emailConfig.smtp_port || 587;
        byId('smtpTLS').checked = true; // Siempre recomendado
        
        // Detectar proveedor basado en el host
        const host = emailConfig.smtp_server || '';
        let provider = 'custom';
        if (host.includes('gmail.com')) provider = 'gmail';
        else if (host.includes('outlook.com')) provider = 'outlook';
        else if (host.includes('yahoo.com')) provider = 'yahoo';
        
        byId('smtpProvider').value = provider;
        
        // Mostrar estado de contraseña
        if (emailConfig.password_configured) {
          byId('smtpPassword').placeholder = '••••••••• (configurada)';
        } else {
          byId('smtpPassword').placeholder = 'Ingrese contraseña de aplicación';
        }
      }
      
      actualizarEstadoAlertas();
    } catch (e) {
      console.error('Error cargando configuración de alertas:', e);
    }
  }
  
  async function guardarConfigAlertas(e) {
    e.preventDefault();
    
    try {
      // Guardar configuración de alertas
      const alertasConfig = {
        email_destino: byId('alertaEmail').value,
        alertas_mantenimiento: byId('alertaMant').checked,
        alertas_polizas: byId('alertaPolizas').checked,
        alertas_rtv: byId('alertaRTV').checked,
        alertas_revisiones: byId('alertaRevisiones').checked,
        alertas_combustible: byId('alertaCombustible').checked,
        alertas_bitacora: byId('alertaBitacora').checked,
        dias_anticipacion_polizas: parseInt(byId('diasPolizas').value),
        dias_anticipacion_rtv: parseInt(byId('diasRTV').value),
        dias_anticipacion_mantenimiento: parseInt(byId('diasMant').value),
        km_diferencia_alerta: parseInt(byId('kmDiferencia').value)
      };
      
      const responseAlertas = await fetch(`${API}/config/alertas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(alertasConfig)
      });
      
      const dataAlertas = await responseAlertas.json();
      
      if (!dataAlertas.success) {
        throw new Error('Error guardando configuración de alertas: ' + dataAlertas.message);
      }
      
      // Guardar configuración SMTP (solo si se proporcionó una nueva contraseña)
      const smtpPassword = byId('smtpPassword').value;
      if (smtpPassword && smtpPassword !== '' && !smtpPassword.includes('•')) {
        const emailConfig = {
          sender_email: byId('smtpEmail').value,
          sender_password: smtpPassword,
          smtp_server: byId('smtpHost').value,
          smtp_port: parseInt(byId('smtpPort').value),
          recipient_email: byId('alertaEmail').value,
          use_tls: byId('smtpTLS').checked
        };
        
        const responseEmail = await fetch(`${API}/config/email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(emailConfig)
        });
        
        const dataEmail = await responseEmail.json();
        
        if (!dataEmail.success) {
          console.warn('Warning: Error guardando configuración SMTP:', dataEmail.message);
          alert('⚠️ Configuración de alertas guardada, pero hubo un problema con la configuración SMTP: ' + dataEmail.message);
          return;
        }
      }
      
      alert('✅ Configuración completa guardada exitosamente');
      actualizarEstadoAlertas();
      
      // Actualizar placeholder de contraseña
      if (smtpPassword) {
        byId('smtpPassword').value = '';
        byId('smtpPassword').placeholder = '••••••••• (configurada)';
      }
      
    } catch (e) {
      alert('❌ Error: ' + e.message);
      console.error('Error guardando configuración:', e);
    }
  }
  
  function actualizarEstadoAlertas() {
    const contenedor = byId('estadoAlertasContent');
    if (!contenedor) return;
    
    const totalVehiculos = Vehiculos.length;
    const alertasActivas = [
      byId('alertaMant').checked,
      byId('alertaPolizas').checked,
      byId('alertaRTV').checked,
      byId('alertaRevisiones').checked,
      byId('alertaCombustible').checked,
      byId('alertaBitacora').checked
    ].filter(Boolean).length;
    
    contenedor.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
          <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${totalVehiculos}</div>
          <div style="font-size: 12px;">Vehículos Monitoreados</div>
        </div>
        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
          <div style="font-size: 24px; font-weight: bold; color: var(--success);">${alertasActivas}/6</div>
          <div style="font-size: 12px;">Tipos de Alertas Activas</div>
        </div>
        <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
          <div style="font-size: 24px; font-weight: bold; color: var(--warn);">${byId('alertaEmail').value ? '✅' : '❌'}</div>
          <div style="font-size: 12px;">Email Configurado</div>
        </div>
      </div>
    `;
  }
  
  function actualizarConfigSMTP() {
    // Función obsoleta - SendGrid integrado automáticamente
    console.log('✅ SendGrid activo - configuración SMTP manual no requerida');
    return;
    const provider = byId('smtpProvider').value;
    const hostField = byId('smtpHost');
    const portField = byId('smtpPort');
    const tlsField = byId('smtpTLS');
    
    const smtpConfigs = {
      gmail: { host: 'smtp.gmail.com', port: 587, tls: true },
      outlook: { host: 'smtp-mail.outlook.com', port: 587, tls: true },
      yahoo: { host: 'smtp.mail.yahoo.com', port: 587, tls: true },
      custom: { host: '', port: 587, tls: true }
    };
    
    const config = smtpConfigs[provider];
    if (config) {
      if (provider !== 'custom') {
        hostField.value = config.host;
        portField.value = config.port;
        tlsField.checked = config.tls;
        hostField.readOnly = true;
      } else {
        hostField.readOnly = false;
        hostField.placeholder = 'mail.tudominio.com';
      }
    }
  }
  
  async function probarConexionSMTP() {
    // Función obsoleta - usar testEmailSystem() en su lugar
    alert('ℹ️ Configuración SMTP manual ya no es necesaria.\n\n' +
          '✅ SendGrid está integrado automáticamente\n' +
          '📧 Use "Probar Email de Prueba" en su lugar');
    return;
    const smtpConfig = {
      email: byId('smtpEmail').value,
      password: byId('smtpPassword').value,
      host: byId('smtpHost').value,
      port: parseInt(byId('smtpPort').value),
      use_tls: byId('smtpTLS').checked
    };
    
    if (!smtpConfig.email || !smtpConfig.password || !smtpConfig.host) {
      alert('Por favor complete todos los campos de configuración SMTP');
      return;
    }
    
    // Mostrar indicador de carga
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '🔄 Probando conexión...';
    button.disabled = true;
    
    try {
      const response = await fetch(`${API}/config/email/test-smtp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(smtpConfig)
      });
      
      const data = await response.json();
      
      if (data.success) {
        let message = '✅ ¡Conexión SMTP exitosa!\n\n';
        message += `📧 Servidor: ${smtpConfig.host}:${smtpConfig.port}\n`;
        message += `👤 Email: ${smtpConfig.email}\n`;
        if (data.method) {
          message += `🔧 Método: ${data.method}\n`;
        }
        message += '\n✅ La configuración es correcta y está lista para enviar alertas.';
        alert(message);
      } else {
        let message = '❌ Error en la conexión SMTP\n\n';
        message += `${data.error}\n\n`;
        message += '💡 Sugerencias:\n';
        message += '• Verifique que email y contraseña sean correctos\n';
        message += '• Para Gmail: use contraseña de aplicación (no la normal)\n';
        message += '• Para Outlook: verifique que la autenticación esté habilitada\n';
        message += '• Pruebe diferentes puertos (587, 465, 25)\n';
        message += '• Consulte con su proveedor de hosting/email';
        alert(message);
      }
    } catch (error) {
      alert(`❌ Error de conexión: ${error.message}\n\nVerifique su conexión a internet y que el servidor backend esté funcionando.`);
    } finally {
      // Restaurar botón
      button.textContent = originalText;
      button.disabled = false;
    }
  }
  
  async function probarAlertas() {
    try {
      const response = await fetch(`${API}/config/email/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('✅ Email de prueba enviado exitosamente');
      } else {
        alert('❌ Error enviando email de prueba: ' + data.message);
      }
    } catch (e) {
      alert('❌ Error: ' + e.message);
    }
  }
  
  async function verificarAlertasManual() {
    try {
      const response = await fetch(`${API}/alertas/verificar`);
      const data = await response.json();
      
      if (data.success) {
        alert(`✅ Verificación completada.\n${data.message || 'Sin alertas pendientes'}`);
      } else {
        alert('❌ Error verificando alertas: ' + data.message);
      }
    } catch (e) {
      alert('❌ Error: ' + e.message);
    }
  }
  
  // ===== MODO COMPACTO MÓVIL =====
  function toggleMobileCompactMode() {
    mobileCompactMode = !mobileCompactMode;
    const body = document.body;
    const toggleBtn = byId('mobileToggle');
    
    if (mobileCompactMode) {
      body.classList.add('mobile-compact');
      if (toggleBtn) {
        toggleBtn.innerHTML = '📋 Normal';
        toggleBtn.title = 'Cambiar a vista normal';
      }
      setupMobileNavigation();
      showMobileNotification('✅ Modo compacto activado - Navegación en la parte inferior', 2000);
      // Guardar preferencia
      try { localStorage.setItem('mobileCompactMode', 'true'); } catch {}
    } else {
      body.classList.remove('mobile-compact');
      if (toggleBtn) {
        toggleBtn.innerHTML = '📱 Compacto';
        toggleBtn.title = 'Activar modo compacto móvil';
      }
      showMobileNotification('✅ Vista normal activada - Navegación en pestañas superiores', 2000);
      // Guardar preferencia
      try { localStorage.setItem('mobileCompactMode', 'false'); } catch {}
    }
  }
  
  function showMobileNotification(message, duration = 3000) {
    // Crear o actualizar notificación
    let notification = byId('mobileNotification');
    if (!notification) {
      notification = document.createElement('div');
      notification.id = 'mobileNotification';
      notification.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        text-align: center;
        max-width: 90%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      `;
      document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.style.opacity = '1';
    
    setTimeout(() => {
      if (notification) {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (notification && notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, duration);
  }
  
  function setupMobileNavigation() {
    const navGrid = byId('mobileNavGrid');
    if (!navGrid || !currentUser) return;
    
    // Definir navegación según rol
    const navItems = [];
    
    if (hasPermission('dashboard')) {
      navItems.push({ tab: 'dashboard', icon: '📊', text: 'Dashboard' });
    }
    if (hasPermission('vehiculos')) {
      navItems.push({ tab: 'vehiculos', icon: '🚗', text: 'Vehículos' });
    }
    if (hasPermission('mantenimientos')) {
      navItems.push({ tab: 'mantenimientos', icon: '🔧', text: 'Mantenim.' });
    }
    if (hasPermission('combustible')) {
      navItems.push({ tab: 'combustible', icon: '⛽', text: 'Combustible' });
    }
    if (hasPermission('polizas')) {
      navItems.push({ tab: 'polizas', icon: '🛡️', text: 'Pólizas' });
    }
    if (hasPermission('ficha-tecnica')) {
      navItems.push({ tab: 'ficha-tecnica', icon: '📋', text: 'Ficha Téc.' });
    }
    if (hasPermission('bitacora')) {
      navItems.push({ tab: 'bitacora', icon: '📝', text: 'Bitácora' });
    }
    if (hasPermission('revision')) {
      navItems.push({ tab: 'revision', icon: '🔍', text: 'Revisión' });
    }
    if (hasPermission('alertas-config')) {
      navItems.push({ tab: 'alertas-config', icon: '⚠️', text: 'Alertas' });
    }
    if (hasPermission('reportes')) {
      navItems.push({ tab: 'reportes', icon: '📈', text: 'Reportes' });
    }
    
    // Crear elementos de navegación (máximo 8 items, dividir en páginas si es necesario)
    navGrid.innerHTML = '';
    const maxItems = 8;
    const itemsToShow = navItems.slice(0, maxItems);
    
    itemsToShow.forEach(item => {
      const navItem = document.createElement('div');
      navItem.className = 'mobile-nav-item';
      navItem.setAttribute('data-tab', item.tab);
      navItem.innerHTML = `
        <span class="nav-icon">${item.icon}</span>
        <span class="nav-text">${item.text}</span>
      `;
      
      navItem.addEventListener('click', () => {
        // Remover active de todos
        document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
        // Agregar active al seleccionado
        navItem.classList.add('active');
        // Cambiar tab
        setTab(item.tab);
      });
      
      navGrid.appendChild(navItem);
    });
    
    // Marcar la pestaña activa
    updateMobileNavActive();
  }
  
  function updateMobileNavActive() {
    const activeTab = document.querySelector('.tab.active');
    const activeTabName = activeTab ? activeTab.getAttribute('data-tab') : 'dashboard';
    
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
      item.classList.remove('active');
      if (item.getAttribute('data-tab') === activeTabName) {
        item.classList.add('active');
      }
    });
  }
  
  // Modificar setTab para actualizar navegación móvil
  const originalSetTab = setTab;
  setTab = function(name) {
    originalSetTab(name);
    if (mobileCompactMode) {
      updateMobileNavActive();
    }
    // Cerrar FAB después de seleccionar una opción
    closeFab();
  };
  
  /* ========================================
     FLOATING FAB FUNCTIONALITY
     ======================================== */
  let fabOpen = false;
  let fabVisible = true;
  
  function toggleFab() {
    const fab = document.getElementById('floatingFab');
    const icon = document.getElementById('fabIcon');
    
    fabOpen = !fabOpen;
    
    if (fabOpen) {
      fab.classList.add('open');
      icon.textContent = '✕';
    } else {
      fab.classList.remove('open');
      icon.textContent = '⚡';
    }
  }
  
  function closeFab() {
    const fab = document.getElementById('floatingFab');
    const icon = document.getElementById('fabIcon');
    
    fabOpen = false;
    fab.classList.remove('open');
    icon.textContent = '⚡';
  }
  
  function hideFab() {
    const fab = document.getElementById('floatingFab');
    fabVisible = false;
    fab.classList.add('hidden');
  }
  
  function showFab() {
    const fab = document.getElementById('floatingFab');
    fabVisible = true;
    fab.classList.remove('hidden');
  }
  
  function toggleFabVisibility() {
    if (fabVisible) {
      hideFab();
    } else {
      showFab();
    }
  }
  
  // Cerrar FAB al hacer clic fuera
  document.addEventListener('click', function(event) {
    const fab = document.getElementById('floatingFab');
    const fabToggle = document.getElementById('fabToggle');
    
    if (fabOpen && fab && !fab.contains(event.target)) {
      closeFab();
    }
  });
  
  // Auto-ocultar FAB al hacer scroll (opcional)
  let lastScrollY = window.scrollY;
  let scrollTimeout;
  
  window.addEventListener('scroll', function() {
    const currentScrollY = window.scrollY;
    
    // Limpiar timeout previo
    clearTimeout(scrollTimeout);
    
    // Si está scrolleando hacia abajo rápidamente, ocultar FAB
    if (currentScrollY > lastScrollY + 50 && fabVisible) {
      hideFab();
    }
    
    // Mostrar FAB después de parar de scrollear
    scrollTimeout = setTimeout(() => {
      if (!fabVisible) {
        showFab();
      }
    }, 1000);
    
    lastScrollY = currentScrollY;
  });
  
  // Cargar preferencia de modo compacto al iniciar
  document.addEventListener('DOMContentLoaded', function() {
    // Intentar restaurar sesión
    if (loadSession()) {
      // Sesión restaurada, mostrar app
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').classList.add('logged-in');
      updateUIForRole();
      startSessionTimer();
      
      // Ir a la primera pestaña disponible
      const firstAvailableTab = currentUser.permissions[0] || 'dashboard';
      setTab(firstAvailableTab);
      
      // FORZAR ACTUALIZACIÓN DE KPIS EN RESTAURACIÓN DE SESIÓN
      if (firstAvailableTab === 'dashboard') {
        setTimeout(() => {
          console.log('🔄 Sesión restaurada: Forzando actualización de KPIs...');
          renderKpis();
          setTimeout(() => {
            const kpiElement = document.getElementById('kpiCostoTotalMes');
            if (kpiElement && (kpiElement.textContent === '-' || kpiElement.textContent === '₡0')) {
              console.log('🚨 Sesión restaurada: KPIs en ₡0, ejecutando fix agresivo...');
              forceKPIUpdate();
            }
          }, 3000);
        }, 2000);
      }
      
      // Cargar datos
      loadAll();
      
      // Inicializar formulario de bitácora en modo salida
      initBitacoraForm();
      
      console.log('✅ Sesión restaurada automáticamente');
    } else {
      // No hay sesión válida, mostrar login
      document.getElementById('loginScreen').style.display = 'flex';
      console.log('🔐 Mostrando pantalla de login');
    }
    
    // Cargar preferencia guardada
    try {
      const savedMode = localStorage.getItem('mobileCompactMode');
      if (savedMode === 'true' && window.innerWidth <= 768) {
        setTimeout(() => toggleMobileCompactMode(), 500);
      }
    } catch {}
  });
  
  </script>
</body>
</html>
