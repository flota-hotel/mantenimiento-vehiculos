<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Sistema de Gesti√≥n Vehicular ‚Äî Hotel</title>

  <!-- PWA (opcional) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1e40af">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registrado', reg))
        .catch(err => console.error('Error registrando SW', err));
    }
  </script>

  <style>
    :root{ 
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --card: #ffffff;
      --ink: #1e293b;
      --muted: #64748b;
      --primary: #1e40af;
      --primary-hover: #1d4ed8;
      --secondary: #0f172a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --line: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:var(--ink);background:var(--bg)}
    
    /* Login Screen */
    .login-screen{position:fixed;top:0;left:0;width:100%;height:100vh;height:calc(var(--vh, 1vh) * 100);background:linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);display:flex;align-items:center;justify-content:center;z-index:1000}
    .login-card{background:white;padding:40px;border-radius:20px;box-shadow:var(--shadow-lg);width:100%;max-width:400px;text-align:center}
    .login-title{font-size:24px;font-weight:700;margin-bottom:8px;color:var(--ink)}
    .login-subtitle{color:var(--muted);margin-bottom:32px}
    .login-form{display:flex;flex-direction:column;gap:20px}
    .role-card{border:2px solid var(--line);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s;user-select:none;-webkit-tap-highlight-color:transparent;min-height:80px;display:flex;flex-direction:column;justify-content:center}
    .role-card:hover{border-color:var(--primary);transform:translateY(-2px)}
    .role-card:active{transform:scale(0.98)}
    .role-card.selected{border-color:var(--primary);background:rgba(30, 64, 175, 0.05);box-shadow:0 0 0 2px rgba(30, 64, 175, 0.2)}
    .role-title{font-weight:600;margin-bottom:4px}
    .role-desc{font-size:14px;color:var(--muted)}
    .password-field{margin-top:20px}
    .password-field input{width:100%;padding:12px;border:1px solid var(--line);border-radius:8px;font-size:16px}
    .login-btn{background:var(--primary);color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.2s}
    .login-btn:hover{background:var(--primary-hover)}
    .login-btn:disabled{opacity:0.5;cursor:not-allowed}
    
    /* Main App */
    .app{display:none}
    .app.logged-in{display:block}
    
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:5;box-shadow:var(--shadow)}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 24px}
    .brand{font-weight:700;font-size:18px;color:var(--primary);display:flex;align-items:center;gap:8px}
    .brand-icon{font-size:24px}
    .search{flex:1;display:flex;gap:8px;max-width:400px}
    .user-info{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:14px}
    .logout-btn{background:var(--danger);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px}
    .logout-btn:hover{background:#dc2626}
    
    input, select{width:100%;padding:12px 16px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px;transition:border-color 0.2s, box-shadow 0.2s;-webkit-appearance:none;-moz-appearance:none;appearance:none}
    input:focus, select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(30, 64, 175, 0.1)}
    
    /* Mejoras espec√≠ficas para m√≥vil */
    @media (max-width: 768px) {
      input, select, textarea {
        font-size:16px !important; /* Previene zoom en iOS */
        padding:14px 16px;
        border-width:2px;
        border-radius:8px;
      }
      input[type="date"], input[type="datetime-local"], input[type="time"] {
        font-size:16px !important;
        min-height:48px;
      }
      select {
        background-image:url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1h4l-2 2z"/></svg>');
        background-repeat:no-repeat;
        background-position:right 12px center;
        background-size:12px;
        padding-right:40px;
      }
    }
    
    button{border:0;border-radius:10px;padding:12px 20px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px;user-select:none;-webkit-tap-highlight-color:transparent;min-height:40px}
    button:hover{background:var(--primary-hover);transform:translateY(-1px);box-shadow:var(--shadow)}
    button:active{transform:scale(0.95);background:var(--primary-hover)}
    button.secondary{background:#f8fafc;color:var(--ink);border:1px solid var(--line)}
    .btn-small{padding:6px 10px;font-size:12px;margin:2px;min-width:auto}
    .btn-small.danger{background:var(--danger)}
    .btn-small.danger:hover{background:#dc2626}
    button.secondary:hover{background:#f1f5f9;border-color:var(--primary)}
    button.danger{background:var(--danger)}
    button.danger:hover{background:#dc2626}
    button.success{background:var(--success)}
    button.success:hover{background:#059669}
    
    .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:16px 24px;background:rgba(255,255,255,0.5);backdrop-filter:blur(10px);position:relative;transition:all 0.3s ease}
    .tab{padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer;font-weight:500;transition:all 0.2s;display:flex;align-items:center;gap:6px;user-select:none;-webkit-tap-highlight-color:transparent}
    .tab:hover{background:var(--primary);color:#fff;border-color:transparent;transform:translateY(-1px)}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent;box-shadow:var(--shadow)}
    .tab:active{transform:scale(0.95)} /* Feedback t√°ctil */
    
    .container{max-width:1400px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:20px}
    .kpis{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:24px;box-shadow:var(--shadow);transition:transform 0.2s, box-shadow 0.2s}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .card h3{margin:0 0 12px 0;font-size:14px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
    .big{font-size:32px;font-weight:800;color:var(--primary)}
    .kpi-icon{font-size:24px;margin-bottom:8px;opacity:0.7}
    
    table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;min-width:600px}
    th,td{padding:12px 16px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;background:#f8fafc;text-transform:uppercase;letter-spacing:0.5px;font-size:12px;position:sticky;top:0;z-index:2}
    tr:hover{background:#f8fafc}
    .table-container{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:12px;box-shadow:var(--shadow);position:relative}
    .table-container::-webkit-scrollbar{height:8px}
    .table-container::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}
    .table-container::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:4px}
    .table-container::-webkit-scrollbar-thumb:hover{background:#a1a1a1}
    
    /* Indicador de scroll para m√≥vil */
    @media (max-width: 768px) {
      .table-container::after{
        content:'‚Üê Deslizar para ver m√°s ‚Üí';
        position:absolute;
        bottom:0;
        right:0;
        background:rgba(0,0,0,0.7);
        color:white;
        padding:4px 8px;
        font-size:10px;
        border-radius:4px 0 0 0;
        pointer-events:none;
        opacity:0.8;
      }
      .table-container::-webkit-scrollbar{height:6px}
    }
    
    .row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600}
    .ok{background:#10b9811a;color:#065f46;border:1px solid #10b98140}
    .warnP{background:#f59e0b1a;color:#7c2d12;border:1px solid #f59e0b40}
    .dangerP{background:#ef44441a;color:#7f1d1d;border:1px solid #ef444440}
    
    .hidden{display:none !important}
    .mobile-only{display:none}
    
    /* Estilos para modo compacto m√≥vil */
    .mobile-compact .tabs {
      display: none !important;
    }
    .mobile-compact .mobile-nav {
      display: block !important;
    }
    .mobile-nav {
      display: none;
      background: white;
      border-top: 1px solid var(--line);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 8px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    .mobile-nav-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      max-width: 100%;
    }
    .mobile-nav-item {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-height: 60px;
      justify-content: center;
    }
    .mobile-nav-item:hover, .mobile-nav-item.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .mobile-nav-item .nav-icon {
      font-size: 16px;
      display: block;
    }
    .mobile-nav-item .nav-text {
      font-size: 9px;
      font-weight: 600;
      line-height: 1.2;
    }
    
    /* Ajustes para modo compacto */
    .mobile-compact .container {
      padding-bottom: 90px; /* Espacio para la nav bottom */
    }
    .mobile-compact .sticky-actions {
      display: none; /* Ocultar botones flotantes */
    }
    .mobile-compact .topbar {
      padding: 8px 12px; /* Header m√°s compacto */
    }
    .mobile-compact .brand {
      font-size: 14px; /* Logo m√°s peque√±o */
    }
    .mobile-compact .user-info {
      gap: 6px;
      font-size: 11px;
    }
    .mobile-compact .search {
      order: 0; /* B√∫squeda arriba */
    }
    .mobile-compact .search input {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    /* Mejorar cards en modo compacto */
    .mobile-compact .card {
      padding: 12px;
      margin-bottom: 8px;
    }
    .mobile-compact .card h3 {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .mobile-compact .big {
      font-size: 20px;
    }
    
    /* KPIs m√°s compactos */
    .mobile-compact .kpis {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .mobile-compact .kpis .card {
      padding: 8px;
      min-height: 80px;
    }
    
    /* Navegaci√≥n m√≥vil mejorada */
    .mobile-nav {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 2px solid var(--primary);
    }
    .mobile-nav-item {
      background: transparent;
      border: none;
      transition: all 0.3s ease;
    }
    .mobile-nav-item:hover, .mobile-nav-item.active {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
    }
    .mobile-nav-item .nav-icon {
      transition: transform 0.3s ease;
    }
    .mobile-nav-item:hover .nav-icon, .mobile-nav-item.active .nav-icon {
      transform: scale(1.2);
    }
    
    /* Asegurar que los modales est√©n ocultos por defecto */
    .modal.hidden{visibility:hidden;opacity:0}
    .modal{visibility:hidden;opacity:0;transition:opacity 0.3s ease, visibility 0.3s ease}
    .modal:not(.hidden){visibility:visible;opacity:1}
    .sticky-actions{position:fixed;right:24px;bottom:24px;display:flex;flex-direction:column;gap:12px;z-index:10}
    .footer{padding:24px;color:var(--muted);font-size:12px;text-align:center;background:var(--card);margin-top:40px;border-top:1px solid var(--line)}
    .tag{font-size:12px;color:var(--muted);border:1px solid var(--line);border-radius:999px;padding:4px 12px;background:white}
    .test{font-size:12px;color:var(--ink)}
    .test .pass{color:#059669}
    .test .fail{color:#b91c1c}
    
    /* highlight bit√°cora */
    .flash{transition:background 0.4s}
    .flash td{background:inherit}
    .flash-ret{background:#fff7ed !important}
    .flash-ent{background:#eef2ff !important}
    .newtag{display:inline-block;margin-right:6px;font-size:12px}
    
    /* Action buttons */
    .action-btn{padding:6px 12px;font-size:12px;margin:0 2px}
    .edit-btn{background:var(--warn);color:white}
    .edit-btn:hover{background:#d97706}
    .delete-btn{background:var(--danger);color:white}
    .delete-btn:hover{background:#dc2626}
    .export-btn{background:var(--success);color:white}
    .export-btn:hover{background:#059669}
    
    /* Modal styles */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;cursor:pointer;padding:20px;box-sizing:border-box}
    .modal-content{background:white;padding:24px;border-radius:16px;max-width:800px;width:90%;max-height:90%;overflow-y:auto;cursor:default;position:relative}
    
    @media (max-width: 768px) {
      .modal{
        align-items:flex-start;
        padding:10px;
      }
      .modal-content{
        width:100%;
        max-width:100%;
        margin-top:20px;
        border-radius:12px;
        padding:16px;
        max-height:calc(100vh - 40px);
      }
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--line)}
    .modal-title{font-size:20px;font-weight:700;color:var(--ink)}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s}
    .close-btn:hover{background:var(--line);color:var(--ink);transform:scale(1.1)}
    
    /* Form improvements */
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--ink)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    
    /* Report preview */
    .report-preview{background:white;border:1px solid var(--line);border-radius:12px;padding:20px;margin-top:20px}
    .report-header{text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--primary)}
    .report-title{font-size:24px;font-weight:700;color:var(--primary);margin-bottom:8px}
    .report-date{color:var(--muted);font-size:14px}
    
    @media (max-width: 768px) {
      /* Layout ajustes */
      .row, .row-3, .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
      .container { padding: 12px 8px; }
      
      /* Header y navegaci√≥n m√≥vil */
      .topbar { 
        flex-direction: column; 
        gap: 12px; 
        padding: 12px 16px;
      }
      .brand { 
        font-size: 16px;
        text-align: center;
      }
      .search { 
        max-width: none; 
        order: 1;
      }
      .user-info { 
        flex-direction: column; 
        gap: 8px; 
        font-size: 12px;
        text-align: center;
      }
      
      /* Mostrar bot√≥n m√≥vil */
      .mobile-only {
        display: inline-flex !important;
      }
      
      /* Tabs m√°s grandes para m√≥vil */
      .tabs { 
        padding: 8px 12px; 
        gap: 6px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        position: relative;
      }
      .tabs::-webkit-scrollbar {
        height: 4px;
      }
      .tabs::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.1);
        border-radius: 2px;
      }
      .tabs::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 2px;
      }
      .tab { 
        padding: 12px 16px; 
        font-size: 14px;
        white-space: nowrap;
        min-width: fit-content;
        flex-shrink: 0;
      }
      
      /* Formularios m√≥viles */
      input, select, textarea { 
        font-size: 16px; /* Previene zoom en iOS */
        padding: 14px 16px;
      }
      button { 
        padding: 14px 20px; 
        font-size: 16px;
        min-height: 48px; /* Mejor √°rea t√°ctil */
      }
      .btn-small {
        padding: 10px 14px;
        font-size: 14px;
        min-height: 40px;
      }
      
      /* Cards m√°s compactas */
      .card { 
        padding: 16px; 
        margin-bottom: 12px;
      }
      .card h3 { 
        font-size: 14px; 
        margin-bottom: 12px;
      }
      
      /* Tablas responsivas */
      table { 
        font-size: 12px; 
        overflow-x: auto;
        display: block;
        white-space: nowrap;
      }
      thead, tbody, tr { 
        display: table; 
        width: 100%;
        table-layout: fixed;
      }
      th, td { 
        padding: 8px 4px; 
        font-size: 11px;
      }
      
      /* KPIs m√°s compactos */
      .big { 
        font-size: 24px; 
      }
      .kpi-icon { 
        font-size: 20px; 
      }
      
      /* Modales m√≥viles */
      .modal-content { 
        width: 95%; 
        max-width: 95%; 
        margin: 20px auto;
        max-height: 85vh;
        padding: 16px;
      }
      .modal-header {
        padding-bottom: 12px;
        margin-bottom: 16px;
      }
      .modal-title { 
        font-size: 18px; 
      }
      
      /* Botones flotantes */
      .sticky-actions { 
        right: 12px; 
        bottom: 12px; 
        gap: 8px;
      }
      .sticky-actions button { 
        font-size: 14px; 
        padding: 12px 16px;
      }
      
      /* Login m√≥vil */
      .login-card { 
        padding: 24px; 
        margin: 20px;
        width: calc(100% - 40px);
      }
      .login-title { 
        font-size: 20px; 
      }
      .role-card { 
        padding: 16px; 
        margin-bottom: 12px;
      }
      
      /* Alertas y pills m√°s peque√±os */
      .pill { 
        font-size: 10px; 
        padding: 4px 8px;
        margin: 1px;
      }
      
      /* Ajustes para campos espec√≠ficos */
      .form-group label { 
        font-size: 14px; 
        margin-bottom: 6px;
        font-weight: 600;
      }
      
      /* Mejoras para filtros */
      .form-row {
        gap: 12px;
      }
      
      /* Botones m√°s accesibles */
      .export-btn { 
        font-size: 12px; 
        padding: 8px 12px;
        min-height: 40px;
      }
      
      /* Mejoras para ficha t√©cnica */
      #fichaTecnicaContent .card { 
        margin-bottom: 8px; 
      }
      
      /* Email config m√≥vil */
      .card[data-roles="admin"] { 
        padding: 12px; 
      }
      .card[data-roles="admin"] h3 { 
        font-size: 16px; 
      }
      
      /* Mejoras espec√≠ficas para dashboard */
      .kpis .card {
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }
      
      /* Mejor separaci√≥n visual */
      .card + .card {
        margin-top: 12px;
      }
      
      /* Acciones m√°s grandes */
      .action-btn {
        min-height: 36px;
        padding: 6px 10px;
        font-size: 12px;
      }
      
      /* Mejora para elementos de b√∫squeda */
      .search input {
        font-size: 14px;
        padding: 10px 12px;
      }
      
      /* Tags y elementos informativos */
      .tag {
        font-size: 11px;
        padding: 3px 8px;
      }
    }
    
    @media (max-width: 480px) {
      /* Pantallas muy peque√±as */
      .container { 
        padding: 8px 4px; 
      }
      .topbar { 
        padding: 8px 12px; 
      }
      .brand { 
        font-size: 14px; 
      }
      .big { 
        font-size: 20px; 
      }
      .modal-content { 
        width: 98%; 
        padding: 12px;
        margin: 10px auto;
      }
      table { 
        font-size: 10px; 
      }
      th, td { 
        padding: 6px 2px; 
      }
      .card { 
        padding: 12px; 
      }
      input, select, textarea, button { 
        font-size: 14px; 
      }
    }
  </style>

  <!-- SheetJS para exportaciones a Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1 class="login-title">üöó Sistema de Gesti√≥n Vehicular</h1>
      <p class="login-subtitle">Seleccione su rol para acceder al sistema</p>
      
      <div class="login-form">
        <div class="role-card" data-role="admin" onclick="selectRole('admin')">
          <div class="role-title">üë®‚Äçüíº Administrador</div>
          <div class="role-desc">Acceso completo a todas las funciones</div>
        </div>
        
        <div class="role-card" data-role="operador" onclick="selectRole('operador')">
          <div class="role-title">üîß Operador</div>
          <div class="role-desc">Mantenimientos, cambios de aceite y combustible</div>
        </div>
        
        <div class="role-card" data-role="supervisor" onclick="selectRole('supervisor')">
          <div class="role-title">üëÅÔ∏è Supervisor</div>
          <div class="role-desc">Solo acceso a revisiones detalladas</div>
        </div>
        
        <div class="password-field">
          <input type="password" id="loginPassword" placeholder="Ingrese su contrase√±a" />
        </div>
        
        <button class="login-btn" onclick="attemptLogin()" disabled>Iniciar Sesi√≥n</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <span class="brand-icon">üöó</span>
        Sistema de Gesti√≥n Vehicular
      </div>
      <div class="search">
        <input id="qPlaca" type="text" placeholder="Buscar por placa (ej. ABC123)‚Ä¶"/>
        <button class="secondary" onclick="buscarPlaca()">üîç Buscar</button>
      </div>
      <div class="user-info">
        <span>üë§ <span id="currentUserRole"></span></span>
        <button id="mobileToggle" class="secondary mobile-only" onclick="toggleMobileCompactMode()" title="Modo Compacto M√≥vil">üì± Compacto</button>
        <button class="secondary" onclick="cerrarTodosLosModales()" title="Cerrar ventanas abiertas">‚úñÔ∏è Cerrar Modales</button>
        <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>
    <div class="tabs" id="mainTabs">
      <button class="tab active" data-tab="dashboard" onclick="setTab('dashboard')" data-roles="admin">üìä Dashboard</button>
      <button class="tab" data-tab="vehiculos" onclick="setTab('vehiculos')" data-roles="admin">üöó Veh√≠culos</button>
      <button class="tab" data-tab="ficha-tecnica" onclick="setTab('ficha-tecnica')" data-roles="admin">üìã Ficha T√©cnica</button>
      <button class="tab" data-tab="polizas" onclick="setTab('polizas')" data-roles="admin">üõ°Ô∏è P√≥lizas & RTV</button>
      <button class="tab" data-tab="mantenimientos" onclick="setTab('mantenimientos')" data-roles="admin,operador">üîß Mantenimientos</button>
      <button class="tab" data-tab="combustible" onclick="setTab('combustible')" data-roles="admin,operador">‚õΩ Combustible</button>
      <button class="tab" data-tab="revision" onclick="setTab('revision')" data-roles="admin,supervisor">üîç Revisi√≥n</button>
      <button class="tab" data-tab="reportes" onclick="setTab('reportes')" data-roles="admin">üìà Reportes</button>
    </div>
  </header>

  <main class="container">
    <section id="tab-dashboard" class="tabpanel">
      <!-- === INDICADORES PRINCIPALES === -->
      <div class="grid kpis">
        <!-- 1. VEH√çCULOS ACTIVOS -->
        <div class="card">
          <div class="kpi-icon">üöó</div>
          <h3>Veh√≠culos Activos</h3>
          <div class="big" id="kpiVeh">-</div>
        </div>
        
        <!-- 2. P√ìLIZAS POR VENCER -->
        <div class="card">
          <div class="kpi-icon">üõ°Ô∏è</div>
          <h3>P√≥lizas (‚â§30d)</h3>
          <div class="big" id="kpiPol30">-</div>
          <div id="proxPolizas" style="margin-top: 8px; min-height: 40px;">
            <div style="color: var(--text-secondary); font-size: 0.8em;">Cargando...</div>
          </div>
        </div>
        
        <!-- 3. RTV POR VENCER -->
        <div class="card">
          <div class="kpi-icon">üîç</div>
          <h3>RTV (‚â§30d)</h3>
          <div class="big" id="kpiRtv30">-</div>
          <div id="proxRTV" style="margin-top: 8px; min-height: 40px;">
            <div style="color: var(--text-secondary); font-size: 0.8em;">Cargando...</div>
          </div>
        </div>
        
        <!-- 4. COSTOS DEL MES -->
        <div class="card">
          <div class="kpi-icon">üí∞</div>
          <h3>Costo Total Mes</h3>
          <div class="big" id="kpiCostoTotalMes">-</div>
          <div style="margin-top: 8px; font-size: 0.85em;">
            <div>‚õΩ <strong>Combustible:</strong> <span id="kpiCombustibleMes">-</span></div>
            <div>üîß <strong>Mantenimiento:</strong> <span id="kpiMantenimientoMes">-</span></div>
          </div>
        </div>
      </div>
      
      <!-- === INDICADORES SECUNDARIOS === -->
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-top: 16px;">
        <div class="card">
          <div class="kpi-icon">üîß</div>
          <h4>Mantenimientos del Mes</h4>
          <div class="big" style="font-size: 1.5em;" id="kpiMantMes">-</div>
        </div>
        
        <div class="card">
          <div class="kpi-icon">üìä</div>
          <h4>Promedio KM/L</h4>
          <div class="big" style="font-size: 1.5em;" id="kpiKmL">-</div>
        </div>
      </div>
      <!-- === RESUMEN DEL MES ACTUAL === -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin: 0 0 16px 0; color: var(--primary);">üìä Resumen del Mes</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
          <div style="text-align: center; padding: 12px; background: rgba(0, 123, 255, 0.1); border-radius: 8px;">
            <div style="font-size: 0.9em; color: var(--text-secondary);">Total Gastado</div>
            <div style="font-size: 1.4em; font-weight: bold; color: var(--primary);" id="kpiCostoTotalMes2">-</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
            <div style="font-size: 0.9em; color: var(--text-secondary);">‚õΩ Combustible</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #28a745;" id="kpiCombustibleMes2">-</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
            <div style="font-size: 0.9em; color: var(--text-secondary);">üîß Mantenimiento</div>
            <div style="font-size: 1.4em; font-weight: bold; color: #ffc107;" id="kpiMantenimientoMes2">-</div>
          </div>
        </div>
      </div>
      
      <!-- === ALERTAS CONSOLIDADAS === -->
      <div class="card" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>‚ö†Ô∏è Alertas y Vencimientos</strong>
          <input id="fltAlertPlaca" type="text" placeholder="Filtrar por placa‚Ä¶" oninput="renderAlertas()"/>
        </div>
        <div class="table-container">
          <table><thead><tr><th>Tipo</th><th>Placa</th><th>D√≠as/Km</th><th>Estado</th></tr></thead><tbody id="tblAlertas"></tbody></table>
        </div>
      </div>
      <div class="card" style="margin-top:16px">
        <details>
          <summary>üß™ Pruebas r√°pidas (dev)</summary>
          <div class="test" id="testOut"></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="secondary" onclick="runTests('api')">Probar Conectividad API</button>
            <button class="secondary" onclick="runTests('get')">Probar GET Veh√≠culos</button>
            <button class="secondary" onclick="runTests('ui')">Probar UI (selects)</button>
            <button class="secondary" onclick="runTests('core')">Probar Core (setTab/XLSX)</button>
            <button class="secondary" onclick="runTests('auto')">Probar autoProximoKm</button>
            <button class="secondary" onclick="runTests('bit')">Probar reset & filtro Bit√°cora</button>
          </div>
        </details>
      </div>
    </section>

    <section id="tab-vehiculos" class="tabpanel hidden">
      <form class="card" onsubmit="guardarVehiculo(event)" style="margin-bottom:12px">
        <h3 style="margin:0 0 16px 0;color:var(--ink)">üöó Agregar Nuevo Veh√≠culo</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Placa</label>
            <input id="vPlaca" type="text" placeholder="ABC123" required/>
          </div>
          <div class="form-group">
            <label>Marca</label>
            <input id="vMarca" type="text" placeholder="Toyota" required/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Modelo</label>
            <input id="vModelo" type="text" placeholder="Corolla" required/>
          </div>
          <div class="form-group">
            <label>A√±o</label>
            <input id="vAnio" type="number" min="1990" max="2100" required/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Tipo</label>
            <select id="vTipo">
              <option value="sed√°n">Sed√°n</option>
              <option value="pickup">Pickup</option>
              <option value="SUV">SUV</option>
              <option value="buseta">Buseta</option>
              <option value="hatchback">Hatchback</option>
              <option value="minivan">Minivan</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="vEstado">
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
              <option value="mantenimiento">En Mantenimiento</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Due√±o</label>
            <input id="vDueno" type="text" placeholder="Ej: Hotel, Juan P√©rez, Empresa XYZ"/>
          </div>
          <div class="form-group">
            <label>N√∫mero de P√≥liza</label>
            <input id="vPoliza" type="text" placeholder="POL-123456"/>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Aseguradora</label>
            <input id="vAseguradora" type="text" placeholder="INS, Mapfre, etc."/>
          </div>
          <div class="form-group">
            <label>Color</label>
            <input id="vColor" type="text" placeholder="Blanco, Negro, etc."/>
          </div>
        </div>
        <div style="margin-top:20px">
          <button type="submit" class="success">üíæ Guardar Veh√≠culo</button>
          <button type="button" class="secondary" onclick="limpiarFormVehiculo()">üóëÔ∏è Limpiar</button>
        </div>
      </form>
      
      <div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <select id="fltVehPlaca" onchange="renderVehiculos()">
            <option value="">üìã Todas las placas</option>
          </select>
          <select id="fltVehEstado" onchange="renderVehiculos()">
            <option value="">üöó Todos los estados</option>
            <option value="activo">‚úÖ Activo</option>
            <option value="inactivo">‚ùå Inactivo</option>
            <option value="mantenimiento">üîß En Mantenimiento</option>
          </select>
          <input id="fltVehDueno" type="text" placeholder="üîç Filtrar por due√±o..." onkeyup="renderVehiculos()"/>
        </div>
        <div>
          <button class="secondary export-btn" onclick="exportarVehiculo()">üìä Exportar Excel</button>
        </div>
      </div>
      
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Placa</th>
              <th>Marca/Modelo</th>
              <th>A√±o</th>
              <th>Tipo</th>
              <th>Due√±o</th>
              <th>Aseguradora</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tblVeh"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-ficha-tecnica" class="tabpanel hidden">
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin:0 0 16px 0;color:var(--ink)">üìã Seleccionar Veh√≠culo para Ficha T√©cnica</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Veh√≠culo</label>
            <select id="fichaVehiculo" onchange="cargarFichaTecnica()">
              <option value="">Seleccione un veh√≠culo...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Per√≠odo de an√°lisis</label>
            <select id="fichaPeriodo" onchange="cargarFichaTecnica()">
              <option value="3">√öltimos 3 meses</option>
              <option value="6" selected>√öltimos 6 meses</option>
              <option value="12">√öltimo a√±o</option>
              <option value="all">Todo el historial</option>
            </select>
          </div>
        </div>
      </div>
      
      <div id="fichaTecnicaContent" class="hidden">
        <div class="row">
          <!-- Informaci√≥n b√°sica del veh√≠culo -->
          <div class="card">
            <h3>üöó Informaci√≥n del Veh√≠culo</h3>
            <div id="fichaInfoBasica"></div>
          </div>
          
          <!-- Estad√≠sticas de rendimiento -->
          <div class="card">
            <h3>üìä Estad√≠sticas de Rendimiento</h3>
            <div id="fichaEstadisticas"></div>
          </div>
        </div>
        
        <div class="row">
          <!-- Costos y mantenimiento -->
          <div class="card">
            <h3>üí∞ An√°lisis de Costos</h3>
            <div id="fichaCostos"></div>
          </div>
          
          <!-- Sistema Completo de Alertas -->
          <div class="card">
            <h3>üö® Sistema Completo de Alertas</h3>
            <div style="margin-bottom: 16px;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <div style="background: #fff3cd; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">üîß Mantenimientos</div>
                  <div id="alertasMantenimiento">0</div>
                </div>
                <div style="background: #d1ecf1; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">üõ°Ô∏è P√≥lizas</div>
                  <div id="alertasPolizas">0</div>
                </div>
                <div style="background: #d4edda; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">üîç RTV</div>
                  <div id="alertasRTV">0</div>
                </div>
                <div style="background: #f8d7da; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">‚ö†Ô∏è Revisiones</div>
                  <div id="alertasRevisiones">0</div>
                </div>
                <div style="background: #fce4ec; padding: 8px; border-radius: 6px; text-align: center;">
                  <div style="font-weight: bold;">‚õΩ Combustible</div>
                  <div id="alertasCombustible">0</div>
                </div>
              </div>
            </div>
            <div id="fichaAlertas" style="max-height: 300px; overflow-y: auto;"></div>
          </div>
          
          <!-- Configuraci√≥n de Email (Solo Administradores) -->
          <div class="card" data-roles="admin">
            <h3>üìß Configuraci√≥n de Alertas por Email</h3>
            
            <!-- Estado actual -->
            <div id="emailStatus" style="margin-bottom: 16px; padding: 12px; border-radius: 8px;">
              <p style="margin: 0; font-weight: bold;">Estado: <span id="emailStatusText">Verificando...</span></p>
              <p style="margin: 4px 0 0 0; font-size: 0.9em; color: var(--muted);" id="emailStatusDetail">
                Cargando configuraci√≥n...
              </p>
            </div>
            
            <!-- Configuraci√≥n r√°pida -->
            <div style="margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px 0;">‚ö° Configuraci√≥n R√°pida</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div>
                  <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Email del sistema:</label>
                  <input id="configSenderEmail" type="email" placeholder="sistema@arenalmanoa.com" style="font-size: 0.9em;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Contrase√±a del email:</label>
                  <input id="configSenderPassword" type="password" placeholder="Contrase√±a o token de aplicaci√≥n" style="font-size: 0.9em;">
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 12px;">
                <div>
                  <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Proveedor de email:</label>
                  <select id="configProvider" style="font-size: 0.9em;">
                    <option value="gmail">Gmail / Google Workspace</option>
                    <option value="outlook">Outlook / Microsoft 365</option>
                    <option value="yahoo">Yahoo Mail</option>
                    <option value="custom">Servidor personalizado</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Puerto SMTP:</label>
                  <input id="configSmtpPort" type="number" value="587" style="width: 80px; font-size: 0.9em;">
                </div>
              </div>
              <div style="margin-bottom: 12px;" id="customServerFields" class="hidden">
                <label style="display: block; margin-bottom: 4px; font-size: 0.9em;">Servidor SMTP personalizado:</label>
                <input id="configSmtpServer" type="text" placeholder="mail.arenalmanoa.com" style="font-size: 0.9em;">
              </div>
            </div>
            
            <!-- Acciones -->
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <button class="success" onclick="guardarConfigEmail()" title="Guardar configuraci√≥n de email">
                üíæ Guardar Configuraci√≥n
              </button>
              <button class="secondary" onclick="probarEmail()" title="Enviar email de prueba">
                üìß Probar Email
              </button>
              <button class="secondary" onclick="verificarAlertas()" title="Verificar alertas manualmente">
                üîç Verificar Alertas
              </button>
              <span id="alertaStatus" style="color: var(--muted); font-size: 0.9em;"></span>
            </div>
            
            <!-- Ayuda -->
            <div style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
              <strong>üí° Ayuda de configuraci√≥n:</strong>
              <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                <li><strong>Gmail:</strong> Necesita activar autenticaci√≥n de 2 factores y crear una "contrase√±a de aplicaci√≥n"</li>
                <li><strong>Outlook:</strong> Use su email y contrase√±a normal de Microsoft 365</li>
                <li><strong>Servidor personalizado:</strong> Contacte a su administrador de IT para obtener configuraci√≥n SMTP</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">üìà Historial Detallado</h3>
            <div>
              <button class="export-btn" onclick="exportarFichaTecnicaCompleta()">üìä Exportar Ficha Completa</button>
              <button class="secondary" onclick="previsualizarFicha()">üëÅÔ∏è Vista Previa</button>
            </div>
          </div>
          <div id="fichaHistorial"></div>
        </div>
      </div>
    </section>

    <section id="tab-polizas" class="tabpanel hidden">
      <div class="card" style="margin-bottom:12px">
        <h3 style="margin:0 0 8px 0;color:var(--ink)">+ P√≥liza / + RTV</h3>
        <div class="row">
          <div>
            <div class="row"><div><label>Veh√≠culo</label><select id="pVeh"></select></div><div><label>Aseguradora</label><input id="pAseg" type="text" placeholder="INS"/></div></div>
            <div class="row"><div><label>N¬∞ P√≥liza</label><input id="pNum" type="text"/></div><div><label>Vence (p√≥liza)</label><input id="pVence" type="date"/></div></div>
            <div><button class="secondary" onclick="guardarPoliza(event)">Guardar p√≥liza</button></div>
          </div>
          <div>
            <div class="row"><div><label>Veh√≠culo</label><select id="rtvVeh"></select></div><div><label>N¬∞ Cita</label><input id="rCita" type="text"/></div></div>
            <div class="row"><div><label>Vence (RTV)</label><input id="rVence" type="date"/></div><div></div></div>
            <div><button class="secondary" onclick="guardarRTV(event)">Guardar RTV</button></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>P√≥lizas</strong><select id="fltPolVencer" onchange="renderPolizas()"><option value="">Todas</option><option value="30">Solo ‚â§30 d√≠as</option><option value="7">Solo ‚â§7 d√≠as</option></select></div>
          <table><thead><tr><th>Placa</th><th>Aseguradora</th><th>N¬∞ P√≥liza</th><th>Vence</th><th>Sem√°foro</th><th>Acciones</th></tr></thead><tbody id="tblPol"></tbody></table>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center"><strong>RTV</strong><select id="fltRtvVencer" onchange="renderRtv()"><option value="">Todas</option><option value="30">Solo ‚â§30 d√≠as</option><option value="7">Solo ‚â§7 d√≠as</option></select></div>
          <table><thead><tr><th>Placa</th><th>N¬∞ Cita</th><th>Vence</th><th>Sem√°foro</th><th>Acciones</th></tr></thead><tbody id="tblRtv"></tbody></table>
        </div>
      </div>
    </section>

    <section id="tab-mantenimientos" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarMantenimiento(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">+ Mantenimiento</h3>
          <div class="row"><div><label>Veh√≠culo</label><select id="mVeh"></select></div><div><label>Tipo</label><select id="mTipo" onchange="toggleMaintenanceFields()"><option value="cambio_aceite">üõ´ Cambio de aceite</option><option value="mantenimiento_preventivo">üîß Mantenimiento Preventivo</option><option value="llantas">üòû Llantas</option><option value="frenos">üõë Frenos</option><option value="bateria">üîã Bater√≠a</option><option value="alineacion">‚öñÔ∏è Alineaci√≥n</option><option value="otro">üìù Otro</option></select></div></div>
          <div class="row"><div><label>Fecha</label><input id="mFecha" type="date" required/></div><div><label>Costo</label><input id="mCosto" type="number" min="0" step="0.01" required/></div></div>
          
          <!-- Campos de alertas duales -->
          <div class="row" id="maintenanceKmFields"><div><label>Km actual</label><input id="mKm" type="number" min="0"/></div><div><label>Pr√≥ximo km</label><input id="mProx" type="number" min="0" placeholder="Kilometraje del pr√≥ximo servicio"/></div></div>
          <div class="row" id="maintenanceDateFields"><div><label>Pr√≥xima fecha</label><input id="mProxFecha" type="date" placeholder="Fecha del pr√≥ximo servicio"/></div><div><label>√öltimo cambio aceite (km)</label><input id="mKmPrevAceite" type="number" readonly/></div></div>
          <div><label>Observaciones</label><input id="mObs" type="text" placeholder="Detalles"/></div>
          <div style="margin-top:12px;display:flex;gap:8px"><button>Guardar</button><button type="button" class="secondary" onclick="autoProximoKm()">Sugerir pr√≥ximo (+5,000)</button></div>
        </form>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>üîß Hist√≥rico de Mantenimientos</strong>
            <div style="display:flex;gap:8px">
              <select id="fltMantPlaca" onchange="renderMant()">
                <option value="">üìã Todas las placas</option>
              </select>
              <select id="fltMantTipo" onchange="renderMant()">
                <option value="">üîß Todos los tipos</option>
                <option value="cambio_aceite">üõ¢Ô∏è Cambio de aceite</option>
                <option value="llantas">üõû Llantas</option>
                <option value="frenos">üõë Frenos</option>
                <option value="bateria">üîã Bater√≠a</option>
                <option value="alineacion">‚öñÔ∏è Alineaci√≥n</option>
                <option value="transmision">‚öôÔ∏è Transmisi√≥n</option>
                <option value="motor">üèéÔ∏è Motor</option>
                <option value="suspension">üî© Suspensi√≥n</option>
                <option value="aire_acondicionado">‚ùÑÔ∏è Aire Acondicionado</option>
                <option value="otro">üìù Otro</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Costo</th>
                <th>Km</th>
                <th>Pr√≥x.</th>
                <th>Obs</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblMant"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <span class="tag" id="sumMant"></span>
            <button class="export-btn" onclick="exportarMantenimientos()">üìä Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-combustible" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarCombustible(event)">
          <h3 style="margin-bottom:8px;color:var(--ink)">+ Carga de combustible</h3>
          <div class="row"><div><label>Veh√≠culo</label><select id="cVeh" onchange="updatePreviousOdometer()"></select></div><div><label>Fecha</label><input id="cFecha" type="date" required/></div></div>
          <div class="row"><div><label>Litros</label><input id="cLitros" type="number" step="0.01" min="0.01" required oninput="calcCosto();calcKmLEstimado()"/></div><div><label>‚Ç°/Litro</label><input id="cPPL" type="number" step="0.01" min="0" required oninput="calcCosto();calcKmLEstimado()"/></div></div>
          <div class="row"><div><label>Od√≥metro km</label><input id="cOdo" type="number" min="0" required oninput="calcCosto();calcKmLEstimado()"/></div><div><label>Proveedor</label><input id="cProv" type="text"/></div></div>
          <div class="row"><div><label>Od√≥metro anterior</label><input id="cOdoPrev" type="number" readonly/></div><div><label>Km/L estimado</label><input id="cKmLEst" type="number" step="0.01" readonly/></div></div>
          <div class="row"><div><label>Costo total</label><input id="cCosto" type="number" readonly/></div><div></div></div>
          <div style="margin-top:12px"><button>Guardar</button></div>
        </form>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>‚õΩ Registros de Combustible</strong>
            <div style="display:flex;gap:8px">
              <select id="fltFuelPlaca" onchange="renderFuel()">
                <option value="">üìã Todas las placas</option>
              </select>
              <select id="fltFuelMes" onchange="renderFuel()">
                <option value="">üìÖ Todos los meses</option>
                <option value="1">Este mes</option>
                <option value="3">√öltimos 3 meses</option>
                <option value="6">√öltimos 6 meses</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Fecha</th>
                <th>Litros</th>
                <th>‚Ç°/L</th>
                <th>Costo</th>
                <th>Od√≥metro</th>
                <th>Km/L</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblFuel"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <span class="tag" id="sumFuel"></span>
              <span class="tag" id="avgKmL"></span>
            </div>
            <button class="export-btn" onclick="exportarCombustible()">üìä Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-revision" class="tabpanel hidden">
      <div class="row">
        <form class="card" onsubmit="guardarRevision(event)">
          <h3 style="margin:0 0 16px 0;color:var(--ink)">üîç Nueva Revisi√≥n Detallada</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="rVeh" required></select>
            </div>
            <div class="form-group">
              <label>Tipo de Revisi√≥n</label>
              <select id="rTipo">
                <option value="rutinaria">Rutinaria</option>
                <option value="preventiva">Preventiva</option>
                <option value="post_mantenimiento">Post-Mantenimiento</option>
                <option value="pre_viaje">Pre-Viaje</option>
                <option value="incidente">Por Incidente</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Fecha y Hora</label>
              <input id="rFecha" type="datetime-local" required/>
            </div>
            <div class="form-group">
              <label>Inspector</label>
              <input id="rInspector" type="text" placeholder="Nombre del inspector" required/>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Kilometraje Actual</label>
              <input id="rKm" type="number" min="0" required/>
            </div>
            <div class="form-group">
              <label>Nivel de Combustible</label>
              <select id="rNivelComb">
                <option value="vacio">Vac√≠o (E)</option>
                <option value="1/4">1/4</option>
                <option value="1/2">1/2</option>
                <option value="3/4">3/4</option>
                <option value="lleno">Lleno (F)</option>
              </select>
            </div>
          </div>
          
          <!-- Revisiones de l√≠quidos -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">üõ¢Ô∏è Revisi√≥n de L√≠quidos</h4>
            <div class="form-row-3">
              <div class="form-group">
                <label>Aceite de Motor</label>
                <select id="rAceiteMotor">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>L√≠quido de Frenos</label>
                <select id="rLiquidoFrenos">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Coolant/Refrigerante</label>
                <select id="rCoolant">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
            <div class="form-row-3">
              <div class="form-group">
                <label>L√≠quido Limpiaparabrisas</label>
                <select id="rLimpiaparabrisas">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="vacio">Vac√≠o</option>
                </select>
              </div>
              <div class="form-group">
                <label>Aceite de Transmisi√≥n</label>
                <select id="rAceiteTransmision">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="verificar">Verificar</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>L√≠quido Direcci√≥n</label>
                <select id="rLiquidoDireccion">
                  <option value="optimo">√ìptimo</option>
                  <option value="bueno">Bueno</option>
                  <option value="bajo">Bajo</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Revisiones mec√°nicas -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">üîß Revisi√≥n Mec√°nica</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Estado de Llantas</label>
                <select id="rEstadoLlantas">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="desgastadas">Desgastadas</option>
                  <option value="cambiar">Necesitan Cambio</option>
                </select>
              </div>
              <div class="form-group">
                <label>Presi√≥n de Llantas</label>
                <select id="rPresionLlantas">
                  <option value="correcta">Correcta</option>
                  <option value="baja">Baja</option>
                  <option value="alta">Alta</option>
                  <option value="revisar">Revisar</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Sistema de Frenos</label>
                <select id="rSistemaFrenos">
                  <option value="excelente">Excelente</option>
                  <option value="bueno">Bueno</option>
                  <option value="regular">Regular</option>
                  <option value="revisar">Revisar</option>
                  <option value="urgente">Atenci√≥n Urgente</option>
                </select>
              </div>
              <div class="form-group">
                <label>Bater√≠a</label>
                <select id="rBateria">
                  <option value="excelente">Excelente</option>
                  <option value="buena">Buena</option>
                  <option value="regular">Regular</option>
                  <option value="debil">D√©bil</option>
                  <option value="cambiar">Necesita Cambio</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Revisiones el√©ctricas y exteriores -->
          <div class="card" style="margin:20px 0;background:#f8fafc">
            <h4 style="margin:0 0 12px 0">üí° Sistema El√©ctrico y Exterior</h4>
            <div class="form-row">
              <div style="display:flex;gap:20px;flex-wrap:wrap">
                <label><input type="checkbox" id="rLucesDelanteras"/> Luces Delanteras</label>
                <label><input type="checkbox" id="rLucesTraseras"/> Luces Traseras</label>
                <label><input type="checkbox" id="rLucesDireccionales"/> Direccionales</label>
                <label><input type="checkbox" id="rLucesFreno"/> Luces de Freno</label>
                <label><input type="checkbox" id="rLucesReversa"/> Luces de Reversa</label>
              </div>
            </div>
            <div class="form-row">
              <div style="display:flex;gap:20px;flex-wrap:wrap">
                <label><input type="checkbox" id="rEspejosLaterales"/> Espejos Laterales</label>
                <label><input type="checkbox" id="rEspejoRetrovisor"/> Espejo Retrovisor</label>
                <label><input type="checkbox" id="rLimpiaparabrisas"/> Limpiaparabrisas</label>
                <label><input type="checkbox" id="rCinturones"/> Cinturones de Seguridad</label>
                <label><input type="checkbox" id="rBocina"/> Bocina</label>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Estado General de Carrocer√≠a</label>
              <select id="rEstadoCarroceria">
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="rayones_menores">Rayones Menores</option>
                <option value="golpes_menores">Golpes Menores</option>
                <option value="da√±os_mayores">Da√±os Mayores</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado del Interior</label>
              <select id="rEstadoInterior">
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="desgastado">Desgastado</option>
                <option value="necesita_limpieza">Necesita Limpieza</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Observaciones Generales</label>
            <textarea id="rObservaciones" rows="3" placeholder="Describa cualquier anomal√≠a, recomendaci√≥n o comentario adicional..."></textarea>
          </div>
          
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Guardar Revisi√≥n</button>
            <button type="button" class="secondary" onclick="limpiarFormRevision()">üóëÔ∏è Limpiar</button>
          </div>
        </form>
        
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong>üîç Hist√≥rico de Revisiones</strong>
            <div style="display:flex;gap:8px">
              <select id="fltRevPlaca" onchange="renderRevisiones()">
                <option value="">üìã Todas las placas</option>
              </select>
              <select id="fltRevTipo" onchange="renderRevisiones()">
                <option value="">üîç Todos los tipos</option>
                <option value="rutinaria">Rutinaria</option>
                <option value="preventiva">Preventiva</option>
                <option value="post_mantenimiento">Post-Mantenimiento</option>
                <option value="pre_viaje">Pre-Viaje</option>
                <option value="incidente">Por Incidente</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Placa</th>
                <th>Tipo</th>
                <th>Inspector</th>
                <th>Fecha</th>
                <th>Km</th>
                <th>Estado General</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tblRevisiones"></tbody>
          </table>
          <div style="margin-top:16px;display:flex;justify-content:end">
            <button class="export-btn" onclick="exportarRevisiones()">üìä Exportar Excel</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-reportes" class="tabpanel hidden">
      <div class="card">
        <h3 style="margin:0 0 20px 0">üìä Generador de Reportes</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Reporte</label>
            <select id="repTipo" onchange="actualizarConfigReporte()">
              <option value="mantenimientos">üîß Mantenimientos</option>
              <option value="combustible">‚õΩ Combustible</option>
              <option value="revisiones">üîç Revisiones</option>
              <option value="polizas_rtv">üõ°Ô∏è P√≥lizas & RTV</option>
              <option value="ficha_vehiculo">üìã Ficha T√©cnica por Veh√≠culo</option>
              <option value="resumen_costos">üí∞ Resumen de Costos</option>
              <option value="alertas">‚ö†Ô∏è Alertas y Vencimientos</option>
              <option value="resumen_general">üìä Resumen General de Flota</option>
            </select>
          </div>
          <div class="form-group">
            <label>Veh√≠culo (opcional)</label>
            <select id="repPlaca">
              <option value="">üìã Todos los veh√≠culos</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Inicio</label>
            <input id="repA" type="date"/>
          </div>
          <div class="form-group">
            <label>Fecha de Fin</label>
            <input id="repB" type="date"/>
          </div>
        </div>
        
        <div class="form-row" id="repConfigAdicional">
          <!-- Se llenar√° din√°micamente seg√∫n el tipo de reporte -->
        </div>
        
        <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
          <button class="success" onclick="previsualizarReporte()">üëÅÔ∏è Vista Previa</button>
          <button class="export-btn" onclick="exportReportXLSX()">üìä Exportar Excel</button>
          <button class="secondary" onclick="enviarReporteEmail()">üìß Enviar por Email</button>
        </div>
      </div>
      
      <!-- √Årea de vista previa -->
      <div id="reportePreview" class="hidden">
        <div class="card">
          <div class="modal-header">
            <h3 class="modal-title">üëÅÔ∏è Vista Previa del Reporte</h3>
            <button class="close-btn" onclick="cerrarPreviewReporte()">√ó</button>
          </div>
          
          <div class="report-preview" id="reporteContent">
            <!-- El contenido del reporte se generar√° aqu√≠ -->
          </div>
          
          <div style="margin-top:20px;text-align:center">
            <button class="export-btn" onclick="exportReportXLSX()">üìä Exportar a Excel</button>
            <button class="secondary" onclick="imprimirReporte()">üñ®Ô∏è Imprimir</button>
            <button class="secondary" onclick="cerrarPreviewReporte()">‚úñÔ∏è Cerrar</button>
          </div>
        </div>
      </div>
    </section>

    <div class="sticky-actions" id="stickyActions">
      <button onclick="setTab('mantenimientos')" data-roles="admin,operador">üîß + Mantenimiento</button>
      <button onclick="setTab('combustible')" class="secondary" data-roles="admin,operador">‚õΩ + Combustible</button>
      <button onclick="setTab('revision')" class="secondary" data-roles="admin,supervisor">üîç + Revisi√≥n</button>
    </div>
    
    <!-- Modales de Edici√≥n -->
    
    <!-- Modal Editar Veh√≠culo -->
    <div id="modalEditVehiculo" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Veh√≠culo</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditVehiculo')">√ó</button>
        </div>
        <form onsubmit="actualizarVehiculo(event)">
          <input type="hidden" id="editVehId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Placa</label>
              <input id="editVPlaca" type="text" required/>
            </div>
            <div class="form-group">
              <label>Marca</label>
              <input id="editVMarca" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Modelo</label>
              <input id="editVModelo" type="text" required/>
            </div>
            <div class="form-group">
              <label>A√±o</label>
              <input id="editVAnio" type="number" min="1990" max="2100" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tipo</label>
              <select id="editVTipo">
                <option value="sed√°n">Sed√°n</option>
                <option value="pickup">Pickup</option>
                <option value="SUV">SUV</option>
                <option value="buseta">Buseta</option>
                <option value="hatchback">Hatchback</option>
                <option value="minivan">Minivan</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editVEstado">
                <option value="activo">Activo</option>
                <option value="inactivo">Inactivo</option>
                <option value="mantenimiento">En Mantenimiento</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Due√±o</label>
              <input id="editVDueno" type="text" placeholder="Ej: Hotel, Juan P√©rez, Empresa XYZ"/>
            </div>
            <div class="form-group">
              <label>N√∫mero de P√≥liza</label>
              <input id="editVPoliza" type="text"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Aseguradora</label>
              <input id="editVAseguradora" type="text"/>
            </div>
            <div class="form-group">
              <label>Color</label>
              <input id="editVColor" type="text"/>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditVehiculo'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Mantenimiento -->
    <div id="modalEditMantenimiento" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Mantenimiento</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditMantenimiento')">√ó</button>
        </div>
        <form onsubmit="actualizarMantenimiento(event)">
          <input type="hidden" id="editMantId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editMVeh" required></select>
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <select id="editMTipo">
                <option value="cambio_aceite">üõ¢Ô∏è Cambio de aceite</option>
                <option value="mantenimiento_preventivo">üîß Mantenimiento Preventivo</option>
                <option value="llantas">üõû Llantas</option>
                <option value="frenos">üõë Frenos</option>
                <option value="bateria">üîã Bater√≠a</option>
                <option value="alineacion">‚öñÔ∏è Alineaci√≥n</option>
                <option value="transmision">‚öôÔ∏è Transmisi√≥n</option>
                <option value="motor">üèéÔ∏è Motor</option>
                <option value="suspension">üî© Suspensi√≥n</option>
                <option value="aire_acondicionado">‚ùÑÔ∏è Aire Acondicionado</option>
                <option value="otro">üìù Otro</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input id="editMFecha" type="date" required/>
            </div>
            <div class="form-group">
              <label>Costo</label>
              <input id="editMCosto" type="number" min="0" step="0.01" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Km actual</label>
              <input id="editMKm" type="number" min="0"/>
            </div>
            <div class="form-group">
              <label>Pr√≥ximo km</label>
              <input id="editMProx" type="number" min="0"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Pr√≥xima fecha</label>
              <input id="editMProxFecha" type="date"/>
            </div>
            <div class="form-group">
              <label></label>
              <div style="color: var(--muted); font-size: 0.8em; padding-top: 8px;">Solo para Cambio de Aceite y Mantenimiento Preventivo</div>
            </div>
          </div>
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editMObs" rows="3"></textarea>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditMantenimiento'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Combustible -->
    <div id="modalEditCombustible" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Registro de Combustible</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditCombustible')">√ó</button>
        </div>
        <form onsubmit="actualizarCombustible(event)">
          <input type="hidden" id="editFuelId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editCVeh" required></select>
            </div>
            <div class="form-group">
              <label>Fecha</label>
              <input id="editCFecha" type="date" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Litros</label>
              <input id="editCLitros" type="number" step="0.01" min="0.01" required/>
            </div>
            <div class="form-group">
              <label>‚Ç°/Litro</label>
              <input id="editCPPL" type="number" step="0.01" min="0" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Od√≥metro km</label>
              <input id="editCOdo" type="number" min="0" required/>
            </div>
            <div class="form-group">
              <label>Proveedor</label>
              <input id="editCProv" type="text"/>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditCombustible'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar P√≥liza -->
    <div id="modalEditPoliza" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar P√≥liza</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditPoliza')">√ó</button>
        </div>
        <form onsubmit="actualizarPoliza(event)">
          <input type="hidden" id="editPolizaId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editPVeh" required></select>
            </div>
            <div class="form-group">
              <label>Aseguradora</label>
              <input id="editPAseg" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>N¬∞ P√≥liza</label>
              <input id="editPNum" type="text" required/>
            </div>
            <div class="form-group">
              <label>Fecha Vencimiento</label>
              <input id="editPVence" type="date" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tipo Cobertura</label>
              <select id="editPTipo">
                <option value="B√°sica">B√°sica</option>
                <option value="Completa">Completa</option>
                <option value="Terceros">Terceros</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editPEstado">
                <option value="Activa">Activa</option>
                <option value="Vencida">Vencida</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </div>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditPoliza'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar RTV -->
    <div id="modalEditRTV" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar RTV</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditRTV')">√ó</button>
        </div>
        <form onsubmit="actualizarRTV(event)">
          <input type="hidden" id="editRTVId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editRVeh" required></select>
            </div>
            <div class="form-group">
              <label>N¬∞ Cita</label>
              <input id="editRCita" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha Vencimiento</label>
              <input id="editRVence" type="date" required/>
            </div>
            <div class="form-group">
              <label>Estado</label>
              <select id="editREstado">
                <option value="Vigente">Vigente</option>
                <option value="Vencido">Vencido</option>
                <option value="Pendiente">Pendiente</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editRObs" rows="3"></textarea>
          </div>
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditRTV'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Editar Revisi√≥n -->
    <div id="modalEditRevision" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‚úèÔ∏è Editar Revisi√≥n</h3>
          <button class="close-btn" onclick="cerrarModal('modalEditRevision')">√ó</button>
        </div>
        <form onsubmit="actualizarRevision(event)">
          <input type="hidden" id="editRevisionId"/>
          <div class="form-row">
            <div class="form-group">
              <label>Veh√≠culo</label>
              <select id="editRVeh" required></select>
            </div>
            <div class="form-group">
              <label>Inspector</label>
              <input id="editRInspector" type="text" required/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input id="editRFecha" type="date" required/>
            </div>
            <div class="form-group">
              <label>Aprobado</label>
              <label class="checkbox-container">
                <input id="editRAprobado" type="checkbox"/>
                <span class="checkmark"></span>
                Revisi√≥n aprobada
              </label>
            </div>
          </div>
          
          <h4 style="color: var(--primary); margin: 20px 0 10px 0;">üîç Estados de Componentes</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Estado Motor</label>
              <select id="editRMotor">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado Frenos</label>
              <select id="editRFrenos">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Estado Luces</label>
              <select id="editRLuces">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
            <div class="form-group">
              <label>Estado Llantas</label>
              <select id="editRLlantas">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="cambiar">Cambiar</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Estado Carrocer√≠a</label>
              <select id="editRCarroceria">
                <option value="">Sin revisar</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="da√±os_menores">Da√±os menores</option>
                <option value="da√±os_mayores">Da√±os mayores</option>
              </select>
            </div>
            <div></div>
          </div>
          
          <div class="form-group">
            <label>Observaciones</label>
            <textarea id="editRObs" rows="3" placeholder="Observaciones generales de la revisi√≥n..."></textarea>
          </div>
          
          <div style="margin-top:20px">
            <button type="submit" class="success">üíæ Actualizar</button>
            <button type="button" class="secondary" onclick="cerrarModal('modalEditRevision'); return false;">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Navegaci√≥n m√≥vil compacta -->
  <div class="mobile-nav" id="mobileNav">
    <div class="mobile-nav-grid" id="mobileNavGrid">
      <!-- Se llenar√° din√°micamente con JavaScript -->
    </div>
  </div>

  <div class="footer">
    Sistema de Gesti√≥n Vehicular - Hotel ¬© 2024 | Conectado a Google Sheets v√≠a Apps Script
  </div>
  </div> <!-- Cierre mainApp -->

  <script>
  // ====== API: Backend Python FastAPI ======
  const API = "https://8000-i2csqmmo4txbkyhmexll8-6532622b.e2b.dev";
  const API_KEY = ""; // si activas API key, col√≥cala aqu√≠

  // ====== ESTADO ======
  let Vehiculos=[], Polizas=[], RTV=[], Mantenimientos=[], Combustible=[], Bitacora=[], Alertas=[], Revisiones=[];
  let currentUser = null;
  
  // ====== SISTEMA DE ROLES Y LOGIN ======
  const ROLES = {
    admin: {
      name: 'Administrador',
      password: 'Admin',
      permissions: ['dashboard', 'vehiculos', 'ficha-tecnica', 'polizas', 'mantenimientos', 'combustible', 'revision', 'reportes']
    },
    operador: {
      name: 'Operador',
      password: 'operador123', 
      permissions: ['mantenimientos', 'combustible']
    },
    supervisor: {
      name: 'Supervisor',
      password: 'supervisor123',
      permissions: ['revision']
    }
  };
  
  let selectedRole = null;
  
  function selectRole(role) {
    selectedRole = role;
    document.querySelectorAll('.role-card').forEach(card => {
      card.classList.remove('selected');
    });
    document.querySelector(`[data-role="${role}"]`).classList.add('selected');
    
    // Enfocar campo de contrase√±a con delay para m√≥vil
    setTimeout(() => {
      const passwordField = document.getElementById('loginPassword');
      if (passwordField) {
        passwordField.focus();
        
        // En m√≥vil, scroll al campo de contrase√±a
        if (window.innerWidth <= 768) {
          passwordField.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
        }
      }
    }, 100);
    
    document.querySelector('.login-btn').disabled = false;
  }
  
  function attemptLogin() {
    const password = document.getElementById('loginPassword').value;
    
    if (!selectedRole || !password) {
      alert('Por favor seleccione un rol e ingrese la contrase√±a');
      return;
    }
    
    if (ROLES[selectedRole] && ROLES[selectedRole].password === password) {
      currentUser = {
        role: selectedRole,
        name: ROLES[selectedRole].name,
        permissions: ROLES[selectedRole].permissions
      };
      
      // Cerrar todos los modales antes de mostrar la app
      cerrarTodosLosModales();
      
      // Ocultar login y mostrar app
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').classList.add('logged-in');
      
      // Ir a la primera pesta√±a disponible seg√∫n el rol
      const firstAvailableTab = currentUser.permissions[0] || 'dashboard';
      setTab(firstAvailableTab);
      
      // Actualizar UI seg√∫n rol
      updateUIForRole();
      
      // Cargar datos
      loadAll();
      
      alert(`¬°Bienvenido, ${currentUser.name}!`);
    } else {
      alert('Contrase√±a incorrecta. Intente nuevamente.');
      document.getElementById('loginPassword').value = '';
    }
  }
  
  function logout() {
    if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
      currentUser = null;
      selectedRole = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('logged-in');
      document.getElementById('loginPassword').value = '';
      document.querySelectorAll('.role-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector('.login-btn').disabled = true;
    }
  }
  
  function updateUIForRole() {
    if (!currentUser) return;
    
    // Actualizar nombre de usuario en header
    document.getElementById('currentUserRole').textContent = currentUser.name;
    
    // Mostrar/ocultar tabs seg√∫n permisos
    document.querySelectorAll('.tab[data-roles]').forEach(tab => {
      const roles = tab.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        tab.style.display = 'flex';
      } else {
        tab.style.display = 'none';
      }
    });
    
    // Mostrar/ocultar botones flotantes seg√∫n permisos
    document.querySelectorAll('#stickyActions button[data-roles]').forEach(btn => {
      const roles = btn.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        btn.style.display = 'flex';
      } else {
        btn.style.display = 'none';
      }
    });
    
    // Mostrar/ocultar contenido (cards, divs) seg√∫n permisos
    document.querySelectorAll('[data-roles]:not(.tab):not(button)').forEach(element => {
      const roles = element.dataset.roles.split(',');
      if (roles.includes(currentUser.role)) {
        element.style.display = 'block';
      } else {
        element.style.display = 'none';
      }
    });
    
    // Redirigir a dashboard si la tab actual no est√° permitida
    const currentTab = document.querySelector('.tab.active');
    if (currentTab && currentTab.dataset.roles && !currentTab.dataset.roles.split(',').includes(currentUser.role)) {
      setTab('dashboard');
    }
    
    // Actualizar navegaci√≥n m√≥vil si est√° activa
    if (mobileCompactMode) {
      setupMobileNavigation();
    }
  }
  
  function hasPermission(permission) {
    return currentUser && currentUser.permissions.includes(permission);
  }

  // ====== HELPERS ======
  const byId = id=> document.getElementById(id);
  const fmt = n=> new Intl.NumberFormat('es-CR',{style:'currency',currency:'CRC',maximumFractionDigits:0}).format(Number(n)||0);
  const vehById = id=> Vehiculos.find(v=> Number(v.id)===Number(id));
  const today = ()=> new Date().toISOString().slice(0,10);
  const diasRestantes = (iso)=> Math.ceil((new Date(iso) - new Date())/86400000);
  const semaforo = (d)=> d<=7? '<span class="pill dangerP">‚â§7d</span>' : (d<=30? '<span class="pill warnP">‚â§30d</span>' : '<span class="pill ok">OK</span>');

  function setTab(name){
    // Verificar permisos
    if (!hasPermission(name)) {
      alert('No tiene permisos para acceder a esta secci√≥n');
      return;
    }
    
    try{ localStorage.setItem('tab', name); }catch{}
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    const btn = document.querySelector(`.tab[data-tab="${name}"]`);
    if(btn) {
      btn.classList.add('active');
      
      // Scroll autom√°tico a la pesta√±a activa en m√≥vil
      if (window.innerWidth <= 768) {
        const tabsContainer = document.querySelector('.tabs');
        if (tabsContainer) {
          const tabRect = btn.getBoundingClientRect();
          const containerRect = tabsContainer.getBoundingClientRect();
          
          if (tabRect.left < containerRect.left || tabRect.right > containerRect.right) {
            btn.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'nearest', 
              inline: 'center' 
            });
          }
        }
      }
    }
    
    document.querySelectorAll('.tabpanel').forEach(s=>s.classList.add('hidden'));
    const sec = byId('tab-'+name);
    if(sec) {
      sec.classList.remove('hidden');
      
      // Scroll suave al inicio de la secci√≥n en m√≥vil
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
      }
    }
    render();
  }

  // ====== API CLIENT PARA FASTAPI ======
  async function apiGet(table){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}`;
    console.log('API GET:', url); // Debug log
    
    try {
      const r = await fetch(url, { 
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json' },
        mode: 'cors'
      });
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      const j = await r.json();
      console.log('API Response:', j); // Debug log
      
      if(!j.success) throw new Error(j.error||'GET error');
      return j.data;
    } catch (error) {
      console.error('API GET Error:', error);
      throw error;
    }
  }
  
  async function apiPost(table, data, action=null){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}`;
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      cache: 'no-store'
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'POST error');
    return j;
  }
  
  async function apiPut(table, id, data){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}/${id}`;
    const r = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      cache: 'no-store'
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'PUT error');
    return j;
  }
  
  async function apiDelete(table, id){
    const endpoint = table.toLowerCase();
    const url = `${API}/${endpoint}/${id}`;
    const r = await fetch(url, {
      method: 'DELETE',
      cache: 'no-store'
    });
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'DELETE error');
    return j;
  }

  // ====== CARGA INICIAL ======
  async function loadAll(){
    try{
      // Cargar datos del nuevo backend
      Vehiculos = await apiGet('vehiculos');
      Mantenimientos = await apiGet('mantenimientos');
      Combustible = await apiGet('combustible');
      Revisiones = await apiGet('revisiones');
      Polizas = await apiGet('polizas');
      RTV = await apiGet('rtv');
      
      // Inicializar arrays vac√≠os para compatibilidad con el frontend
      Bitacora = [];
      Alertas = [];
      
      fillVehSelects();
      fillPlacaFilters();
      render();
      
      // Cargar configuraci√≥n de email si es administrador
      if (currentUser && currentUser.role === 'admin') {
        setTimeout(() => {
          if (typeof cargarConfigEmail === 'function') {
            cargarConfigEmail();
          }
        }, 1000);
      }
    }catch(e){
      alert('Error cargando datos: '+e.message);
      console.error(e);
    }
  }

  // ====== RENDER ======
  function render(){ 
    renderKpis(); 
    renderAlertas(); 
    renderVehiculos(); 
    renderPolizas(); 
    renderRtv(); 
    renderMant(); 
    renderFuel(); 
    renderRevisiones(); 
    refreshHints(); 
  }

  function renderKpis(){
    // === 1. CANTIDAD DE VEH√çCULOS ACTIVOS ===
    if(byId('kpiVeh')) byId('kpiVeh').textContent = Vehiculos.length;
    
    // === 2. P√ìLIZAS POR VENCER (30 D√çAS) CON PRIMERAS 3 PLACAS ===
    const polizasPorVencer = Polizas
      .filter(p=> p.fecha_vencimiento && diasRestantes(p.fecha_vencimiento) <= 30 && diasRestantes(p.fecha_vencimiento) >= 0)
      .sort((a, b) => diasRestantes(a.fecha_vencimiento) - diasRestantes(b.fecha_vencimiento));
    
    if(byId('kpiPol30')) {
      byId('kpiPol30').textContent = polizasPorVencer.length;
    }
    
    // Mostrar las primeras 3 p√≥lizas por vencer
    if(byId('proxPolizas')) {
      const top3Polizas = polizasPorVencer.slice(0, 3);
      byId('proxPolizas').innerHTML = top3Polizas.length > 0 ? 
        top3Polizas.map(p => {
          const dias = diasRestantes(p.fecha_vencimiento);
          const colorClass = dias <= 7 ? 'dangerP' : 'warnP';
          return `<div class="pill ${colorClass}" style="margin: 2px; font-size: 0.8em;">${p.placa}: ${dias}d</div>`;
        }).join('') : 
        '<div style="color: var(--text-secondary); font-size: 0.8em;">‚úÖ Sin vencimientos pr√≥ximos</div>';
    }
    
    // === 3. RTV POR VENCER (30 D√çAS) CON PRIMERAS 3 PLACAS ===
    const rtvPorVencer = RTV
      .filter(r=> r.fecha_vencimiento && diasRestantes(r.fecha_vencimiento) <= 30 && diasRestantes(r.fecha_vencimiento) >= 0)
      .sort((a, b) => diasRestantes(a.fecha_vencimiento) - diasRestantes(b.fecha_vencimiento));
    
    if(byId('kpiRtv30')) {
      byId('kpiRtv30').textContent = rtvPorVencer.length;
    }
    
    // Mostrar las primeras 3 RTV por vencer
    if(byId('proxRTV')) {
      const top3RTV = rtvPorVencer.slice(0, 3);
      byId('proxRTV').innerHTML = top3RTV.length > 0 ? 
        top3RTV.map(r => {
          const dias = diasRestantes(r.fecha_vencimiento);
          const colorClass = dias <= 7 ? 'dangerP' : 'warnP';
          return `<div class="pill ${colorClass}" style="margin: 2px; font-size: 0.8em;">${r.placa}: ${dias}d</div>`;
        }).join('') : 
        '<div style="color: var(--text-secondary); font-size: 0.8em;">‚úÖ Sin vencimientos pr√≥ximos</div>';
    }
    
    // === 4. COSTO TOTAL DEL MES ACTUAL ===
    const inicioMes = new Date();
    inicioMes.setDate(1);
    inicioMes.setHours(0, 0, 0, 0);
    
    const gastosCombustibleMes = Combustible
      .filter(f => new Date(f.fecha) >= inicioMes)
      .reduce((total, f) => total + Number(f.costo || 0), 0);
    
    const gastosMantenimientoMes = Mantenimientos
      .filter(m => new Date(m.fecha) >= inicioMes)
      .reduce((total, m) => total + Number(m.costo || 0), 0);
    
    const costoTotalMes = gastosCombustibleMes + gastosMantenimientoMes;
    
    // Mostrar costos del mes
    if(byId('kpiCombustibleMes')) byId('kpiCombustibleMes').textContent = fmt(gastosCombustibleMes);
    if(byId('kpiMantenimientoMes')) byId('kpiMantenimientoMes').textContent = fmt(gastosMantenimientoMes);
    if(byId('kpiCostoTotalMes')) byId('kpiCostoTotalMes').textContent = fmt(costoTotalMes);
    
    // Duplicar valores para el resumen del mes
    if(byId('kpiCombustibleMes2')) byId('kpiCombustibleMes2').textContent = fmt(gastosCombustibleMes);
    if(byId('kpiMantenimientoMes2')) byId('kpiMantenimientoMes2').textContent = fmt(gastosMantenimientoMes);
    if(byId('kpiCostoTotalMes2')) byId('kpiCostoTotalMes2').textContent = fmt(costoTotalMes);
    
    // === ESTAD√çSTICAS ADICIONALES ===
    const mantMes = Mantenimientos.filter(m=> {
      const d = new Date(m.fecha);
      const n = new Date();
      return d.getMonth() === n.getMonth() && d.getFullYear() === n.getFullYear();
    }).length;
    if(byId('kpiMantMes')) byId('kpiMantMes').textContent = mantMes;
    
    // === SISTEMA COMPLETO DE ALERTAS ===
    renderSistemaCompletoAlertas();
    
    // Renderizar funciones adicionales si existen
    if (typeof renderVehiculosDetalle === 'function') renderVehiculosDetalle();
    if (typeof renderAlertasConsolidadas === 'function') renderAlertasConsolidadas();
  }
  
  // === FUNCI√ìN PARA SISTEMA COMPLETO DE ALERTAS ===
  function renderSistemaCompletoAlertas() {
    const hoy = new Date();
    const en30Dias = new Date();
    en30Dias.setDate(hoy.getDate() + 30);
    
    // === CONTADORES DE ALERTAS ===
    let alertasMantenimiento = 0;
    let alertasPolizas = 0;
    let alertasRTV = 0;
    let alertasRevisiones = 0;
    let alertasCombustible = 0;
    
    const todasLasAlertas = [];
    
    // === 1. ALERTAS DE MANTENIMIENTO ===
    Mantenimientos.forEach(mant => {
      if (mant.tipo === 'cambio_aceite' || mant.tipo === 'mantenimiento_preventivo') {
        const vehiculo = Vehiculos.find(v => v.placa === mant.placa);
        if (!vehiculo) return;
        
        // Alerta por kilometraje
        if (mant.proximo_km) {
          const ultimoCombustible = Combustible
            .filter(f => f.placa === mant.placa && f.kilometraje)
            .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
          
          if (ultimoCombustible) {
            const kmActual = Number(ultimoCombustible.kilometraje);
            const kmProximo = Number(mant.proximo_km);
            const kmRestantes = kmProximo - kmActual;
            
            if (kmRestantes <= 1500 && kmRestantes > 0) {
              alertasMantenimiento++;
              todasLasAlertas.push({
                categoria: 'mantenimiento',
                tipo: 'kilometraje',
                placa: mant.placa,
                descripcion: `${mant.tipo} - ${kmRestantes.toLocaleString()} km restantes`,
                urgente: kmRestantes <= 200,
                icono: mant.tipo === 'cambio_aceite' ? 'üõ¢Ô∏è' : 'üîß'
              });
            }
          }
        }
        
        // Alerta por fecha
        if (mant.proxima_fecha) {
          const fechaProxima = new Date(mant.proxima_fecha);
          const diasRestantes = Math.ceil((fechaProxima - hoy) / (1000 * 60 * 60 * 24));
          
          if (diasRestantes <= 30 && diasRestantes >= 0) {
            alertasMantenimiento++;
            todasLasAlertas.push({
              categoria: 'mantenimiento',
              tipo: 'fecha',
              placa: mant.placa,
              descripcion: `${mant.tipo} - ${diasRestantes} d√≠as restantes`,
              urgente: diasRestantes <= 7,
              icono: mant.tipo === 'cambio_aceite' ? 'üõ¢Ô∏è' : 'üîß'
            });
          }
        }
      }
    });
    
    // === 2. ALERTAS DE P√ìLIZAS VENCIDAS ===
    Polizas.forEach(poliza => {
      if (poliza.estado === 'Activa') {
        const fechaVencimiento = new Date(poliza.fecha_vencimiento);
        const diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
        
        if (diasRestantes <= 30 && diasRestantes >= 0) {
          alertasPolizas++;
          const vehiculo = Vehiculos.find(v => v.placa === poliza.placa);
          todasLasAlertas.push({
            categoria: 'poliza',
            tipo: 'vencimiento',
            placa: poliza.placa,
            descripcion: `P√≥liza ${poliza.numero_poliza} - ${diasRestantes} d√≠as restantes`,
            urgente: diasRestantes <= 7,
            icono: 'üõ°Ô∏è',
            vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'
          });
        }
      }
    });
    
    // === 3. ALERTAS DE RTV VENCIDAS ===
    RTV.forEach(rtv => {
      if (rtv.estado === 'Vigente') {
        const fechaVencimiento = new Date(rtv.fecha_vencimiento);
        const diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
        
        if (diasRestantes <= 30 && diasRestantes >= 0) {
          alertasRTV++;
          const vehiculo = Vehiculos.find(v => v.placa === rtv.placa);
          todasLasAlertas.push({
            categoria: 'rtv',
            tipo: 'vencimiento',
            placa: rtv.placa,
            descripcion: `RTV ${rtv.numero_cita} - ${diasRestantes} d√≠as restantes`,
            urgente: diasRestantes <= 7,
            icono: 'üîç',
            vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'
          });
        }
      }
    });
    
    // === 4. ALERTAS DE REVISIONES CON FALLAS ===
    const fecha30DiasAtras = new Date();
    fecha30DiasAtras.setDate(hoy.getDate() - 30);
    
    Revisiones.forEach(revision => {
      if (!revision.aprobado && new Date(revision.fecha) >= fecha30DiasAtras) {
        alertasRevisiones++;
        const vehiculo = Vehiculos.find(v => v.placa === revision.placa);
        
        const fallas = [];
        if (revision.estado_motor !== 'Bueno') fallas.push('Motor');
        if (revision.estado_frenos !== 'Bueno') fallas.push('Frenos');
        if (revision.estado_luces !== 'Bueno') fallas.push('Luces');
        if (revision.estado_llantas !== 'Bueno') fallas.push('Llantas');
        if (revision.estado_carroceria !== 'Bueno') fallas.push('Carrocer√≠a');
        
        todasLasAlertas.push({
          categoria: 'revision',
          tipo: 'falla',
          placa: revision.placa,
          descripcion: `Fallas: ${fallas.join(', ') || 'Revisi√≥n no aprobada'}`,
          urgente: true,
          icono: '‚ö†Ô∏è',
          vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A',
          fecha: revision.fecha
        });
      }
    });
    
    // === 5. ALERTAS DE CONSUMO ANORMAL DE COMBUSTIBLE ===
    // Simular detecci√≥n de consumo anormal (en producci√≥n esto vendr√≠a del backend)
    const vehiculosConConsumo = {};
    Combustible.forEach(registro => {
      if (!vehiculosConConsumo[registro.placa]) {
        vehiculosConConsumo[registro.placa] = [];
      }
      if (registro.kilometraje && new Date(registro.fecha) >= fecha30DiasAtras) {
        vehiculosConConsumo[registro.placa].push(registro);
      }
    });
    
    Object.keys(vehiculosConConsumo).forEach(placa => {
      const registros = vehiculosConConsumo[placa].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      if (registros.length >= 3) {
        // Calcular rendimientos
        const rendimientos = [];
        for (let i = 1; i < registros.length; i++) {
          const kmRecorridos = registros[i].kilometraje - registros[i-1].kilometraje;
          if (kmRecorridos > 0) {
            rendimientos.push(kmRecorridos / registros[i].litros);
          }
        }
        
        if (rendimientos.length >= 2) {
          const promedio = rendimientos.reduce((a, b) => a + b, 0) / rendimientos.length;
          const ultimo = rendimientos[rendimientos.length - 1];
          
          // Si el √∫ltimo rendimiento es 30% menor al promedio
          if (ultimo < promedio * 0.7) {
            alertasCombustible++;
            const vehiculo = Vehiculos.find(v => v.placa === placa);
            todasLasAlertas.push({
              categoria: 'combustible',
              tipo: 'consumo_anormal',
              placa: placa,
              descripcion: `Consumo anormal: ${ultimo.toFixed(1)} vs ${promedio.toFixed(1)} km/L promedio`,
              urgente: ultimo < promedio * 0.5,
              icono: '‚õΩ',
              vehiculo: vehiculo ? `${vehiculo.marca} ${vehiculo.modelo}` : 'N/A'
            });
          }
        }
      }
    });
    
    // === ACTUALIZAR CONTADORES EN EL DASHBOARD ===
    if (byId('alertasMantenimiento')) byId('alertasMantenimiento').textContent = alertasMantenimiento;
    if (byId('alertasPolizas')) byId('alertasPolizas').textContent = alertasPolizas;
    if (byId('alertasRTV')) byId('alertasRTV').textContent = alertasRTV;
    if (byId('alertasRevisiones')) byId('alertasRevisiones').textContent = alertasRevisiones;
    if (byId('alertasCombustible')) byId('alertasCombustible').textContent = alertasCombustible;
    
    // === MOSTRAR LISTA DETALLADA DE ALERTAS ===
    const fichaAlertas = byId('fichaAlertas');
    if (fichaAlertas) {
      if (todasLasAlertas.length === 0) {
        fichaAlertas.innerHTML = '<div style="color: var(--success); text-align: center; padding: 20px;">‚úÖ No hay alertas pendientes</div>';
      } else {
        // Ordenar por urgencia y categor√≠a
        todasLasAlertas.sort((a, b) => {
          if (a.urgente && !b.urgente) return -1;
          if (!a.urgente && b.urgente) return 1;
          return a.categoria.localeCompare(b.categoria);
        });
        
        const alertasHtml = todasLasAlertas.map(alerta => {
          const colorClass = alerta.urgente ? 'dangerP' : 'warnP';
          return `
            <div class="pill ${colorClass}" style="margin: 4px; padding: 8px; display: block; text-align: left;">
              <div style="font-weight: bold;">${alerta.icono} ${alerta.placa}</div>
              <div style="font-size: 0.9em;">${alerta.descripcion}</div>
              ${alerta.vehiculo ? `<div style="font-size: 0.8em; color: var(--muted);">${alerta.vehiculo}</div>` : ''}
            </div>
          `;
        }).join('');
        
        fichaAlertas.innerHTML = alertasHtml;
      }
    }
    
    // === NOTIFICAR SI HAY ALERTAS CR√çTICAS ===
    const alertasCriticas = todasLasAlertas.filter(a => a.urgente);
    if (alertasCriticas.length > 0) {
      console.log(`üö® ${alertasCriticas.length} alertas cr√≠ticas detectadas:`, alertasCriticas);
    }
    
    return {
      total: todasLasAlertas.length,
      criticas: alertasCriticas.length,
      mantenimiento: alertasMantenimiento,
      polizas: alertasPolizas,
      rtv: alertasRTV,
      revisiones: alertasRevisiones,
      combustible: alertasCombustible
    };
  }
  
  // === FUNCIONES AUXILIARES PARA DASHBOARD MEJORADO ===
  function renderVehiculosDetalle() {
    const contenedor = byId('vehiculosDetalle');
    if (!contenedor) return;
    
    const vehiculosData = Vehiculos.map(vehiculo => {
      // Datos b√°sicos
      const poliza = Polizas.find(p => p.placa === vehiculo.placa);
      const rtv = RTV.find(r => r.placa === vehiculo.placa);
      
      // Pr√≥ximo cambio de aceite
      const ultimoCambio = Mantenimientos
        .filter(m => m.placa === vehiculo.placa && m.tipo === 'cambio_aceite' && m.proximo_km)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      const ultimoCombustible = Combustible
        .filter(f => f.placa === vehiculo.placa && f.kilometraje)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      let proximoCambio = null;
      if (ultimoCambio && ultimoCombustible) {
        const kmActual = Number(ultimoCombustible.kilometraje);
        const kmProximo = Number(ultimoCambio.proximo_km);
        proximoCambio = {
          kmActual,
          kmProximo,
          kmRestantes: kmProximo - kmActual,
          urgente: (kmProximo - kmActual) <= 200,
          proximo: (kmProximo - kmActual) <= 1000
        };
      }
      
      // Rendimiento √∫ltimos 30 d√≠as
      const hace30Dias = new Date();
      hace30Dias.setDate(hace30Dias.getDate() - 30);
      
      const combustibleReciente = Combustible
        .filter(f => f.placa === vehiculo.placa && new Date(f.fecha) >= hace30Dias && f._calculatedKmL);
      
      const rendimientoPromedio = combustibleReciente.length > 0 ?
        (combustibleReciente.reduce((a,f) => a + f._calculatedKmL, 0) / combustibleReciente.length).toFixed(1) : 'N/A';
      
      // Alertas del veh√≠culo
      const alertas = [];
      if (poliza && diasRestantes(poliza.fecha_vencimiento) <= 30) {
        alertas.push({
          tipo: 'P√≥liza',
          dias: diasRestantes(poliza.fecha_vencimiento),
          urgente: diasRestantes(poliza.fecha_vencimiento) <= 7
        });
      }
      if (rtv && diasRestantes(rtv.fecha_vencimiento) <= 30) {
        alertas.push({
          tipo: 'RTV',
          dias: diasRestantes(rtv.fecha_vencimiento),
          urgente: diasRestantes(rtv.fecha_vencimiento) <= 7
        });
      }
      if (proximoCambio && proximoCambio.proximo) {
        alertas.push({
          tipo: 'Cambio Aceite',
          km: proximoCambio.kmRestantes,
          urgente: proximoCambio.urgente
        });
      }
      
      return {
        vehiculo,
        poliza,
        rtv,
        proximoCambio,
        rendimientoPromedio,
        alertas
      };
    });
    
    const html = vehiculosData.map(data => {
      const v = data.vehiculo;
      const alertasHtml = data.alertas.map(a => 
        `<div class="pill ${a.urgente ? 'dangerP' : 'warnP'}" style="font-size: 0.8em; margin: 2px;">
          ${a.tipo}: ${a.dias !== undefined ? a.dias + 'd' : a.km + 'km'}
         </div>`
      ).join('');
      
      return `
        <div class="vehicle-card" style="border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin: 8px; background: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <h4 style="margin: 0; color: var(--primary);">üöó ${v.placa}</h4>
            <span style="font-size: 0.9em; color: var(--text-secondary);">${v.marca} ${v.modelo}</span>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
            <div>
              <strong>üìä Rendimiento:</strong> ${data.rendimientoPromedio} km/L<br>
              <strong>üîí P√≥liza:</strong> ${data.poliza ? diasRestantes(data.poliza.fecha_vencimiento) + 'd' : 'Sin registro'}<br>
              <strong>üîç RTV:</strong> ${data.rtv ? diasRestantes(data.rtv.fecha_vencimiento) + 'd' : 'Sin registro'}
            </div>
            <div>
              <strong>üõ´ Pr√≥ximo cambio:</strong> ${data.proximoCambio ? data.proximoCambio.kmRestantes + 'km' : 'N/A'}<br>
              <strong>üìç Km actual:</strong> ${data.proximoCambio ? data.proximoCambio.kmActual.toLocaleString() : 'N/A'}<br>
              <strong>‚ö†Ô∏è Alertas:</strong> ${data.alertas.length}
            </div>
          </div>
          
          ${data.alertas.length > 0 ? `<div style="margin-top: 8px;">${alertasHtml}</div>` : ''}
        </div>
      `;
    }).join('');
    
    contenedor.innerHTML = html;
  }
  
  function renderAlertasConsolidadas() {
    const contenedor = byId('alertasConsolidadas');
    if (!contenedor) return;
    
    const alertas = [];
    
    // Alertas de p√≥lizas
    Polizas.forEach(poliza => {
      const dias = diasRestantes(poliza.fecha_vencimiento);
      if (dias <= 30 && dias >= 0) {
        alertas.push({
          tipo: 'üîí P√≥liza',
          vehiculo: poliza.placa,
          descripcion: `Vence en ${dias} d√≠as`,
          urgencia: dias <= 7 ? 'critica' : dias <= 15 ? 'alta' : 'media',
          fecha: poliza.fecha_vencimiento
        });
      }
    });
    
    // Alertas de RTV
    RTV.forEach(rtv => {
      const dias = diasRestantes(rtv.fecha_vencimiento);
      if (dias <= 30 && dias >= 0) {
        alertas.push({
          tipo: 'üîç RTV',
          vehiculo: rtv.placa,
          descripcion: `Vence en ${dias} d√≠as`,
          urgencia: dias <= 7 ? 'critica' : dias <= 15 ? 'alta' : 'media',
          fecha: rtv.fecha_vencimiento
        });
      }
    });
    
    // Alertas de cambio de aceite
    Vehiculos.forEach(vehiculo => {
      const ultimoCambio = Mantenimientos
        .filter(m => m.placa === vehiculo.placa && m.tipo === 'cambio_aceite' && m.proximo_km)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      const ultimoCombustible = Combustible
        .filter(f => f.placa === vehiculo.placa && f.kilometraje)
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
      
      if (ultimoCambio && ultimoCombustible) {
        const kmActual = Number(ultimoCombustible.kilometraje);
        const kmProximo = Number(ultimoCambio.proximo_km);
        const kmRestantes = kmProximo - kmActual;
        
        if (kmRestantes <= 1000 && kmRestantes > 0) {
          alertas.push({
            tipo: 'üõ´ Cambio Aceite',
            vehiculo: vehiculo.placa,
            descripcion: `Faltan ${kmRestantes.toLocaleString()} km`,
            urgencia: kmRestantes <= 200 ? 'critica' : kmRestantes <= 500 ? 'alta' : 'media',
            fecha: null
          });
        }
      }
    });
    
    // Ordenar por urgencia
    const ordenUrgencia = { critica: 1, alta: 2, media: 3 };
    alertas.sort((a, b) => ordenUrgencia[a.urgencia] - ordenUrgencia[b.urgencia]);
    
    const html = alertas.map(alerta => {
      const colorClass = alerta.urgencia === 'critica' ? 'dangerP' : alerta.urgencia === 'alta' ? 'warnP' : 'ok';
      return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-left: 4px solid var(${alerta.urgencia === 'critica' ? '--danger' : alerta.urgencia === 'alta' ? '--warning' : '--success'}); margin: 4px 0; background: rgba(0,0,0,0.02);">
          <div>
            <strong>${alerta.tipo}</strong> - ${alerta.vehiculo}<br>
            <span style="font-size: 0.9em; color: var(--text-secondary);">${alerta.descripcion}</span>
          </div>
          <span class="pill ${colorClass}" style="font-size: 0.8em;">${alerta.urgencia.toUpperCase()}</span>
        </div>
      `;
    }).join('');
    
    contenedor.innerHTML = alertas.length > 0 ? html : '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">‚úÖ No hay alertas pendientes</div>';
  }
  
  function renderAlertas(){
    const q=byId('fltAlertPlaca').value?.trim().toUpperCase();
    const rows = (Alertas||[])
      .filter(a=> !q || (vehById(a.vehiculo_id)?.placa||'').includes(q))
      .map(a=>`<tr><td>${a.tipo}</td><td>${vehById(a.vehiculo_id)?.placa||''}</td><td>${a.dias_restantes||''} ${a.km_restantes? ((a.dias_restantes?' / ':'')+a.km_restantes+' km'):''}</td><td><span class="pill ${a.estado==='pendiente'?'warnP':'ok'}">${a.estado}</span></td></tr>`)
      .join('');
    byId('tblAlertas').innerHTML = rows || '<tr><td colspan="4">Sin alertas</td></tr>';
  }
  function renderVehiculos(){
    const q=byId('fltVehPlaca').value||''; 
    const est=byId('fltVehEstado').value;
    const dueno=byId('fltVehDueno')?.value?.toLowerCase()||'';
    
    const rows = Vehiculos
      .filter(v=> {
        const matchPlaca = !q || (v.placa||'').includes(q);
        const matchEstado = !est || est === 'activo'; // Por ahora todos los veh√≠culos son activos
        const matchDueno = !dueno || (v.propietario||v.dueno||'').toLowerCase().includes(dueno);
        return matchPlaca && matchEstado && matchDueno;
      })
      .map(v=>{
        // Mapear campos del backend al frontend correctamente
        const ano = v.ano || v.anio || '-';
        const tipo = 'Veh√≠culo'; // Campo por defecto ya que el backend no tiene tipo
        const estado = 'Activo'; // Campo por defecto ya que el backend no tiene estado
        const estadoColor = 'ok'; // Color por defecto para estado activo
        const duenoValue = v.propietario || v.dueno || 'Hotel';
        const aseguradoraValue = v.seguro || v.aseguradora || '-';
        
        return `<tr>
          <td><strong>${v.placa}</strong></td>
          <td>${v.marca} ${v.modelo}</td>
          <td>${ano}</td>
          <td>${tipo}</td>
          <td>üë§ ${duenoValue}</td>
          <td>${aseguradoraValue}</td>
          <td><span class="pill ${estadoColor}">${estado}</span></td>
          <td>
            <button class="action-btn edit-btn" onclick="editarVehiculo('${v.id}')" title="Editar">‚úèÔ∏è</button>
            <button class="action-btn export-btn" onclick="exportFichaExcel('${v.placa}')" title="Exportar">üìä</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarVehiculo('${v.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    byId('tblVeh').innerHTML = rows || '<tr><td colspan="8">Sin veh√≠culos</td></tr>';
  }
  function renderPolizas(){
    const mode=byId('fltPolVencer').value;
    const rows = Polizas.map(p=>{
      const d=diasRestantes(p.fecha_vencimiento);
      if(mode==='30' && d>30) return '';
      if(mode==='7' && d>7) return '';
      const acciones = hasPermission('polizas') ? 
        `<button class="btn-small" onclick="editarPoliza(${p.id})" title="Editar">‚úèÔ∏è</button>
         <button class="btn-small danger" onclick="eliminarPoliza(${p.id})" title="Eliminar">üóëÔ∏è</button>` : '';
      return `<tr><td>${p.placa||''}</td><td>${p.aseguradora}</td><td>${p.numero_poliza}</td><td>${p.fecha_vencimiento}</td><td>${semaforo(d)}</td><td>${acciones}</td></tr>`;
    }).join('');
    byId('tblPol').innerHTML = rows || '<tr><td colspan="6">Sin datos</td></tr>';
  }
  function renderRtv(){
    const mode=byId('fltRtvVencer').value;
    const rows = RTV.map(r=>{
      const d=diasRestantes(r.fecha_vencimiento);
      if(mode==='30' && d>30) return '';
      if(mode==='7' && d>7) return '';
      const acciones = hasPermission('polizas') ? 
        `<button class="btn-small" onclick="editarRTV(${r.id})" title="Editar">‚úèÔ∏è</button>
         <button class="btn-small danger" onclick="eliminarRTV(${r.id})" title="Eliminar">üóëÔ∏è</button>` : '';
      return `<tr><td>${r.placa||'-'}</td><td>${r.numero_cita||'-'}</td><td>${r.fecha_vencimiento}</td><td>${semaforo(d)}</td><td>${acciones}</td></tr>`;
    }).join('');
    byId('tblRtv').innerHTML = rows || '<tr><td colspan="5">Sin datos</td></tr>';
  }
  function renderMant(){
    const q=byId('fltMantPlaca').value||''; const t=byId('fltMantTipo').value;
    const filtered = Mantenimientos
      .filter(m=> (!t || m.tipo===t) && (!q || m.placa === q))
      .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
      
    const rows = filtered
      .map(m=>{
        const tipoIcon = {
          'cambio_aceite': 'üõ¢Ô∏è',
          'llantas': 'üõû',
          'frenos': 'üõë',
          'bateria': 'üîã',
          'alineacion': '‚öñÔ∏è',
          'transmision': '‚öôÔ∏è',
          'motor': 'üèéÔ∏è',
          'suspension': 'üî©',
          'aire_acondicionado': '‚ùÑÔ∏è'
        }[m.tipo] || 'üìù';
        
        return `<tr>
          <td><strong>${m.placa||''}</strong></td>
          <td>${m.fecha}</td>
          <td>${tipoIcon} ${(m.tipo||'').replace('_', ' ')}</td>
          <td><strong>${fmt(m.costo)}</strong></td>
          <td>${m.kilometraje??''}</td>
          <td>${m.proximo_km??''}</td>
          <td>${m.descripcion||''}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editarMantenimiento('${m.id}')" title="Editar">‚úèÔ∏è</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarMantenimiento('${m.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    byId('tblMant').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
    
    const total = filtered.reduce((a,b)=>a+(Number(b.costo)||0),0);
    const count = filtered.length;
    byId('sumMant').textContent = `${count} registros - Total: ${fmt(total)}`;
  }
  function renderFuel(){
    const q=byId('fltFuelPlaca').value||'';
    const meses=byId('fltFuelMes')?.value;
    
    let rec = Combustible.filter(f=> (!q || f.placa === q));
    
    if (meses) {
      const fechaLimite = new Date();
      fechaLimite.setMonth(fechaLimite.getMonth() - parseInt(meses));
      rec = rec.filter(f=> new Date(f.fecha) >= fechaLimite);
    }
    
    rec = rec.sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
    
    // Ordenar para calcular km/L correctamente
    const sortedRec = rec.sort((a, b) => {
      if (a.placa !== b.placa) return a.placa.localeCompare(b.placa);
      return new Date(a.fecha) - new Date(b.fecha);
    });
    
    const rows = sortedRec.map((f, index) =>{
      // Calcular km/L correctamente usando el registro anterior de la misma placa
      let kmL = null;
      for (let i = index - 1; i >= 0; i--) {
        const prev = sortedRec[i];
        if (prev.placa === f.placa && prev.kilometraje && f.kilometraje) {
          const kmActual = Number(f.kilometraje);
          const kmAnterior = Number(prev.kilometraje);
          const litros = Number(f.litros);
          
          if (kmActual > kmAnterior && litros > 0) {
            const distancia = kmActual - kmAnterior;
            kmL = distancia / litros;
          }
          break;
        }
      }
      
      const precioLitro = Number(f.costo) / Number(f.litros);
      
      // Almacenar km/L calculado en el objeto para uso posterior
      f._calculatedKmL = kmL;
      
      return `<tr>
        <td><strong>${f.placa||''}</strong></td>
        <td>${f.fecha}</td>
        <td>${f.litros}L</td>
        <td>${fmt(precioLitro)}</td>
        <td><strong>${fmt(f.costo)}</strong></td>
        <td>${f.kilometraje||'-'} km</td>
        <td>${kmL ? '<span class="pill ' + (kmL > 10 ? 'ok' : kmL > 7 ? 'warnP' : 'dangerP') + '">' + kmL.toFixed(2) + '</span>' : '-'}</td>
        <td>
          <button class="action-btn edit-btn" onclick="editarCombustible('${f.id}')" title="Editar">‚úèÔ∏è</button>
          ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarCombustible('${f.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
        </td>
      </tr>`;
    }).join('');
    byId('tblFuel').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
    
    // Estad√≠sticas corregidas
    const totalCosto = sortedRec.reduce((a,f)=> a + Number(f.costo), 0);
    const totalLitros = sortedRec.reduce((a,f)=> a + Number(f.litros), 0);
    const kmLPromedio = sortedRec.map(f=>{
      // Usar el km/L ya calculado
      return f._calculatedKmL;
    }).filter(x => x !== null && x > 0);
    
    const avgKmL = kmLPromedio.length > 0 ? (kmLPromedio.reduce((a,b)=>a+b,0) / kmLPromedio.length).toFixed(1) : '0';
    
    if (byId('sumFuel')) byId('sumFuel').textContent = `${rec.length} cargas - ${totalLitros.toFixed(1)}L - ${fmt(totalCosto)}`;
    if (byId('avgKmL')) byId('avgKmL').textContent = `Promedio: ${avgKmL} km/L`;
  }
  function fmtDT(v){
    if(v===undefined || v===null) return '';
    const d = new Date(v);
    if(!isNaN(d)) return d.toISOString().slice(0,16).replace('T',' ');
    const s = String(v);
    return s.indexOf('T')>-1 ? s.replace('T',' ').slice(0,16) : s;
  }
  function renderBit(){
    const q=byId('fltBitPlaca').value||'';
    const rows = Bitacora
      .filter(b=> (!q || (vehById(b.vehiculo_id)?.placa||'')===q))
      .sort((a,b)=> new Date(b.fecha_hora) - new Date(a.fecha_hora))
      .map(b=>`<tr><td>${vehById(b.vehiculo_id)?.placa||''}</td><td>${b.accion}</td><td>${b.conductor||''}</td><td>${fmtDT(b.fecha_hora)}</td><td>${b.km}</td><td>${b.nivel_combustible}</td><td>${['F:',b.chequeo_frenos?'‚úî':'‚úñ',' D:',b.chequeo_direccion?'‚úî':'‚úñ',' L:',b.chequeo_luces?'‚úî':'‚úñ'].join('')}</td><td>${b.observaciones||''}</td></tr>`)
      .join('');
    byId('tblBit').innerHTML = rows || '<tr><td colspan="8">Sin registros</td></tr>';
  }
  
  function renderRevisiones(){
    const q=byId('fltRevPlaca')?.value||'';
    const t=byId('fltRevTipo')?.value||'';
    
    const rows = (Revisiones||[])
      .filter(r=> (!q || r.placa === q))
      .sort((a,b)=> new Date(b.fecha) - new Date(a.fecha))
      .map(r=>{
        const tipoIcon = {
          'rutinaria': 'üîÑ',
          'preventiva': 'üõ°Ô∏è',
          'post_mantenimiento': 'üîß',
          'pre_viaje': '‚úàÔ∏è',
          'incidente': '‚ö†Ô∏è'
        }[r.tipo] || 'üîç';
        
        // Calcular estado general basado en las revisiones
        let estadoGeneral = 'excelente';
        const checks = [
          r.aceite_motor, r.liquido_frenos, r.coolant, r.estado_llantas,
          r.sistema_frenos, r.bateria, r.estado_carroceria, r.estado_interior
        ];
        if (checks.some(c => c === 'cambiar' || c === 'urgente' || c === 'da√±os_mayores')) {
          estadoGeneral = 'urgente';
        } else if (checks.some(c => c === 'bajo' || c === 'regular' || c === 'revisar')) {
          estadoGeneral = 'regular';
        } else if (checks.some(c => c === 'bueno')) {
          estadoGeneral = 'bueno';
        }
        
        const estadoColor = estadoGeneral === 'urgente' ? 'dangerP' : 
                           estadoGeneral === 'regular' ? 'warnP' : 'ok';
        
        return `<tr>
          <td><strong>${r.placa||''}</strong></td>
          <td>${tipoIcon} Revisi√≥n</td>
          <td>${r.inspector}</td>
          <td>${r.fecha}</td>
          <td>${r.kilometraje || '-'}</td>
          <td><span class="pill ${estadoColor}">${estadoGeneral}</span></td>
          <td>
            <button class="action-btn" onclick="verDetalleRevision('${r.id}')" title="Ver detalle">üëÅÔ∏è</button>
            <button class="action-btn edit-btn" onclick="editarRevision('${r.id}')" title="Editar">‚úèÔ∏è</button>
            ${currentUser && currentUser.role === 'admin' ? `<button class="action-btn delete-btn" onclick="eliminarRevision('${r.id}')" title="Eliminar">üóëÔ∏è</button>` : ''}
          </td>
        </tr>`;
      })
      .join('');
    
    if (byId('tblRevisiones')) {
      byId('tblRevisiones').innerHTML = rows || '<tr><td colspan="7">Sin registros</td></tr>';
    }
  }
  function fillVehSelects(){
    const opts = '<option value="">Seleccione un veh√≠culo...</option>' + 
                 Vehiculos.map(v=>`<option value="${v.id}">${v.placa} - ${v.marca} ${v.modelo}</option>`).join('');
    ['mVeh','cVeh','bVeh','pVeh','rVeh','rtvVeh','fichaVehiculo','editMVeh','editCVeh','editPVeh','editRVeh'].forEach(id=> { 
      const el = byId(id); 
      if(el) {
        const currentValue = el.value;
        el.innerHTML = opts;
        if (currentValue) el.value = currentValue;
      }
    });
  }
  function fillPlacaFilters(){
    const placas = Array.from(new Set(Vehiculos.map(v=>v.placa))).sort();
    const ids=['fltVehPlaca','fltMantPlaca','fltFuelPlaca','fltBitPlaca','fltRevPlaca','repPlaca'];
    ids.forEach(id=>{ 
      const el=byId(id); 
      if(!el) return; 
      const cur = el.value; 
      const baseText = id.includes('rep') ? 'Todos los veh√≠culos' : 'Todas las placas';
      el.innerHTML = `<option value="">üìã ${baseText}</option>` + placas.map(p=>`<option value="${p}">${p}</option>`).join(''); 
      if(placas.includes(cur)) el.value=cur; 
    });
  }

  // ====== FORM HANDLERS ======
  async function guardarVehiculo(e){
    e.preventDefault();
    if(!hasPermission('vehiculos')) return alert('Sin permisos para crear veh√≠culos');
    
    try{
      // Validaciones b√°sicas
      const placa = (byId('vPlaca').value||'').trim().toUpperCase();
      const marca = (byId('vMarca').value||'').trim();
      const modelo = (byId('vModelo').value||'').trim();
      const ano = Number(byId('vAnio').value);
      
      if(!placa) return alert('La placa es requerida');
      if(!marca) return alert('La marca es requerida');
      if(!modelo) return alert('El modelo es requerido');
      
      const year=new Date().getFullYear();
      if(isNaN(ano) || ano<1990||ano>year+1) return alert('A√±o fuera de rango v√°lido (1990-'+(year+1)+')');
      
      // Objeto para FastAPI backend
      const obj = { 
        placa: placa, 
        marca: marca, 
        modelo: modelo, 
        ano: ano,
        color: byId('vColor').value||'No especificado',
        propietario: byId('vDueno').value||'Hotel',
        poliza: byId('vPoliza').value||null,
        seguro: byId('vAseguradora').value||null
      };
      
      await apiPost('vehiculos', obj);
      Vehiculos = await apiGet('vehiculos');
      fillVehSelects(); 
      fillPlacaFilters(); 
      renderVehiculos(); 
      renderKpis();
      limpiarFormVehiculo();
      alert('‚úÖ Veh√≠culo creado exitosamente');
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  
  function limpiarFormVehiculo() {
    ['vPlaca', 'vMarca', 'vModelo', 'vAnio', 'vDueno', 'vPoliza', 'vAseguradora', 'vColor'].forEach(id => {
      const el = byId(id);
      if (el) el.value = '';
    });
    const tipoEl = byId('vTipo');
    const estadoEl = byId('vEstado');
    if (tipoEl) tipoEl.selectedIndex = 0;
    if (estadoEl) estadoEl.selectedIndex = 0;
  }
  async function guardarPoliza(e){
    if(e&&e.preventDefault) e.preventDefault();
    if(!hasPermission('polizas')) return alert('Sin permisos para crear p√≥lizas');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('pVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    if(!placa) return alert('Debe seleccionar un veh√≠culo v√°lido');
    
    const obj = { 
      numero_poliza: byId('pNum').value || '',
      placa: placa,
      aseguradora: byId('pAseg').value || '',
      fecha_inicio: new Date().toISOString().split('T')[0], // Usar fecha actual como inicio
      fecha_vencimiento: byId('pVence').value || '', // Usar el campo correcto del formulario
      tipo_cobertura: 'B√°sica',
      estado: 'Activa'
    };
    
    if(!obj.numero_poliza) return alert('N√∫mero de p√≥liza requerido');
    if(!obj.fecha_vencimiento) return alert('Fecha de vencimiento requerida');
    
    try{
      await apiPost('polizas', obj);
      Polizas = await apiGet('polizas');
      renderPolizas(); 
      renderKpis();
      clearPolicyForm(); // Limpiar formulario despu√©s de guardar
      alert('‚úÖ P√≥liza guardada exitosamente');
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  async function guardarRTV(e){
    if(e&&e.preventDefault) e.preventDefault();
    if(!hasPermission('polizas')) return alert('Sin permisos para crear RTV');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('rtvVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    if(!placa) return alert('Debe seleccionar un veh√≠culo v√°lido');
    
    const obj = { 
      numero_cita: byId('rCita').value || '',
      placa: placa,
      fecha_vencimiento: byId('rVence').value || '',
      estado: 'Vigente',
      observaciones: ''
    };
    
    if(!obj.numero_cita) return alert('N√∫mero de cita requerido');
    if(!obj.fecha_vencimiento) return alert('Fecha de vencimiento RTV requerida');
    
    try{
      await apiPost('rtv', obj);
      RTV = await apiGet('rtv');
      renderRtv(); 
      renderKpis();
      clearRTVForm(); // Limpiar formulario despu√©s de guardar
      alert('‚úÖ RTV guardado exitosamente');
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  async function guardarMantenimiento(e){
    e.preventDefault();
    if(!hasPermission('mantenimientos')) return alert('Sin permisos para crear mantenimientos');
    
    // Validaciones
    const vehiculoId = byId('mVeh').value;
    const fecha = byId('mFecha').value;
    const costo = Number(byId('mCosto').value||0);
    
    if(!vehiculoId) return alert('Debe seleccionar un veh√≠culo');
    if(!fecha) return alert('La fecha es requerida');
    if(costo < 0) return alert('El costo no puede ser negativo');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    if(!placa) return alert('No se pudo encontrar la placa del veh√≠culo seleccionado');
    
    const obj = { 
      fecha: fecha, 
      placa: placa,
      tipo: byId('mTipo').value || 'otro',
      descripcion: byId('mObs').value || byId('mTipo').value || 'Mantenimiento',
      costo: costo, 
      kilometraje: byId('mKm').value? Number(byId('mKm').value): null,
      proximo_km: byId('mProx').value? Number(byId('mProx').value): null,
      proxima_fecha: byId('mProxFecha').value || null
    };
    
    try{ 
      await apiPost('mantenimientos', obj); 
      Mantenimientos = await apiGet('mantenimientos'); 
      renderMant(); 
      renderKpis(); 
      refreshHints(); 
      clearMaintenanceForm(); // Limpiar formulario despu√©s de guardar
      alert('‚úÖ Mantenimiento guardado exitosamente'); 
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  
  async function guardarCombustible(e){
    e.preventDefault();
    if(!hasPermission('combustible')) return alert('Sin permisos para registrar combustible');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('cVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    const obj = { 
      fecha: byId('cFecha').value, 
      placa: placa,
      litros: Number(byId('cLitros').value), 
      costo: Number(byId('cPPL').value) * Number(byId('cLitros').value), 
      kilometraje: Number(byId('cOdo').value), 
      estacion: byId('cProv').value||'' 
    };
    
    try{ 
      await apiPost('combustible', obj); 
      Combustible = await apiGet('combustible'); 
      renderFuel(); 
      renderKpis(); 
      refreshHints(); 
      clearFuelForm(); // Limpiar formulario despu√©s de guardar
      alert('‚úÖ Carga de combustible guardada exitosamente'); 
    }catch(e2){ 
      alert('‚ùå Error: '+e2.message); 
    }
  }
  function resetBitacoraForm(){
    byId('bVeh').selectedIndex = 0;
    byId('bAccion').value = 'retiro';
    byId('bCond').value = '';
    byId('bFecha').value = '';
    byId('bKm').value = '';
    byId('bNivel').value = 'lleno';
    byId('bFrenos').checked = false;
    byId('bDir').checked = false;
    byId('bLuces').checked = false;
    byId('bGolpes').value = 'false';
    byId('bObs').value = '';
  }
  
  async function guardarRevision(e){
    e.preventDefault();
    if(!hasPermission('revision')) return alert('Sin permisos para crear revisiones');
    
    // Obtener placa del veh√≠culo seleccionado
    const vehiculoId = byId('rVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    const placa = vehiculo ? vehiculo.placa : '';
    
    // Evaluar estados generales
    const estadoMotor = evaluarEstadoGeneral(['rAceiteMotor', 'rCoolant', 'rBateria']);
    const estadoFrenas = evaluarEstadoGeneral(['rLiquidoFrenos', 'rSistemaFrenos']);
    const estadoLuces = evaluarEstadoLuces();
    const estadoLlantas = byId('rEstadoLlantas').value || 'bueno';
    const estadoCarroceria = byId('rEstadoCarroceria').value || 'bueno';
    
    // Determinar aprobaci√≥n general
    const aprobado = [estadoMotor, estadoFrenas, estadoLuces, estadoLlantas, estadoCarroceria].every(estado => estado !== 'malo');
    
    const obj = {
      fecha: byId('rFecha').value,
      placa: placa,
      inspector: byId('rInspector').value || 'Inspector',
      estado_motor: estadoMotor,
      estado_frenos: estadoFrenas,
      estado_luces: estadoLuces,
      estado_llantas: estadoLlantas,
      estado_carroceria: estadoCarroceria,
      observaciones: byId('rObservaciones').value || '',
      aprobado: aprobado
    };
    
    try {
      await apiPost('revisiones', obj);
      Revisiones = await apiGet('revisiones');
      renderRevisiones();
      limpiarFormRevision();
      alert('‚úÖ Revisi√≥n guardada exitosamente');
    } catch(e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  // Funci√≥n auxiliar para evaluar estado general
  function evaluarEstadoGeneral(fieldIds) {
    const estados = fieldIds.map(id => byId(id)?.value || 'bueno');
    if (estados.some(e => e === 'malo')) return 'malo';
    if (estados.some(e => e === 'regular')) return 'regular';
    return 'bueno';
  }
  
  // Funci√≥n auxiliar para evaluar estado de luces
  function evaluarEstadoLuces() {
    const luces = ['rLucesDelanteras', 'rLucesTraseras', 'rLucesDireccionales', 'rLucesFreno'];
    const funcionan = luces.map(id => byId(id)?.checked || false);
    const porcentajeFuncionando = funcionan.filter(Boolean).length / funcionan.length;
    
    if (porcentajeFuncionando >= 0.8) return 'bueno';
    if (porcentajeFuncionando >= 0.5) return 'regular';
    return 'malo';
  }
  
  function limpiarFormRevision() {
    // Resetear campos de texto
    ['rInspector', 'rFecha', 'rKm', 'rObservaciones'].forEach(id => {
      const el = byId(id);
      if (el) el.value = '';
    });
    
    // Resetear selects
    ['rVeh', 'rTipo', 'rNivelComb', 'rAceiteMotor', 'rLiquidoFrenos', 'rCoolant', 
     'rLimpiaparabrisas', 'rAceiteTransmision', 'rLiquidoDireccion', 'rEstadoLlantas',
     'rPresionLlantas', 'rSistemaFrenos', 'rBateria', 'rEstadoCarroceria', 'rEstadoInterior'].forEach(id => {
      const el = byId(id);
      if (el) el.selectedIndex = 0;
    });
    
    // Desmarcar checkboxes
    ['rLucesDelanteras', 'rLucesTraseras', 'rLucesDireccionales', 'rLucesFreno', 
     'rLucesReversa', 'rEspejosLaterales', 'rEspejoRetrovisor', 'rLimpiaparabrisas', 
     'rCinturones', 'rBocina'].forEach(id => {
      const el = byId(id);
      if (el) el.checked = false;
    });
  }
  async function guardarBitacora(e){
    e.preventDefault();
    const rol=byId('rol').value; if(!['admin','recepcion'].includes(rol)) return alert('Sin permiso');
    const obj = { vehiculo_id:Number(byId('bVeh').value), accion:byId('bAccion').value, conductor:byId('bCond').value||'', fecha_hora:byId('bFecha').value||new Date().toISOString().slice(0,16), km:Number(byId('bKm').value), nivel_combustible:byId('bNivel').value, golpes_carroceria:(byId('bGolpes').value==='true'), chequeo_frenos:byId('bFrenos').checked, chequeo_direccion:byId('bDir').checked, chequeo_luces:byId('bLuces').checked, observaciones:byId('bObs').value||'' };
    if(obj.accion==='retiro' && !obj.conductor) return alert('Conductor obligatorio en retiro');
    if(obj.accion==='entrega' && obj.golpes_carroceria && !obj.observaciones) return alert('Si hay golpes, agregue observaciones');
    try {
      await apiPost('Bitacora', obj);
      Bitacora = await apiGet('Bitacora');
      Alertas  = await apiGet('Alertas');
      const placaSel = vehById(obj.vehiculo_id)?.placa || '';
      const flt = byId('fltBitPlaca'); if (flt && placaSel) flt.value = placaSel;
      setTab('bitacora');
      renderBit();
      renderAlertas();
      const tbody = byId('tblBit');
      if (tbody && tbody.firstElementChild){
        const firstRow = tbody.firstElementChild;
        try { firstRow.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
        const flashClass = (obj.accion === 'retiro') ? 'flash-ret' : 'flash-ent';
        firstRow.classList.add('flash', flashClass);
        setTimeout(() => firstRow.classList.remove('flash', 'flash-ret', 'flash-ent'), 3000);
        const firstCell = firstRow.cells && firstRow.cells[0];
        if (firstCell){
          const badge = document.createElement('span');
          badge.textContent = 'üÜï';
          badge.className = 'newtag';
          badge.title = (obj.accion === 'retiro') ? 'Nuevo retiro' : 'Nueva entrega';
          firstCell.prepend(badge);
          setTimeout(() => { try{ badge.remove(); }catch{} }, 60000);
        }
        const dateCell = firstRow.cells && firstRow.cells[3];
        if (dateCell){
          const original = dateCell.textContent || (typeof fmtDT==='function' ? fmtDT(obj.fecha_hora) : String(obj.fecha_hora||''));
          dateCell.dataset.old = original;
          dateCell.textContent = 'justo ahora';
          setTimeout(() => { dateCell.textContent = dateCell.dataset.old || original; }, 60000);
        }
      }
      resetBitacoraForm();
      refreshHints();
      alert('Bit√°cora guardada');
    } catch (err) {
      console.error('Error guardando Bit√°cora', err);
      alert('Error guardando Bit√°cora: ' + (err?.message || err));
    }
  }

  // ====== UTILIDADES ======
  function getLastBitKm(vid){
    const rec = (Bitacora||[]).filter(b=> Number(b.vehiculo_id)===Number(vid)).sort((a,b)=> new Date(b.fecha_hora)-new Date(a.fecha_hora))[0];
    return rec? (Number(rec.km)||'') : '';
  }
  async function getLastFuelOdo(vehiculoId){
    try {
      // Encontrar la placa del veh√≠culo
      const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
      if (!vehiculo) return 0;
      
      const placa = vehiculo.placa;
      
      // Llamar al endpoint del backend para obtener el √∫ltimo od√≥metro
      const response = await fetch(`${API}/combustible/last-odometer/${placa}`);
      if (response.ok) {
        const data = await response.json();
        return data.success ? data.data.kilometraje : 0;
      }
      return 0;
    } catch (error) {
      console.error('Error al obtener √∫ltimo od√≥metro:', error);
      return 0;
    }
  }
  function getLastOilKm(vid){
    const rec = (Mantenimientos||[]).filter(m=> Number(m.vehiculo_id)===Number(vid) && m.tipo==='cambio_aceite').sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
    return rec? (Number(rec.km_actual)||'') : '';
  }
  async function refreshHints(){
    const bSel = byId('bVeh'); if(bSel && bSel.value){ const v = getLastBitKm(bSel.value); const el=byId('bKmPrev'); if(el) el.value = v; }
    const cSel = byId('cVeh'); if(cSel && cSel.value){ const v = await getLastFuelOdo(cSel.value); const el=byId('cOdoPrev'); if(el) el.value = v; }
    const mSel = byId('mVeh'); if(mSel && mSel.value){ const v = getLastOilKm(mSel.value); const el=byId('mKmPrevAceite'); if(el) el.value = v; }
    calcKmLEstimado();
  }
  function calcCosto(){ const L=Number(byId('cLitros').value||0); const P=Number(byId('cPPL').value||0); byId('cCosto').value = (L*P)||0; }
  function calcKmLEstimado(){
    const prev = Number(byId('cOdoPrev')?.value||0);
    const odo = Number(byId('cOdo')?.value||0);
    const litros = Number(byId('cLitros')?.value||0);
    const dist = odo - prev;
    const val = (litros>0 && dist>0)? (dist/litros).toFixed(2): '';
    if(byId('cKmLEst')) byId('cKmLEst').value = val;
  }
  
  // Funci√≥n para actualizar el od√≥metro anterior cuando se selecciona un veh√≠culo
  async function updatePreviousOdometer() {
    const vehiculoId = byId('cVeh').value;
    if (vehiculoId) {
      const lastOdometer = await getLastFuelOdo(vehiculoId);
      const el = byId('cOdoPrev');
      if (el) {
        el.value = lastOdometer;
        calcKmLEstimado(); // Recalcular km/L estimado
      }
    } else {
      // Si no hay veh√≠culo seleccionado, limpiar el campo
      const el = byId('cOdoPrev');
      if (el) el.value = '';
    }
  }
  
  // Funci√≥n para limpiar formularios despu√©s de guardar
  function clearFuelForm() {
    ['cVeh', 'cFecha', 'cLitros', 'cPPL', 'cOdo', 'cProv', 'cOdoPrev', 'cKmLEst', 'cCosto'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
  }
  
  function clearMaintenanceForm() {
    ['mVeh', 'mTipo', 'mFecha', 'mCosto', 'mKm', 'mProx', 'mProxFecha', 'mObs', 'mKmPrevAceite'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
    // Despu√©s de limpiar, actualizar la visibilidad de campos
    toggleMaintenanceFields();
  }
  
  function clearInspectionForm() {
    ['rVeh', 'rFecha', 'rInsp', 'rMotor', 'rFreno', 'rLuces', 'rLlantas', 'rCarroc', 'rObs', 'rAprobado'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else if (el.type === 'checkbox') {
          el.checked = false;
        } else {
          el.value = '';
        }
      }
    });
  }
  
  function clearPolicyForm() {
    ['pVeh', 'pNum', 'pAseg', 'pVence'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
  }
  
  function clearRTVForm() {
    ['rtvVeh', 'rCita', 'rVence'].forEach(id => {
      const el = byId(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.value = '';
        } else {
          el.value = '';
        }
      }
    });
  }
  function buscarPlaca(){ const v=byId('qPlaca').value.trim().toUpperCase(); if(!v) return; const sel = byId('fltVehPlaca'); if(sel){ sel.value=v; } setTab('vehiculos'); renderVehiculos(); }
  function exportarVehiculo(){ const placa = byId('fltVehPlaca').value; if(!placa) return alert('Seleccione una placa en el filtro'); exportFichaExcel(placa); }
  function autoProximoKm(){ const tipo = byId('mTipo').value; if(tipo !== 'cambio_aceite') { alert('Aplica solo a "Cambio de aceite"'); return; } const km = parseInt(byId('mKm').value||'0',10); if(!km || Number.isNaN(km) || km<0){ alert('Ingrese km actual v√°lido'); return; } byId('mProx').value = km + 5000; }
  
  // Funci√≥n para mostrar/ocultar campos espec√≠ficos de mantenimiento
  function toggleMaintenanceFields() {
    const tipo = byId('mTipo').value;
    const isOilChange = tipo === 'cambio_aceite';
    const isPreventive = tipo === 'mantenimiento_preventivo';
    const requiresAlerts = isOilChange || isPreventive;
    
    // SIEMPRE mostrar campos de kilometraje (para todos los tipos)
    const kmFields = byId('maintenanceKmFields');
    if (kmFields) {
      kmFields.style.display = 'grid';
    }
    
    // Mostrar campos de fecha pr√≥xima para cambio de aceite y mantenimiento preventivo
    const dateFields = byId('maintenanceDateFields');
    if (dateFields) {
      dateFields.style.display = requiresAlerts ? 'grid' : 'none';
    }
    
    // Auto-completar sugerencias
    if (requiresAlerts) {
      // Sugerir fecha pr√≥xima (3 meses para aceite, 6 meses para preventivo)
      const today = new Date();
      const monthsToAdd = isOilChange ? 3 : 6;
      today.setMonth(today.getMonth() + monthsToAdd);
      const suggestedDate = today.toISOString().split('T')[0];
      
      const proxFechaField = byId('mProxFecha');
      if (proxFechaField && !proxFechaField.value) {
        proxFechaField.value = suggestedDate;
      }
    }
    
    // Limpiar campos cuando no aplica
    if (!requiresAlerts) {
      ['mProx', 'mProxFecha', 'mKmPrevAceite'].forEach(id => {
        const el = byId(id);
        if (el) el.value = '';
      });
    }
  }
  
  // ====== FUNCIONES DE EDICI√ìN ======
  
  function editarVehiculo(id) {
    console.log('Editando veh√≠culo ID:', id);
    
    if (!hasPermission('vehiculos')) {
      alert('Sin permisos para editar veh√≠culos');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == id);
    console.log('Veh√≠culo encontrado:', vehiculo);
    
    if (!vehiculo) {
      alert('Veh√≠culo no encontrado');
      return;
    }
    
    // Llenar el modal de edici√≥n
    byId('editVehId').value = vehiculo.id;
    byId('editVPlaca').value = vehiculo.placa || '';
    byId('editVMarca').value = vehiculo.marca || '';
    byId('editVModelo').value = vehiculo.modelo || '';
    byId('editVAnio').value = vehiculo.ano || '';
    byId('editVTipo').value = vehiculo.tipo || 'otro';
    byId('editVEstado').value = vehiculo.estado || 'activo';
    byId('editVDueno').value = vehiculo.propietario || '';
    byId('editVPoliza').value = vehiculo.poliza || '';
    byId('editVAseguradora').value = vehiculo.seguro || '';
    byId('editVColor').value = vehiculo.color || '';
    
    // Mostrar modal
    const modal = byId('modalEditVehiculo');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarVehiculo(e) {
    e.preventDefault();
    
    const id = byId('editVehId').value;
    const placa = byId('editVPlaca').value.trim().toUpperCase();
    
    // Validaciones
    if(!placa) return alert('La placa es requerida');
    if(!byId('editVMarca').value.trim()) return alert('La marca es requerida');
    if(!byId('editVModelo').value.trim()) return alert('El modelo es requerido');
    
    const obj = {
      marca: byId('editVMarca').value.trim(),
      modelo: byId('editVModelo').value.trim(),
      ano: parseInt(byId('editVAnio').value),
      color: byId('editVColor').value || 'No especificado',
      propietario: byId('editVDueno').value || 'Hotel',
      poliza: byId('editVPoliza').value || null,
      seguro: byId('editVAseguradora').value || null
    };
    
    try {
      await apiPut('vehiculos', placa, obj);
      Vehiculos = await apiGet('vehiculos');
      fillVehSelects();
      fillPlacaFilters();
      renderVehiculos();
      cerrarModal('modalEditVehiculo');
      alert('‚úÖ Veh√≠culo actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  function editarMantenimiento(id) {
    console.log('Editando mantenimiento ID:', id);
    
    if (!hasPermission('mantenimientos')) {
      alert('Sin permisos para editar mantenimientos');
      return;
    }
    
    const mant = Mantenimientos.find(m => m.id == id);
    console.log('Mantenimiento encontrado:', mant);
    
    if (!mant) {
      alert('Mantenimiento no encontrado');
      return;
    }
    
    fillVehSelects(); // Asegurar que los selects est√©n llenos
    
    byId('editMantId').value = mant.id;
    // Encontrar el veh√≠culo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === mant.placa);
    byId('editMVeh').value = vehiculo ? vehiculo.id : '';
    byId('editMTipo').value = mant.tipo;
    byId('editMFecha').value = mant.fecha;
    byId('editMCosto').value = mant.costo;
    byId('editMKm').value = mant.kilometraje || '';
    byId('editMProx').value = mant.proximo_km || '';
    byId('editMProxFecha').value = mant.proxima_fecha || '';
    byId('editMObs').value = mant.descripcion || '';
    
    const modal = byId('modalEditMantenimiento');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarMantenimiento(e) {
    e.preventDefault();
    
    const id = byId('editMantId').value;
    const vehiculoId = byId('editMVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un veh√≠culo v√°lido');
      return;
    }
    
    const obj = {
      fecha: byId('editMFecha').value,
      placa: vehiculo.placa,
      tipo: byId('editMTipo').value,
      descripcion: byId('editMObs').value || byId('editMTipo').value,
      costo: parseFloat(byId('editMCosto').value),
      kilometraje: byId('editMKm').value ? parseInt(byId('editMKm').value) : null,
      proximo_km: byId('editMProx').value ? parseInt(byId('editMProx').value) : null,
      proxima_fecha: byId('editMProxFecha').value || null
    };
    
    try {
      await apiPut('mantenimientos', id, obj);
      Mantenimientos = await apiGet('mantenimientos');
      renderMant();
      renderKpis();
      cerrarModal('modalEditMantenimiento');
      alert('‚úÖ Mantenimiento actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  // ====== FUNCIONES PARA REVISIONES ======
  function verDetalleRevision(id) {
    console.log('Viendo detalle de revisi√≥n ID:', id);
    
    const revision = Revisiones.find(r => r.id == id);
    if (!revision) {
      alert('Revisi√≥n no encontrada');
      return;
    }
    
    // Crear contenido del modal con todos los detalles
    const contenido = `
      <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
        <h3 style="margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px;">
          üîç Detalle de Revisi√≥n - ${revision.placa}
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <strong>üìÖ Fecha:</strong> ${revision.fecha}<br>
            <strong>üë®‚Äçüîß Inspector:</strong> ${revision.inspector}<br>
            <strong>üöó Veh√≠culo:</strong> ${revision.placa}
          </div>
          <div>
            <strong>‚úÖ Aprobado:</strong> ${revision.aprobado ? '‚úÖ S√≠' : '‚ùå No'}<br>
            <strong>üìù Observaciones:</strong> ${revision.observaciones || 'Ninguna'}
          </div>
        </div>
        
        <h4 style="color: var(--secondary); margin: 20px 0 10px 0;">üîç Estados de Componentes</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <strong>üî• Motor:</strong> <span class="pill ${getEstadoPill(revision.estado_motor)}">${revision.estado_motor || 'No revisado'}</span><br>
            <strong>üõë Frenos:</strong> <span class="pill ${getEstadoPill(revision.estado_frenos)}">${revision.estado_frenos || 'No revisado'}</span><br>
            <strong>üí° Luces:</strong> <span class="pill ${getEstadoPill(revision.estado_luces)}">${revision.estado_luces || 'No revisado'}</span><br>
            <strong>üéØ Llantas:</strong> <span class="pill ${getEstadoPill(revision.estado_llantas)}">${revision.estado_llantas || 'No revisado'}</span>
          </div>
          <div>
            <strong>üöó Carrocer√≠a:</strong> <span class="pill ${getEstadoPill(revision.estado_carroceria)}">${revision.estado_carroceria || 'No revisado'}</span><br>
            <strong>üß† Interior:</strong> <span class="pill ${getEstadoPill(revision.estado_interior)}">${revision.estado_interior || 'No revisado'}</span><br>
            <strong>üîã Bater√≠a:</strong> <span class="pill ${getEstadoPill(revision.bateria)}">${revision.bateria || 'No revisado'}</span><br>
            <strong>üõ¢Ô∏è Sistema Frenos:</strong> <span class="pill ${getEstadoPill(revision.sistema_frenos)}">${revision.sistema_frenos || 'No revisado'}</span>
          </div>
        </div>
        
        <h4 style="color: var(--secondary); margin: 20px 0 10px 0;">ü´¢ Fluidos</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <strong>üõ´ Aceite Motor:</strong> <span class="pill ${getEstadoPill(revision.aceite_motor)}">${revision.aceite_motor || 'No revisado'}</span><br>
            <strong>üî¥ L√≠quido Frenos:</strong> <span class="pill ${getEstadoPill(revision.liquido_frenos)}">${revision.liquido_frenos || 'No revisado'}</span>
          </div>
          <div>
            <strong>üßä Refrigerante:</strong> <span class="pill ${getEstadoPill(revision.coolant)}">${revision.coolant || 'No revisado'}</span>
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
          <button class="secondary" onclick="cerrarModal('modalDetalleRevision')">Cerrar</button>
          <button class="primary" onclick="cerrarModal('modalDetalleRevision'); editarRevision('${revision.id}');">Editar</button>
        </div>
      </div>
    `;
    
    // Crear modal din√°mico
    let modal = byId('modalDetalleRevision');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modalDetalleRevision';
      modal.className = 'modal';
      modal.innerHTML = '<div class="modal-content"></div>';
      document.body.appendChild(modal);
    }
    
    modal.querySelector('.modal-content').innerHTML = contenido;
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
  }
  
  function getEstadoPill(estado) {
    if (!estado) return 'ok';
    const estadoLower = estado.toLowerCase();
    if (estadoLower.includes('excelente') || estadoLower.includes('bueno')) return 'ok';
    if (estadoLower.includes('regular') || estadoLower.includes('revisar') || estadoLower.includes('bajo')) return 'warnP';
    if (estadoLower.includes('malo') || estadoLower.includes('cambiar') || estadoLower.includes('urgente') || estadoLower.includes('da√±os')) return 'dangerP';
    return 'ok';
  }
  
  function editarRevision(id) {
    console.log('Editando revisi√≥n ID:', id);
    
    if (!hasPermission('revisiones')) {
      alert('Sin permisos para editar revisiones');
      return;
    }
    
    const revision = Revisiones.find(r => r.id == id);
    console.log('Revisi√≥n encontrada:', revision);
    
    if (!revision) {
      alert('Revisi√≥n no encontrada');
      return;
    }
    
    fillVehSelects();
    
    // Llenar campos del modal de edici√≥n
    byId('editRevisionId').value = revision.id;
    const vehiculo = Vehiculos.find(v => v.placa === revision.placa);
    byId('editRVeh').value = vehiculo ? vehiculo.id : '';
    byId('editRFecha').value = revision.fecha;
    byId('editRInspector').value = revision.inspector;
    
    // Estados de componentes
    byId('editRMotor').value = revision.estado_motor || '';
    byId('editRFrenos').value = revision.estado_frenos || '';
    byId('editRLuces').value = revision.estado_luces || '';
    byId('editRLlantas').value = revision.estado_llantas || '';
    byId('editRCarroceria').value = revision.estado_carroceria || '';
    
    byId('editRObs').value = revision.observaciones || '';
    byId('editRAprobado').checked = revision.aprobado || false;
    
    const modal = byId('modalEditRevision');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarRevision(e) {
    e.preventDefault();
    
    const id = byId('editRevisionId').value;
    const vehiculoId = byId('editRVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un veh√≠culo v√°lido');
      return;
    }
    
    const obj = {
      fecha: byId('editRFecha').value,
      placa: vehiculo.placa,
      inspector: byId('editRInspector').value,
      estado_motor: byId('editRMotor').value,
      estado_frenos: byId('editRFrenos').value,
      estado_luces: byId('editRLuces').value,
      estado_llantas: byId('editRLlantas').value,
      estado_carroceria: byId('editRCarroceria').value,
      observaciones: byId('editRObs').value,
      aprobado: byId('editRAprobado').checked
    };
    
    try {
      await apiPut('revisiones', id, obj);
      Revisiones = await apiGet('revisiones');
      renderRevisiones();
      renderKpis();
      cerrarModal('modalEditRevision');
      alert('‚úÖ Revisi√≥n actualizada exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  // ====== FUNCIONES PARA P√ìLIZAS ======
  function editarPoliza(id) {
    console.log('Editando p√≥liza ID:', id);
    
    if (!hasPermission('polizas')) {
      alert('Sin permisos para editar p√≥lizas');
      return;
    }
    
    const poliza = Polizas.find(p => p.id == id);
    console.log('P√≥liza encontrada:', poliza);
    
    if (!poliza) {
      alert('P√≥liza no encontrada');
      return;
    }
    
    fillVehSelects();
    
    byId('editPolizaId').value = poliza.id;
    // Encontrar el veh√≠culo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === poliza.placa);
    byId('editPVeh').value = vehiculo ? vehiculo.id : '';
    byId('editPAseg').value = poliza.aseguradora;
    byId('editPNum').value = poliza.numero_poliza;
    byId('editPVence').value = poliza.fecha_vencimiento;
    byId('editPTipo').value = poliza.tipo_cobertura || 'B√°sica';
    byId('editPEstado').value = poliza.estado || 'Activa';
    
    const modal = byId('modalEditPoliza');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarPoliza(e) {
    e.preventDefault();
    
    const id = byId('editPolizaId').value;
    const vehiculoId = byId('editPVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un veh√≠culo v√°lido');
      return;
    }
    
    const obj = {
      numero_poliza: byId('editPNum').value,
      placa: vehiculo.placa,
      aseguradora: byId('editPAseg').value,
      fecha_inicio: new Date().toISOString().split('T')[0],
      fecha_vencimiento: byId('editPVence').value,
      tipo_cobertura: byId('editPTipo').value,
      estado: byId('editPEstado').value
    };
    
    try {
      await apiPut('polizas', id, obj);
      Polizas = await apiGet('polizas');
      renderPolizas();
      renderKpis();
      cerrarModal('modalEditPoliza');
      alert('‚úÖ P√≥liza actualizada exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  async function eliminarPoliza(id) {
    if (!hasPermission('polizas')) {
      alert('Sin permisos para eliminar p√≥lizas');
      return;
    }
    
    const poliza = Polizas.find(p => p.id == id);
    if (!poliza) {
      alert('P√≥liza no encontrada');
      return;
    }
    
    if (!confirm(`¬øEst√° seguro de eliminar la p√≥liza ${poliza.numero_poliza}?`)) {
      return;
    }
    
    try {
      await apiDelete('polizas', id);
      Polizas = await apiGet('polizas');
      renderPolizas();
      renderKpis();
      alert('‚úÖ P√≥liza eliminada exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  // ====== FUNCIONES PARA RTV ======
  function editarRTV(id) {
    console.log('Editando RTV ID:', id);
    
    if (!hasPermission('polizas')) {
      alert('Sin permisos para editar RTV');
      return;
    }
    
    const rtv = RTV.find(r => r.id == id);
    console.log('RTV encontrado:', rtv);
    
    if (!rtv) {
      alert('RTV no encontrado');
      return;
    }
    
    fillVehSelects();
    
    byId('editRTVId').value = rtv.id;
    // Encontrar el veh√≠culo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === rtv.placa);
    byId('editRVeh').value = vehiculo ? vehiculo.id : '';
    byId('editRCita').value = rtv.numero_cita;
    byId('editRVence').value = rtv.fecha_vencimiento;
    byId('editREstado').value = rtv.estado || 'Vigente';
    byId('editRObs').value = rtv.observaciones || '';
    
    const modal = byId('modalEditRTV');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarRTV(e) {
    e.preventDefault();
    
    const id = byId('editRTVId').value;
    const vehiculoId = byId('editRVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un veh√≠culo v√°lido');
      return;
    }
    
    const obj = {
      numero_cita: byId('editRCita').value,
      placa: vehiculo.placa,
      fecha_vencimiento: byId('editRVence').value,
      estado: byId('editREstado').value,
      observaciones: byId('editRObs').value || ''
    };
    
    try {
      await apiPut('rtv', id, obj);
      RTV = await apiGet('rtv');
      renderRtv();
      renderKpis();
      cerrarModal('modalEditRTV');
      alert('‚úÖ RTV actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  async function eliminarRTV(id) {
    if (!hasPermission('polizas')) {
      alert('Sin permisos para eliminar RTV');
      return;
    }
    
    const rtv = RTV.find(r => r.id == id);
    if (!rtv) {
      alert('RTV no encontrado');
      return;
    }
    
    if (!confirm(`¬øEst√° seguro de eliminar el RTV ${rtv.numero_cita}?`)) {
      return;
    }
    
    try {
      await apiDelete('rtv', id);
      RTV = await apiGet('rtv');
      renderRtv();
      renderKpis();
      alert('‚úÖ RTV eliminado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  function editarCombustible(id) {
    console.log('Editando combustible ID:', id);
    
    if (!hasPermission('combustible')) {
      alert('Sin permisos para editar registros de combustible');
      return;
    }
    
    const fuel = Combustible.find(f => f.id == id);
    console.log('Combustible encontrado:', fuel);
    
    if (!fuel) {
      alert('Registro de combustible no encontrado');
      return;
    }
    
    fillVehSelects();
    
    byId('editFuelId').value = fuel.id;
    // Encontrar el veh√≠culo por placa para obtener el ID
    const vehiculo = Vehiculos.find(v => v.placa === fuel.placa);
    byId('editCVeh').value = vehiculo ? vehiculo.id : '';
    byId('editCFecha').value = fuel.fecha;
    byId('editCLitros').value = fuel.litros;
    byId('editCPPL').value = fuel.costo / fuel.litros; // Calcular precio por litro
    byId('editCOdo').value = fuel.kilometraje;
    byId('editCProv').value = fuel.estacion || '';
    
    const modal = byId('modalEditCombustible');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
    }
  }
  
  async function actualizarCombustible(e) {
    e.preventDefault();
    
    const id = byId('editFuelId').value;
    const vehiculoId = byId('editCVeh').value;
    const vehiculo = Vehiculos.find(v => v.id == vehiculoId);
    
    if (!vehiculo) {
      alert('Debe seleccionar un veh√≠culo v√°lido');
      return;
    }
    
    const litros = parseFloat(byId('editCLitros').value);
    const precioPorLitro = parseFloat(byId('editCPPL').value);
    const costo = litros * precioPorLitro;
    
    const obj = {
      fecha: byId('editCFecha').value,
      placa: vehiculo.placa,
      litros: litros,
      costo: costo,
      kilometraje: parseInt(byId('editCOdo').value) || null,
      estacion: byId('editCProv').value || null
    };
    
    try {
      await apiPut('combustible', id, obj);
      Combustible = await apiGet('combustible');
      renderFuel();
      renderKpis();
      cerrarModal('modalEditCombustible');
      alert('‚úÖ Registro de combustible actualizado exitosamente');
    } catch (e2) {
      alert('‚ùå Error: ' + e2.message);
    }
  }
  
  function cerrarModal(modalId) {
    const modal = byId(modalId);
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  // Funci√≥n para cerrar todos los modales
  function cerrarTodosLosModales() {
    const modales = ['modalEditVehiculo', 'modalEditMantenimiento', 'modalEditCombustible', 'reportePreview'];
    modales.forEach(modalId => {
      const modal = byId(modalId);
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }
    });
    
    // Tambi√©n cerrar cualquier elemento con clase 'modal'
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.add('hidden');
      modal.style.display = 'none';
    });
  }
  
  // Funci√≥n para inicializar la aplicaci√≥n correctamente
  function inicializarApp() {
    // Asegurarse de que todos los modales est√©n cerrados
    cerrarTodosLosModales();
    
    // Resetear cualquier estado de la interfaz
    const loginScreen = byId('loginScreen');
    const mainApp = byId('mainApp');
    
    if (loginScreen) loginScreen.style.display = 'flex';
    if (mainApp) mainApp.classList.remove('logged-in');
    
    // Limpiar formularios si existen
    try {
      limpiarFormVehiculo();
    } catch(e) {}
    
    // Asegurar que el dashboard sea la pesta√±a por defecto
    setTimeout(() => {
      setTab('dashboard');
    }, 100);
  }
  
  // Funciones de eliminaci√≥n (solo para admin)
  async function eliminarVehiculo(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar veh√≠culos');
      return;
    }
    
    const vehiculo = Vehiculos.find(v => v.id == id);
    if (!vehiculo) return;
    
    if (confirm(`¬øEst√° seguro de eliminar el veh√≠culo ${vehiculo.placa}?`)) {
      try {
        await apiDelete('vehiculos', vehiculo.placa);
        Vehiculos = await apiGet('vehiculos');
        fillVehSelects();
        fillPlacaFilters();
        renderVehiculos();
        alert('‚úÖ Veh√≠culo eliminado exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }
  
  async function eliminarMantenimiento(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¬øEst√° seguro de eliminar este registro de mantenimiento?')) {
      try {
        await apiDelete('mantenimientos', id);
        Mantenimientos = await apiGet('mantenimientos');
        renderMant();
        renderKpis();
        alert('‚úÖ Registro eliminado exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }
  
  async function eliminarCombustible(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¬øEst√° seguro de eliminar este registro de combustible?')) {
      try {
        await apiDelete('combustible', id);
        Combustible = await apiGet('combustible');
        renderFuel();
        renderKpis();
        alert('‚úÖ Registro eliminado exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }

  async function eliminarRevision(id) {
    if (currentUser.role !== 'admin') {
      alert('Solo el administrador puede eliminar registros');
      return;
    }
    
    if (confirm('¬øEst√° seguro de eliminar esta revisi√≥n?')) {
      try {
        await apiDelete('revisiones', id);
        Revisiones = await apiGet('revisiones');
        renderRevisiones();
        renderKpis();
        alert('‚úÖ Revisi√≥n eliminada exitosamente');
      } catch (e) {
        alert('‚ùå Error: ' + e.message);
      }
    }
  }

  // ====== FICHA T√âCNICA ======
  
  function cargarFichaTecnica() {
    const vehiculoId = byId('fichaVehiculo').value;
    const periodo = byId('fichaPeriodo').value;
    
    if (!vehiculoId) {
      byId('fichaTecnicaContent').classList.add('hidden');
      return;
    }
    
    const vehiculo = vehById(vehiculoId);
    if (!vehiculo) return;
    
    // Calcular fecha l√≠mite seg√∫n el per√≠odo
    let fechaLimite = new Date('2000-01-01');
    if (periodo !== 'all') {
      fechaLimite = new Date();
      fechaLimite.setMonth(fechaLimite.getMonth() - parseInt(periodo));
    }
    
    // Filtrar datos por veh√≠culo y per√≠odo (usando placa en lugar de vehiculo_id)
    const mantVehiculo = Mantenimientos.filter(m => 
      m.placa === vehiculo.placa && 
      new Date(m.fecha) >= fechaLimite
    );
    
    const fuelVehiculo = Combustible.filter(f => 
      f.placa === vehiculo.placa && 
      new Date(f.fecha) >= fechaLimite
    );
    
    const revVehiculo = (Revisiones || []).filter(r => 
      r.placa === vehiculo.placa && 
      new Date(r.fecha) >= fechaLimite
    );
    
    // Informaci√≥n b√°sica (usar placa en lugar de vehiculo_id)
    const poliza = Polizas.find(p => p.placa === vehiculo.placa);
    const rtvVehiculo = RTV.find(r => r.placa === vehiculo.placa);
    
    let infoBasica = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Placa:</strong> ${vehiculo.placa}<br>
          <strong>Marca:</strong> ${vehiculo.marca}<br>
          <strong>Modelo:</strong> ${vehiculo.modelo}<br>
          <strong>A√±o:</strong> ${vehiculo.ano || vehiculo.anio}<br>
          <strong>Tipo:</strong> Veh√≠culo<br>
          <strong>Color:</strong> ${vehiculo.color || 'No especificado'}
        </div>
        <div>
          <strong>Propietario:</strong> ${vehiculo.propietario || vehiculo.dueno || 'Hotel'}<br>
          <strong>Estado:</strong> <span class="pill ok">Activo</span><br>
          <strong>Aseguradora:</strong> ${vehiculo.seguro || vehiculo.aseguradora || 'No especificada'}<br>
          <strong>P√≥liza:</strong> ${poliza ? poliza.numero_poliza : (vehiculo.poliza || 'No especificada')}<br>
          <strong>Vence P√≥liza:</strong> ${poliza ? poliza.fecha_vencimiento : 'No registrada'}<br>
          <strong>Vence RTV:</strong> ${rtvVehiculo ? rtvVehiculo.fecha_vencimiento : 'No registrada'}
        </div>
      </div>
    `;
    
    // Estad√≠sticas de rendimiento
    const totalKm = fuelVehiculo.length > 0 ? 
      Math.max(...fuelVehiculo.map(f => Number(f.kilometraje || 0))) - 
      Math.min(...fuelVehiculo.map(f => Number(f.kilometraje || 0))) : 0;
    
    const totalLitros = fuelVehiculo.reduce((a, f) => a + Number(f.litros), 0);
    const promedioKmL = totalLitros > 0 ? (totalKm / totalLitros).toFixed(1) : '0';
    
    const ultimaRevision = revVehiculo.length > 0 ? 
      revVehiculo.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0] : null;
    
    let estadisticas = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Km Recorridos (per√≠odo):</strong> ${totalKm.toLocaleString()} km<br>
          <strong>Litros Consumidos:</strong> ${totalLitros.toFixed(1)} L<br>
          <strong>Promedio Km/L:</strong> ${promedioKmL}<br>
          <strong>Mantenimientos:</strong> ${mantVehiculo.length}
        </div>
        <div>
          <strong>Revisiones:</strong> ${revVehiculo.length}<br>
          <strong>√öltima Revisi√≥n:</strong> ${ultimaRevision ? new Date(ultimaRevision.fecha).toLocaleDateString() : 'No registrada'}<br>
          <strong>Od√≥metro Actual:</strong> ${fuelVehiculo.length > 0 ? Math.max(...fuelVehiculo.map(f => Number(f.kilometraje || 0))).toLocaleString() : 'No disponible'} km
        </div>
      </div>
    `;
    
    // An√°lisis de costos (usar campos correctos del nuevo backend)
    const totalMant = mantVehiculo.reduce((a, m) => a + Number(m.costo || 0), 0);
    const totalComb = fuelVehiculo.reduce((a, f) => a + Number(f.costo || 0), 0); // Usar costo directo
    const promedioMantMensual = mantVehiculo.length > 0 ? (totalMant / parseInt(periodo === 'all' ? 12 : periodo)) : 0;
    
    let costos = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <strong>Costo Total Mantenimiento:</strong> ${fmt(totalMant)}<br>
          <strong>Costo Total Combustible:</strong> ${fmt(totalComb)}<br>
          <strong>Costo Total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(totalMant + totalComb)}</span>
        </div>
        <div>
          <strong>Promedio Mant. Mensual:</strong> ${fmt(promedioMantMensual)}<br>
          <strong>Costo por Km:</strong> ${totalKm > 0 ? fmt((totalMant + totalComb) / totalKm) : fmt(0)}<br>
          <strong>Costo por Litro Prom.:</strong> ${totalLitros > 0 ? fmt(totalComb / totalLitros) : fmt(0)}
        </div>
      </div>
    `;
    
    // Alertas
    const alertasVehiculo = (Alertas || []).filter(a => Number(a.vehiculo_id) === Number(vehiculoId));
    let alertasHtml = alertasVehiculo.length > 0 ? 
      alertasVehiculo.map(a => `<div class="pill ${a.estado === 'pendiente' ? 'warnP' : 'ok'}">${a.tipo}: ${a.dias_restantes || a.km_restantes || 'Revisar'}</div>`).join('') :
      '<div class="pill ok">Sin alertas pendientes</div>';
    
    // Historial combinado
    let historial = [];
    
    mantVehiculo.forEach(m => {
      historial.push({
        fecha: m.fecha,
        tipo: 'Mantenimiento',
        detalle: `${m.tipo} - ${fmt(m.costo)}`,
        km: m.kilometraje || '',
        observaciones: m.descripcion || ''
      });
    });
    
    fuelVehiculo.forEach(f => {
      const precioLitro = f.litros > 0 ? (Number(f.costo) / Number(f.litros)) : 0;
      // Calcular km/L para la ficha t√©cnica
      const prev = Combustible
        .filter(x=> x.placa === f.placa && new Date(x.fecha) < new Date(f.fecha))
        .sort((a,b)=> new Date(b.fecha)-new Date(a.fecha))[0];
      const dist = prev ? (Number(f.kilometraje)-Number(prev.kilometraje)) : null;
      const kmL = (dist && dist > 0 && Number(f.litros) > 0) ? (dist/Number(f.litros)).toFixed(1) : null;
      
      historial.push({
        fecha: f.fecha,
        tipo: 'Combustible',
        detalle: `${f.litros}L - ${fmt(f.costo)} (‚Ç°${Math.round(precioLitro)}/L)${kmL ? ` - ${kmL} km/L` : ''}`,
        km: f.kilometraje || '',
        observaciones: f.estacion || ''
      });
    });
    
    revVehiculo.forEach(r => {
      historial.push({
        fecha: r.fecha,
        tipo: 'Revisi√≥n',
        detalle: `Revisi√≥n T√©cnica por ${r.inspector}`,
        km: '', // Las revisiones no tienen kilometraje
        observaciones: r.observaciones || `Estados: Motor(${r.estado_motor}), Frenos(${r.estado_frenos}), Luces(${r.estado_luces})`
      });
    });
    
    historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    const historialHtml = historial.map(h => `
      <tr>
        <td>${h.fecha}</td>
        <td><span class="pill ${h.tipo === 'Mantenimiento' ? 'warnP' : h.tipo === 'Combustible' ? 'ok' : 'dangerP'}">${h.tipo}</span></td>
        <td>${h.detalle}</td>
        <td>${h.km}</td>
        <td>${h.observaciones}</td>
      </tr>
    `).join('');
    
    // Llenar el contenido
    byId('fichaInfoBasica').innerHTML = infoBasica;
    byId('fichaEstadisticas').innerHTML = estadisticas;
    byId('fichaCostos').innerHTML = costos;
    byId('fichaAlertas').innerHTML = alertasHtml;
    byId('fichaHistorial').innerHTML = `
      <table>
        <thead>
          <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Km</th><th>Observaciones</th></tr>
        </thead>
        <tbody>${historialHtml}</tbody>
      </table>
    `;
    
    byId('fichaTecnicaContent').classList.remove('hidden');
  }
  
  function exportarFichaTecnicaCompleta() {
    const vehiculoId = byId('fichaVehiculo').value;
    if (!vehiculoId) {
      alert('Seleccione un veh√≠culo primero');
      return;
    }
    
    const vehiculo = vehById(vehiculoId);
    exportFichaExcel(vehiculo.placa);
  }
  
  function previsualizarFicha() {
    alert('Vista previa de ficha t√©cnica - Esta funcionalidad se puede expandir para mostrar un reporte imprimible');
  }

  // ====== EXPORTS (XLSX) ======
  function exportFichaExcel(placa){
    const v = Vehiculos.find(x=>x.placa===placa); 
    if(!v) return alert('Placa no existe');
    
    // Usar la nueva funci√≥n mejorada
    byId('repTipo').value = 'ficha_vehiculo';
    byId('repPlaca').value = placa;
    exportReportXLSX();
  }
  function exportMantXLSX(){
    // Usar la nueva funci√≥n mejorada
    byId('repTipo').value = 'mantenimientos';
    byId('repA').value = '2000-01-01';
    byId('repB').value = today();
    byId('repPlaca').value = '';
    exportReportXLSX();
  }
  
  function exportFuelXLSX(){
    // Usar la nueva funci√≥n mejorada
    byId('repTipo').value = 'combustible';
    byId('repA').value = '2000-01-01';
    byId('repB').value = today();
    byId('repPlaca').value = '';
    exportReportXLSX();
  }
  
  function exportAlertXLSX(){
    // Generar reporte de alertas (vencimientos pr√≥ximos)
    const wb = XLSX.utils.book_new();
    const fechaActual = new Date();
    
    // Alertas de p√≥lizas
    const alertasPolizas = Polizas.map(p => {
      const dias = diasRestantes(p.fecha_vencimiento);
      return {
        'Tipo': 'P√≥liza de Seguro',
        'Placa': p.placa,
        'Detalle': `${p.aseguradora} - ${p.numero_poliza}`,
        'Fecha Vencimiento': p.fecha_vencimiento,
        'D√≠as Restantes': dias,
        'Estado': dias <= 0 ? 'VENCIDA' : dias <= 7 ? 'CR√çTICO' : dias <= 30 ? 'PR√ìXIMO A VENCER' : 'VIGENTE',
        'Prioridad': dias <= 0 ? 'üî¥ URGENTE' : dias <= 7 ? 'üü† ALTA' : dias <= 30 ? 'üü° MEDIA' : 'üü¢ BAJA'
      };
    }).filter(a => a['D√≠as Restantes'] <= 30); // Solo alertas de pr√≥ximos 30 d√≠as
    
    // Alertas de RTV
    const alertasRTV = RTV.map(r => {
      const dias = diasRestantes(r.fecha_vencimiento);
      return {
        'Tipo': 'Revisi√≥n T√©cnica Vehicular',
        'Placa': r.placa,
        'Detalle': `Cita: ${r.numero_cita}`,
        'Fecha Vencimiento': r.fecha_vencimiento,
        'D√≠as Restantes': dias,
        'Estado': dias <= 0 ? 'VENCIDA' : dias <= 7 ? 'CR√çTICO' : dias <= 30 ? 'PR√ìXIMO A VENCER' : 'VIGENTE',
        'Prioridad': dias <= 0 ? 'üî¥ URGENTE' : dias <= 7 ? 'üü† ALTA' : dias <= 30 ? 'üü° MEDIA' : 'üü¢ BAJA'
      };
    }).filter(a => a['D√≠as Restantes'] <= 30);
    
    // Combinar todas las alertas
    const todasAlertas = [...alertasPolizas, ...alertasRTV]
      .sort((a, b) => a['D√≠as Restantes'] - b['D√≠as Restantes']);
    
    if(todasAlertas.length === 0) {
      alert('No hay alertas de vencimiento en los pr√≥ximos 30 d√≠as');
      return;
    }
    
    const ws = XLSX.utils.json_to_sheet(todasAlertas);
    ws['!cols'] = [
      {wch: 25}, // Tipo
      {wch: 12}, // Placa
      {wch: 25}, // Detalle
      {wch: 15}, // Fecha Venc
      {wch: 10}, // D√≠as
      {wch: 18}, // Estado
      {wch: 12}  // Prioridad
    ];
    
    // Agregar t√≠tulo
    const fechaGeneracion = new Date().toLocaleString('es-ES');
    XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE ALERTAS Y VENCIMIENTOS - Generado: ${fechaGeneracion}`]], {origin: "A1"});
    
    XLSX.utils.book_append_sheet(wb, ws, 'Alertas');
    XLSX.writeFile(wb, `alertas_vencimientos_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
    
    alert(`‚úÖ Reporte de alertas exportado con ${todasAlertas.length} elementos`);
  }
  // ====== REPORTES MEJORADOS ======
  
  function actualizarConfigReporte() {
    const tipo = byId('repTipo').value;
    const configDiv = byId('repConfigAdicional');
    
    // Limpiar configuraci√≥n anterior
    configDiv.innerHTML = '';
    
    // Agregar configuraciones espec√≠ficas seg√∫n el tipo
    if (tipo === 'ficha_vehiculo') {
      configDiv.innerHTML = `
        <div class="form-group">
          <label>Per√≠odo de An√°lisis</label>
          <select id="repPeriodo">
            <option value="3">√öltimos 3 meses</option>
            <option value="6">√öltimos 6 meses</option>
            <option value="12">√öltimo a√±o</option>
            <option value="all">Todo el historial</option>
          </select>
        </div>
      `;
    } else if (tipo === 'resumen_costos') {
      configDiv.innerHTML = `
        <div class="form-group">
          <label>Agrupar por</label>
          <select id="repAgrupar">
            <option value="vehiculo">Veh√≠culo</option>
            <option value="mes">Mes</option>
            <option value="tipo">Tipo de Gasto</option>
          </select>
        </div>
      `;
    }
  }
  
  function previsualizarReporte() {
    const tipo = byId('repTipo').value;
    const placa = byId('repPlaca').value;
    const fechaA = byId('repA').value || '2000-01-01';
    const fechaB = byId('repB').value || today();
    
    let contenido = '';
    let titulo = '';
    
    // Generar contenido seg√∫n el tipo de reporte
    switch(tipo) {
      case 'mantenimientos':
        titulo = 'Reporte de Mantenimientos';
        contenido = generarReporteMantenimientos(placa, fechaA, fechaB);
        break;
      case 'combustible':
        titulo = 'Reporte de Combustible';
        contenido = generarReporteCombustible(placa, fechaA, fechaB);
        break;
      case 'revisiones':
        titulo = 'Reporte de Revisiones';
        contenido = generarReporteRevisiones(placa, fechaA, fechaB);
        break;
      case 'polizas_rtv':
        titulo = 'Reporte de P√≥lizas y RTV';
        contenido = generarReportePolizasRTV();
        break;
      case 'ficha_vehiculo':
        if (!placa) {
          alert('Seleccione un veh√≠culo para la ficha t√©cnica');
          return;
        }
        titulo = `Ficha T√©cnica - ${placa}`;
        contenido = generarFichaTecnicaCompleta(placa);
        break;
      case 'resumen_costos':
        titulo = 'Resumen de Costos';
        contenido = generarResumenCostos(placa, fechaA, fechaB);
        break;
      case 'alertas':
        titulo = 'Alertas y Vencimientos';
        contenido = generarReporteAlertas();
        break;
    }
    
    // Mostrar en el modal de vista previa
    const reporteContent = byId('reporteContent');
    reporteContent.innerHTML = `
      <div class="report-header">
        <div class="report-title">${titulo}</div>
        <div class="report-date">Generado el ${new Date().toLocaleDateString('es-CR')}</div>
        ${placa ? `<div style="margin-top:8px">Veh√≠culo: <strong>${placa}</strong></div>` : ''}
        ${fechaA !== '2000-01-01' ? `<div>Per√≠odo: ${fechaA} - ${fechaB}</div>` : ''}
      </div>
      ${contenido}
    `;
    
    byId('reportePreview').classList.remove('hidden');
  }
  
  function generarReporteMantenimientos(placa, fechaA, fechaB) {
    const data = Mantenimientos.filter(x=> 
      x.fecha >= fechaA && x.fecha <= fechaB && 
      (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
    );
    
    const total = data.reduce((a, m) => a + Number(m.costo || 0), 0);
    
    const tablaHtml = `
      <h4>üìä Resumen</h4>
      <p><strong>Total de registros:</strong> ${data.length}</p>
      <p><strong>Costo total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(total)}</span></p>
      
      <h4>üìã Detalle</h4>
      <table>
        <thead>
          <tr><th>Placa</th><th>Fecha</th><th>Tipo</th><th>Costo</th><th>Km</th><th>Observaciones</th></tr>
        </thead>
        <tbody>
          ${data.map(m => `
            <tr>
              <td>${vehById(m.vehiculo_id)?.placa||''}</td>
              <td>${m.fecha}</td>
              <td>${m.tipo}</td>
              <td><strong>${fmt(m.costo)}</strong></td>
              <td>${m.km_actual || ''}</td>
              <td>${m.observaciones || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    return data.length > 0 ? tablaHtml : '<p>No se encontraron registros para el per√≠odo seleccionado.</p>';
  }
  
  function generarReporteCombustible(placa, fechaA, fechaB) {
    const data = Combustible.filter(x=> 
      x.fecha >= fechaA && x.fecha <= fechaB && 
      (!placa || (vehById(x.vehiculo_id)?.placa||'') === placa)
    );
    
    const totalCosto = data.reduce((a, f) => a + (Number(f.litros) * Number(f.precio_por_litro)), 0);
    const totalLitros = data.reduce((a, f) => a + Number(f.litros), 0);
    
    const tablaHtml = `
      <h4>üìä Resumen</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div>
          <p><strong>Total de cargas:</strong> ${data.length}</p>
          <p><strong>Total litros:</strong> ${totalLitros.toFixed(1)} L</p>
        </div>
        <div>
          <p><strong>Costo total:</strong> <span style="color:var(--primary);font-weight:bold">${fmt(totalCosto)}</span></p>
          <p><strong>Precio promedio/L:</strong> ${totalLitros > 0 ? fmt(totalCosto/totalLitros) : fmt(0)}</p>
        </div>
      </div>
      
      <h4>üìã Detalle</h4>
      <table>
        <thead>
          <tr><th>Placa</th><th>Fecha</th><th>Litros</th><th>‚Ç°/L</th><th>Costo</th><th>Od√≥metro</th><th>Proveedor</th></tr>
        </thead>
        <tbody>
          ${data.map(f => `
            <tr>
              <td>${vehById(f.vehiculo_id)?.placa||''}</td>
              <td>${f.fecha}</td>
              <td>${f.litros}</td>
              <td>${fmt(f.precio_por_litro)}</td>
              <td><strong>${fmt(Number(f.litros) * Number(f.precio_por_litro))}</strong></td>
              <td>${f.odometro_km} km</td>
              <td>${f.proveedor || ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
    return data.length > 0 ? tablaHtml : '<p>No se encontraron registros para el per√≠odo seleccionado.</p>';
  }
  
  function cerrarPreviewReporte() {
    byId('reportePreview').classList.add('hidden');
  }
  
  function imprimirReporte() {
    window.print();
  }
  
  function enviarReporteEmail() {
    alert('Funcionalidad de env√≠o por email - Se puede integrar con un servicio de email');
  }
  
  function exportReportXLSX(){
    const tipo = byId('repTipo').value;
    const placa = byId('repPlaca').value||'';
    const a = byId('repA').value||'2000-01-01';
    const b = byId('repB').value||today();
    const wb = XLSX.utils.book_new();
    
    // Informaci√≥n de encabezado para todos los reportes
    const fechaGeneracion = new Date().toLocaleString('es-ES');
    const rangoFechas = placa ? `Veh√≠culo: ${placa} | ` : 'Todos los veh√≠culos | ';
    const titulo = rangoFechas + `Per√≠odo: ${a} a ${b} | Generado: ${fechaGeneracion}`;

    if(tipo==='mantenimientos'){
      // Filtrar y mapear datos de mantenimientos con la estructura correcta del nuevo backend
      const filtered = Mantenimientos.filter(x=> 
        x.fecha >= a && 
        x.fecha <= b && 
        (!placa || x.placa === placa)
      );
      
      const data = filtered.map(x=>({
        'Placa': x.placa || '',
        'Fecha': x.fecha,
        'Tipo de Mantenimiento': x.tipo || '',
        'Descripci√≥n': x.descripcion || '',
        'Costo (‚Ç°)': Number(x.costo) || 0,
        'Kilometraje': x.kilometraje || '',
        'Fecha de Registro': x.created_at ? new Date(x.created_at).toLocaleDateString('es-ES') : ''
      }));
      
      // Calcular totales
      const costoTotal = data.reduce((sum, item) => sum + Number(item['Costo (‚Ç°)']), 0);
      const cantidadServicios = data.length;
      
      // Agregar fila de resumen
      data.push({});
      data.push({
        'Placa': 'RESUMEN',
        'Fecha': `Total de servicios: ${cantidadServicios}`,
        'Tipo de Mantenimiento': '',
        'Descripci√≥n': '',
        'Costo (‚Ç°)': costoTotal,
        'Kilometraje': 'COSTO TOTAL',
        'Fecha de Registro': ''
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Formato de columnas
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Fecha
        {wch: 20}, // Tipo
        {wch: 30}, // Descripci√≥n
        {wch: 15}, // Costo
        {wch: 12}, // Kilometraje
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar t√≠tulo en la primera fila
      XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE MANTENIMIENTOS - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Mantenimientos');
      XLSX.writeFile(wb, `mantenimientos_${placa || 'todos'}_${a}_${b}.xlsx`);
      return;
    }
    
    if(tipo==='combustible'){
      // Filtrar y mapear datos de combustible con la estructura correcta
      const filtered = Combustible.filter(x=> 
        x.fecha >= a && 
        x.fecha <= b && 
        (!placa || x.placa === placa)
      );
      
      // Ordenar primero por placa y fecha para calcular km/L correctamente
      const sortedFiltered = filtered.sort((a,b) => {
        if (a.placa !== b.placa) return a.placa.localeCompare(b.placa);
        return new Date(a.fecha) - new Date(b.fecha);
      });
      
      const data = sortedFiltered.map((x, index) =>{
        const precioLitro = x.litros > 0 ? (Number(x.costo) / Number(x.litros)) : 0;
        
        // Calcular km/L correctamente
        // Buscar el registro anterior de la misma placa
        let kmL = null;
        for (let i = index - 1; i >= 0; i--) {
          const prev = sortedFiltered[i];
          if (prev.placa === x.placa && prev.kilometraje && x.kilometraje) {
            const kmActual = Number(x.kilometraje);
            const kmAnterior = Number(prev.kilometraje);
            const litros = Number(x.litros);
            
            if (kmActual > kmAnterior && litros > 0) {
              const distancia = kmActual - kmAnterior;
              kmL = (distancia / litros).toFixed(2);
            }
            break; // Solo tomar el registro inmediatamente anterior
          }
        }
        
        return {
          'Placa': x.placa || '',
          'Fecha': x.fecha,
          'Litros': Number(x.litros) || 0,
          'Precio/Litro (‚Ç°)': Math.round(precioLitro * 100) / 100,
          'Costo Total (‚Ç°)': Number(x.costo) || 0,
          'Od√≥metro (km)': x.kilometraje || '',
          'Km/L': kmL || 'N/A',
          'Estaci√≥n': x.estacion || '',
          'Fecha de Registro': x.created_at ? new Date(x.created_at).toLocaleDateString('es-ES') : ''
        };
      });
      
      // Calcular totales y estad√≠sticas
      const litrosTotales = data.reduce((sum, item) => sum + Number(item['Litros']), 0);
      const costoTotal = data.reduce((sum, item) => sum + Number(item['Costo Total (‚Ç°)']), 0);
      const promedioPrecioLitro = litrosTotales > 0 ? (costoTotal / litrosTotales) : 0;
      const cantidadCargas = data.length;
      
      // Agregar filas de resumen
      data.push({});
      data.push({
        'Placa': 'RESUMEN',
        'Fecha': `Total cargas: ${cantidadCargas}`,
        'Litros': litrosTotales,
        'Precio/Litro (‚Ç°)': Math.round(promedioPrecioLitro * 100) / 100,
        'Costo Total (‚Ç°)': costoTotal,
        'Od√≥metro (km)': 'TOTALES',
        'Estaci√≥n': '',
        'Fecha de Registro': ''
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Formato de columnas
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Fecha
        {wch: 10}, // Litros
        {wch: 15}, // Precio/Litro
        {wch: 15}, // Costo Total
        {wch: 12}, // Od√≥metro
        {wch: 10}, // Km/L
        {wch: 15}, // Estaci√≥n
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar t√≠tulo
      XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE COMBUSTIBLE - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Combustible');
      XLSX.writeFile(wb, `combustible_${placa || 'todos'}_${a}_${b}.xlsx`);
      return;
    }
    
    if(tipo==='revisiones'){
      // Filtrar y mapear datos de revisiones con la estructura correcta
      const filtered = Revisiones.filter(x=> 
        (!placa || x.placa === placa) && 
        x.fecha >= a && 
        x.fecha <= b
      );
      
      const data = filtered.map(x=>({
        'Placa': x.placa || '',
        'Fecha': x.fecha,
        'Inspector': x.inspector || '',
        'Estado Motor': x.estado_motor || '',
        'Estado Frenos': x.estado_frenos || '',
        'Estado Luces': x.estado_luces || '',
        'Estado Llantas': x.estado_llantas || '',
        'Estado Carrocer√≠a': x.estado_carroceria || '',
        'Aprobado': x.aprobado ? 'S√ç' : 'NO',
        'Observaciones': x.observaciones || '',
        'Fecha de Registro': x.created_at ? new Date(x.created_at).toLocaleDateString('es-ES') : ''
      }));
      
      // Estad√≠sticas
      const totalRevisiones = data.length;
      const aprobadas = data.filter(x => x.Aprobado === 'S√ç').length;
      const reprobadas = totalRevisiones - aprobadas;
      
      // Agregar resumen
      data.push({});
      data.push({
        'Placa': 'RESUMEN',
        'Fecha': `Total: ${totalRevisiones}`,
        'Inspector': `Aprobadas: ${aprobadas}`,
        'Estado Motor': `Reprobadas: ${reprobadas}`,
        'Estado Frenos': '',
        'Estado Luces': '',
        'Estado Llantas': '',
        'Estado Carrocer√≠a': '',
        'Aprobado': '',
        'Observaciones': '',
        'Fecha de Registro': ''
      });
      
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Formato de columnas
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Fecha
        {wch: 15}, // Inspector
        {wch: 12}, // Estado Motor
        {wch: 12}, // Estado Frenos
        {wch: 12}, // Estado Luces
        {wch: 12}, // Estado Llantas
        {wch: 15}, // Estado Carrocer√≠a
        {wch: 10}, // Aprobado
        {wch: 30}, // Observaciones
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar t√≠tulo
      XLSX.utils.sheet_add_aoa(ws, [[`REPORTE DE REVISIONES - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Revisiones');
      XLSX.writeFile(wb, `revisiones_${placa || 'todos'}_${a}_${b}.xlsx`);
      return;
    }
    
    if(tipo==='polizas_rtv'){
      // Datos de P√≥lizas
      const polizasData = Polizas.map(p=>{
        const diasVencimiento = diasRestantes(p.fecha_vencimiento);
        return {
          'Placa': p.placa || '',
          'Aseguradora': p.aseguradora || '',
          'N√∫mero P√≥liza': p.numero_poliza || '',
          'Fecha Inicio': p.fecha_inicio || '',
          'Fecha Vencimiento': p.fecha_vencimiento || '',
          'Tipo Cobertura': p.tipo_cobertura || '',
          'Estado': p.estado || '',
          'D√≠as al Vencimiento': diasVencimiento,
          'Sem√°foro': diasVencimiento <= 7 ? 'üî¥ CR√çTICO' : diasVencimiento <= 30 ? 'üü° PR√ìXIMO' : 'üü¢ VIGENTE',
          'Fecha de Registro': p.created_at ? new Date(p.created_at).toLocaleDateString('es-ES') : ''
        };
      });
      
      // Datos de RTV
      const rtvData = RTV.map(r=>{
        const diasVencimiento = diasRestantes(r.fecha_vencimiento);
        return {
          'Placa': r.placa || '',
          'N√∫mero Cita': r.numero_cita || '',
          'Fecha Vencimiento': r.fecha_vencimiento || '',
          'Estado': r.estado || '',
          'D√≠as al Vencimiento': diasVencimiento,
          'Sem√°foro': diasVencimiento <= 7 ? 'üî¥ CR√çTICO' : diasVencimiento <= 30 ? 'üü° PR√ìXIMO' : 'üü¢ VIGENTE',
          'Observaciones': r.observaciones || '',
          'Fecha de Registro': r.created_at ? new Date(r.created_at).toLocaleDateString('es-ES') : ''
        };
      });
      
      // Crear hojas
      const wsP = XLSX.utils.json_to_sheet(polizasData);
      const wsR = XLSX.utils.json_to_sheet(rtvData);
      
      // Formato de columnas para P√≥lizas
      wsP['!cols'] = [
        {wch: 12}, // Placa
        {wch: 15}, // Aseguradora
        {wch: 15}, // N√∫mero
        {wch: 12}, // Fecha Inicio
        {wch: 12}, // Fecha Venc
        {wch: 12}, // Tipo
        {wch: 10}, // Estado
        {wch: 8},  // D√≠as
        {wch: 12}, // Sem√°foro
        {wch: 15}  // Fecha Registro
      ];
      
      // Formato de columnas para RTV
      wsR['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Cita
        {wch: 12}, // Fecha Venc
        {wch: 10}, // Estado
        {wch: 8},  // D√≠as
        {wch: 12}, // Sem√°foro
        {wch: 25}, // Observaciones
        {wch: 15}  // Fecha Registro
      ];
      
      // Agregar t√≠tulos
      XLSX.utils.sheet_add_aoa(wsP, [[`REPORTE DE P√ìLIZAS - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsR, [[`REPORTE DE RTV - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, wsP, 'P√≥lizas');
      XLSX.utils.book_append_sheet(wb, wsR, 'RTV');
      XLSX.writeFile(wb, `polizas_rtv_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='ficha_vehiculo' && placa){
      // Reporte completo por veh√≠culo
      const vehiculo = Vehiculos.find(v => v.placa === placa);
      if(!vehiculo){
        alert('Veh√≠culo no encontrado');
        return;
      }
      
      // Datos del veh√≠culo
      const vehiculoData = [{
        'Campo': 'Placa',
        'Valor': vehiculo.placa
      }, {
        'Campo': 'Marca',
        'Valor': vehiculo.marca
      }, {
        'Campo': 'Modelo',
        'Valor': vehiculo.modelo
      }, {
        'Campo': 'A√±o',
        'Valor': vehiculo.ano
      }, {
        'Campo': 'Color',
        'Valor': vehiculo.color || 'No especificado'
      }, {
        'Campo': 'Propietario',
        'Valor': vehiculo.propietario || 'Hotel'
      }];
      
      // Mantenimientos del veh√≠culo
      const mantVehiculo = Mantenimientos.filter(m => m.placa === placa);
      
      // Combustible del veh√≠culo
      const fuelVehiculo = Combustible.filter(f => f.placa === placa);
      
      // Revisiones del veh√≠culo
      const revVehiculo = Revisiones.filter(r => r.placa === placa);
      
      // P√≥lizas del veh√≠culo
      const polizaVehiculo = Polizas.filter(p => p.placa === placa);
      
      // RTV del veh√≠culo
      const rtvVehiculo = RTV.filter(r => r.placa === placa);
      
      // Crear m√∫ltiples hojas
      const wsVeh = XLSX.utils.json_to_sheet(vehiculoData);
      wsVeh['!cols'] = [{wch: 20}, {wch: 30}];
      
      XLSX.utils.book_append_sheet(wb, wsVeh, 'Informaci√≥n General');
      
      if(mantVehiculo.length > 0) {
        const wsMant = XLSX.utils.json_to_sheet(mantVehiculo.map(m => ({
          'Fecha': m.fecha,
          'Tipo': m.tipo,
          'Descripci√≥n': m.descripcion,
          'Costo': m.costo,
          'Kilometraje': m.kilometraje
        })));
        wsMant['!cols'] = [{wch: 12}, {wch: 18}, {wch: 30}, {wch: 12}, {wch: 12}];
        XLSX.utils.book_append_sheet(wb, wsMant, 'Mantenimientos');
      }
      
      if(fuelVehiculo.length > 0) {
        const wsFuel = XLSX.utils.json_to_sheet(fuelVehiculo.map(f => ({
          'Fecha': f.fecha,
          'Litros': f.litros,
          'Costo': f.costo,
          'Kilometraje': f.kilometraje,
          'Estaci√≥n': f.estacion
        })));
        wsFuel['!cols'] = [{wch: 12}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15}];
        XLSX.utils.book_append_sheet(wb, wsFuel, 'Combustible');
      }
      
      if(revVehiculo.length > 0) {
        const wsRev = XLSX.utils.json_to_sheet(revVehiculo.map(r => ({
          'Fecha': r.fecha,
          'Inspector': r.inspector,
          'Motor': r.estado_motor,
          'Frenos': r.estado_frenos,
          'Luces': r.estado_luces,
          'Llantas': r.estado_llantas,
          'Carrocer√≠a': r.estado_carroceria,
          'Aprobado': r.aprobado ? 'S√ç' : 'NO',
          'Observaciones': r.observaciones
        })));
        wsRev['!cols'] = [{wch: 12}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}, {wch: 8}, {wch: 30}];
        XLSX.utils.book_append_sheet(wb, wsRev, 'Revisiones');
      }
      
      XLSX.writeFile(wb, `ficha_completa_${placa}_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='resumen_costos'){
      // Reporte de resumen de costos por veh√≠culo y por tipo
      const vehiculosData = Vehiculos.map(vehiculo => {
        const mantVehiculo = Mantenimientos.filter(m => m.placa === vehiculo.placa);
        const fuelVehiculo = Combustible.filter(f => f.placa === vehiculo.placa);
        
        const costoMantenimiento = mantVehiculo.reduce((sum, m) => sum + Number(m.costo || 0), 0);
        const costosCombustible = fuelVehiculo.reduce((sum, f) => sum + Number(f.costo || 0), 0);
        const totalLitros = fuelVehiculo.reduce((sum, f) => sum + Number(f.litros || 0), 0);
        
        return {
          'Placa': vehiculo.placa,
          'Marca': vehiculo.marca,
          'Modelo': vehiculo.modelo,
          'A√±o': vehiculo.ano,
          'Costo Mantenimiento (‚Ç°)': costoMantenimiento,
          'Costo Combustible (‚Ç°)': costosCombustible,
          'Total Litros': totalLitros,
          'Costo Total (‚Ç°)': costoMantenimiento + costosCombustible,
          'Servicios Mantenimiento': mantVehiculo.length,
          'Cargas Combustible': fuelVehiculo.length
        };
      });
      
      // Agregar totales
      const totalMantenimiento = vehiculosData.reduce((sum, v) => sum + v['Costo Mantenimiento (‚Ç°)'], 0);
      const totalCombustible = vehiculosData.reduce((sum, v) => sum + v['Costo Combustible (‚Ç°)'], 0);
      const totalLitrosFlota = vehiculosData.reduce((sum, v) => sum + v['Total Litros'], 0);
      
      vehiculosData.push({});
      vehiculosData.push({
        'Placa': 'TOTALES FLOTA',
        'Marca': `${Vehiculos.length} veh√≠culos`,
        'Modelo': '',
        'A√±o': '',
        'Costo Mantenimiento (‚Ç°)': totalMantenimiento,
        'Costo Combustible (‚Ç°)': totalCombustible,
        'Total Litros': totalLitrosFlota,
        'Costo Total (‚Ç°)': totalMantenimiento + totalCombustible,
        'Servicios Mantenimiento': Mantenimientos.length,
        'Cargas Combustible': Combustible.length
      });
      
      const ws = XLSX.utils.json_to_sheet(vehiculosData);
      ws['!cols'] = [
        {wch: 12}, // Placa
        {wch: 12}, // Marca
        {wch: 15}, // Modelo
        {wch: 8},  // A√±o
        {wch: 18}, // Costo Mant
        {wch: 18}, // Costo Comb
        {wch: 12}, // Litros
        {wch: 15}, // Total
        {wch: 12}, // Servicios
        {wch: 12}  // Cargas
      ];
      
      XLSX.utils.sheet_add_aoa(ws, [[`RESUMEN DE COSTOS POR VEH√çCULO - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, ws, 'Resumen Costos');
      XLSX.writeFile(wb, `resumen_costos_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='resumen_general'){
      // Reporte general de la flota
      const totalVehiculos = Vehiculos.length;
      const totalMantenimientos = Mantenimientos.length;
      const totalCombustible = Combustible.length;
      const totalRevisiones = Revisiones.length;
      const totalPolizas = Polizas.length;
      const totalRTV = RTV.length;
      
      // Estad√≠sticas generales
      const estadisticasGenerales = [
        { 'Concepto': 'Total de Veh√≠culos', 'Cantidad': totalVehiculos, 'Detalle': '' },
        { 'Concepto': 'Servicios de Mantenimiento', 'Cantidad': totalMantenimientos, 'Detalle': 'Registros totales' },
        { 'Concepto': 'Cargas de Combustible', 'Cantidad': totalCombustible, 'Detalle': 'Registros totales' },
        { 'Concepto': 'Revisiones T√©cnicas', 'Cantidad': totalRevisiones, 'Detalle': 'Inspecciones realizadas' },
        { 'Concepto': 'P√≥lizas de Seguro', 'Cantidad': totalPolizas, 'Detalle': 'Activas y vencidas' },
        { 'Concepto': 'RTV Registradas', 'Cantidad': totalRTV, 'Detalle': 'Revisiones t√©cnicas vehiculares' }
      ];
      
      // Costos totales
      const costoTotalMant = Mantenimientos.reduce((sum, m) => sum + Number(m.costo || 0), 0);
      const costoTotalComb = Combustible.reduce((sum, f) => sum + Number(f.costo || 0), 0);
      const litrosTotales = Combustible.reduce((sum, f) => sum + Number(f.litros || 0), 0);
      
      const resumenCostos = [
        { 'Concepto': 'Costo Total Mantenimientos', 'Monto (‚Ç°)': costoTotalMant, 'Observaciones': 'Todos los servicios registrados' },
        { 'Concepto': 'Costo Total Combustible', 'Monto (‚Ç°)': costoTotalComb, 'Observaciones': `${litrosTotales} litros totales` },
        { 'Concepto': 'COSTO TOTAL OPERACI√ìN', 'Monto (‚Ç°)': costoTotalMant + costoTotalComb, 'Observaciones': 'Mantenimiento + Combustible' }
      ];
      
      // Veh√≠culos por marca
      const vehiculosPorMarca = {};
      Vehiculos.forEach(v => {
        vehiculosPorMarca[v.marca] = (vehiculosPorMarca[v.marca] || 0) + 1;
      });
      
      const resumenMarcas = Object.entries(vehiculosPorMarca).map(([marca, cantidad]) => ({
        'Marca': marca,
        'Cantidad': cantidad,
        'Porcentaje': Math.round((cantidad / totalVehiculos) * 100) + '%'
      }));
      
      // Alertas de vencimientos
      const polizasProximas = Polizas.filter(p => diasRestantes(p.fecha_vencimiento) <= 30).length;
      const rtvProximas = RTV.filter(r => diasRestantes(r.fecha_vencimiento) <= 30).length;
      
      const alertasVencimiento = [
        { 'Tipo': 'P√≥lizas pr√≥ximas a vencer (30 d√≠as)', 'Cantidad': polizasProximas, 'Estado': polizasProximas > 0 ? '‚ö†Ô∏è ATENCI√ìN' : '‚úÖ OK' },
        { 'Tipo': 'RTV pr√≥ximos a vencer (30 d√≠as)', 'Cantidad': rtvProximas, 'Estado': rtvProximas > 0 ? '‚ö†Ô∏è ATENCI√ìN' : '‚úÖ OK' }
      ];
      
      // Crear hojas
      const wsGeneral = XLSX.utils.json_to_sheet(estadisticasGenerales);
      const wsCostos = XLSX.utils.json_to_sheet(resumenCostos);
      const wsMarcas = XLSX.utils.json_to_sheet(resumenMarcas);
      const wsAlertas = XLSX.utils.json_to_sheet(alertasVencimiento);
      
      // Formato de columnas
      wsGeneral['!cols'] = [{wch: 30}, {wch: 12}, {wch: 25}];
      wsCostos['!cols'] = [{wch: 30}, {wch: 18}, {wch: 30}];
      wsMarcas['!cols'] = [{wch: 15}, {wch: 12}, {wch: 12}];
      wsAlertas['!cols'] = [{wch: 35}, {wch: 12}, {wch: 15}];
      
      // Agregar t√≠tulos
      XLSX.utils.sheet_add_aoa(wsGeneral, [[`ESTAD√çSTICAS GENERALES - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsCostos, [[`RESUMEN DE COSTOS - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsMarcas, [[`VEH√çCULOS POR MARCA - ${titulo}`]], {origin: "A1"});
      XLSX.utils.sheet_add_aoa(wsAlertas, [[`ALERTAS DE VENCIMIENTO - ${titulo}`]], {origin: "A1"});
      
      XLSX.utils.book_append_sheet(wb, wsGeneral, 'Estad√≠sticas Generales');
      XLSX.utils.book_append_sheet(wb, wsCostos, 'Resumen Costos');
      XLSX.utils.book_append_sheet(wb, wsMarcas, 'Veh√≠culos por Marca');
      XLSX.utils.book_append_sheet(wb, wsAlertas, 'Alertas Vencimiento');
      
      XLSX.writeFile(wb, `resumen_general_flota_${fechaGeneracion.replace(/[\/\s:]/g, '_')}.xlsx`);
      return;
    }
    
    if(tipo==='alertas'){
      // Usar la funci√≥n de alertas existente
      exportAlertXLSX();
      return;
    }
    
    alert('‚úÖ Reporte exportado exitosamente');
  }

  // ====== TESTS ======
  function tlog(msg, ok=true){ const el=byId('testOut'); if(!el) return; const div=document.createElement('div'); div.className= ok? 'pass' : 'fail'; div.textContent = (ok?'‚úî ':'‚úñ ')+msg; el.appendChild(div); }
  function clearTests(){ const el=byId('testOut'); if(el) el.innerHTML=''; }
  async function runTests(kind){ clearTests(); try{
      if(kind==='api'){
        tlog('URL API configurada: ' + API);
        try {
          const response = await fetch(API + '/docs');
          tlog('API responde (docs): ' + response.status, response.ok);
        } catch(e) {
          tlog('Error conectando a API docs: ' + e.message, false);
        }
        
        try {
          const response = await fetch(API + '/vehiculos');
          tlog('Endpoint /vehiculos responde: ' + response.status, response.ok);
          if (response.ok) {
            const data = await response.json();
            tlog('Respuesta JSON v√°lida', !!data);
            tlog('Campo success existe', 'success' in data);
            tlog('Success = true', data.success === true);
          }
        } catch(e) {
          tlog('Error en /vehiculos: ' + e.message, false);
        }
      }
      if(kind==='get'){ const data = await apiGet('Vehiculos'); tlog('GET Vehiculos devolvi√≥ array', Array.isArray(data)); tlog('GET no lanz√≥ error', true); }
      if(kind==='ui'){ fillVehSelects(); const m = byId('mVeh'); tlog('Select mVeh existe', !!m); tlog('Select mVeh poblado (si hay veh√≠culos)', m && m.options.length>=0); }
      if(kind==='core'){
        tlog('Funci√≥n setTab definida', typeof setTab==='function');
        try{ setTab(localStorage.getItem('tab') || 'dashboard'); tlog('setTab ejecuta sin throw', true); }catch(e){ tlog('setTab lanz√≥ excepci√≥n: '+e.message, false); }
        tlog('Librer√≠a XLSX cargada', !!window.XLSX);
        tlog('exportReportXLSX existe', typeof exportReportXLSX==='function');
        tlog('refreshHints existe', typeof refreshHints==='function');
      }
      if(kind==='auto'){
        const old = window.alert; let lastMsg=''; window.alert = (m)=>{ lastMsg=String(m||''); };
        byId('mTipo').value='cambio_aceite'; byId('mKm').value='12000'; byId('mProx').value=''; autoProximoKm();
        tlog('autoProximoKm suma 5000 (12000‚Üí17000)', byId('mProx').value==='17000');
        byId('mTipo').value='llantas'; byId('mKm').value='100'; byId('mProx').value=''; lastMsg=''; autoProximoKm();
        tlog('autoProximoKm alerta cuando tipo ‚â† cambio_aceite', lastMsg.toLowerCase().includes('cambio de aceite'));
        byId('mTipo').value='cambio_aceite'; byId('mKm').value=''; lastMsg=''; autoProximoKm();
        tlog('autoProximoKm alerta si km vac√≠o', lastMsg.toLowerCase().includes('km'));
        window.alert = old;
      }
      if(kind==='bit'){
        byId('bVeh').selectedIndex=0; byId('fltBitPlaca').value=''; resetBitacoraForm();
        if(Vehiculos.length){ byId('bVeh').value = String(Vehiculos[0].id); const placa = Vehiculos[0].placa; const flt = byId('fltBitPlaca'); flt.value = placa; tlog('Filtro Bit√°cora se puede fijar por placa', flt.value===placa); resetBitacoraForm(); tlog('resetBitacoraForm limpia campos', !byId('bCond').value && !byId('bKm').value && byId('bNivel').value==='lleno'); } else { tlog('No hay veh√≠culos de ejemplo para probar filtro Bit√°cora', false); }
      }
    }catch(err){ tlog('Error en test: '+err.message, false); }
  }

  // ====== INIT ======
  window.addEventListener('DOMContentLoaded', ()=>{
    // Inicializar la aplicaci√≥n correctamente
    inicializarApp();
    
    // Event listeners para el login
    document.getElementById('loginPassword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && selectedRole) {
        attemptLogin();
      }
    });
    
    // Inicializar fechas por defecto en reportes
    const hoy = today();
    const tresMesesAtras = new Date();
    tresMesesAtras.setMonth(tresMesesAtras.getMonth() - 3);
    
    setTimeout(() => {
      const fechaA = byId('repA');
      const fechaB = byId('repB');
      if (fechaA) fechaA.value = tresMesesAtras.toISOString().slice(0,10);
      if (fechaB) fechaB.value = hoy;
      
      // Event listeners para hints y c√°lculos
      ['bVeh','cVeh','mVeh','rVeh','rtvVeh'].forEach(id=>{ 
        const el=byId(id); 
        if(el){ el.addEventListener('change', refreshHints); }
      });
      
      ['cOdo','cLitros','cFecha'].forEach(id=>{ 
        const el=byId(id); 
        if(el){ 
          el.addEventListener('input', calcKmLEstimado); 
          el.addEventListener('change', calcKmLEstimado); 
        }
      });
      
      // Inicializar campos de mantenimiento
      toggleMaintenanceFields();
      
      // UX: Enter en buscador = buscar
      const q = byId('qPlaca');
      if(q){ 
        q.addEventListener('keydown', (e)=>{ 
          if(e.key==='Enter'){ 
            e.preventDefault(); 
            buscarPlaca(); 
          } 
        }); 
      }
      
      // Cerrar modales al hacer click fuera o con ESC
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.classList.add('hidden');
        }
      });
      
      // Cerrar modales con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          cerrarTodosLosModales();
        }
      });
      
      // Asegurar que los botones de cerrar funcionen
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('close-btn') || e.target.textContent === '√ó') {
          const modal = e.target.closest('.modal');
          if (modal) {
            modal.classList.add('hidden');
          }
        }
      });
      
    }, 100);
  });
  
  // ===== FUNCIONES DE CONFIGURACI√ìN DE EMAIL =====
  
  async function cargarConfigEmail() {
    try {
      const response = await fetch(`${API}/config/email`);
      const data = await response.json();
      
      if (data.success) {
        const config = data.config;
        
        // Actualizar campos del formulario
        if (byId('configSenderEmail')) byId('configSenderEmail').value = config.sender_email || '';
        if (byId('configSmtpPort')) byId('configSmtpPort').value = config.smtp_port || 587;
        
        // Determinar proveedor basado en servidor SMTP
        let provider = 'custom';
        if (config.smtp_server === 'smtp.gmail.com') provider = 'gmail';
        else if (config.smtp_server === 'smtp-mail.outlook.com') provider = 'outlook';
        else if (config.smtp_server === 'smtp.mail.yahoo.com') provider = 'yahoo';
        
        if (byId('configProvider')) byId('configProvider').value = provider;
        
        // Mostrar campos personalizados si es necesario
        toggleCustomServerFields();
        
        // Actualizar estado
        const statusEl = byId('emailStatus');
        const statusTextEl = byId('emailStatusText');
        const statusDetailEl = byId('emailStatusDetail');
        
        if (config.password_configured) {
          if (statusEl) statusEl.style.backgroundColor = '#d1f2eb';
          if (statusTextEl) statusTextEl.textContent = '‚úÖ Configurado';
          if (statusDetailEl) statusDetailEl.textContent = `Servidor: ${config.smtp_server}:${config.smtp_port} | Destino: ${config.recipient_email}`;
        } else {
          if (statusEl) statusEl.style.backgroundColor = '#fdeaa7';
          if (statusTextEl) statusTextEl.textContent = '‚ö†Ô∏è Requiere configuraci√≥n';
          if (statusDetailEl) statusDetailEl.textContent = 'Configure email y contrase√±a para recibir alertas autom√°ticas';
        }
      }
    } catch (e) {
      console.error('Error cargando configuraci√≥n de email:', e);
    }
  }
  
  function toggleCustomServerFields() {
    const provider = byId('configProvider')?.value;
    const customFields = byId('customServerFields');
    
    if (customFields) {
      if (provider === 'custom') {
        customFields.classList.remove('hidden');
      } else {
        customFields.classList.add('hidden');
      }
    }
  }
  
  async function guardarConfigEmail() {
    try {
      const statusEl = byId('alertaStatus');
      if (statusEl) statusEl.textContent = 'üíæ Guardando configuraci√≥n...';
      
      const config = {
        sender_email: byId('configSenderEmail')?.value,
        sender_password: byId('configSenderPassword')?.value,
        provider: byId('configProvider')?.value,
        smtp_port: parseInt(byId('configSmtpPort')?.value) || 587
      };
      
      // Agregar servidor personalizado si es necesario
      if (config.provider === 'custom') {
        config.smtp_server = byId('configSmtpServer')?.value;
      }
      
      // Validaciones b√°sicas
      if (!config.sender_email) {
        alert('‚ùå Por favor ingrese el email del sistema');
        return;
      }
      
      if (!config.sender_password) {
        alert('‚ùå Por favor ingrese la contrase√±a del email');
        return;
      }
      
      if (config.provider === 'custom' && !config.smtp_server) {
        alert('‚ùå Por favor ingrese el servidor SMTP personalizado');
        return;
      }
      
      const response = await fetch(`${API}/config/email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });
      
      const data = await response.json();
      
      if (data.success) {
        if (statusEl) {
          statusEl.textContent = '‚úÖ Configuraci√≥n guardada';
          setTimeout(() => statusEl.textContent = '', 5000);
        }
        
        // Limpiar campo de contrase√±a por seguridad
        if (byId('configSenderPassword')) byId('configSenderPassword').value = '';
        
        // Recargar estado
        cargarConfigEmail();
        
        alert('‚úÖ Configuraci√≥n de email guardada exitosamente.\n\n¬øDesea enviar un email de prueba ahora?') 
          ? probarEmail() : null;
      } else {
        throw new Error(data.message || 'Error guardando configuraci√≥n');
      }
    } catch (e) {
      const statusEl = byId('alertaStatus');
      if (statusEl) {
        statusEl.textContent = '‚ùå Error guardando';
        setTimeout(() => statusEl.textContent = '', 5000);
      }
      alert('‚ùå Error guardando configuraci√≥n: ' + e.message);
    }
  }
  
  async function verificarAlertas() {
    try {
      const statusEl = byId('alertaStatus');
      if (statusEl) statusEl.textContent = 'üîÑ Verificando alertas...';
      
      const response = await fetch(`${API}/alertas/verificar`);
      const data = await response.json();
      
      if (data.success) {
        if (statusEl) {
          const mensaje = data.alertas_enviadas > 0 
            ? `‚úÖ ${data.alertas_enviadas} alertas procesadas` 
            : '‚úÖ Sin alertas pendientes';
          statusEl.textContent = mensaje;
          setTimeout(() => statusEl.textContent = '', 5000);
        }
        alert(`‚úÖ Verificaci√≥n completada.\n${data.message}`);
      } else {
        throw new Error(data.message || 'Error verificando alertas');
      }
    } catch (e) {
      const statusEl = byId('alertaStatus');
      if (statusEl) {
        statusEl.textContent = '‚ùå Error';
        setTimeout(() => statusEl.textContent = '', 5000);
      }
      alert('‚ùå Error verificando alertas: ' + e.message);
    }
  }
  
  async function probarEmail() {
    try {
      const statusEl = byId('alertaStatus');
      if (statusEl) statusEl.textContent = 'üìß Enviando email de prueba...';
      
      const response = await fetch(`${API}/config/email/test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      
      if (data.success) {
        if (statusEl) {
          statusEl.textContent = '‚úÖ Email enviado';
          setTimeout(() => statusEl.textContent = '', 5000);
        }
        alert('‚úÖ Email de prueba enviado exitosamente a contabilidad2@arenalmanoa.com');
      } else {
        throw new Error(data.message || 'Error enviando email de prueba');
      }
    } catch (e) {
      const statusEl = byId('alertaStatus');
      if (statusEl) {
        statusEl.textContent = '‚ùå Error enviando email';
        setTimeout(() => statusEl.textContent = '', 5000);
      }
      alert('‚ùå Error enviando email de prueba: ' + e.message + '\n\nüí° Aseg√∫rese de que la configuraci√≥n de email est√© correcta.');
    }
  }
  
  // Event listeners para configuraci√≥n de email
  document.addEventListener('DOMContentLoaded', function() {
    // Cargar configuraci√≥n inicial
    setTimeout(cargarConfigEmail, 1000);
    
    // Event listener para cambio de proveedor
    const providerSelect = byId('configProvider');
    if (providerSelect) {
      providerSelect.addEventListener('change', toggleCustomServerFields);
    }
    
    // Mejoras espec√≠ficas para m√≥vil
    initMobileEnhancements();
  });
  
  // ===== MEJORAS PARA M√ìVIL =====
  function initMobileEnhancements() {
    // Detectar si es m√≥vil
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
      // Prevenir zoom en inputs doble-tap
      document.addEventListener('touchend', function(e) {
        const now = new Date().getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // Mejorar scroll en tabs
      const tabsContainer = document.querySelector('.tabs');
      if (tabsContainer) {
        // Agregar indicador de scroll sutil
        tabsContainer.addEventListener('scroll', function() {
          if (this.scrollLeft > 0) {
            this.classList.add('scrolled');
          } else {
            this.classList.remove('scrolled');
          }
        });
      }
      
      // Optimizar tablas para m√≥vil
      const tables = document.querySelectorAll('table');
      tables.forEach(table => {
        if (!table.closest('.table-container')) {
          const container = document.createElement('div');
          container.className = 'table-container';
          table.parentNode.insertBefore(container, table);
          container.appendChild(table);
        }
      });
      
      // Mejorar experiencia t√°ctil para cards
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.style.cursor = 'default';
      });
    }
    
    // Ajustar viewport height para m√≥vil (problema com√∫n con iOS Safari)
    function updateVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    updateVH();
    window.addEventListener('resize', updateVH);
    window.addEventListener('orientationchange', updateVH);
  }
  
  let lastTouchEnd = 0;
  let mobileCompactMode = false;
  
  // ===== MODO COMPACTO M√ìVIL =====
  function toggleMobileCompactMode() {
    mobileCompactMode = !mobileCompactMode;
    const body = document.body;
    const toggleBtn = byId('mobileToggle');
    
    if (mobileCompactMode) {
      body.classList.add('mobile-compact');
      if (toggleBtn) {
        toggleBtn.innerHTML = 'üìã Normal';
        toggleBtn.title = 'Cambiar a vista normal';
      }
      setupMobileNavigation();
      showMobileNotification('‚úÖ Modo compacto activado - Navegaci√≥n en la parte inferior', 2000);
      // Guardar preferencia
      try { localStorage.setItem('mobileCompactMode', 'true'); } catch {}
    } else {
      body.classList.remove('mobile-compact');
      if (toggleBtn) {
        toggleBtn.innerHTML = 'üì± Compacto';
        toggleBtn.title = 'Activar modo compacto m√≥vil';
      }
      showMobileNotification('‚úÖ Vista normal activada - Navegaci√≥n en pesta√±as superiores', 2000);
      // Guardar preferencia
      try { localStorage.setItem('mobileCompactMode', 'false'); } catch {}
    }
  }
  
  function showMobileNotification(message, duration = 3000) {
    // Crear o actualizar notificaci√≥n
    let notification = byId('mobileNotification');
    if (!notification) {
      notification = document.createElement('div');
      notification.id = 'mobileNotification';
      notification.style.cssText = `
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        text-align: center;
        max-width: 90%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      `;
      document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.style.opacity = '1';
    
    setTimeout(() => {
      if (notification) {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (notification && notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }, duration);
  }
  
  function setupMobileNavigation() {
    const navGrid = byId('mobileNavGrid');
    if (!navGrid || !currentUser) return;
    
    // Definir navegaci√≥n seg√∫n rol
    const navItems = [];
    
    if (hasPermission('dashboard')) {
      navItems.push({ tab: 'dashboard', icon: 'üìä', text: 'Dashboard' });
    }
    if (hasPermission('vehiculos')) {
      navItems.push({ tab: 'vehiculos', icon: 'üöó', text: 'Veh√≠culos' });
    }
    if (hasPermission('mantenimientos')) {
      navItems.push({ tab: 'mantenimientos', icon: 'üîß', text: 'Mantenim.' });
    }
    if (hasPermission('combustible')) {
      navItems.push({ tab: 'combustible', icon: '‚õΩ', text: 'Combustible' });
    }
    if (hasPermission('polizas')) {
      navItems.push({ tab: 'polizas', icon: 'üõ°Ô∏è', text: 'P√≥lizas' });
    }
    if (hasPermission('ficha-tecnica')) {
      navItems.push({ tab: 'ficha-tecnica', icon: 'üìã', text: 'Ficha T√©c.' });
    }
    if (hasPermission('revision')) {
      navItems.push({ tab: 'revision', icon: 'üîç', text: 'Revisi√≥n' });
    }
    if (hasPermission('reportes')) {
      navItems.push({ tab: 'reportes', icon: 'üìà', text: 'Reportes' });
    }
    
    // Crear elementos de navegaci√≥n (m√°ximo 8 items, dividir en p√°ginas si es necesario)
    navGrid.innerHTML = '';
    const maxItems = 8;
    const itemsToShow = navItems.slice(0, maxItems);
    
    itemsToShow.forEach(item => {
      const navItem = document.createElement('div');
      navItem.className = 'mobile-nav-item';
      navItem.setAttribute('data-tab', item.tab);
      navItem.innerHTML = `
        <span class="nav-icon">${item.icon}</span>
        <span class="nav-text">${item.text}</span>
      `;
      
      navItem.addEventListener('click', () => {
        // Remover active de todos
        document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
        // Agregar active al seleccionado
        navItem.classList.add('active');
        // Cambiar tab
        setTab(item.tab);
      });
      
      navGrid.appendChild(navItem);
    });
    
    // Marcar la pesta√±a activa
    updateMobileNavActive();
  }
  
  function updateMobileNavActive() {
    const activeTab = document.querySelector('.tab.active');
    const activeTabName = activeTab ? activeTab.getAttribute('data-tab') : 'dashboard';
    
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
      item.classList.remove('active');
      if (item.getAttribute('data-tab') === activeTabName) {
        item.classList.add('active');
      }
    });
  }
  
  // Modificar setTab para actualizar navegaci√≥n m√≥vil
  const originalSetTab = setTab;
  setTab = function(name) {
    originalSetTab(name);
    if (mobileCompactMode) {
      updateMobileNavActive();
    }
  };
  
  // Cargar preferencia de modo compacto al iniciar
  document.addEventListener('DOMContentLoaded', function() {
    // Cargar preferencia guardada
    try {
      const savedMode = localStorage.getItem('mobileCompactMode');
      if (savedMode === 'true' && window.innerWidth <= 768) {
        setTimeout(() => toggleMobileCompactMode(), 500);
      }
    } catch {}
  });
  
  </script>
</body>
</html>
