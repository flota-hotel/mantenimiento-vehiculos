<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard - Datos Combustible</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .kpi-card {
            background: #e3f2fd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }
        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: #1976d2;
        }
        .kpi-label {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Dashboard - Verificaci√≥n de Datos</h1>
        
        <div id="status" class="status loading">
            üîÑ Cargando datos desde API local...
        </div>

        <div class="kpi-card">
            <div class="kpi-label">üíæ Registros de Combustible Locales</div>
            <div id="combustibleCount" class="kpi-value">--</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">üìù Registros de Bit√°cora Locales</div>
            <div id="bitacoraCount" class="kpi-value">--</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">üí∞ Costo Total Combustible (Mes Actual)</div>
            <div id="costoTotal" class="kpi-value">--</div>
        </div>

        <div id="rawData" style="margin-top: 30px;">
            <h3>üìã Datos Raw de Combustible:</h3>
            <pre id="combustibleData" style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px;"></pre>
        </div>

        <div id="backupTest" style="margin-top: 30px;">
            <h3>üíæ Test de Backup Railway:</h3>
            <button id="btnTestBackup" onclick="testBackup()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üöÄ Probar Backup Railway
            </button>
            <div id="backupResult" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        const API_LOCAL = "https://8001-i2csqmmo4txbkyhmexll8-6532622b.e2b.dev";
        const API_RAILWAY = "https://mantenimiento-vehiculos-production.up.railway.app";

        async function loadData() {
            const status = document.getElementById('status');
            
            try {
                status.className = 'status loading';
                status.innerHTML = 'üîÑ Cargando datos desde API local...';

                // Cargar combustible
                const combustibleResponse = await fetch(`${API_LOCAL}/combustible`);
                const combustibleData = await combustibleResponse.json();
                
                // Cargar bit√°cora
                const bitacoraResponse = await fetch(`${API_LOCAL}/bitacora`);
                const bitacoraData = await bitacoraResponse.json();

                if (combustibleData.success && bitacoraData.success) {
                    const combustibleCount = combustibleData.data.length;
                    const bitacoraCount = bitacoraData.data.length;
                    
                    // Calcular costo total del mes
                    const inicioMes = new Date();
                    inicioMes.setDate(1);
                    const costoTotal = combustibleData.data
                        .filter(f => new Date(f.fecha) >= inicioMes)
                        .reduce((total, f) => total + Number(f.costo || 0), 0);

                    // Actualizar KPIs
                    document.getElementById('combustibleCount').textContent = combustibleCount;
                    document.getElementById('bitacoraCount').textContent = bitacoraCount;
                    document.getElementById('costoTotal').textContent = '‚Ç°' + costoTotal.toLocaleString();

                    // Mostrar datos raw
                    document.getElementById('combustibleData').textContent = JSON.stringify(combustibleData.data, null, 2);

                    status.className = 'status success';
                    status.innerHTML = `‚úÖ Datos cargados exitosamente: ${combustibleCount} combustible, ${bitacoraCount} bit√°cora`;
                } else {
                    throw new Error('Error en respuesta de API');
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                status.className = 'status error';
                status.innerHTML = `‚ùå Error cargando datos: ${error.message}`;
            }
        }

        async function testBackup() {
            const btn = document.getElementById('btnTestBackup');
            const result = document.getElementById('backupResult');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Ejecutando backup...';
                result.innerHTML = '<div class="status loading">üîÑ Enviando solicitud de backup a Railway...</div>';

                const response = await fetch(`${API_RAILWAY}/admin/backup-manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <div class="status success">
                            ‚úÖ Backup exitoso: ${data.sistemas_exitosos}/${data.sistemas_totales} sistemas<br>
                            üìÖ Timestamp: ${data.timestamp}<br>
                            üìã Detalles: ${JSON.stringify(data.resultados, null, 2)}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="status error">‚ùå Backup fall√≥: ${data.message}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Error en backup: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Probar Backup Railway';
            }
        }

        // Cargar datos al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>